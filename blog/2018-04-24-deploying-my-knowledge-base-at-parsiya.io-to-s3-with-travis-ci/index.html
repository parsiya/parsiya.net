<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1">
<link href=/css/fonts.css rel=stylesheet type=text/css>
<title>Deploying my Knowledge Base at parsiya.io to S3 with Travis CI</title><link rel=stylesheet href=/css/hugo-octopress.css>
<link rel=stylesheet href=/css/fork-awesome.min.css>
<link href=https://parsiya.net/favicon.png rel=icon>
<meta name=description content>
<meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]">
<meta name=author content="Parsia">
<meta name=generator content="Hugo 0.93.0">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Deploying my Knowledge Base at parsiya.io to S3 with Travis CI">
<meta name=twitter:description content="I finally managed to automate deployment of parsiya.io with Travis CI. Not having done this before, I encountered some pitfalls. Additionally I had two extra problems:

The structure of the blog is different from most Hugo deployments. Parsia-Clone only contains the content directory. Parents and everything else are in the parsiya.io repo. So while we push to Parsia-Clone, we need to clone parsiya.io and build the repository there.
I am hosting it out of an S3 bucket. All other examples were using github pages.

Update November 2020: As of late November 2020, I have switched to Github
actions for both parsiya.net and parsiya.io. Please see
deploy.ymlOLD.
Update February 2021: parsiya.io is now hosted on github pages with a custom
domain instead of an S3 bucket. Please see the workflow file at
gh-pages.yml.">
<meta name=twitter:domain content="parsiya.net">
<meta name=twitter:creator content="@CryptoGangsta">
</head><body>
<header role=banner>
<hgroup>
<h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation>
<fieldset class=mobile-nav>
<select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select>
</fieldset><ul class=main-navigation>
<li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription>
<a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
</ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer">
<fieldset role=search>
<input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/>
</fieldset></form></nav><div id=main>
<div id=content>
<div>
<article class=hentry role=article>
<header>
<p class=meta>Apr 24, 2018
- 7 minute read
- <a href=https://parsiya.net/blog/2018-04-24-deploying-my-knowledge-base-at-parsiya.io-to-s3-with-travis-ci/#disqus_thread>Comments</a>
- <a class=label href=https://parsiya.net/categories/not-security/>Not Security </a><a class=label href=https://parsiya.net/categories/clone/>Clone </a><a class=label href=https://parsiya.net/categories/automation/>Automation </a>
</p><h1 class=entry-title>
Deploying my Knowledge Base at parsiya.io to S3 with Travis CI
</h1></header><div class=entry-content>
<p>I finally managed to automate deployment of <a href=https://parsiya.io target=_blank rel="noreferrer noopener">parsiya.io</a> with Travis CI. Not having done this before, I encountered some pitfalls. Additionally I had two extra problems:</p><ul>
<li>The structure of the blog is different from most Hugo deployments. <a href=https://github.com/parsiya/Parsia-Clone target=_blank rel="noreferrer noopener">Parsia-Clone</a> only contains the <code>content</code> directory. Parents and everything else are in the <a href=https://github.com/parsiya/Parsiya.io target=_blank rel="noreferrer noopener">parsiya.io</a> repo. So while we push to <code>Parsia-Clone</code>, we need to clone <code>parsiya.io</code> and build the repository there.</li><li>I am hosting it out of an S3 bucket. All other examples were using github pages.</li></ul><p><strong>Update November 2020:</strong> As of late November 2020, I have switched to Github
actions for both <code>parsiya.net</code> and <code>parsiya.io</code>. Please see
<a href=https://github.com/parsiya/Parsia-Clone/blob/main/.github/workflows/deploy.ymlOLD target=_blank rel="noreferrer noopener">deploy.ymlOLD</a>.</p><p><strong>Update February 2021:</strong> parsiya.io is now hosted on github pages with a custom
domain instead of an S3 bucket. Please see the workflow file at
<a href=https://github.com/parsiya/Parsia-Clone/blob/main/.github/workflows/gh-pages.yml target=_blank rel="noreferrer noopener">gh-pages.yml</a>.</p><h1 id=tldr>TL;DR
<a class=header-link href=#tldr><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h1><ol>
<li>Sign into <a href=https://travis-ci.org/ target=_blank rel="noreferrer noopener">travis-ci.org</a> with your Github account.</li><li>Alternatively create an access token. All my repositories are public so I do not care.</li><li>Add the repository containing the content. In this case <code>Parsia-Clone</code>.
<ul>
<li>Enable <code>Build pushed branches</code>.</li></ul></li><li>Create the destination S3 bucket (e.g. <code>BUCKET_NAME</code>).</li><li>Create the following Amazon IAM policy and substitute <code>BUCKET_NAME</code>. This policy only gives read/write access to <code>BUCKET_NAME</code>.
<figure class=code>
<figcaption>
<span>travis-write-policy</span>
</figcaption><div class=codewrapper>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;Version&#34;</span>: <span style=color:#2aa198>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;Effect&#34;</span>: <span style=color:#2aa198>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#2aa198>&#34;s3:ListBucket&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;Resource&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#2aa198>&#34;arn:aws:s3:::BUCKET_NAME&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;Effect&#34;</span>: <span style=color:#2aa198>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#2aa198>&#34;s3:PutObject&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#2aa198>&#34;s3:GetObject&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#2aa198>&#34;s3:DeleteObject&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#2aa198>&#34;s3:AbortMultipartUpload&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#2aa198>&#34;s3:GetObjectAcl&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#2aa198>&#34;s3:PutObjectAcl&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;Resource&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#2aa198>&#34;arn:aws:s3:::BUCKET_NAME/*&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure></li><li>Create a group with the previous policy (e.g. <code>travis-writers</code>).</li><li>Create a user and add it to the <code>travis-writers</code> group. Copy the AWS access/secret keys.</li><li>Create <code>.travis.yml</code> in <code>Parsia-Clone</code>.
<figure class=code>
<figcaption>
<span>.travis.yml</span>
</figcaption><div class=codewrapper>
<div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4>
<table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#586e75># safelist - only build on pushes to these branches</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>branches</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>only</span>:
</span></span><span style=display:flex><span>  - master
</span></span><span style=display:flex><span>  - travis
</span></span><span style=display:flex><span><span style=color:#586e75># we needed this if wanted to build Hugo manually</span>
</span></span><span style=display:flex><span><span style=color:#586e75># language: go</span>
</span></span><span style=display:flex><span><span style=color:#586e75># go:</span>
</span></span><span style=display:flex><span><span style=color:#586e75># - 1.10</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>install</span>:
</span></span><span style=display:flex><span><span style=color:#586e75># change this version as it goes up</span>
</span></span><span style=display:flex><span><span style=color:#586e75># get and install Hugo</span>
</span></span><span style=display:flex><span>- wget https://github.com/gohugoio/hugo/releases/download/v0.40/hugo_0.40_Linux-64bit.deb
</span></span><span style=display:flex><span>- sudo dpkg -i hugo*.deb
</span></span><span style=display:flex><span><span style=color:#586e75># clone the parent repository, note this is different from Parsia-Clone</span>
</span></span><span style=display:flex><span>- git clone https://github.com/parsiya/parsiya.io
</span></span><span style=display:flex><span>- cd parsiya.io
</span></span><span style=display:flex><span><span style=color:#586e75># update and fetch submodules</span>
</span></span><span style=display:flex><span>- git submodule init
</span></span><span style=display:flex><span>- git submodule update --recursive --remote
</span></span><span style=display:flex><span><span style=color:#268bd2>script</span>:
</span></span><span style=display:flex><span><span style=color:#586e75># build the website with Hugo, output will be in public directory</span>
</span></span><span style=display:flex><span>- hugo
</span></span><span style=display:flex><span><span style=color:#586e75># deploy public directory to the bucket</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>deploy</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>provider</span>: s3
</span></span><span style=display:flex><span>  <span style=color:#268bd2>access_key_id</span>: $AWS_ACCESS_KEY
</span></span><span style=display:flex><span>  <span style=color:#268bd2>secret_access_key</span>: $AWS_SECRET_KEY
</span></span><span style=display:flex><span>  <span style=color:#268bd2>bucket</span>: BUCKET_NAME
</span></span><span style=display:flex><span>  <span style=color:#268bd2>region</span>: us-east-1
</span></span><span style=display:flex><span>  <span style=color:#268bd2>local-dir</span>: public
</span></span><span style=display:flex><span>  <span style=color:#268bd2>skip_cleanup</span>: <span style=color:#cb4b16>true</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>acl</span>: public_read
</span></span><span style=display:flex><span>  <span style=color:#268bd2>on</span>:
</span></span><span style=display:flex><span>    <span style=color:#586e75># make it work on branch other than master</span>
</span></span><span style=display:flex><span>    <span style=color:#586e75># change this to master or any other branch if needed</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>branch</span>: travis</span></span></code></pre></td></tr></table></div></div></div></figure></li><li>Add the AWS keys in <code>Settings > Environment Variables</code> (do not include <code>$</code>):
<ul>
<li><code>AWS_ACCESS_KEY</code></li><li><code>AWS_SECRET_KEY</code></li></ul></li><li>Push any object and enjoy the deployed blog in your bucket.</li></ol><p>Now for the longer version.</p><h1 id=setup>Setup
<a class=header-link href=#setup><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h1><p>My git structure is unnecessarily complex. I will explain it in detail in a different blog post. But I wanted to keep <code>Parsia-Clone</code> intact and did not want to add the modified <a href=https://github.com/parsiya/Hugo-Octopress target=_blank rel="noreferrer noopener">Hugo-Octopress</a> them to it. <code>Parsia-Clone</code> is in the <code>content</code> directory. The parent them is in the <a href=https://github.com/parsiya/Parsiya.io target=_blank rel="noreferrer noopener">parsiya.io</a> repository that contains the theme and the clone as submodules.</p><p>After every push to the <code>Parsia-Clone</code> repository. Travis CI will:</p><ol>
<li>Create a new default container with Go.</li><li>Install Hugo.</li><li>Clone the <code>parsiya.io</code> directory.</li><li>Update and fetch submodules (theme and <code>Parsia-Clone</code>).</li><li>Build the website and deploy it to S3.</li><li>???</li><li>Profit.</li></ol><p>We can see it in the <code>travis.yml</code> file above. Let's talk about them a bit:</p><h2 id=safelist>safelist
<a class=header-link href=#safelist><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h2><p>Safelist tells Travis CI to only build on certain branches. In this case, I am pushing to <code>master</code> and <code>travis</code>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#586e75># safelist - only build on pushes to these branches</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>branches</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>only</span>:
</span></span><span style=display:flex><span>  - master
</span></span><span style=display:flex><span>  - travis
</span></span></code></pre></div><h2 id=language>language
<a class=header-link href=#language><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h2><p>If you want to build Hugo manually instead of downloading a deb, you can install Go and configure it.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#268bd2>language</span>: go
</span></span><span style=display:flex><span><span style=color:#268bd2>go</span>:
</span></span><span style=display:flex><span>- <span style=color:#2aa198>1.10</span>
</span></span></code></pre></div><h2 id=install>install
<a class=header-link href=#install><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h2><p><code>install</code> runs commands after push and is setting up the environment:</p><ol>
<li><code>wget https://github.com/gohugoio/hugo/releases/download/v0.40/hugo_0.40_Linux-64bit.deb</code>
<ul>
<li>Download the Hugo <code>deb</code>. At the time of writing, version <code>0.40</code> is out.</li></ul></li><li><code>sudo dpkg -i hugo*.deb</code>
<ul>
<li>Install the <code>deb</code> file.</li></ul></li><li><code>git clone https://github.com/parsiya/parsiya.io</code>
<ul>
<li>Clone the parent repository.</li></ul></li><li><code>git submodule init</code> - <code>git submodule update --recursive --remote</code>
<ul>
<li>Update and fetch submodules. The submodules might have been updated since the last commit to <code>parsiya.io</code>, so they must be updated.</li></ul></li></ol><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#268bd2>install</span>:
</span></span><span style=display:flex><span><span style=color:#586e75># change this version as it goes up</span>
</span></span><span style=display:flex><span><span style=color:#586e75># get and install Hugo</span>
</span></span><span style=display:flex><span>- wget https://github.com/gohugoio/hugo/releases/download/v0.40/hugo_0.40_Linux-64bit.deb
</span></span><span style=display:flex><span>- sudo dpkg -i hugo*.deb
</span></span><span style=display:flex><span><span style=color:#586e75># clone the parent repository, note this is different from Parsia-Clone</span>
</span></span><span style=display:flex><span>- git clone https://github.com/parsiya/parsiya.io
</span></span><span style=display:flex><span>- cd parsiya.io
</span></span><span style=display:flex><span><span style=color:#586e75># update and fetch submodules</span>
</span></span><span style=display:flex><span>- git submodule init
</span></span><span style=display:flex><span>- git submodule update --recursive --remote
</span></span></code></pre></div><h2 id=script>script
<a class=header-link href=#script><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h2><p>Now we will build the blog by running <code>hugo</code>. This command without any parameters will build the current website and put it in the <code>public</code> directory.</p><h2 id=deploy>deploy
<a class=header-link href=#deploy><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h2><ul>
<li>Deploy to S3 every time the <code>travis</code> branch is updated. <code>on</code> at the bottom of the file.</li><li>Access and secret keys are set in environmental variables above.</li><li>Region is <code>us-east-1</code>. This is the default region and does not need to be provided, if you bucket is in a different region be sure to change this.</li><li><code>local-dir: public</code>: Copy the <code>public</code> directory to the bucket.</li><li><code>bucket: BUCKET_NAME</code>: Destination bucket, change this.</li><li><code>skip_cleanup: true</code>: Do not delete the build artifacts.</li><li><code>acl: public_read</code>: Grant everyone read access to the bucket objects. This is only needed if you want to deploy the bucket via HTTP. If you want to deploy it over TLS via CloudFront, remove this and configure your bucket permissions for CloudFront properly.</li></ul><h2 id=pitfalls>Pitfalls
<a class=header-link href=#pitfalls><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h2><p>Being the first time that I have used Travis CI, I encountered some errors. I am documenting them here because inevitably me and some other people get these errors. You're welcome future me.</p><h3 id=add-environmental-variables-with--in-travis-ci-web-ui>Add Environmental Variables with $ in Travis CI Web UI
<a class=header-link href=#add-environmental-variables-with--in-travis-ci-web-ui><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h3><p>Initially when adding the environmental variables, I had added them as they appear in <code>travis.yml</code> file. Meaning they started with <code>$</code>. I am not sure why I had added them with the prefix. The error will be similar to:</p><ul>
<li><code>The previous command failed, possibly due to a malformed secure environment variable.</code></li></ul><p><strong>Solution:</strong> Don't add your environmental variables with <code>$</code>.</p><h3 id=error-with-go-get-hugo>Error with go get Hugo
<a class=header-link href=#error-with-go-get-hugo><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h3><p>To build Hugo from source, I initially had setup the container to have <code>Go</code> and then use <code>go get</code> to download and build Hugo. I got this error <code>imports context: unrecognized import path "context"</code>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>$ <span style=color:#719e07>go</span> get github.com<span style=color:#719e07>/</span>gohugoio<span style=color:#719e07>/</span>hugo
</span></span><span style=display:flex><span><span style=color:#719e07>package</span> github.com<span style=color:#719e07>/</span>gohugoio<span style=color:#719e07>/</span>hugo
</span></span><span style=display:flex><span>    imports context: unrecognized <span style=color:#719e07>import</span> path <span style=color:#2aa198>&#34;context&#34;</span>
</span></span><span style=display:flex><span>The command <span style=color:#2aa198>&#34;go get github.com/gohugoio/hugo&#34;</span> failed and exited with <span style=color:#2aa198>1</span> during .
</span></span></code></pre></div><p><strong>Solution:</strong> I decided to not build Hugo from source and just download and instead install the lastest <code>deb</code> release.</p><h3 id=repository-name-not-matching-the-condition-in-deploy>Repository Name not Matching the Condition in Deploy
<a class=header-link href=#repository-name-not-matching-the-condition-in-deploy><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h3><p>I am building inside the <code>parsiya.io</code> repo but I had originally added <code>Parsia-Clone</code> as condition in deployment in <code>travis.yml</code> like this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#268bd2>deploy</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>provider</span>: s3
</span></span><span style=display:flex><span>  <span style=color:#586e75># ... </span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>acl</span>: public_read
</span></span><span style=display:flex><span>  <span style=color:#268bd2>on</span>:
</span></span><span style=display:flex><span>    <span style=color:#586e75># Make it work on branch other than master.</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>branch</span>: travis
</span></span><span style=display:flex><span>    <span style=color:#268bd2>repo</span>: parsiya/parsia-clone
</span></span></code></pre></div><p>I got this error:</p><ul>
<li><code>this repo's name does not match one specified in .travis.yml's deploy.on.repo</code>.</li></ul><p><strong>Solution</strong>: Remove the <code>repo</code> condition. It's not needed.</p><h3 id=no-deleteobject-permission-in-aws-user-policy>No DeleteObject Permission in AWS User Policy
<a class=header-link href=#no-deleteobject-permission-in-aws-user-policy><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a>
</h3><p>If you do not give permission to delete the previous versions in the bucket (overwriting), the build will fail. The error message is a bit vague:</p><ul>
<li><code>Oops, It looks like you tried to write to a bucket that isn't yours or doesn't exist yet. Please create the bucket before trying to write to it.</code></li></ul><p>This error message in general means you do not have enough access. I had initially only given <code>PutObject</code> and <code>GetObject</code>.</p><p><strong>Solution:</strong> Add the following permissions:</p><ul>
<li><code>s3:PutObject</code></li><li><code>s3:GetObject</code></li><li><code>s3:DeleteObject</code></li><li><code>s3:AbortMultipartUpload</code></li><li><code>s3:GetObjectAcl</code></li><li><code>s3:PutObjectAcl</code></li></ul></div><footer>
<p class=meta>
<span class="byline author vcard">Posted by <span class=fn>Parsia</span></span>
<time>Apr 24, 2018</time>
<span class=categories>
Tags:
<a class=category href=https://parsiya.net/tags/blog>Blog</a> <a class=category href=https://parsiya.net/tags/travis-ci>Travis CI</a> <a class=category href=https://parsiya.net/tags/hugo>Hugo</a>
</span>
</p><p class=meta>
<a class="basic-alignment left" href=https://parsiya.net/blog/2018-04-15-adding-custom-chroma-styles-to-hugo-themes/ title="Adding Custom Chroma Styles to Hugo Themes">Adding Custom Chroma Styles to Hugo Themes</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2018-04-24-semi-automated-cloning-pain-free-knowledge-base-creation/ title="Semi-Automated Cloning: Pain-Free Knowledge Base Creation">Semi-Automated Cloning: Pain-Free Knowledge Base Creation</a>
</p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//parsiya.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</footer></article></div><aside class="sidebar thirds">
<section class="first odd">
<h1>Who am I?</h1><p>
<p>I am Parsia, a senior security engineer at <a href=https://www.ea.com/security target=_blank rel="noreferrer noopener">Electronic Arts</a>.</p><p>I write about application security, reverse engineering,
Go, cryptography, and (obviously) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more.</p></p></section><ul class=sidebar-nav>
<li class=sidebar-nav-item>
<a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://keybase.io/parsiya/ title=https://keybase.io/parsiya/><i class="fa fa-keybase fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a>
</li></ul><section class=odd>
<h1>Collections</h1><li>
<a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a>
</li><li>
<a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a>
</li><li>
<a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a>
</li><li>
<a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a>
</li><li>
<a href=https://parsiya.net/categories/go/ title=Go/Golang>Go/Golang</a>
</li><li>
<a href=https://parsiya.net/categories/blockchain/ title=Blockchain>Blockchain</a>
</li><li>
<a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a>
</li><li>
<a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a>
</li><li>
<a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a>
</li><li>
<a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a>
</li><li>
<a href=https://parsiya.net/categories/winappdbg/ title=WinAppDbg>WinAppDbg</a>
</li><li>
<a href=https://awsome.pw title="AWSome.pw - S3 bucket squatting - my very legit branded vulnerability">AWSome.pw - S3 bucket squatting - my very legit branded vulnerability</a>
</li></section></aside></div></div><footer role=contentinfo>
<p>Copyright &copy; 2022 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.
</p></footer></body></html>