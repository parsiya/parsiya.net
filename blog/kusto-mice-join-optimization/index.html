<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Kusto-Mice: Optimizing Kusto joins</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.net/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia"><meta name=generator content="Hugo 0.148.1"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content="https://parsiya.net/blog/kusto-mice-join-optimization/01-trenchcoat.png"><meta name=twitter:title content="Kusto-Mice: Optimizing Kusto joins"><meta name=twitter:description content="A few weeks ago I wrestled with a complex Kusto query. I shared what I learned
at work in a presentation. In this blog, I'll use a public example to walk you
through it."><meta name=twitter:domain content="parsiya.net"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select></fieldset><ul class=main-navigation><li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription><a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>May 18, 2025
- 10 minute read - <a class=label href=https://parsiya.net/categories/kusto/>Kusto</a></p><h1 class=entry-title>Kusto-Mice: Optimizing Kusto joins</h1></header><div class=entry-content><nav id=TableOfContents><ul><li><a href=#what-are-we-gonna-learn-here-today>What Are We Gonna Learn Here Today?</a></li><li><a href=#whats-kusto>What's Kusto?</a></li><li><a href=#sample-tables>Sample Tables</a></li><li><a href=#errors>Errors</a></li><li><a href=#avoiding-e_runaway_query>Avoiding E_RUNAWAY_QUERY</a><ul><li><a href=#join-use-the-smaller-table-first>join: Use the Smaller Table First</a></li><li><a href=#join-only-project-the-columns-you-need>join: Only Project the Columns You Need</a></li><li><a href=#join-move-predicates-into-join>join: Move Predicates into Join</a><ul><li><a href=#soapbox-has-vs-contains>Soapbox: has vs. contains</a></li></ul></li><li><a href=#join-broadcast-strategy>join: Broadcast Strategy</a></li><li><a href=#join-codifying-queries>join: Codifying Queries</a></li><li><a href=#join-one-column-ditch-join>join: One Column? Ditch Join</a></li></ul></li><li><a href=#avoiding-e_query_result_set_too_large>Avoiding E_QUERY_RESULT_SET_TOO_LARGE</a><ul><li><a href=#reducing-the-result-size>Reducing the Result Size</a></li><li><a href=#deduplicate>Deduplicate</a></li></ul></li><li><a href=#wrapping-up>Wrapping Up</a></li></ul></nav><p>A few weeks ago I wrestled with a complex Kusto query. I shared what I learned
at work in a presentation. In this blog, I'll use a public example to walk you
through it.</p><h1 id=what-are-we-gonna-learn-here-today>What Are We Gonna Learn Here Today?
<a class=header-link href=#what-are-we-gonna-learn-here-today><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Moved to the top:</p><ul><li>joins:<ul><li>The left side should be smaller.</li><li>Apply predicates before joining on both sides.</li><li>Use broadcast for cross-cluster queries.</li><li>Ditch join and use a predicate if one side is a single column.</li></ul></li><li>Result size:<ul><li>Project only the columns you need.</li><li>Use summarize to deduplicate the results.</li></ul></li></ul><h1 id=whats-kusto>What's Kusto?
<a class=header-link href=#whats-kusto><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Kusto, or Azure Data Explorer (ADX), is a distributed database. Honestly,
everyone calls it Kusto. It uses a language called <a href=https://learn.microsoft.com/en-us/kusto/query/ target=_blank rel="noreferrer noopener">Kusto Query Language or KQL</a>.
Kusto is popular for threat hunting in Azure because, well, everything at Azure
and subsequently at Microsoft ends up in a Kusto database somewhere.</p><p><span class=caption-wrapper><img class=caption src=01-trenchcoat.png title="Microsoft is three Kusto clusters in a trench coat. Image credit: Unknown" alt="Microsoft is three Kusto clusters in a trench coat. Image credit: Unknown">
<span class=caption-text>Microsoft is three Kusto clusters in a trench coat. Image credit: Unknown</span>
</span><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>I use <a href=https://learn.microsoft.com/en-us/kusto/query/tutorials/join-data-from-multiple-tables target=_blank rel="noreferrer noopener">join</a> a lot, and it's probably one of the most expensive operators. It
retrieves data from multiple tables and combines them. For this example, we'll
use the web interface and the sample databases
<a href=https://dataexplorer.azure.com/clusters/help/databases/Samples target=_blank rel="noreferrer noopener">https://dataexplorer.azure.com/clusters/help/databases/Samples</a>. At work, I use
the <a href=https://aka.ms/ke target=_blank rel="noreferrer noopener">Kusto Explorer</a> desktop app.</p><p>In the rest of the examples, I assume the web interface has automatically
selected the <code>Samples</code> database on the left side. If it hasn't, and you're using
multiple clusters, add the following (don't forget the <code>.</code> at the end) to the
beginning of the queries:
<code>cluster('help.kusto.windows.net').database('Samples').</code></p><h1 id=sample-tables>Sample Tables
<a class=header-link href=#sample-tables><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>We'll use the <code>StormEvents</code> and <code>PopulationData</code> tables. To join them, we need
one or more columns with matching data. I usually start with <code>take 5</code> to take
a peak:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>StormEvents
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> take <span style=color:#2aa198>5</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> take <span style=color:#2aa198>5</span>
</span></span></code></pre></div><p>Note that an empty line starts a new query in both Kusto Explorer and the ADX
web interface. You can have multiple queries in one window and run them
individually.</p><p>A pet peeve of mine is hitting <code>F5</code> in the web interface, which refreshes the
page instead of running the query like it does in the desktop app.</p><p>Both tables have a State column, so we can join them like this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>StormEvents
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>(PopulationData) <span style=color:#719e07>on</span> <span style=color:#719e07>State</span>
</span></span></code></pre></div><p>Or, for different column names, we'd use <code>$left</code> and <code>$right</code>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>StormEvents
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>(PopulationData) <span style=color:#719e07>on</span> $<span style=color:#719e07>left</span>.<span style=color:#719e07>State</span> <span style=color:#719e07>==</span> $<span style=color:#719e07>right</span>.OtherState
</span></span></code></pre></div><p>I mostly use inner join. See all join modes in
<a href=https://learn.microsoft.com/en-us/kusto/query/join-operator target=_blank rel="noreferrer noopener">Kusto docs - join operator</a>. We'll filter to only data with matching
states, as <code>StormEvents</code> includes locations like <code>Atlantic North</code> or
<code>Gulf of Mexico</code> (gets hauled away in an unmarked van).</p><p>In this case we get 57,714 rows, but in the real world I am usually dealing with
millions of rows and I hit the cluster limitations.</p><h1 id=errors>Errors
<a class=header-link href=#errors><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>After running a Kusto query, I usually see one of these errors:</p><ol><li>Timeout: Query execution exceeds a specific limit (usually a few minutes).</li><li><code>E_RUNAWAY_QUERY</code>: Query uses too much memory (usually a few GBs).</li><li><code>E_QUERY_RESULT_SET_TOO_LARGE</code>: Result set is too big (64MB in my case).</li></ol><p>Read more in <a href=https://learn.microsoft.com/en-us/kusto/concepts/query-limits target=_blank rel="noreferrer noopener">Kusto docs - Query Limits</a>.</p><span class=caption-wrapper><img class=caption src=02-errors.jpg title="The banes of my Kusto queries" alt="The banes of my Kusto queries">
<span class=caption-text>The banes of my Kusto queries</span></span><h1 id=avoiding-e_runaway_query>Avoiding E_RUNAWAY_QUERY
<a class=header-link href=#avoiding-e_runaway_query><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Joins often run out of memory due to excessive data matching. So our focus
should be on reducing both sides of the join before it happens. To quote Super
Troopers, "Enhance!"</p><p>You can monitor query memory usage and result size in both the web interface and
Kusto Explorer. In the web interface, click the <code>Stats</code> tab.</p><p>Note on performance: This isn't a scientific experiment. Due to warm-up,
caching, and other optimizations, measuring query performance can be
challenging. These tables are small, so the differences might be subtle, but
they were dramatic in my query.</p><span class=caption-wrapper><img class=caption src=07-perf.png title="Performance of the original query" alt="Performance of the original query">
<span class=caption-text>Performance of the original query</span></span><h2 id=join-use-the-smaller-table-first>join: Use the Smaller Table First
<a class=header-link href=#join-use-the-smaller-table-first><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The smaller table should be first. <code>PopulationData</code> only has 52 rows (50 states,
PR, and DC). Easy swap:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>(StormEvents) <span style=color:#719e07>on</span> <span style=color:#719e07>State</span>
</span></span></code></pre></div><p>To make the left side table smaller, apply all the <del>conditions</del> predicates
before the join. For example, if we want to look at events for states with a
population over 10 million, we can filter <code>PopulationData</code> first which leaves us
with only nine states:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>(StormEvents) <span style=color:#719e07>on</span> <span style=color:#719e07>State</span>
</span></span></code></pre></div><ul><li>Peak memory usage: 66MB.</li><li>Result: 17,037 rows. 19,336,519 bytes.</li></ul><p>Applying predicates after the join would produce the same results with
unnecessary computation matching the rows we don't care about.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>(StormEvents) <span style=color:#719e07>on</span> <span style=color:#719e07>State</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span></code></pre></div><span class=caption-wrapper><img class=caption src=03-predicate.jpg title="Say 'predicate' to impress your functional programming friends" alt="Say 'predicate' to impress your functional programming friends">
<span class=caption-text>Say 'predicate' to impress your functional programming friends</span></span><h2 id=join-only-project-the-columns-you-need>join: Only Project the Columns You Need
<a class=header-link href=#join-only-project-the-columns-you-need><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>To make the left side of the join as small as possible, include only needed
columns. Our left side table is small, but as a rule of thumb, don't project
columns with predicates unless needed. Let's remove Population:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project <span style=color:#719e07>State</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>(StormEvents) <span style=color:#719e07>on</span> <span style=color:#719e07>State</span>
</span></span></code></pre></div><ul><li>Peak memory usage: Still around 66MB.</li><li>Result: 17,037 rows. 19,183,186 bytes. Omitting the population column reduced it a little.</li></ul><p>After the <code>project</code> line, the query only sees the <code>State</code> column. We can rename
columns, too. If <code>State</code> was originally named <code>UsState</code>, we could rename it. Two
show two ways to rename, we rename it with <code>project-rename</code>
and then use <code>project State = UsState</code>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-SQL data-lang=SQL><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project<span style=color:#719e07>-</span><span style=color:#719e07>rename</span> UsState <span style=color:#719e07>=</span> <span style=color:#719e07>State</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project <span style=color:#719e07>State</span> <span style=color:#719e07>=</span> UsState
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>(StormEvents) <span style=color:#719e07>on</span> <span style=color:#719e07>State</span>
</span></span></code></pre></div><p>Remember when I mentioned we can have multiple queries in one window separated
by empty lines? This works nicely here for experimenting. We can copy a query,
modify it and compare the results.</p><span class=caption-wrapper><img class=caption src=04-multiple.png title="Multiple queries in one window" alt="Multiple queries in one window">
<span class=caption-text>Multiple queries in one window</span></span><h2 id=join-move-predicates-into-join>join: Move Predicates into Join
<a class=header-link href=#join-move-predicates-into-join><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>A teammate who is an expert in Kusto, Barry, reviewed my presentation and shared
some great tips. One suggestion was to move conditions into the join on the
right side. The <code>StormEvents</code> table has <code>BeginLocation</code> and <code>EndLocation</code>
columns. Let's filter events where these contain the word <code>beach</code>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project <span style=color:#719e07>State</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>(StormEvents) <span style=color:#719e07>on</span> <span style=color:#719e07>State</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> (BeginLocation has <span style=color:#2aa198>&#39;beach&#39;</span>) <span style=color:#719e07>or</span> (EndLocation has <span style=color:#2aa198>&#39;beach&#39;</span>)
</span></span></code></pre></div><p>Move the filter into the right side:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project <span style=color:#719e07>State</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>(
</span></span><span style=display:flex><span>    StormEvents
</span></span><span style=display:flex><span>    <span style=color:#719e07>|</span> <span style=color:#719e07>where</span> (BeginLocation has <span style=color:#2aa198>&#39;beach&#39;</span>) <span style=color:#719e07>or</span> (EndLocation has <span style=color:#2aa198>&#39;beach&#39;</span>)
</span></span><span style=display:flex><span>) <span style=color:#719e07>on</span> <span style=color:#719e07>State</span>
</span></span></code></pre></div><p><code>where</code> has move into the join. The fewer rows that we match on either side of
the join, the better.</p><ul><li>Peak memory usage: 18.15MB.</li><li>Results: 55 rows. 53,882 bytes.</li></ul><h3 id=soapbox-has-vs-contains>Soapbox: has vs. contains
<a class=header-link href=#soapbox-has-vs-contains><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Using <code>contains</code> triggers a warning recommending <code>has</code> instead.</p><span class=caption-wrapper><img class=caption src=05-contains-warning.png title="Contains has a warning (har har)" alt="Contains has a warning (har har)">
<span class=caption-text>Contains has a warning (har har)</span></span><p><code>has</code> and <code>contains</code> are not interchangeable. <code>has</code> matches whole words, while
<code>contains</code> is like a substring function. For example, given <code>CLEARWATER BEACH</code>:</p><ul><li>Searching for <code>beach</code> returns true for both <code>has</code> and <code>contains</code> since it's a separate word.</li><li>Searching for <code>clear</code> returns false for <code>has</code>, but true for <code>contains</code>.</li></ul><p>Learn more about string operators at <a href=https://aka.ms/kusto.stringterms target=_blank rel="noreferrer noopener">https://aka.ms/kusto.stringterms</a>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>print Example <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;CLEARWATER BEACH&#34;</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> extend Has_beach <span style=color:#719e07>=</span> (Example has <span style=color:#2aa198>&#34;beach&#34;</span>)           <span style=color:#719e07>//</span> <span style=color:#719e07>true</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> extend Contains_beach <span style=color:#719e07>=</span> (Example <span style=color:#719e07>contains</span> <span style=color:#2aa198>&#34;beach&#34;</span>) <span style=color:#719e07>//</span> <span style=color:#719e07>true</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> extend Has_clear <span style=color:#719e07>=</span> (Example has <span style=color:#2aa198>&#34;clear&#34;</span>)           <span style=color:#719e07>//</span> <span style=color:#719e07>false</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> extend Contains_clear <span style=color:#719e07>=</span> (Example <span style=color:#719e07>contains</span> <span style=color:#2aa198>&#34;clear&#34;</span>) <span style=color:#719e07>//</span> <span style=color:#719e07>true</span>
</span></span></code></pre></div><span class=caption-wrapper><img class=caption src=06-has-contains.png title="has and contains in action" alt="has and contains in action">
<span class=caption-text>has and contains in action</span></span><p>Note both operators are case-insensitive; case-sensitive versions are <code>has_cs</code>
and <code>contains_cs</code>.</p><h2 id=join-broadcast-strategy>join: Broadcast Strategy
<a class=header-link href=#join-broadcast-strategy><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Another tip from Barry.</p><p>When joining tables across clusters, a normal join is executed on a single
<a href=https://learn.microsoft.com/en-us/fabric/real-time-intelligence/create-eventhouse target=_blank rel="noreferrer noopener">eventhouse node</a>, a group of databases sharing resources. While not
always correct, I assume databases on the same cluster are in the same
eventhouse and experiment with broadcast when joining cross-cluster tables.</p><p>The <a href=https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/broadcast-join target=_blank rel="noreferrer noopener">broadcast strategy</a> distributes the join load between
eventhouses. However, the left side of
the join must be small, typically in the "10s of MBs".</p><p>The documentation shows us a way to guesstimate the size of tables:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> summarize <span style=color:#719e07>sum</span>(estimate_data_size(<span style=color:#719e07>*</span>))
</span></span><span style=display:flex><span><span style=color:#719e07>//</span> <span style=color:#2aa198>869</span>
</span></span></code></pre></div><p>Applying a predicate reduces the size:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> summarize <span style=color:#719e07>sum</span>(estimate_data_size(<span style=color:#719e07>*</span>))
</span></span><span style=display:flex><span><span style=color:#719e07>//</span> <span style=color:#2aa198>147</span>
</span></span></code></pre></div><p>Projecting only the needed column:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project <span style=color:#719e07>State</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> summarize <span style=color:#719e07>sum</span>(estimate_data_size(<span style=color:#719e07>*</span>)) 
</span></span><span style=display:flex><span><span style=color:#719e07>//</span> <span style=color:#2aa198>75</span>
</span></span></code></pre></div><p>We can apply the broadcast strategy:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project <span style=color:#719e07>State</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> hint.strategy <span style=color:#719e07>=</span> broadcast kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>( <span style=color:#719e07>//</span> <span style=color:#719e07>&lt;</span><span style=color:#586e75>--- Only change
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    StormEvents
</span></span><span style=display:flex><span>    <span style=color:#719e07>|</span> <span style=color:#719e07>where</span> (BeginLocation has <span style=color:#2aa198>&#39;beach&#39;</span>) <span style=color:#719e07>or</span> (EndLocation has <span style=color:#2aa198>&#39;beach&#39;</span>)
</span></span><span style=display:flex><span>) <span style=color:#719e07>on</span> <span style=color:#719e07>State</span>
</span></span></code></pre></div><ul><li>Peak memory usage: 25.93MB (interestingly, higher because of data duplication).</li><li>Results: 55 rows, 49,913 bytes.<ul><li>Slightly less than the previous query due to a bug? I checked and both
queries return the exact same results.</li></ul></li></ul><h2 id=join-codifying-queries>join: Codifying Queries
<a class=header-link href=#join-codifying-queries><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>When working with multiple tables, queries can get complex. Kusto variables can
help us here. I'll use the full cluster and database names, as we often work
with multiple clusters.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>let popData <span style=color:#719e07>=</span> <span style=color:#719e07>cluster</span>(<span style=color:#2aa198>&#39;help.kusto.windows.net&#39;</span>).<span style=color:#719e07>database</span>(<span style=color:#2aa198>&#39;Samples&#39;</span>).PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project <span style=color:#719e07>State</span>;
</span></span><span style=display:flex><span>let events <span style=color:#719e07>=</span> <span style=color:#719e07>cluster</span>(<span style=color:#2aa198>&#39;help.kusto.windows.net&#39;</span>).<span style=color:#719e07>database</span>(<span style=color:#2aa198>&#39;Samples&#39;</span>).StormEvents
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> (BeginLocation has <span style=color:#2aa198>&#39;beach&#39;</span>) <span style=color:#719e07>or</span> (EndLocation has <span style=color:#2aa198>&#39;beach&#39;</span>);
</span></span><span style=display:flex><span>popData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>join</span> hint.strategy <span style=color:#719e07>=</span> broadcast kind<span style=color:#719e07>=</span><span style=color:#719e07>inner</span>(events) <span style=color:#719e07>on</span> <span style=color:#719e07>State</span>
</span></span></code></pre></div><p>This approach doesn't change peak memory usage or results, but makes the query
easier to read and modify. Note that variable declarations should be
consecutive, without empty lines, to be considered part of the same query.</p><h2 id=join-one-column-ditch-join>join: One Column? Ditch Join
<a class=header-link href=#join-one-column-ditch-join><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>"But wait, there's more!"</p><p>When working with a single column, we can create a variable and use it in a
predicate.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>let popData <span style=color:#719e07>=</span> <span style=color:#719e07>cluster</span>(<span style=color:#2aa198>&#39;help.kusto.windows.net&#39;</span>).<span style=color:#719e07>database</span>(<span style=color:#2aa198>&#39;Samples&#39;</span>).PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project <span style=color:#719e07>State</span>;
</span></span><span style=display:flex><span><span style=color:#719e07>cluster</span>(<span style=color:#2aa198>&#39;help.kusto.windows.net&#39;</span>).<span style=color:#719e07>database</span>(<span style=color:#2aa198>&#39;Samples&#39;</span>).StormEvents
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> (BeginLocation has <span style=color:#2aa198>&#39;beach&#39;</span>) <span style=color:#719e07>or</span> (EndLocation has <span style=color:#2aa198>&#39;beach&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> <span style=color:#719e07>State</span> <span style=color:#719e07>in</span> (popData) <span style=color:#719e07>//</span> <span style=color:#719e07>&lt;</span><span style=color:#586e75>--- See here
</span></span></span></code></pre></div><p>This approach replaces the join with a more efficient <code>in</code> operator,
significantly reducing peak memory usage.</p><ul><li><strong>Peak memory usage: 1.01MB!!</strong> (dramatic decrease).</li><li>Result: 55 rows, 49,526 bytes.<ul><li>Again, results are identical to the last two queries, but the reported size is
different. Maybe it includes metadata?</li></ul></li></ul><h1 id=avoiding-e_query_result_set_too_large>Avoiding E_QUERY_RESULT_SET_TOO_LARGE
<a class=header-link href=#avoiding-e_query_result_set_too_large><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>When returning too much data (typically over 64MB), you might encounter the <code>E_QUERY_RESULT_SET_TOO_LARGE</code> error and get truncated results. To mitigate this, focus on reducing the result size.</p><h2 id=reducing-the-result-size>Reducing the Result Size
<a class=header-link href=#reducing-the-result-size><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>One effective approach is to <code>project</code> only necessary columns, especially at the
end of the query like we did above before the join. When hitting the result
limit, I use two methods:</p><ol><li>Paginate results in multiple queries.</li><li>Exclude unnecessary columns from the result.</li></ol><p>In this example, we'll use the second solution. The <code>StormSummary</code> column is a
JSON object with redundant data, making it a prime candidate for removal using
the <a href=https://learn.microsoft.com/en-us/kusto/query/project-away-operator target=_blank rel="noreferrer noopener">project-away</a> operator.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#586e75>// Example of StormSummary
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>{
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;TotalDamages&#34;</span>: <span style=color:#2aa198>6000000</span>,
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;StartTime&#34;</span>: <span style=color:#2aa198>&#34;2007-02-02T04:22:00.0000000Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;EndTime&#34;</span>: <span style=color:#2aa198>&#34;2007-02-02T04:27:00.0000000Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;Details&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&#34;Description&#34;</span>: <span style=color:#2aa198>&#34;The same mesocyclone that produced [...]&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&#34;Location&#34;</span>: <span style=color:#2aa198>&#34;FLORIDA&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The query would look like:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>let popData <span style=color:#719e07>=</span> <span style=color:#719e07>cluster</span>(<span style=color:#2aa198>&#39;help.kusto.windows.net&#39;</span>).<span style=color:#719e07>database</span>(<span style=color:#2aa198>&#39;Samples&#39;</span>).PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project <span style=color:#719e07>State</span>;
</span></span><span style=display:flex><span><span style=color:#719e07>cluster</span>(<span style=color:#2aa198>&#39;help.kusto.windows.net&#39;</span>).<span style=color:#719e07>database</span>(<span style=color:#2aa198>&#39;Samples&#39;</span>).StormEvents
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> (BeginLocation has <span style=color:#2aa198>&#39;beach&#39;</span>) <span style=color:#719e07>or</span> (EndLocation has <span style=color:#2aa198>&#39;beach&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> <span style=color:#719e07>State</span> <span style=color:#719e07>in</span> (popData)
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project<span style=color:#719e07>-</span>away StormSummary
</span></span></code></pre></div><ul><li>Peak memory usage: 1.01MB.</li><li>Result: 55 rows, 31,349 bytes.</li></ul><p>Other good candidates are <code>EpisodeNarrative</code> and <code>EventNarrative</code>, which would
drop the result size to 8,426 bytes.</p><h2 id=deduplicate>Deduplicate
<a class=header-link href=#deduplicate><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>When working with regularly captured data, you might want to see only the latest
instance. In our example, we have 55 rows, mostly about Florida. To get the last
event for each state, we can modify the query:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>let popData <span style=color:#719e07>=</span> <span style=color:#719e07>cluster</span>(<span style=color:#2aa198>&#39;help.kusto.windows.net&#39;</span>).<span style=color:#719e07>database</span>(<span style=color:#2aa198>&#39;Samples&#39;</span>).PopulationData
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> Population <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>10000000</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project <span style=color:#719e07>State</span>;
</span></span><span style=display:flex><span><span style=color:#719e07>cluster</span>(<span style=color:#2aa198>&#39;help.kusto.windows.net&#39;</span>).<span style=color:#719e07>database</span>(<span style=color:#2aa198>&#39;Samples&#39;</span>).StormEvents
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> (BeginLocation has <span style=color:#2aa198>&#39;beach&#39;</span>) <span style=color:#719e07>or</span> (EndLocation has <span style=color:#2aa198>&#39;beach&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> <span style=color:#719e07>where</span> <span style=color:#719e07>State</span> <span style=color:#719e07>in</span> (popData)
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> summarize arg_max(EndTime, <span style=color:#719e07>*</span>) <span style=color:#719e07>by</span> <span style=color:#719e07>State</span>
</span></span><span style=display:flex><span><span style=color:#719e07>|</span> project<span style=color:#719e07>-</span>away StormSummary, EpisodeNarrative, EventNarrative
</span></span></code></pre></div><p>This query returns 5 rows and 985 bytes, showing only the latest event for each
state.</p><span class=caption-wrapper><img class=caption src=08-end.png title="The result of the last query" alt="The result of the last query">
<span class=caption-text>The result of the last query</span></span><h1 id=wrapping-up>Wrapping Up
<a class=header-link href=#wrapping-up><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>These basic tips helped me replace a query that was running out of memory (10GB
peak) and returning 200MB of data into one that finished in just 3 minutes, used
2GB of peak memory, and returned 21MB. I hope these tips will be useful for you,
too.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>I couldn't find the original image. Please let me know if you do, so I can credit the artist (or remove it if usage isn't allowed). It's one of my favorite images.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Parsia</span></span><time>May 18, 2025</time></span></p><p class=meta><a class="basic-alignment left" href=https://parsiya.net/blog/steam-open-desktop/ title="Steam's 'Open in Desktop' Button">Steam's 'Open in Desktop' Button</a></p></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I?</h1><p><p>I am Parsia, a security engineer at Microsoft.</p><p>I write about application security, cryptography, static analysis, and
(of course) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more. Contact me via any of these ways.</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="me noopener noreferrer" href=https://infosec.exchange/@parsiya title=https://infosec.exchange/@parsiya><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><h1>Collections</h1><li><a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a></li><li><a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a></li><li><a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a></li><li><a href=https://parsiya.net/categories/static-analysis/ title="Static Analysis">Static Analysis</a></li><li><a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a></li><li><a href=https://parsiya.net/categories/blockchain/ title="Blockchain (lol)">Blockchain (lol)</a></li><li><a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a></li><li><a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a></li><li><a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a></li><li><a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a></li><li><a href=https://parsiya.net/categories/winappdbg/ title="WinAppDbg (use Frida instead)">WinAppDbg (use Frida instead)</a></li><li><a href=https://awsome.pw title='AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability'>AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability</a></li></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2025 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>