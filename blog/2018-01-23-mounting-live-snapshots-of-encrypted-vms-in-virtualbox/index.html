<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Mounting Live Snapshots of Encrypted VMs in VirtualBox</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.net/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia"><meta name=generator content="Hugo 0.101.0"><meta name=twitter:card content="summary"><meta name=twitter:title content="Mounting Live Snapshots of Encrypted VMs in VirtualBox"><meta name=twitter:description content="TL;DR

Problem: We have an encrypted Virtual Machine (VM) disk and the associated
VirtualBox (VBox) live snapshot (taken when user was logged in). Mount the VM
and restore the live snapshot to get access to the data.
It seems pretty easy, but turns out it's not and looks to be a first of its kind
tutorial (at least public). This is surprising because I can imagine this issue
being a recurring problem in the forensics community.
A few days ago I did a couple of Forensics challenges. Both involved mounting
images and analyzing the contents of a VM. The second challenge was a disk and a
live snapshot. Part of the challenge involved mounting the snapshot and
restoring the state to log in.
It's an ongoing challenge so I do not want to spill the beans. Instead, I have
re-created a VM to show what I did. Hopefully this will help the next person
with a similar problem."><meta name=twitter:domain content="parsiya.net"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select></fieldset><ul class=main-navigation><li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription><a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Jan 23, 2018
- 11 minute read
- <a href=https://parsiya.net/blog/2018-01-23-mounting-live-snapshots-of-encrypted-vms-in-virtualbox/#disqus_thread>Comments</a>
- <a class=label href=https://parsiya.net/categories/forensics/>Forensics </a><a class=label href=https://parsiya.net/categories/writeup/>Writeup</a></p><h1 class=entry-title>Mounting Live Snapshots of Encrypted VMs in VirtualBox</h1></header><div class=entry-content><h3 id=tldr>TL;DR
<a class=header-link href=#tldr><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p><strong>Problem</strong>: We have an encrypted Virtual Machine (VM) disk and the associated
VirtualBox (VBox) live snapshot (taken when user was logged in). Mount the VM
and restore the live snapshot to get access to the data.</p><p>It seems pretty easy, but turns out it's not and looks to be a first of its kind
tutorial (at least public). This is surprising because I can imagine this issue
being a recurring problem in the forensics community.</p><p>A few days ago I did a couple of Forensics challenges. Both involved mounting
images and analyzing the contents of a VM. The second challenge was a disk and a
live snapshot. Part of the challenge involved mounting the snapshot and
restoring the state to log in.</p><p>It's an ongoing challenge so I do not want to spill the beans. Instead, I have
re-created a VM to show what I did. Hopefully this will help the next person
with a similar problem.</p><h1 id=table-of-contents>Table of Contents
<a class=header-link href=#table-of-contents><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><ul><li><a href=#table-of-contents>Table of Contents</a></li><li><a href=#setup>Setup</a></li><li><a href=#recon>Recon</a></li><li><a href=#reading-the-vdi-in-another-vm>Reading the VDI in Another VM</a></li><li><a href=#how-do-we-trick-vbox-into-restoring-our-saved-state>How do We Trick VBox into Restoring Our Saved State?</a><ul><li><a href=#whats-the-operating-system>What's the Operating System?</a><ul><li><a href=#whats-in-the-swap-file-and-live-snapshot>What's in the Swap File and Live Snapshot?</a></li></ul></li><li><a href=#mounting-the-vm-in-vbox>Mounting the VM in VBox</a><ul><li><a href=#adding-the-snapshot>Adding the Snapshot</a></li></ul></li><li><a href=#trial-and-error-in-vbox>Trial and Error in VBox</a><ul><li><a href=#first-blood-memory-size-mismatch>First Blood: Memory Size Mismatch</a></li><li><a href=#vram-size-mismatch>"VRam" size mismatch</a></li><li><a href=#missing-device-on-port-0>Missing Device on Port 0</a></li><li><a href=#secondary-master-device>Secondary Master Device</a></li><li><a href=#great-success>Great Success</a></li></ul></li><li><a href=#bonus-errors>Bonus Errors</a><ul><li><a href=#bonus-error-1---fioapicpresent-savedtrue-configfalse>Bonus Error #1 - fIoApicPresent: saved=true config=false</a></li><li><a href=#bonus-error-2---uapicmode-saved2-config3>Bonus Error #2 - uApicMode: saved=2 config=3</a><ul><li><a href=#uapicmode>uApicMode</a></li><li><a href=#different-enum>Different Enum</a></li></ul></li></ul></li></ul></li><li><a href=#where-do-we-go-from-here>Where do We Go From Here?</a></li><li><a href=#conclusion-and-future-work>Conclusion and Future Work</a></li></ul><h1 id=setup>Setup
<a class=header-link href=#setup><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><ul><li><a href=https://www.virtualbox.org/wiki/Downloads target=_blank rel="noreferrer noopener">VirtualBox</a>: If VBox people break compatibility, we have to
download an older version. Later we will see how to extract the VBox version
used to create the image.</li><li>Sample VDI and live snapshot from Google Drive: If you want to play along and practice.<ul><li><a href="https://drive.google.com/open?id=1tf0ZLNVQHoYCuESlGz1QHGtTtuzgha9e" target=_blank rel="noreferrer noopener">Encrypted VM and snapshot (2GB)</a>: Encrypted disk with live snapshot <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</li></ul></li><li>A Hex editor. I use <a href=https://mh-nexus.de/en/hxd/ target=_blank rel="noreferrer noopener">HxD</a>.</li></ul><h1 id=recon>Recon
<a class=header-link href=#recon><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>After extracting the 7z file, we have these files:</p><pre tabindex=0><code>E:\MysteryVM&gt;tree /F
Folder PATH listing for volume Local Disk
E:.
│   MysteryVM.vdi
│
└───Snapshots
        2018-01-23T03-19-37-348469500Z.sav
</code></pre><h1 id=reading-the-vdi-in-another-vm>Reading the VDI in Another VM
<a class=header-link href=#reading-the-vdi-in-another-vm><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Detecting the file system and mounting the disk in another VM is the easiest way
to read the disk if it's not encrypted. This is easy to do in VBox (or any other
virtualization platform).</p><p>In this case I am going to mount it in a Kali VM. Kali; after all, is a Debian
distro with a bunch of security tools pre-installed.</p><ol><li>Stop the Kali VM if running.</li><li><code>Settings > Storage > Add a new SATA hard disk</code>.</li><li><code>Choose existing disk</code> and select the VDI.</li><li>Boot up the Kali VM.</li></ol><span class=caption-wrapper><img class=caption src=/images/2018/vbox1/01-add-vdi.png title="Adding MysteryVM.vdi as a disk to Kali" alt="Adding MysteryVM.vdi as a disk to Kali">
<span class=caption-text>Adding MysteryVM.vdi as a disk to Kali</span></span><p>But the drive is encrypted, oops!</p><span class=caption-wrapper><img class=caption src=/images/2018/vbox1/02-encrypted-drive.png title="Need the passphrase" alt="Need the passphrase">
<span class=caption-text>Need the passphrase</span></span><p>That did not work, so we must:</p><ol><li>Find/Crack the disk passphrase. Not usually feasible.</li><li>Restore the live snapshot in VBox.</li></ol><p>Stop the VM and remove the disk. VBox allows each disk to be only part of one VM.</p><h1 id=how-do-we-trick-vbox-into-restoring-our-saved-state>How do We Trick VBox into Restoring Our Saved State?
<a class=header-link href=#how-do-we-trick-vbox-into-restoring-our-saved-state><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>This is "my contribution" to science. We need to tell VBox to run the VM and
restore the live snapshot. This way, we are logged-in after the VM is running.</p><h2 id=whats-the-operating-system>What's the Operating System?
<a class=header-link href=#whats-the-operating-system><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>When a VM is created in VBox, we can define the VM (e.g. Windows 7 64-bit). I am
not sure if it's really relevant but we can still discover the OS by sifting
through the VDI file. The disk is encrypted but we have two other pieces of
information:</p><ol><li>Swap partition</li><li>Live snapshot</li></ol><h3 id=whats-in-the-swap-file-and-live-snapshot>What's in the Swap File and Live Snapshot?
<a class=header-link href=#whats-in-the-swap-file-and-live-snapshot><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>The VDI comes with a separate swap partition. Using a swap partition/file is
common practice for most operating systems. Open the VDI with 7-zip and extract
<code>0.img</code>.</p><span class=caption-wrapper><img class=caption src=/images/2018/vbox1/03-swap-partition.png title="Swap partition in VDI" alt="Swap partition in VDI">
<span class=caption-text>Swap partition in VDI</span></span><p>Open the swap partition with a hex editor. Although the disk is encrypted, swap
partition contains some clues about the OS. Running <code>strings</code> on it and
searching for <code>linux</code> outputs some familiar strings. I am going to search for
<code>Debian</code> because I know the OS but you can try other things.</p><pre tabindex=0><code>E:\MysteryVM&gt; strings64.exe 0.img | findstr Debian
4.9.0-4-amd64 (debian-kernel@lists.debian.org) #1 SMP Debian 4.9.65-3 (2017-12-03)
4.9.0-4-amd64 (debian-kernel@lists.debian.org) #1 SMP Debian 4.9.65-3+deb9u1 (2017-12-23)
GCC: (Debian 6.3.0-6) 6.3.0 20170205
GCC: (Debian 6.3.0-6) 6.3.0 20170205
grub_target_cc_version=&#39;gcc-6 (Debian 6.3.0-6) 6.3.0 20170205&#39;
...
</code></pre><p>The snapshot gives us the same strings:</p><pre tabindex=0><code>E:\MysteryVM&gt;strings64.exe Snapshots/2018-01-23T03-19-37-348469500Z.sav | findstr &#34;Debian&#34;
Debian GNU/Linux system are free
h as Debian
having that way in Debian under
GCC: (Debian 6.3.0-18)
 Debian 4.9.65-3+deb9u1
GCC: (Debian 6.3.0-18)
GCC: (Debian 6.3.0-18)
GCC: (Debian 6.3.0-18)
GCC: (Debian 6.3.0-18)
GCC: (Debian 6.3.0-18)
...
</code></pre><p>Now we know it's a Debian distro (even the GCC version).</p><h2 id=mounting-the-vm-in-vbox>Mounting the VM in VBox
<a class=header-link href=#mounting-the-vm-in-vbox><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Create a new Debian 64-bit VM in VBox and add the VDI as disk. Go with the
default settings (e.g. 1024MB RAM).</p><h3 id=adding-the-snapshot>Adding the Snapshot
<a class=header-link href=#adding-the-snapshot><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Do not start the VM. Instead, right click on the newly created VM in VBox and
select <code>Show in Explorer</code> to open the VM directory. Copy (do not move, we do not
want to lose our original copies) the <code>Snapshots</code> directory to that path. Then
<strong>close VBox because it will overwrite the config files when it exits</strong>.</p><p>The directory should look like this:</p><pre tabindex=0><code>E:\VirtualBox VMs\MysteryVM&gt;tree /F
Folder PATH listing for volume Local Disk
E:.
│   MysteryVM.vbox
│   MysteryVM.vbox-prev
│
├───Logs
│       VBox.log
│       VBoxHardening.log
│
└───Snapshots
        2018-01-23T03-19-37-348469500Z.sav
</code></pre><p>Now make a copy of <code>MysteryVM.vbox</code> and open the original in a text editor. It's
an XML file. We are interested in this tag:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;Machine</span> uuid=<span style=color:#2aa198>&#34;{048b16c8-20be-463f-8808-24443c7493e2}&#34;</span> 
</span></span><span style=display:flex><span>    name=<span style=color:#2aa198>&#34;MysteryVM&#34;</span> OSType=<span style=color:#2aa198>&#34;Debian_64&#34;</span> snapshotFolder=<span style=color:#2aa198>&#34;Snapshots&#34;</span> 
</span></span><span style=display:flex><span>    lastStateChange=<span style=color:#2aa198>&#34;2018-01-23T03:38:51Z&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span></code></pre></div><p>We only need to add the <code>stateFile</code> like this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;Machine</span> uuid=<span style=color:#2aa198>&#34;{a5ce5d3d-9fca-4d72-a391-78d41c8d451c}&#34;</span>
</span></span><span style=display:flex><span>    name=<span style=color:#2aa198>&#34;MysteryVM&#34;</span> OSType=<span style=color:#2aa198>&#34;Debian_64&#34;</span> snapshotFolder=<span style=color:#2aa198>&#34;Snapshots&#34;</span>
</span></span><span style=display:flex><span>    lastStateChange=<span style=color:#2aa198>&#34;2018-01-23T02:52:12Z&#34;</span>
</span></span><span style=display:flex><span>    stateFile=<span style=color:#2aa198>&#34;Snapshots/2018-01-23T03-19-37-348469500Z.sav&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span></code></pre></div><p>Make sure the filename is the same as the live snapshot we copied.</p><p>Start VBox and the VM should have a saved state. If it does not close VBox and
try again.</p><span class=caption-wrapper><img class=caption src=/images/2018/vbox1/04-saved-state.png title="Saved state added to VM" alt="Saved state added to VM">
<span class=caption-text>Saved state added to VM</span></span><h2 id=trial-and-error-in-vbox>Trial and Error in VBox
<a class=header-link href=#trial-and-error-in-vbox><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Now we start the trial and error sequence. Start the VM and resolve any errors. Rinse and repeat.</p><h3 id=first-blood-memory-size-mismatch>First Blood: Memory Size Mismatch
<a class=header-link href=#first-blood-memory-size-mismatch><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>We do not have the correct amount of RAM.</p><pre tabindex=0><code>Failed to load unit &#39;mm&#39; (VERR_SSM_LOAD_MEMORY_SIZE_MISMATCH).

Result Code: 
E_FAIL (0x80004005)
Component: 
ConsoleWrap
Interface: 
IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><p>The error message does not give us any info, so we need to jump into the
snapshot file (<code>sav</code> file). Luckily, we can find our answer at
<a href=https://superuser.com/a/936602 target=_blank rel="noreferrer noopener">https://superuser.com/a/936602</a>.</p><p>Each <code>sav</code> file has some units. We are looking for the <code>Memory Manager (mm)</code>
unit which has the RAM size. Using the instructions from the SuperUser answer,
we can find the RAM size (we will dissect some parts of the <code>sav</code> file in a
future post).</p><span class=caption-wrapper><img class=caption src=/images/2018/vbox1/05-ram-size.png title="VM RAM size" alt="VM RAM size">
<span class=caption-text>VM RAM size</span></span><p>We have <code>0x200</code> in little-endian. <strong>RAM Size: 512 MB</strong>.</p><p>Stop the VM, change the memory in VBox to <code>512</code> and restart. We can also edit
the <code>vbox</code> XML file:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>    
</span></span><span style=display:flex><span>FROM: <span style=color:#268bd2>&lt;Memory</span> RAMSize=<span style=color:#2aa198>&#34;1024&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>TO  : <span style=color:#268bd2>&lt;Memory</span> RAMSize=<span style=color:#2aa198>&#34;512&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span></code></pre></div><h3 id=vram-size-mismatch>"VRam" size mismatch
<a class=header-link href=#vram-size-mismatch><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Next error is very clear. We need to change the video RAM size.</p><pre tabindex=0><code>pgm#1: MMIO2 region &#34;VRam&#34; size mismatch:
saved=0000000001400000 config=0000000001000000
[ver=14 pass=final] (VERR_SSM_LOAD_CONFIG_MISMATCH).

Result Code: 
E_FAIL (0x80004005)
Component: 
ConsoleWrap
Interface: 
IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><p>The error message is really helpful this time. Unlike RAM, VRAM is in bytes (not MBs):</p><ul><li>saved: <code>1400000</code> == <code>20MB</code></li><li>config: <code>1000000</code> == <code>16MB</code></li></ul><p>Modify the XML (close the GUI first because it overwrites the vbox file every
time you close it) or use the GUI:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>    
</span></span><span style=display:flex><span>FROM: <span style=color:#268bd2>&lt;Display</span> VRAMSize=<span style=color:#2aa198>&#34;16&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>TO  : <span style=color:#268bd2>&lt;Display</span> VRAMSize=<span style=color:#2aa198>&#34;20&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>    
</span></span></code></pre></div><h3 id=missing-device-on-port-0>Missing Device on Port 0
<a class=header-link href=#missing-device-on-port-0><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Now this one is pretty interesting and had me baffled for a while.</p><pre tabindex=0><code>ahci#0: The target VM is missing a device on port 0.
Please make sure the source and target VMs have compatible storage configurations
[ver=8 pass=final] (VERR_SSM_LOAD_CONFIG_MISMATCH).

Result Code: 
E_FAIL (0x80004005)
Component: 
ConsoleWrap
Interface: 
IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><p>Looking at the configuration, we can see our hard disk on port 0:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;StorageController</span> name=<span style=color:#2aa198>&#34;IDE&#34;</span> type=<span style=color:#2aa198>&#34;PIIX4&#34;</span> PortCount=<span style=color:#2aa198>&#34;2&#34;</span> useHostIOCache=<span style=color:#2aa198>&#34;true&#34;</span>
</span></span><span style=display:flex><span>                   Bootable=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;AttachedDevice</span> type=<span style=color:#2aa198>&#34;HardDisk&#34;</span> hotpluggable=<span style=color:#2aa198>&#34;false&#34;</span> port=<span style=color:#2aa198>&#34;0&#34;</span> device=<span style=color:#2aa198>&#34;0&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;Image</span> uuid=<span style=color:#2aa198>&#34;{cde4de0a-2d80-4c57-85e5-e1813c7d2c68}&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;/AttachedDevice&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;AttachedDevice</span> passthrough=<span style=color:#2aa198>&#34;false&#34;</span> type=<span style=color:#2aa198>&#34;DVD&#34;</span> hotpluggable=<span style=color:#2aa198>&#34;false&#34;</span> port=<span style=color:#2aa198>&#34;1&#34;</span> device=<span style=color:#2aa198>&#34;0&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/StorageController&gt;</span>
</span></span></code></pre></div><p>If you do not have the VDI on the IDE port, you might get a different error.</p><p>Why are we getting this error? There's a device on port 0 (the hard disk).
Searching the internet and VBox forums are less than helpful. Almost all answers
are "delete the saved state and restart the VM." This is not what we need.</p><p>Let's remove the VDI and attach it as an SATA device. To do this, we must remove
the state, do the configuration in the GUI and then re-do the saved state
(adding <code>stateFile=...</code> and copying the sav file again). I did this because I
did not know (or be bothered to find out) what to change in the vbox file.</p><p>Now the config file looks like:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;StorageController</span> name=<span style=color:#2aa198>&#34;IDE&#34;</span> type=<span style=color:#2aa198>&#34;PIIX4&#34;</span> PortCount=<span style=color:#2aa198>&#34;2&#34;</span> useHostIOCache=<span style=color:#2aa198>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    Bootable=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;StorageController</span> name=<span style=color:#2aa198>&#34;SATA&#34;</span> type=<span style=color:#2aa198>&#34;AHCI&#34;</span> PortCount=<span style=color:#2aa198>&#34;1&#34;</span>
</span></span><span style=display:flex><span>    useHostIOCache=<span style=color:#2aa198>&#34;false&#34;</span> Bootable=<span style=color:#2aa198>&#34;true&#34;</span> IDE0MasterEmulationPort=<span style=color:#2aa198>&#34;0&#34;</span>
</span></span><span style=display:flex><span>    IDE0SlaveEmulationPort=<span style=color:#2aa198>&#34;1&#34;</span> IDE1MasterEmulationPort=<span style=color:#2aa198>&#34;2&#34;</span>
</span></span><span style=display:flex><span>    IDE1SlaveEmulationPort=<span style=color:#2aa198>&#34;3&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;AttachedDevice</span> type=<span style=color:#2aa198>&#34;HardDisk&#34;</span> hotpluggable=<span style=color:#2aa198>&#34;false&#34;</span> port=<span style=color:#2aa198>&#34;0&#34;</span> device=<span style=color:#2aa198>&#34;0&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#268bd2>&lt;Image</span> uuid=<span style=color:#2aa198>&#34;{cde4de0a-2d80-4c57-85e5-e1813c7d2c68}&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;/AttachedDevice&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/StorageController&gt;</span>
</span></span></code></pre></div><p>We have one empty CD-drive on IDE primary master and the VDI as a(n) SATA device.</p><span class=caption-wrapper><img class=caption src=/images/2018/vbox1/06-drives1.png title="Drives after modification" alt="Drives after modification">
<span class=caption-text>Drives after modification</span></span><h3 id=secondary-master-device>Secondary Master Device
<a class=header-link href=#secondary-master-device><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Now we need a secondary master device.</p><pre tabindex=0><code>piix3ide#0: The target VM is missing a secondary master device.
Please make sure the source and target VMs have compatible storage
configurations [ver=20 pass=final] (VERR_SSM_LOAD_CONFIG_MISMATCH).

Result Code: 
E_FAIL (0x80004005)
Component: 
ConsoleWrap
Interface: 
IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><p>You know the drill. Add an empty secondary master IDE and re-try. Be sure to
choose secondary master.</p><span class=caption-wrapper><img class=caption src=/images/2018/vbox1/07-drives2.png title="Adding secondary master" alt="Adding secondary master">
<span class=caption-text>Adding secondary master</span></span><h3 id=great-success>Great Success
<a class=header-link href=#great-success><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Annnnnnnd we're in.</p><span class=caption-wrapper><img class=caption src=/images/2018/vbox1/08-loggedin.png title=Logged-in alt=Logged-in>
<span class=caption-text>Logged-in</span></span><h2 id=bonus-errors>Bonus Errors
<a class=header-link href=#bonus-errors><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>During the challenge I encountered a couple of more errors. I am documenting
them here for future reference.</p><h3 id=bonus-error-1---fioapicpresent-savedtrue-configfalse>Bonus Error #1 - fIoApicPresent: saved=true config=false
<a class=header-link href=#bonus-error-1---fioapicpresent-savedtrue-configfalse><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>This is for <code>I/O APIC mode</code> in <code>System</code>.</p><pre tabindex=0><code>Failed to open a session for the virtual machine MysteryVM.

apic#0: Config mismatch - fIoApicPresent: saved=true
config=false [ver=3 pass=final] (VERR_SSM_LOAD_CONFIG_MISMATCH).

Result Code: E_FAIL (0x80004005)
Component: ConsoleWrap
Interface: IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><p>Either use the GUI or modify the config file and enable it:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;BIOS&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;IOAPIC</span> enabled=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/BIOS&gt;</span>
</span></span></code></pre></div><h3 id=bonus-error-2---uapicmode-saved2-config3>Bonus Error #2 - uApicMode: saved=2 config=3
<a class=header-link href=#bonus-error-2---uapicmode-saved2-config3><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>This one is more interesting:</p><pre tabindex=0><code>Failed to open a session for the virtual machine MysteryVM.

apic#0: Config mismatch - uApicMode: saved=2 config=3
[ver=3 pass=final] (VERR_SSM_LOAD_CONFIG_MISMATCH).

Result Code: E_FAIL (0x80004005)
Component: ConsoleWrap
Interface: IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><p>Change this to false:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;CPU&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;X2APIC</span> enabled=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/CPU&gt;</span>
</span></span></code></pre></div><p>Detailed discussion follows.</p><h4 id=uapicmode>uApicMode
<a class=header-link href=#uapicmode><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>Searching for <code>uApicMode</code> returns only a few results. Both of the errors that we
have seen come from this file:</p><ul><li><a href=https://www.virtualbox.org/svn/vbox/trunk/src/VBox/VMM/VMMR3/APIC.cpp target=_blank rel="noreferrer noopener">https://www.virtualbox.org/svn/vbox/trunk/src/VBox/VMM/VMMR3/APIC.cpp</a></li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>static</span> <span style=color:#dc322f>int</span> <span style=color:#268bd2>apicR3LoadVMData</span>(PVM pVM, PSSMHANDLE pSSM)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    PAPIC pApic <span style=color:#719e07>=</span> VM_TO_APIC(pVM);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>/* Load and verify number of CPUs. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span> cCpus;
</span></span><span style=display:flex><span>    <span style=color:#dc322f>int</span> rc <span style=color:#719e07>=</span> SSMR3GetU32(pSSM, <span style=color:#719e07>&amp;</span>cCpus);
</span></span><span style=display:flex><span>    AssertRCReturn(rc, rc);
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (cCpus <span style=color:#719e07>!=</span> pVM<span style=color:#719e07>-&gt;</span>cCpus)
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span> SSMR3SetCfgError(pSSM, RT_SRC_POS,
</span></span><span style=display:flex><span>            N_(<span style=color:#2aa198>&#34;Config mismatch - cCpus: saved=%u config=%u&#34;</span>),
</span></span><span style=display:flex><span>            cCpus, pVM<span style=color:#719e07>-&gt;</span>cCpus);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>/* Load and verify I/O APIC presence. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>bool</span> fIoApicPresent;
</span></span><span style=display:flex><span>    rc <span style=color:#719e07>=</span> SSMR3GetBool(pSSM, <span style=color:#719e07>&amp;</span>fIoApicPresent);
</span></span><span style=display:flex><span>    AssertRCReturn(rc, rc);
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (fIoApicPresent <span style=color:#719e07>!=</span> pApic<span style=color:#719e07>-&gt;</span>fIoApicPresent)
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span> SSMR3SetCfgError(pSSM, RT_SRC_POS, 
</span></span><span style=display:flex><span>            N_(<span style=color:#2aa198>&#34;Config mismatch - fIoApicPresent: saved=%RTbool config=%RTbool&#34;</span>),
</span></span><span style=display:flex><span>            fIoApicPresent, pApic<span style=color:#719e07>-&gt;</span>fIoApicPresent);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>/* Load and verify configured max APIC mode. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span> uSavedMaxApicMode;
</span></span><span style=display:flex><span>    rc <span style=color:#719e07>=</span> SSMR3GetU32(pSSM, <span style=color:#719e07>&amp;</span>uSavedMaxApicMode);
</span></span><span style=display:flex><span>    AssertRCReturn(rc, rc);
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (uSavedMaxApicMode <span style=color:#719e07>!=</span> (<span style=color:#dc322f>uint32_t</span>)pApic<span style=color:#719e07>-&gt;</span>enmMaxMode)
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span> SSMR3SetCfgError(pSSM, RT_SRC_POS,
</span></span><span style=display:flex><span>               N_(<span style=color:#2aa198>&#34;Config mismatch - uApicMode: saved=%u config=%u&#34;</span>),
</span></span><span style=display:flex><span>               uSavedMaxApicMode, pApic<span style=color:#719e07>-&gt;</span>enmMaxMode);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> VINF_SUCCESS;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We are getting an error when comparing the <code>max APIC mode</code>. Ours is 3, config is
2. But what is this?</p><p>Searching for <code>max apic</code> sends us to a <a href=https://www.reddit.com/r/linux/comments/6jepx3/intel_skylakekaby_lake_processors_broken target=_blank rel="noreferrer noopener">reddit thread</a>:</p><blockquote><p>Max APIC IDs reserved field is Valid. A value of 0 for HTT indicates there is
only a single logical processor in the package and software should assume only
a single APIC ID is reserved. A value of 1 for HTT indicates the value in
CPUID.1.EBX[23:16]_(the Maximum number of addressable IDs for logical
processors in this package) is valid for the package.</p></blockquote><p>But does it have anything to do what we want? How do we change it? What do we
need to change in our CPU config?</p><p>Inside <a href=https://www.virtualbox.org/svn/vbox/trunk/src/VBox/VMM/include/APICInternal.h target=_blank rel="noreferrer noopener">/VMM/include/APICInternal.h</a>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#586e75>/** The max supported APIC mode from CFGM.  */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE                 enmMaxMode;
</span></span></code></pre></div><p>And later in <a href=https://www.virtualbox.org/svn/vbox/trunk/include/VBox/vmm/pdmdev.h target=_blank rel="noreferrer noopener">VBox/vmm/pdmdev.h</a>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>typedef</span> <span style=color:#719e07>enum</span> <span style=color:#268bd2>PDMAPICMODE</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Invalid 0 entry. */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE_INVALID <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** No APIC. */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE_NONE,
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Standard APIC (X86_CPUID_FEATURE_EDX_APIC). */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE_APIC,
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Intel X2APIC (X86_CPUID_FEATURE_ECX_X2APIC). */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE_X2APIC,
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The usual 32-bit paranoia. */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE_32BIT_HACK <span style=color:#719e07>=</span> <span style=color:#2aa198>0x7fffffff</span>
</span></span><span style=display:flex><span>} PDMAPICMODE;
</span></span></code></pre></div><p>This seems to be it. We have <code>X2APIC</code> (3) enabled but want <code>APIC</code> (2). First
enum is <code>0</code> and next is <code>1</code> and so on. <code>iota</code> in Go is a copycat.</p><p>Inside the config file we have this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;CPU&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;PAE</span> enabled=<span style=color:#2aa198>&#34;false&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;LongMode</span> enabled=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;X2APIC</span> enabled=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;HardwareVirtExLargePages</span> enabled=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/CPU&gt;</span>
</span></span></code></pre></div><p>We are going to change it to <code>false</code> and then try again.</p><h4 id=different-enum>Different Enum
<a class=header-link href=#different-enum><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>On a side-note, this threw me off. Inside <a href=https://www.virtualbox.org/svn/vbox/trunk/src/VBox/Devices/PC/BIOS/post.c target=_blank rel="noreferrer noopener">/VBox/Devices/PC/BIOS/post.c</a>
there's a different enum:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>#define APICMODE_DISABLED   0
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define APICMODE_APIC       1
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define APICMODE_X2APIC     2
</span></span></span></code></pre></div><p>This is off by one compared to what we got in the error message (X2APIC is 3
there but 2 here).</p><h1 id=where-do-we-go-from-here>Where do We Go From Here?
<a class=header-link href=#where-do-we-go-from-here><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Now that we are inside, we can finally see inside the <code>password.txt</code> file which
is the password for both the <code>debian/root</code> accounts and also the disk password
(yes I know it's a bad password and also password re-use is bad).</p><p>Another thing to always check is the clipboard, in this case I have not
installed a desktop environment so it's useless but be sure to always check.</p><p>A lot of forensics CTF challenges focus on grabbing keys/credentials in memory.
Mounted luks or truecrypt containers are popular.</p><h1 id=conclusion-and-future-work>Conclusion and Future Work
<a class=header-link href=#conclusion-and-future-work><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>We did a practical exercise and <del>for the first time in world history</del> mounted
a live VBox state. This allowed us to bypass the disk encryption/user password
and login directly.</p><p>I have already done some analysis of the <code>sav</code> file. I will do a bit more and
then publish it. That's another world first, so stay tuned for that.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>As an exercise, compress both the plaintext and encrypted version of the
same file. Compare the file sizes. Which one is smaller and why? In other words,
if file size (and not security) is our end goal, should we <code>compress then encrypt</code>
or <code>encrypt then compress</code>?&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Parsia</span></span>
<time>Jan 23, 2018</time>
<span class=categories>Tags:
<a class=category href=https://parsiya.net/tags/virtualbox>VirtualBox</a></span></p><p class=meta><a class="basic-alignment left" href=https://parsiya.net/blog/2018-01-19-decoding-large-base64-files-with-go/ title="Decoding Large Base64 Files with Go">Decoding Large Base64 Files with Go</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2018-01-29-virtualbox-live-state-file-format/ title="VirtualBox Live State File Format">VirtualBox Live State File Format</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//parsiya.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I?</h1><p><p>I am Parsia, a senior security engineer at <a href=https://www.ea.com/security target=_blank rel="noreferrer noopener">Electronic Arts</a>.</p><p>I write about application security, reverse engineering,
Go, cryptography, and (obviously) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more.</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://keybase.io/parsiya/ title=https://keybase.io/parsiya/><i class="fa fa-keybase fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><h1>Collections</h1><li><a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a></li><li><a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a></li><li><a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a></li><li><a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a></li><li><a href=https://parsiya.net/categories/go/ title=Go/Golang>Go/Golang</a></li><li><a href=https://parsiya.net/categories/blockchain/ title=Blockchain>Blockchain</a></li><li><a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a></li><li><a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a></li><li><a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a></li><li><a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a></li><li><a href=https://parsiya.net/categories/winappdbg/ title=WinAppDbg>WinAppDbg</a></li><li><a href=https://awsome.pw title="AWSome.pw - S3 bucket squatting - my very legit branded vulnerability">AWSome.pw - S3 bucket squatting - my very legit branded vulnerability</a></li></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2022 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>