<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1">
<link href=/css/fonts.css rel=stylesheet type=text/css>
<title>Silly Attack Using Run Line</title>
<link rel=stylesheet href=/css/hugo-octopress.css>
<link rel=stylesheet href=/css/fork-awesome.min.css>
<link href=https://parsiya.net/favicon.png rel=icon>
<meta name=description content>
<meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]">
<meta name=author content="Parsia">
<meta name=generator content="Hugo 0.92.1">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Silly Attack Using Run Line">
<meta name=twitter:description content="Previously we saw how Windows Run Line searches in App Paths registry keys before PATH. We can perform a silly attack and create a registry key for an application in path and point it to another command.
This is a silly attack because we need to be admin to create/edit those keys. But if you ever find yourself in the unlikely situation, you can use this to become delayed admin (i.e. wait for admin to run the app via Run Line).">
<meta name=twitter:domain content="parsiya.net">
<meta name=twitter:creator content="@CryptoGangsta">
</head>
<body>
<header role=banner>
<hgroup>
<h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1>
<h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2>
</hgroup></header>
<nav role=navigation>
<fieldset class=mobile-nav>
<select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select>
</fieldset>
<ul class=main-navigation>
<li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li>
<li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li>
<li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li>
<li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li>
<li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li>
<li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li>
</ul>
<ul class=subscription>
<a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
</ul>
<form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer">
<fieldset role=search>
<input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/>
</fieldset>
</form>
</nav>
<div id=main>
<div id=content>
<div>
<article class=hentry role=article>
<header>
<p class=meta>Oct 26, 2017
- 2 minute read
- <a href=https://parsiya.net/blog/2017-10-26-silly-attack-using-run-line/#disqus_thread>Comments</a>
- <a class=label href=https://parsiya.net/categories/windows/>Windows </a>
</p>
<h1 class=entry-title>
Silly Attack Using Run Line
</h1>
</header>
<div class=entry-content>
<p><a href=https://parsiya.net/blog/2017-10-23-run-line-vs.-cmd-vs.-powershell/ title="Run Line vs. cmd vs. PowerShell">Previously</a> we saw how Windows Run Line searches in <code>App Paths</code> registry keys before PATH. We can perform a silly attack and create a registry key for an application in path and point it to another command.</p>
<p>This is a silly attack because we need to be admin to create/edit those keys. But if you ever find yourself in the unlikely situation, you can use this to become delayed admin (i.e. wait for admin to run the app via Run Line).</p>
<p>This also serves as a <del>tutorial</del> note for using PowerShell to list/manipulate registry.</p>
<p>Let"s pick <code>notepad</code> which is in PATH and point it to <code>calc</code>. Open an admin PowerShell prompt.</p>
<p>First check if key exists (note we have tab auto-complete inside registry):</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#586e75># notepad does not have an entry</span>
$ <span style=color:#b58900>Test-Path</span> <span style=color:#2aa198>&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\notepad.exe&#34;</span>
False
<span style=color:#586e75># chrome does</span>
$ <span style=color:#b58900>Test-Path</span> <span style=color:#2aa198>&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\chrome.exe&#34;</span>
True
</code></pre></div><p>Now create the key and set the default property:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>$ <span style=color:#b58900>New-Item</span> -Path <span style=color:#2aa198>&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths&#34;</span>
        -Name notepad.exe -Value <span style=color:#2aa198>&#34;C:\Windows\System32\calc.exe&#34;</span>

    Hive: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths

SKC  VC Name                           Property
---  -- ----                           --------
  0   1 notepad.exe                    {(<span style=color:#719e07>default</span>)}

</code></pre></div><p>We could have set the default value later using <code>Set-Item</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>$ <span style=color:#b58900>Set-Item</span> -Path <span style=color:#2aa198>&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\notepad.exe&#34;</span>
           -Value <span style=color:#2aa198>&#34;C:\Windows\System32\calc.exe&#34;</span>
</code></pre></div><p>To create new properties use <code>New-ItemProperty</code>. For example the property <code>Path</code> contains the working directory:</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>$ <span style=color:#b58900>New-ItemProperty</span> -Path <span style=color:#2aa198>&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\notepad.exe&#34;</span> 
                   -Name Path -Value <span style=color:#2aa198>&#34;C:\Windows\System32\&#34;</span>

PSPath       : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft
               \Windows\CurrentVersion\App Paths\notepad.exe
PSParentPath : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft
               \Windows\CurrentVersion\App Paths
PSChildName  : notepad.exe
PSDrive      : HKLM
PSProvider   : Microsoft.PowerShell.Core\Registry
Path         : C:\Windows\System32\
</code></pre></div><p><code>ls/gci/Get-ChildItem</code> do not list the properties, only registry keys.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>$ <span style=color:#b58900>ls </span>-path <span style=color:#2aa198>&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\&#34;</span>
    Hive: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths

SKC  VC Name                           Property
---  -- ----                           --------
  0   2 chrome.exe                     {(<span style=color:#719e07>default</span>), Path}
  0   2 notepad.exe                    {(<span style=color:#719e07>default</span>), Path}

$ <span style=color:#b58900>ls </span>-path <span style=color:#2aa198>&#34;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\notepad.exe&#34;</span>
</code></pre></div><p>We need to get each property one by one (or use a PS script to run <code>$Key.GetValueNames()</code> and iterate over them).</p>
<p>Now open up Run Line and enter <code>notepad</code> to see <code>calc</code> pop up.</p>
<p>Silly attack because only admins can edit those registry keys.</p>
</div>
<footer>
<p class=meta>
<span class="byline author vcard">Posted by <span class=fn>Parsia</span></span>
<time>Oct 26, 2017</time>
<span class=categories>
Tags:
<a class=category href=https://parsiya.net/tags/run-line>Run Line</a>
</span>
</p>
<p class=meta>
<a class="basic-alignment left" href=https://parsiya.net/blog/2017-10-23-run-line-vs.-cmd-vs.-powershell/ title="Run Line vs. cmd vs. PowerShell">Run Line vs. cmd vs. PowerShell</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2017-11-09-winappdbg-part-1-basics/ title="WinAppDbg - Part 1 - Basics">WinAppDbg - Part 1 - Basics</a>
</p>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//parsiya.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</footer>
</article>
</div>
<aside class="sidebar thirds">
<section class="first odd">
<h1>Who am I?</h1>
<p>
<p>I am Parsia, a senior security engineer at <a href=https://www.ea.com/security>Electronic Arts</a>.</p>
<p>I write about application security, reverse engineering,
Go, cryptography, and (obviously) videogames.</p>
<p>Click on <a href=/about/>About Me!</a> to know more.</p>
</p>
</section>
<ul class=sidebar-nav>
<li class=sidebar-nav-item>
<a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://keybase.io/parsiya/ title=https://keybase.io/parsiya/><i class="fa fa-keybase fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a>
</li>
</ul>
<section class=odd>
<h1>Collections</h1>
<li>
<a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a>
</li>
<li>
<a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a>
</li>
<li>
<a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a>
</li>
<li>
<a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a>
</li>
<li>
<a href=https://parsiya.net/categories/go/ title=Go/Golang>Go/Golang</a>
</li>
<li>
<a href=https://parsiya.net/categories/blockchain/ title=Blockchain>Blockchain</a>
</li>
<li>
<a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a>
</li>
<li>
<a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a>
</li>
<li>
<a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a>
</li>
<li>
<a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a>
</li>
<li>
<a href=https://parsiya.net/categories/winappdbg/ title=WinAppDbg>WinAppDbg</a>
</li>
<li>
<a href=https://awsome.pw title="AWSome.pw - S3 bucket squatting - my very legit branded vulnerability">AWSome.pw - S3 bucket squatting - my very legit branded vulnerability</a>
</li>
</section>
</aside>
</div>
</div>
<footer role=contentinfo>
<p>Copyright &copy; 2022 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.
</p>
</footer>
</body>
</html>