<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Old ContextIS Challenge Solutions</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.net/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia"><meta name=generator content="Hugo 0.110.0"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content="https://parsiya.net/blog/2020-02-09-old-contextis-challenge-solutions/forensics102-clipboard.png"><meta name=twitter:title content="Old ContextIS Challenge Solutions"><meta name=twitter:description content="A few years ago I did the Context Information Security
challenges. They used it for recruiting so I never published the results.
However, they have now switched to Hack The Box and the old
challenges are gone. So I am publishing what I did.
You can see the page with the old challenges using the Wayback Machine at:

http://web.archive.org/web/20181012035146/https://www.contextis.com/en/careers/challenges

I also did some of their xmas 2018 challenges."><meta name=twitter:domain content="parsiya.net"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select></fieldset><ul class=main-navigation><li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription><a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Feb 9, 2020
- 22 minute read
- <a href=https://parsiya.net/blog/2020-02-09-old-contextis-challenge-solutions/#disqus_thread>Comments</a>
- <a class=label href=https://parsiya.net/categories/writeup/>Writeup </a><a class=label href=https://parsiya.net/categories/reverse-engineering/>Reverse Engineering </a><a class=label href=https://parsiya.net/categories/crypto/>Crypto</a></p><h1 class=entry-title>Old ContextIS Challenge Solutions</h1></header><div class=entry-content><nav id=TableOfContents><ul><li><a href=#crypto>Crypto</a><ul><li><a href=#crypto1>Crypto1</a></li><li><a href=#crypto2>Crypto2</a></li></ul></li><li><a href=#binary-security>Binary Security</a><ul><li><a href=#secret-recipe>Secret Recipe</a></li></ul></li><li><a href=#forensics-101>Forensics 101</a></li><li><a href=#forensics-102>Forensics 102</a><ul><li><a href=#tldr>TL;DR</a></li><li><a href=#here-we-go>Here we go</a><ul><li><a href=#cracking-the-hash>Cracking the hash?</a></li><li><a href=#how-do-i-trick-virtualbox-into-restoring-our-saved-state>How do I trick VirtualBox into restoring our saved state?</a><ul><li><a href=#uapicmode>uApicMode</a></li><li><a href=#apic-io>APIC I/O?</a></li></ul></li><li><a href=#back-to-uapicmode>Back to uApicMode</a><ul><li><a href=#different-enum>Different Enum</a></li><li><a href=#video-memory-size-error>Video Memory Size Error</a></li><li><a href=#primary-master-device-error>Primary Master Device Error</a></li></ul></li><li><a href=#whats-in-the-box>WHAT's IN THE BOX?</a></li><li><a href=#inside-the-swap-file>Inside the Swap File</a></li></ul></li><li><a href=#clipboard>Clipboard</a></li><li><a href=#dive-into-sav>Dive into sav</a><ul><li><a href=#ssm-file-header--ssmfilhdr>SSM File Header * SSMFILHDR</a><ul><li><a href=#flags>Flags</a></li></ul></li><li><a href=#saved-state-units>Saved State Units</a><ul><li><a href=#unit-header--ssmfileunithdrv2>Unit Header * SSMFILEUNITHDRV2</a></li><li><a href=#unit-data>Unit Data</a></li></ul></li><li><a href=#file-footer--ssmfileftr>File Footer * SSMFILEFTR</a></li></ul></li></ul></li></ul></nav><p>A few years ago I did the <a href=https://www.contextis.com/en/ target=_blank rel="noreferrer noopener">Context Information Security</a>
challenges. They used it for recruiting so I never published the results.
However, they have now switched to <a href=https://www.hackthebox.eu/ target=_blank rel="noreferrer noopener">Hack The Box</a> and the old
challenges are gone. So I am publishing what I did.</p><p>You can see the page with the old challenges using the Wayback Machine at:</p><ul><li><a href=http://web.archive.org/web/20181012035146/https://www.contextis.com/en/careers/challenges target=_blank rel="noreferrer noopener">http://web.archive.org/web/20181012035146/https://www.contextis.com/en/careers/challenges</a></li></ul><p>I also did some of their <a href=/blog/2018-06-05-contextis-xmas-ctf-writeup/ title="xmas 2018 challenges">xmas 2018 challenges</a>.</p><h1 id=crypto>Crypto
<a class=header-link href=#crypto><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><h2 id=crypto1>Crypto1
<a class=header-link href=#crypto1><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Caesar's cipher. ROT19.</p><ol><li>Paste in CyberChef.</li><li>Add <code>ROT13</code>.</li><li>Change <code>amount</code> until you get it right.</li></ol><pre tabindex=0><code>Hence! home, YoU idle creaTUres geT YoU home:
Is This a holidaY? WhaT! knoW YoU noT,
Being mechanical, YoU oUghT noT Walk
upon a laboUring daY WiThoUT The sign
Of YoUr profession? Speak, WhaT Trade arT ThoU?
* Shakespear
</code></pre><p><strong>Flag</strong>:
<code>CONtExtIS{mlrUcniUc9dlZhl9dr4c8qifh0Z3nj0VUqTYW0so,TalenT@cTX.is}</code></p><h2 id=crypto2>Crypto2
<a class=header-link href=#crypto2><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>It's repeated key XOR. We can already break it using our code from Cryptopals or
drop it in any cipher solver.</p><p>Key is: <code>akeycanopenalockeddoor</code></p><p><strong>Flag</strong>:
<code>cONTeXtiS{oTuaHUtgVI4yMRGkD24p1C1zmCnnBtUmM3Bkjzy2,CAReErs@coNteXtis.Com}(MAyBE Its CAse SenSITIVE?)</code></p><h1 id=binary-security>Binary Security
<a class=header-link href=#binary-security><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><h2 id=secret-recipe>Secret Recipe
<a class=header-link href=#secret-recipe><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>File is base64 encoded. There's a bootleg way of base64 encoding/decoding files
on Windows without PowerShell using "certutil":</p><pre tabindex=0><code>certutil -decode reversing-chal01.base64 decoded-chal01.exe
certutil -encode whatever.exe whatever.base64
</code></pre><p>After looking at the strings inside the file, it looks like a Python program
converted to standalone exe. Looking at the strings we can see
<code>.opyi-windows-manifest-filename binary-ctf.exe</code>.</p><p>Searching for <code>opyi-windows-manifest-filename</code> we get to these three posts by
Didier Stevens.</p><ul><li><a href=https://isc.sans.edu/forums/diary/Python+Malware+Part+1/21057/ target=_blank rel="noreferrer noopener">https://isc.sans.edu/forums/diary/Python+Malware+Part+1/21057/</a></li><li><a href=https://isc.sans.edu/forums/diary/Python+Malware+Part+2/21085/ target=_blank rel="noreferrer noopener">https://isc.sans.edu/forums/diary/Python+Malware+Part+2/21085/</a></li><li><a href=https://isc.sans.edu/forums/diary/Python+Malware+Part+3/21265/ target=_blank rel="noreferrer noopener">https://isc.sans.edu/forums/diary/Python+Malware+Part+3/21265/</a></li></ul><p>Seems like <code>pyinstaller</code> was used to create an executable.
<code>pyinstallerextractor</code> to the rescue:</p><ul><li><a href=https://sourceforge.net/projects/pyinstallerextractor/ target=_blank rel="noreferrer noopener">https://sourceforge.net/projects/pyinstallerextractor/</a></li></ul><p>There are tons of files extracted. But we already know what we are looking for
<code>binary-ctf</code>. Inside that file again there are tons of things but we do not care
about them. There's a comment</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#586e75>#keyy = &#34;Brandy+Frigeo Ahoj Sherbet+Pizza Hawaii&#34;</span>
</span></span><span style=display:flex><span><span style=color:#586e75>##echo -n &#34;\n\n\n\n\n5\n11\n13\n\n&#34; | python binary-ctf.py</span>
</span></span></code></pre></div><p>Seems like it's decrypting a file using 3DES.
Choosing these will show (and also create a file with the same text):</p><pre tabindex=0><code>whooohoo you found the flag.!! Great. Congratulations Flag: &#34;K3epOnMoving&#34;
Jazek: mhhh it tast like... Brandy with Frigeo Ahoj Sherbet and Pizza Hawaii
It&#39;s awful ..., but it reminds me on the good old time. (military secret).
</code></pre><p>At the end of `` there's this call:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>testfunc(f,s,t,r,<span style=color:#2aa198>&#34;This is the Real Flag ;-)</span>
</span></span><span style=display:flex><span>    :<span style=color:#2aa198>&#34;+flag, important+&#34;</span> are you <span style=color:#719e07>from</span> the<span style=color:#2aa198>&#34; +flagg + &#34;</span><span style=color:#719e07>.</span> Hello<span style=color:#719e07>.</span> Hello<span style=color:#719e07>.</span> McFly, Anybody home?<span style=color:#2aa198>&#34;)</span>
</span></span></code></pre></div><p>The string is (<code>Welcme</code> is misspelled on purpose):</p><pre tabindex=0><code>This is the Real Flag ;-)  :Idon&#39;tKHOwToFuzz,
    Fl4g:WelcmeToC0ntext are you from the past?. Hello. Hello. McFly, Anybody home?
</code></pre><h1 id=forensics-101>Forensics 101
<a class=header-link href=#forensics-101><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Decompress the file and you get a *nix (if I may interject!) file (note the
<code>0x0A</code> for new line instead of <code>0x0D 0x0A</code> on Windows). Each line has two chars
and the chars look like they are base64 encoded.</p><p>The file could be garbage but have some actual text inside. I grep-ed for <code>flag</code>
and <code>contextis</code> and could not find it.</p><p>Because I am obsessed with Go, I wrote a Go program to read the file, pass it to
a base64 stream decoder and then write the output to file.</p><p>Result is a 7z file, after extraction we get a QED file.</p><p>Specification here: <a href=https://wiki.qemu.org/Features/QED/Specification target=_blank rel="noreferrer noopener">https://wiki.qemu.org/Features/QED/Specification</a>.</p><p>We can convert and use it in Hyper-V or VirtualBox with:</p><ul><li>Hyper-V: <code>qemu-img.exe convert -f qed -O vpc 0.qed 0.vpc</code></li><li>VirtualBox: <code>qemu-img.exe convert -f qed -O vdi 0.qed 0.vdi</code></li></ul><p>We can also mount it normally in VirtualBox. Long story short, flag is in a file called
<code>Untitled.dib</code> inside <code>root</code>.</p><span class=caption-wrapper><img class=caption src=forensics101.jpg title="Forensics 101 challenge" alt="Forensics 101 challenge">
<span class=caption-text>Forensics 101 challenge</span></span><p><strong>Flag: CfxXM2mhqPeHsIjpKTV</strong></p><p>Go code for forensics 101.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#719e07>package</span> main
</span></span><span style=display:flex><span><span style=color:#719e07>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#2aa198>&#34;encoding/base64&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#2aa198>&#34;flag&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#2aa198>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#2aa198>&#34;io&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#2aa198>&#34;os&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#268bd2>func</span> <span style=color:#268bd2>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// This creates a flag parameter. Meaning we can call -file or --file.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#268bd2>var</span> filename <span style=color:#dc322f>string</span>
</span></span><span style=display:flex><span>    flag.<span style=color:#268bd2>StringVar</span>(<span style=color:#719e07>&amp;</span>filename, <span style=color:#2aa198>&#34;file&#34;</span>, <span style=color:#2aa198>&#34;&#34;</span>, <span style=color:#2aa198>&#34;input file&#34;</span>)
</span></span><span style=display:flex><span>    flag.<span style=color:#268bd2>Parse</span>()
</span></span><span style=display:flex><span>    fmt.<span style=color:#268bd2>Println</span>(<span style=color:#2aa198>&#34;reading input file, this may take a while&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Open file.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    i, err <span style=color:#719e07>:=</span> os.<span style=color:#268bd2>Open</span>(filename)
</span></span><span style=display:flex><span>    <span style=color:#586e75>// We are panic-ing with every error because we want to stop if things
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// go wrong.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>if</span> err <span style=color:#719e07>!=</span> <span style=color:#cb4b16>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#b58900>panic</span>(err)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Close input file
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>defer</span> i.<span style=color:#268bd2>Close</span>()
</span></span><span style=display:flex><span>    o, err <span style=color:#719e07>:=</span> os.<span style=color:#268bd2>Create</span>(filename <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;-out.txt&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> err <span style=color:#719e07>!=</span> <span style=color:#cb4b16>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#b58900>panic</span>(err)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Close output file
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#719e07>defer</span> o.<span style=color:#268bd2>Close</span>()
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Create base64 stream decoder from input file. *io.File implements the
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// io.Reader interface. In other words we can pass it to NewDecoder.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    decoder <span style=color:#719e07>:=</span> base64.<span style=color:#268bd2>NewDecoder</span>(base64.StdEncoding, i)
</span></span><span style=display:flex><span>    io.<span style=color:#268bd2>Copy</span>(o, decoder)
</span></span><span style=display:flex><span>    fmt.<span style=color:#268bd2>Println</span>(<span style=color:#2aa198>&#34;storing base64 decoder input file&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=forensics-102>Forensics 102
<a class=header-link href=#forensics-102><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>I never solved it but I learned a lot about VirtualBox save state files. I think
I broke new ground there because no one had done anything about that format
before. I wrote some hands-on blog posts about what I learned:</p><ul><li><a href=/blog/2018-01-23-mounting-live-snapshots-of-encrypted-vms-in-virtualbox/ title="Mounting Live Snapshots of Encrypted VMs in VirtualBox">Mounting Live Snapshots of Encrypted VMs in VirtualBox</a>.</li><li><a href=/blog/2018-01-29-virtualbox-live-state-file-format/ title="VirtualBox Live State File Format">VirtualBox Live State File Format</a>.</li></ul><h2 id=tldr>TL;DR
<a class=header-link href=#tldr><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><ul><li>VM credentials are <code>root/toor</code>.</li><li>I managed to find a way to mount the VM in VirtualBox with the live snapshot,
meaning I could just login. I did not see anything about it out there, so I
assume it's (at least publicly) a new thing.</li><li>VM has a file called <code>secret</code> which is a Luks container. Looking at the swap
file (and live snapshot) I retraced some of the commands used to create it
(some <code>token.txt</code> was used too).</li><li>The truecrypt files and <code>untitled.dib</code> are all encrypted (or just random).
<code>Untitled.dib</code> is 40960 bytes which is pretty curious.</li><li>On desktop (also in bash_history via <code>cat Desktop/secret.txt</code>) is a 4096 byte
file called <code>secret.txt</code> which seems to be key file but it's not. Could not
open neither the Luks container not any of the other "encrypted" files.</li><li>After logging in live, clipboard has a 33 char "password." Looks base64
encoded but has an invalid length for a base64 string (tl;dr: the way base64
formating works you can only have one or two or zero padding because one
encoded will be 1 and 1/3). Read more at:
<a href=https://parsiya.net/blog/2017-08-06-tldr-base64/ target=_blank rel="noreferrer noopener">https://parsiya.net/blog/2017-08-06-tldr-base64/</a></li></ul><h2 id=here-we-go>Here we go
<a class=header-link href=#here-we-go><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>This is 5 stars. Inside the file we have a Debian qed file and a snapshot.
Opening the snapshot in a hex editor reveals it's a VirtualBox SavedState V2.0.</p><p>While we can start the qed file as hard disk in VirtualBox, we do not have the
user/pass. And the backdoor GRUB (28 backspaces) does not work on this version.
We will attach this as a normal hard disk to another Debian distro and open it
like Forensics101.</p><p>So inside <code>root</code> are a bunch of encrypted files.</p><ul><li><code>/root/secret</code> is a 10 MB file. Running <code>file</code> on it returns:<ul><li><code>secret: LUKS encrypted file, ver 1 [aes, xts-plain, sha1] UUID: 770ac37d-60d1-437e-888b-9866bd525adf</code></li></ul></li><li><code>truecrypt-7.2-setup-console-x64</code>: Encrypted</li><li><code>Untitled.dib</code>: Encrypted</li><li><code>TrueCrypt-7.2-Linux-console-x64.tar.gz</code>: Encrypted</li><li><code>/Desktop/secret.txt</code>: Encrypted (but only <code>4096</code> bytes), perhaps the key?</li></ul><p>If I have to guess, key to the file is <code>/Desktop/secret</code>.</p><p>No keys in <code>/etc/crypttab</code>.</p><pre tabindex=0><code>$ sudo cryptsetup luksDump secret
LUKS header information for secret

Version:        1
Cipher name:    aes
Cipher mode:    xts-plain
Hash spec:      sha1
Payload offset: 4096
MK bits:        512
MK digest:      a8 2f 68 27 2a 25 3b 41 47 37 78 3a c4 80 85 46 55 90 d8 7f 
MK salt:        71 b1 d1 08 43 95 d0 6a a8 d9 13 69 42 b3 63 b9 
                d2 19 b4 0f 14 f2 e6 3a 73 ed 16 7d 63 75 08 98 
MK iterations:  121125
UUID:           770ac37d-60d1-437e-888b-9866bd525adf

Key Slot 0: ENABLED
    Iterations:             481202
    Salt:                   23 b3 c6 e6 be 13 99 cb e3 f5 42 e9 45 65 1c 27 
                            78 bc 20 b5 be 89 e6 c7 e7 3f 3c 36 03 c3 44 54 
    Key material offset:    8
    AF stripes:             4000
Key Slot 1: DISABLED
Key Slot 2: DISABLED
Key Slot 3: DISABLED
Key Slot 4: DISABLED
Key Slot 5: DISABLED
Key Slot 6: DISABLED
Key Slot 7: DISABLED
</code></pre><p>Seems like <code>secret.txt</code> is not the key file:</p><pre tabindex=0><code>$ sudo cryptsetup luksOpen secret tmpData --key-file /Desktop/secret.txt
No key available with this passphrase.
</code></pre><p>Maybe there's something in the sav file?</p><h3 id=cracking-the-hash>Cracking the hash?
<a class=header-link href=#cracking-the-hash><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Maybe we should crack the hash?</p><ul><li><code>ENCRYPT_METHOD SHA512</code> inside <code>etc/login.defs</code>.</li><li><code>$6$bpWNT25M$6/r.d4a4G/wQX3/eSbBiTQluVQpmPSmAKvk0r5kS/LY7HS88.StLG06.3gR2rKXGXYryAjosq49ZJAPro1Emo0:16940:0:99999:7:::</code></li></ul><p><strong>password is toor</strong> used hashcat and my GTX 1080 GPU took care of it.</p><pre tabindex=0><code>hashcat64.exe -m 1800 -O -w 3 -a 3 [...hash]
</code></pre><ul><li><a href="https://hashcat.net/wiki/doku.php?id=hashcat" target=_blank rel="noreferrer noopener">https://hashcat.net/wiki/doku.php?id=hashcat</a></li></ul><h3 id=how-do-i-trick-virtualbox-into-restoring-our-saved-state>How do I trick VirtualBox into restoring our saved state?
<a class=header-link href=#how-do-i-trick-virtualbox-into-restoring-our-saved-state><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>We have no idea how the config file looks like with a saved state.</p><p>Right click on the machine <code>Show in Explorer</code>, open up <code>[machine-name].vbox</code> and
make a copy. Start the machine, close the Window and save the state. Close
VirtualBox and copy the file again. Compare these two. The value of <code>stateFile</code>
has changed. Change the value of <code>stateFile</code> to the file (maybe we should change
the <code>lastStateChange</code> too). Copy the file from the challenge zip.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;Machine</span> uuid=<span style=color:#2aa198>&#34;{e6fe2819-7bc2-436c-a14f-e274aa4112ef}&#34;</span> name=<span style=color:#2aa198>&#34;Debian3&#34;</span>
</span></span><span style=display:flex><span>    OSType=<span style=color:#2aa198>&#34;Debian_64&#34;</span> stateFile=<span style=color:#2aa198>&#34;Snapshots/2018-01-13T17-11-21-868995300Z.sav&#34;</span>
</span></span><span style=display:flex><span>    snapshotFolder=<span style=color:#2aa198>&#34;Snapshots&#34;</span> lastStateChange=<span style=color:#2aa198>&#34;2018-01-13T17:11:21Z&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span></code></pre></div><h4 id=uapicmode>uApicMode
<a class=header-link href=#uapicmode><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>The desktop Was displayed for second and then we got this error, damn!</p><pre tabindex=0><code>Failed to open a session for the virtual machine Debian3.

apic#0: Config mismatch * uApicMode: saved=2 config=3
    [ver=3 pass=final] (VERR_SSM_LOAD_CONFIG_MISMATCH).

Result Code: E_FAIL (0x80004005)
Component: ConsoleWrap
Interface: IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><h4 id=apic-io>APIC I/O?
<a class=header-link href=#apic-io><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>We need to find out what does <code>APIC</code> mode 2 mean. If I have to make a guess, we
need to disable <code>I/O APIC mode</code> in <code>Syetem</code>. Dicard the state, remove it and try
again.</p><p>This disappears from the config file (we could have probably just removed this
from the config file manually instead of discarding the state and doing it
again):</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;BIOS&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;IOAPIC</span> enabled=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/BIOS&gt;</span>
</span></span></code></pre></div><p>Add the saved state to the snapshot as we saw before and try again!</p><p>Whelp! That was the wrong APIC. Serves me right by taking quick action.</p><pre tabindex=0><code>Failed to open a session for the virtual machine Debian3.

apic#0: Config mismatch * fIoApicPresent: saved=true  config=false
    [ver=3 pass=final] (VERR_SSM_LOAD_CONFIG_MISMATCH).

Result Code: E_FAIL (0x80004005)
Component: ConsoleWrap
Interface: IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><h3 id=back-to-uapicmode>Back to uApicMode
<a class=header-link href=#back-to-uapicmode><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Searching for <code>uApicMode</code> returns only a few results. Both of the errors that we
have seen come from this file:</p><ul><li><a href=https://www.virtualbox.org/svn/vbox/trunk/src/VBox/VMM/VMMR3/APIC.cpp target=_blank rel="noreferrer noopener">https://www.virtualbox.org/svn/vbox/trunk/src/VBox/VMM/VMMR3/APIC.cpp</a></li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>static</span> <span style=color:#dc322f>int</span> <span style=color:#268bd2>apicR3LoadVMData</span>(PVM pVM, PSSMHANDLE pSSM)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    PAPIC pApic <span style=color:#719e07>=</span> VM_TO_APIC(pVM);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>/* Load and verify number of CPUs. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span> cCpus;
</span></span><span style=display:flex><span>    <span style=color:#dc322f>int</span> rc <span style=color:#719e07>=</span> SSMR3GetU32(pSSM, <span style=color:#719e07>&amp;</span>cCpus);
</span></span><span style=display:flex><span>    AssertRCReturn(rc, rc);
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (cCpus <span style=color:#719e07>!=</span> pVM<span style=color:#719e07>-&gt;</span>cCpus)
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span> SSMR3SetCfgError(pSSM, RT_SRC_POS, N_(<span style=color:#2aa198>&#34;Config mismatch * cCpus: saved=%u config=%u&#34;</span>),
</span></span><span style=display:flex><span>            cCpus, pVM<span style=color:#719e07>-&gt;</span>cCpus);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>/* Load and verify I/O APIC presence. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>bool</span> fIoApicPresent;
</span></span><span style=display:flex><span>    rc <span style=color:#719e07>=</span> SSMR3GetBool(pSSM, <span style=color:#719e07>&amp;</span>fIoApicPresent);
</span></span><span style=display:flex><span>    AssertRCReturn(rc, rc);
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (fIoApicPresent <span style=color:#719e07>!=</span> pApic<span style=color:#719e07>-&gt;</span>fIoApicPresent)
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span> SSMR3SetCfgError(pSSM, RT_SRC_POS, N_(<span style=color:#2aa198>&#34;Config mismatch * fIoApicPresent: saved=%RTbool config=%RTbool&#34;</span>), fIoApicPresent, pApic<span style=color:#719e07>-&gt;</span>fIoApicPresent);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#586e75>/* Load and verify configured max APIC mode. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span> uSavedMaxApicMode;
</span></span><span style=display:flex><span>    rc <span style=color:#719e07>=</span> SSMR3GetU32(pSSM, <span style=color:#719e07>&amp;</span>uSavedMaxApicMode);
</span></span><span style=display:flex><span>    AssertRCReturn(rc, rc);
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (uSavedMaxApicMode <span style=color:#719e07>!=</span> (<span style=color:#dc322f>uint32_t</span>)pApic<span style=color:#719e07>-&gt;</span>enmMaxMode)
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span> SSMR3SetCfgError(pSSM, RT_SRC_POS, N_(<span style=color:#2aa198>&#34;Config mismatch * uApicMode: saved=%u config=%u&#34;</span>),
</span></span><span style=display:flex><span>                                uSavedMaxApicMode, pApic<span style=color:#719e07>-&gt;</span>enmMaxMode);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> VINF_SUCCESS;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We are getting an error when comparing the <code>max APIC mode</code>. Ours is 3, config is
2. But what is this?</p><p>Searching for <code>max apic</code> sends us to a <a href=https://www.reddit.com/r/linux/comments/6jepx3/intel_skylakekaby_lake_processors_broken/ target=_blank rel="noreferrer noopener">reddit thread</a>:</p><blockquote><p>Max APIC IDs reserved field is Valid. A value of 0 for HTT indicates there is
only a single logical processor in the package and software should assume only
a single APIC ID is reserved. A value of 1 for HTT indicates the value in
CPUID.1.EBX[23:16] (the Maximum number of addressable IDs for logical
processors in this package) is valid for the package.</p></blockquote><p>But does it have anything to do what we want? How do we change it? What do we
need to change in our CPU config?</p><p>Inside <a href=https://www.virtualbox.org/svn/vbox/trunk/src/VBox/VMM/include/APICInternal.h target=_blank rel="noreferrer noopener">/VMM/include/APICInternal.h</a>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>/** The max supported APIC mode from CFGM.  */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE                 enmMaxMode;
</span></span></code></pre></div><p>And later in <a href=https://www.virtualbox.org/svn/vbox/trunk/include/VBox/vmm/pdmdev.h target=_blank rel="noreferrer noopener">VBox/vmm/pdmdev.h</a>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>typedef</span> <span style=color:#719e07>enum</span> PDMAPICMODE
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Invalid 0 entry. */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE_INVALID <span style=color:#719e07>=</span> <span style=color:#2aa198>0</span>,
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** No APIC. */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE_NONE,
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Standard APIC (X86_CPUID_FEATURE_EDX_APIC). */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE_APIC,
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Intel X2APIC (X86_CPUID_FEATURE_ECX_X2APIC). */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE_X2APIC,
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The usual 32-bit paranoia. */</span>
</span></span><span style=display:flex><span>    PDMAPICMODE_32BIT_HACK <span style=color:#719e07>=</span> <span style=color:#2aa198>0x7fffffff</span>
</span></span><span style=display:flex><span>} PDMAPICMODE;
</span></span></code></pre></div><p>This seems to be it. We have <code>X2APIC</code> (3) enabled but want <code>APIC</code>.</p><p>Inside the config file we have this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;CPU&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;PAE</span> enabled=<span style=color:#2aa198>&#34;false&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;LongMode</span> enabled=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;X2APIC</span> enabled=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;HardwareVirtExLargePages</span> enabled=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/CPU&gt;</span>
</span></span></code></pre></div><p>We are going to change it to <code>false</code> and then try again.</p><h4 id=different-enum>Different Enum
<a class=header-link href=#different-enum><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>On a side-note, this threw me off inside
<a href=https://www.virtualbox.org/svn/vbox/trunk/src/VBox/Devices/PC/BIOS/post.c target=_blank rel="noreferrer noopener">/VBox/Devices/PC/BIOS/post.c</a>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#719e07>#define APICMODE_DISABLED   0
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define APICMODE_APIC       1
</span></span></span><span style=display:flex><span><span style=color:#719e07>#define APICMODE_X2APIC     2
</span></span></span></code></pre></div><p>This enum is different by one compared to the other one (X2APIC is 3 there but 2
here).</p><h4 id=video-memory-size-error>Video Memory Size Error
<a class=header-link href=#video-memory-size-error><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>After setting <code>&lt;X2APIC enabled="false"/></code> we get a different error.</p><pre tabindex=0><code>Failed to open a session for the virtual machine Debian3.

vga#0: VRAM size changed: config=0x1000000 state=0xc00000
    [ver=16 pass=final] (VERR_SSM_LOAD_CONFIG_MISMATCH).

Result Code: E_FAIL (0x80004005)
Component: ConsoleWrap
Interface: IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><ul><li>Config VRAM is <code>0x1000000</code> == <code>16777216</code> == <code>16MB</code></li><li>State VRAM is <code>0xc00000</code> == <code>12582912</code> == <code>12MB</code></li></ul><p>We can change it in the config file from 16 to 12 and try again:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;Hardware&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;Display</span> VRAMSize=<span style=color:#2aa198>&#34;16&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/Hardware&gt;</span>
</span></span></code></pre></div><h4 id=primary-master-device-error>Primary Master Device Error
<a class=header-link href=#primary-master-device-error><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>Another error, this time for the hard drive:</p><pre tabindex=0><code>Failed to open a session for the virtual machine Debian3.

piix3ide#0: The target VM is missing a primary master device.
Please make sure the source and target VMs have compatible storage configurations
[ver=20 pass=final] (VERR_SSM_LOAD_CONFIG_MISMATCH).

Result Code: E_FAIL (0x80004005)
Component: ConsoleWrap
Interface: IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><p>We have attached the VM disk as an SATA drive. We need to add it as IDE and
primary master. This time the config file is a bit more complicated, so we will
discard the state (which allows us to edit the VM via the GUI) and attach the
image as IDE. Just remember that you need to do the snapshot trick again.</p><p>It's now:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;StorageControllers&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;StorageController</span> name=<span style=color:#2aa198>&#34;IDE&#34;</span> type=<span style=color:#2aa198>&#34;PIIX4&#34;</span> PortCount=<span style=color:#2aa198>&#34;2&#34;</span> useHostIOCache=<span style=color:#2aa198>&#34;true&#34;</span> Bootable=<span style=color:#2aa198>&#34;true&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;AttachedDevice</span> type=<span style=color:#2aa198>&#34;HardDisk&#34;</span> hotpluggable=<span style=color:#2aa198>&#34;false&#34;</span> port=<span style=color:#2aa198>&#34;0&#34;</span> device=<span style=color:#2aa198>&#34;0&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&lt;Image</span> uuid=<span style=color:#2aa198>&#34;{401cb5a0-d3bf-4d40-83b8-e0f658d4d12f}&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;/AttachedDevice&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&lt;AttachedDevice</span> passthrough=<span style=color:#2aa198>&#34;false&#34;</span> type=<span style=color:#2aa198>&#34;DVD&#34;</span> hotpluggable=<span style=color:#2aa198>&#34;false&#34;</span> port=<span style=color:#2aa198>&#34;1&#34;</span> device=<span style=color:#2aa198>&#34;0&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;/StorageController&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&lt;StorageController</span> name=<span style=color:#2aa198>&#34;SATA&#34;</span> type=<span style=color:#2aa198>&#34;AHCI&#34;</span> PortCount=<span style=color:#2aa198>&#34;1&#34;</span> useHostIOCache=<span style=color:#2aa198>&#34;false&#34;</span>
</span></span><span style=display:flex><span>        Bootable=<span style=color:#2aa198>&#34;true&#34;</span> IDE0MasterEmulationPort=<span style=color:#2aa198>&#34;0&#34;</span> IDE0SlaveEmulationPort=<span style=color:#2aa198>&#34;1&#34;</span>
</span></span><span style=display:flex><span>        IDE1MasterEmulationPort=<span style=color:#2aa198>&#34;2&#34;</span> IDE1SlaveEmulationPort=<span style=color:#2aa198>&#34;3&#34;</span><span style=color:#268bd2>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/StorageControllers&gt;</span>
</span></span></code></pre></div><p>First we get this error without any description.</p><pre tabindex=0><code>Failed to open a session for the virtual machine Debian3.

The VM session was closed before any attempt to power it on.

Result Code: E_FAIL (0x80004005)
Component: SessionMachine
Interface: ISession {7844aa05-b02e-4cdd-a04f-ade4a762e6b7}
</code></pre><p>After discarding the state and trying again we get:</p><pre tabindex=0><code>ahci#0: The target VM is missing a device on port 0. Please make sure the source
and target VMs have compatible storage configurations
    [ver=8 pass=final] (VERR_SSM_LOAD_CONFIG_MISMATCH).

Result Code: 
E_FAIL (0x80004005)
Component: 
ConsoleWrap
Interface: 
IConsole {872da645-4a9b-1727-bee2-5585105b9eed}
</code></pre><p>Looking around, this seems like a version issue. Seems like states created by
older versions get this error with newer ones. I either need to find a solution
or discover the VirtualBox version that the VM was created with. One way is to
look at the date of the snapshot (and the files inside the image) and get the
build number (it's 5.0.2 with SVN revision 102546, see below on how I got it).
Then we can try with that exact version.</p><p><strong>Solution to mounting the VM:</strong></p><p>So the trick was having another drive on primary master and not the qed image.
Guess what? It's VirtualBox and chances are, you mounted the <strong>VB guest
additions CD</strong>. So CDROM with guest additions loaded goes into primary master,
the drive goes into first SATA, and voila! (insert Poirot image). It works (not
the MLM). However, I did look at the <code>sav</code> file format. Feel free to read it
further down you want.</p><h3 id=whats-in-the-box>WHAT's IN THE BOX?
<a class=header-link href=#whats-in-the-box><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>We have already seen pretty much everything. Opening a terminal and looking at
history we can only see:</p><ul><li><code>cat Desktop/secret.txt</code></li><li><code>cryptsetup luksOpen secret tmpMe --key-file secret --key-slot 0</code></li></ul><p><code>key-slot 0</code> seems to do something else. But still no bono.</p><h3 id=inside-the-swap-file>Inside the Swap File
<a class=header-link href=#inside-the-swap-file><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>The qed has two images, the drive and the swap file. Convert it to <code>vdi</code> format
with <code>qemu-img</code> as seen above and open it with 7-zip. There are two img files
inside, open the swap file in a hex editor like <code>HxD</code> and search for stuff.</p><p>It contains the commands you used to setup the thing. Hint: If you see <code>UU</code>, you
are about to see a command. I just searched for the text <code>secret</code>. Seems like
this appears before every command <code>F7 0x 55 55</code> (where <code>x</code> can be 2,3,4 etc.).</p><p>These start at offset <code>0x00F2F0C0</code> (comments are just friendly banter, do not
take it seriously)</p><pre tabindex=0><code>ifconfig
sudo cryptsetup luksOPen /dev/loop0 container # Oops we do not have cryptsetup
ifconfig                                      # Oops we do not have internet
apt-get install cryptsetup                    # Install cryptsetup
nano -w /mnt/token.txt                        # Ah, a fellow nano fan
# I saw some color (like [0;10m) and control characters, I assume it&#39;s commands
# interacting with nano.
cryptsetup luksOpen /dev/loop0 container
poweroff
cat .bash_history
dd if=/dev/urandom of=secret bs=1M count=10   # Create the initial file
/usr/bin/mesg                                 # Why? Some util running cmds?
chmod +x truecrypt-7.2-setup-console-x64
mesg
startx
AX.G0.XT.U8.E0.E3.S0.TS.ka2.kb1.kb3.kc2       # No idea what this is
ifconfig
root@0:~#
/root/.terminfo
/root
/truecrypt-7.2-setup-console-x64
apt-cache search fuse
apt-cache search luks
apt-get install fuse
apt-get install luks
</code></pre><p>More stuff at <code>0x00F7C540</code> (these seem to be before the previous set):</p><pre tabindex=0><code>tar xzvf TrueCrypt-7.2-Linux-console-x64.tar.gz
file truecrypt-7.2-setup-console-x64
wget &#34;http://tenet.dl.sourceforge.net/project/truecrypt/TrueCrypt/Other/TrueCrypt-7.2-Linux-console-x64.tar.gz
losetup /dev/loop0 secret
startx
# some stuff here
losetup -f
mount -t ext4 /dev/mapper/container /mnt
</code></pre><p>Stuff at <code>0x00F29D00</code>:</p><pre tabindex=0><code>mkfs.ext4 /dev/mapper/container
apt-get install xorg
XDG_RUNTIME_DIR=/run/user/0.
</code></pre><p>At <code>0x00F76000</code>:</p><pre tabindex=0><code>cryptsetup -c aes-xts-plain -y -s 512 luksFormat /dev/loop0
/root/.terminfo./etc/terminfo./lib/terminfo./usr/share/terminfo./etc/terminfo
cryptsetup -c aes-xts-plain -y -s 512 luksFormat /dev/loop0
/bin/startx
startx # a bunch of these
</code></pre><p>At <code>0x1499730</code>:</p><pre tabindex=0><code>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHT1OYnj7LsN3ZvtcF6xpQojuELJzUYM0sa/LurKaoHS.

root@0..SANtrq1/eNzyH7hC8RgnVPJcIWMWEuVEqPsz24i4rle8RYx8xUUNZiBBervbflV5SoV+8A=.root@0..qm+PPjrHaa4rmfJ/DkC1I+Uldr2kI3TAAAAFQCcBsZds4dQIqb6Zlx4Lurj4fjmPQAAAIBPFoAof1ao1lPuXHPQV7Vwn1AqBQ7NFAv9mz8q/qUCYFUYwGCnwxGKRv/ytK1n5DN9UI4bKfrF5yERoRswjM8K6V/xyRKPatN9HVqHHJzDLcgu0Qh8DRuNRRZSnQVKahawQ9boIS13u53I6EI5W2c708MKmeYTfbj9WNWa2ZwPrQAAAIBuzHcePHEdJ8+Lrqt62PErYw8wJvxWSZjrzmZgbO8MEhw+W4kgixqvzEDCc9j0+RddTYyeoTLcgVWaLtkvXMw2cJlWtZpyj3ANHLjPsVbvsUsz8jXEDe64tHoR3dN9qSng+I1yiv5m6p/w6+pJ6uvirAFpZiHzAnBRkGnc7x2taw==

root@0
</code></pre><p><code>cryptsetup -c aes-xts-plain -y -s 512 luksFormat /dev/loop0</code>:</p><ul><li><code>-c</code>: Cipher == <code>aes-xts-plain</code></li><li><code>-y</code>: Ask for passwords twice</li><li><code>-s</code>: Key size == <code>512</code></li><li><code>luksFormat /dev/loop0</code><ul><li><code>luksFormat &lt;device> [&lt;key file>]</code></li></ul></li></ul><h2 id=clipboard>Clipboard
<a class=header-link href=#clipboard><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Shift+Insert in a terminal to get the clipboard:</p><ul><li><code>d27a0102bV1uahFX6covGkTdKR6Li5BK5</code></li></ul><span class=caption-wrapper><img class=caption src=forensics102-clipboard.png title=Clipboard alt=Clipboard>
<span class=caption-text>Clipboard</span></span><p>This is the wrong length for a base64 encoded string. Base64 gives us 4 chars
for each 3 chars in input. So each char is 4/3 chars. Meaning you can never have
a string of length <code>4*n+1</code> because the last char is encoded into 2 chars. In
other words, a base64 string can only have zero, one or two padding chars.</p><p>Decoded from base64, there's an error because of 5. Removing 5 gives us this (in hex):</p><ul><li><code>776edad35d366d5d6e6a1157e9ca2f1a44dd291e8b8b904a</code></li></ul><p>With Cyberchef we get:</p><p><code>776edad35d366d5d6e6a1157e9ca2f1a44dd291e8b8b904a e4</code></p><p><strong>Might be the creators SSH password.</strong></p><h2 id=dive-into-sav>Dive into sav
<a class=header-link href=#dive-into-sav><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The sav format is pretty much undocumented but we have source files. This is a
pretty new thing, I am going to write a blog post on it.</p><p>According to <a href=https://www.virtualbox.org/pipermail/vbox-dev/2012-October/010986.html target=_blank rel="noreferrer noopener">this
thread</a>,
"A .sav file is created using the SSM (saved state manager) code. You find the
API in include/VBox/vmm/ssm.h and src/VBox/VMM/VMMR3/SSM.cpp."</p><ul><li><a href=https://www.virtualbox.org/svn/vbox/trunk/include/VBox/vmm/ssm.h target=_blank rel="noreferrer noopener">https://www.virtualbox.org/svn/vbox/trunk/include/VBox/vmm/ssm.h</a></li><li><a href=https://www.virtualbox.org/svn/vbox/trunk/src/VBox/VMM/VMMR3/SSM.cpp target=_blank rel="noreferrer noopener">https://www.virtualbox.org/svn/vbox/trunk/src/VBox/VMM/VMMR3/SSM.cpp</a></li></ul><h3 id=ssm-file-header--ssmfilhdr>SSM File Header * SSMFILHDR
<a class=header-link href=#ssm-file-header--ssmfilhdr><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>First 64 bytes are the file header.</p><pre tabindex=0><code>00000000  7f 56 69 72 74 75 61 6c 42 6f 78 20 53 61 76 65  |.VirtualBox Save|
00000010  64 53 74 61 74 65 20 56 32 2e 30 0a 00 00 00 00  |dState V2.0.....|
00000020  05 00 00 00 04 00 00 00 92 90 01 00 40 08 08 00  |............@...|
00000030  28 00 00 00 01 00 00 00 00 10 00 00 28 6b b1 c8  |(...........(k±È|
</code></pre><p>Inside <code>ssm.cpp</code> search for <code>struct SSMFILEHDR</code>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>typedef</span> <span style=color:#719e07>struct</span> <span style=color:#268bd2>SSMFILEHDR</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Magic string which identifies this file as a version of VBox saved state
</span></span></span><span style=display:flex><span><span style=color:#586e75>     *  file format (SSMFILEHDR_MAGIC_V2_0). */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>char</span>            szMagic[<span style=color:#2aa198>32</span>];
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The major version number. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint16_t</span>        u16VerMajor;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The minor version number. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint16_t</span>        u16VerMinor;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The build number. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        u32VerBuild;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The SVN revision. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        u32SvnRev;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** 32 or 64 depending on the host. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint8_t</span>         cHostBits;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The size of RTGCPHYS. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint8_t</span>         cbGCPhys;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The size of RTGCPTR. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint8_t</span>         cbGCPtr;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Reserved header space * must be zero. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint8_t</span>         u8Reserved;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The number of units that (may) have stored data in the file. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        cUnits;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Flags, see SSMFILEHDR_FLAGS_XXX.  */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        fFlags;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The maximum size of decompressed data. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        cbMaxDecompr;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The checksum of this header.
</span></span></span><span style=display:flex><span><span style=color:#586e75>     * This field is set to zero when calculating the checksum. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        u32CRC;
</span></span><span style=display:flex><span>} SSMFILEHDR;
</span></span></code></pre></div><p>First 32 bytes contain the <code>magic string</code>. For us it's:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>/** Saved state file v2.0 magic. */</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#define SSMFILEHDR_MAGIC_V2_0  &#34;\177VirtualBox SavedState V2.0\n\0\0\0&#34;
</span></span></span></code></pre></div><p>Note the <code>\177</code> is octal (base 8) or <code>0x7F</code> which is exactly what we are seeing
in the file:</p><pre tabindex=0><code>00000020  05 00 00 00 04 00 00 00 92 90 01 00 40 08 08 00  |............@...|
00000030  28 00 00 00 01 00 00 00 00 10 00 00 28 6b b1 c8  |(...........(k±È|
</code></pre><p>And then we have the rest (in little-endian):</p><ul><li><code>05 00</code>: Major version number == <code>5.0</code>.</li><li><code>00 00</code>: Minor version number == <code>0.0</code>.</li><li><code>04 00 00 00</code>: Build number == <code>04</code>.</li><li><code>92 90 01 00</code>: SVN revision == <code>102546</code>.</li><li><code>40</code>: Host bits == <code>64</code> (32 bit or 64 bit host).</li><li><code>08</code>: Size of RTGCPHYS (Guest physical memory address) == <code>08</code>.</li><li><code>08</code>: Size of RTGCPTR (Guest context pointer) == <code>08</code>. I have no idea what
this does.</li><li><code>00</code>: Reserved header space * must be zero.</li><li><code>28 00 00 00</code>: Number of units that (may) have stored data in the file == <code>40</code>.</li><li><code>01 00 00 00</code>: Flags, discussed below. <code>01</code> == it was a live save.</li><li><code>00 10 00 00</code>: Maximum size of decompressed data == <code>4096</code>.</li><li><code>28 6b b1 c8</code>: CRC32 checksum of the header. Set to zero when calculating the
checksum.</li></ul><p>For some reason CyberChef does not show the correct CRC32 checksum while other
online calculators too. Some info might be lost when convert hex bytes to chars
and calculating the checksum (or I am simply using the wrong formula).</p><h4 id=flags>Flags
<a class=header-link href=#flags><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>In short, flag is <code>01</code> if it was a live save (which was in our case) and <code>00</code> if
the stream is checksummed up to the footer.</p><p>Flags are defined as follows:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>/** @name SSMFILEHDR::fFlags
</span></span></span><span style=display:flex><span><span style=color:#586e75> * @{ */</span>
</span></span><span style=display:flex><span><span style=color:#586e75>/** The stream is checksummed up to the footer using CRC-32. */</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#define SSMFILEHDR_FLAGS_STREAM_CRC32           RT_BIT_32(0)
</span></span></span><span style=display:flex><span><span style=color:#719e07></span><span style=color:#586e75>/** Indicates that the file was produced by a live save. */</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#define SSMFILEHDR_FLAGS_STREAM_LIVE_SAVE       RT_BIT_32(1)
</span></span></span><span style=display:flex><span><span style=color:#719e07></span><span style=color:#586e75>/** @} */</span>
</span></span></code></pre></div><h3 id=saved-state-units>Saved State Units
<a class=header-link href=#saved-state-units><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Then we can see a bunch of saved state units that conveniently have the text <code>Unit</code> in them.</p><p>Search for <code>typedef struct SSMUNIT</code> in <code>SSMInternal.h</code> for more info.</p><h4 id=unit-header--ssmfileunithdrv2>Unit Header * SSMFILEUNITHDRV2
<a class=header-link href=#unit-header--ssmfileunithdrv2><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>Each unit has its own header.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#719e07>typedef</span> <span style=color:#719e07>struct</span> <span style=color:#268bd2>SSMFILEUNITHDRV2</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Magic (SSMFILEUNITHDR_MAGIC or SSMFILEUNITHDR_END). */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>char</span>            szMagic[<span style=color:#2aa198>8</span>];
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The offset in the saved state stream of the start of this unit.
</span></span></span><span style=display:flex><span><span style=color:#586e75>     * This is mainly intended for sanity checking. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint64_t</span>        offStream;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The CRC-in-progress value this unit starts at. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        u32CurStreamCRC;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** The checksum of this structure, including the whole name.
</span></span></span><span style=display:flex><span><span style=color:#586e75>     * Calculated with this field set to zero.  */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        u32CRC;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Data version. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        u32Version;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Instance number. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        u32Instance;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Data pass number. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        u32Pass;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Flags reserved for future extensions. Must be zero. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        fFlags;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Size of the data unit name including the terminator. (bytes) */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>uint32_t</span>        cbName;
</span></span><span style=display:flex><span>    <span style=color:#586e75>/** Data unit name, variable size. */</span>
</span></span><span style=display:flex><span>    <span style=color:#dc322f>char</span>            szName[SSM_MAX_NAME_SIZE];
</span></span><span style=display:flex><span>} SSMFILEUNITHDRV2;
</span></span></code></pre></div><p>Let's analyze the first unit after the header:</p><pre tabindex=0><code>00000000  0a 55 6e 69 74 0a 00 00 40 00 00 00 00 00 00 00  |.Unit...@.......|
00000010  43 1d d4 81 b3 2b 74 a0 01 00 00 00 00 00 00 00  |C.Ô.³+t ........|
00000020  ff ff ff ff 00 00 00 00 04 00 00 00 53 53 4d 00  |ÿÿÿÿ........SSM.|
00000030  92 39 0a 00 00 00 42 75 69 6c 64 20 54 79 70 65  |.9....Build Type|
00000040  07 00 00 00 72 65 6c 65 61 73 65 07 00 00 00 48  |....release....H|
00000050  6f 73 74 20 4f 53 09 00 00 00 77 69 6e 2e 61 6d  |ost OS....win.am|
00000060  64 36 34 00 00 00 00 00 00 00 00 91 0e 01 00 b1  |d64............±|
00000070  c7 65 e5 4b 00 00 00 00 00 00 00                 |ÇeåK.......|
</code></pre><p>First 8 bytes contain the data unit magic header that can have two values:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#586e75>/** Data unit magic. */</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#define SSMFILEUNITHDR_MAGIC    &#34;\nUnit\n\0&#34;
</span></span></span><span style=display:flex><span><span style=color:#719e07></span><span style=color:#586e75>/** Data end marker magic. */</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#define SSMFILEUNITHDR_END      &#34;\nTheEnd&#34;
</span></span></span></code></pre></div><p>In this case we have <code>0a 55 6e 69 74 0a 00 00</code> or <code>\nUnit\n\0</code>.</p><ul><li><code>40 00 00 00</code>: Offset of this unit in the stream. For this unit it's <code>0x40</code>.
In other words, if we go this offset in the sav file, we will see this data
unit.</li><li><code>00 00 00 00</code>: The CRC-in-progress value this unit starts at. No idea what
this is. It could be default value of the CRC bytes when we are creating the
CRC checksum (live above).</li><li><code>43 1d d4 81</code>: Checksum of the data unit with these bytes set to zero == <code>81 d4 1d 43</code>.</li><li><code>b3 2b 74 a0</code>: Data version == <code>a0 74 2b b3</code>. (?)</li><li><code>01 00 00 00</code>: Instance number == <code>01</code>. (?)</li><li><code>00 00 00 00</code>: Data pass number == <code>00</code>. (?)</li><li><code>ff ff ff ff</code>: <strong>These 4 bytes do not appear in the spec.</strong> Could be alignment
for the data unit header? These appear in my new live states too.</li><li><code>00 00 00 00</code>: Flags reserved for future extensions. Must be zero.</li><li><code>04 00 00 00</code>: Size of null-terminated data unit name with bytes, <code>4</code> in this
data unit.</li><li><code>53 53 4d 00</code>: Data unit name, <code>SMM</code>.</li></ul><h4 id=unit-data>Unit Data
<a class=header-link href=#unit-data><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h4><p>Going back up the <code>ssm.cpp</code> file we can see the data in each saved state unit.</p><pre tabindex=0><code>00000030  92 39 0a 00 00 00 42 75 69 6c 64 20 54 79 70 65  |.9....Build Type|
00000040  07 00 00 00 72 65 6c 65 61 73 65 07 00 00 00 48  |....release....H|
00000050  6f 73 74 20 4f 53 09 00 00 00 77 69 6e 2e 61 6d  |ost OS....win.am|
00000060  64 36 34 00 00 00 00 00 00 00 00 91 0e 01 00 b1  |d64............±|
00000070  c7 65 e5 4b 00 00 00 00 00 00 00                 |ÇeåK.......|
</code></pre><p>00000030 92 39 0a 00 00 00 42 75 69 6c 64 20 54 79 70 65 |.9....Build Type|
00000040 07 00 00 00 72 65 6c 65 61 73 65 07 00 00 00 48 |....release....H|
00000050 6f 73 74 20 4f 53 09 00 00 00 77 69 6e 2e 61 6d |ost OS....win.am|
00000060 64 36 34 00 00 00 00 00 00 00 00 91 0e 01 00 b1 |d64............±|
00000070 c7 65 e5 4b 00 00 00 00 00 00 00 |ÇeåK.......|</p><p>"The first byte in the record header indicates the type and flags." We have
<code>0x92</code> or <code>1001 0010</code>:</p><ul><li>bits 0..3: Record type <code>0010</code>: type = Raw data record.</li><li>bit 4: <code>1</code> if important and <code>0</code> if it can be skipped. This is an important data unit.</li><li>bit 5, 6: Must be <code>0</code>.</li><li>bit 7: Always <code>1</code>.</li></ul><p>So we have an important raw data record.</p><p>"Record header byte 2 (optionally thru 7) is the size of the following data
encoded in UTF-8 style." We have <code>0x39</code> or <code>57</code> decimal. So we will read 57
bytes.</p><p>This part is easy. Read a little-endian uint32, that's field length. Then read
that many bytes for the field. This is a typical Pascal style string (on the
other side we have C style string without length where we read until we reach
the null terminator <code>0x00</code>). Note these strings do not have null terminators.</p><ul><li><code>0a 00 00 00 42 75 69 6c 64 20 54 79 70 65</code>: 10 bytes * <code>Build Type</code>.</li><li><code>07 00 00 00 72 65 6c 65 61 73 65</code>: 7 bytes * <code>release</code>.</li><li><code>07 00 00 00 48 6f 73 74 20 4f 53</code>: 7 bytes * <code>Host OS</code>.</li><li><code>09 00 00 00 77 69 6e 2e 61 6d 64 36 34</code>: 9 bytes * <code>win.amd64</code>.</li><li><code>00 00 00 00 00 00 00 00</code>: 0 bytes * empty (?).</li></ul><h3 id=file-footer--ssmfileftr>File Footer * SSMFILEFTR
<a class=header-link href=#file-footer--ssmfileftr><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>And finally we have the file footer. Bored now. Search in the VirtualBox source
code for it.</p><p><strong>RAGE QUIT LOL.</strong></p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Parsia</span></span>
<time>Feb 9, 2020</time></span></p><p class=meta><a class="basic-alignment left" href=https://parsiya.net/blog/2020-02-06-documentation-writing-for-system-administrators-notes/ title="Documentation Writing for System Administrators - Notes">Documentation Writing for System Administrators - Notes</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2020-03-13-time-management-for-systems-administrators-lessons-learned/ title="Time Management For Systems Administrators - Lessons Learned">Time Management For Systems Administrators - Lessons Learned</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//parsiya.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I?</h1><p><p>I am Parsia, an application security engineer.</p><p>I write about application security, cryptography, static analysis, and
(of course) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more.</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="me noopener noreferrer" href=https://infosec.exchange/@parsiya title=https://infosec.exchange/@parsiya><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><h1>Collections</h1><li><a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a></li><li><a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a></li><li><a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a></li><li><a href=https://parsiya.net/categories/semgrep/ title=Semgrep>Semgrep</a></li><li><a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a></li><li><a href=https://parsiya.net/categories/blockchain/ title="Blockchain (lol)">Blockchain (lol)</a></li><li><a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a></li><li><a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a></li><li><a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a></li><li><a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a></li><li><a href=https://parsiya.net/categories/winappdbg/ title="WinAppDbg (use Frida instead)">WinAppDbg (use Frida instead)</a></li><li><a href=https://awsome.pw title='AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability'>AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability</a></li></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2023 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>