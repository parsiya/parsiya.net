<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Tiredful API - Part 2 - Comparing Site Maps with Burp</title>
<link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.net/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia"><meta name=generator content="Hugo 0.120.2"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content="https://parsiya.net/blog/2018-12-17-tiredful-api-part-2-comparing-site-maps-with-burp/08-sitemap.png"><meta name=twitter:title content="Tiredful API - Part 2 - Comparing Site Maps with Burp"><meta name=twitter:description content="In Part 1 - Burp Session Validation with Macros I discussed using Burp macros to validate sessions. In this part, I will show how to use Burp's sitemap comparison to detect forced browsing/access control/direct object reference issues and the like.
The flow is straightforward:

Navigate around the application as user1. Personally, I just do my normal testing for a couple of days.
Set a session handling rule to do one of the two:

Update the cookie from the cookie jar. In this case you login as user2 first and let Burp update cookies.
Run a macro to create a valid session for user2 and use the token.


Tell Burp to compare site maps.

Also, read these:

https://portswigger.net/burp/documentation/desktop/tools/target/site-map/comparing
https://support.portswigger.net/customer/portal/articles/1969844-using-burp-s-site-map-to-test-for-access-control-issues
"><meta name=twitter:domain content="parsiya.net"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select></fieldset><ul class=main-navigation><li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription><a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Dec 17, 2018
- 4 minute read
- <a href=https://parsiya.net/blog/2018-12-17-tiredful-api-part-2-comparing-site-maps-with-burp/#disqus_thread>Comments</a>
- <a class=label href=https://parsiya.net/categories/burp/>Burp </a><a class=label href=https://parsiya.net/categories/writeup/>Writeup</a></p><h1 class=entry-title>Tiredful API - Part 2 - Comparing Site Maps with Burp</h1></header><div class=entry-content><nav id=TableOfContents><ul><li><a href=#exams---insecure-direct-object-reference>Exams - Insecure Direct Object Reference</a></li><li><a href=#using-site-map-comparison>Using Site Map Comparison</a><ul><li><a href=#login-macros>Login Macros</a></li><li><a href=#session-handling-rules>Session Handling Rules</a></li><li><a href=#setup-scope>Setup Scope</a></li><li><a href=#add-custom-header>Add Custom Header</a></li><li><a href=#cleaning-site-map>Cleaning Site Map</a></li><li><a href=#browsing-exams>Browsing Exams</a></li><li><a href=#comparing-site-maps>Comparing Site Maps</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav><p>In <a href=/blog/2018-12-11-tiredful-api-part-1-burp-session-validation-with-macros/ title="Burp Session Validation with Macros">Part 1 - Burp Session Validation with Macros</a> I discussed using Burp macros to validate sessions. In this part, I will show how to use Burp's sitemap comparison to detect forced browsing/access control/direct object reference issues and the like.</p><p>The flow is straightforward:</p><ol><li>Navigate around the application as user1. Personally, I just do my normal testing for a couple of days.</li><li>Set a session handling rule to do one of the two:<ol><li>Update the cookie from the cookie jar. In this case you login as user2 first and let Burp update cookies.</li><li>Run a macro to create a valid session for user2 and use the token.</li></ol></li><li>Tell Burp to compare site maps.</li></ol><p>Also, read these:</p><ul><li><a href=https://portswigger.net/burp/documentation/desktop/tools/target/site-map/comparing target=_blank rel="noreferrer noopener">https://portswigger.net/burp/documentation/desktop/tools/target/site-map/comparing</a></li><li><a href=https://support.portswigger.net/customer/portal/articles/1969844-using-burp-s-site-map-to-test-for-access-control-issues target=_blank rel="noreferrer noopener">https://support.portswigger.net/customer/portal/articles/1969844-using-burp-s-site-map-to-test-for-access-control-issues</a></li></ul><h1 id=exams---insecure-direct-object-reference>Exams - Insecure Direct Object Reference
<a class=header-link href=#exams---insecure-direct-object-reference><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>In the test API, <code>Insecure Direct Object Reference</code> lists the API call for viewing exams. Results can be retrieved with a GET request (our endpoint is <code>192.168.99.100:8000</code>):</p><ul><li><code>http://192.168.99.100:8000/api/v1/exams/{{ exam_id }}/</code></li></ul><p>where <code>exam_id</code> is a base64 encoded number. Exams <code>MQ==</code> (1) and <code>Mg==</code> (2) belong to Batman. There's no access check and we can see any exam results by directly referencing its ID as Superman.</p><p>The solution to this exercise is trivial. We can solve it with Intruder and going through exam IDs 1 to 100. The only trick is to base64 encode the payload with a rule under <code>Intruder > Payload Processing</code>.</p><span class=caption-wrapper><img class=caption src=01-encode-rule.png title="Payload processing rule" alt="Payload processing rule">
<span class=caption-text>Payload processing rule</span></span><h1 id=using-site-map-comparison>Using Site Map Comparison
<a class=header-link href=#using-site-map-comparison><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><ol><li>Modify the old Batman (user1) session handling rule to include Burp's "Proxy."</li><li>Navigate to Batman's two exam results.</li><li>Create a second macro to login as Superman (user2).</li><li>Compare sitemaps.</li></ol><h2 id=login-macros>Login Macros
<a class=header-link href=#login-macros><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Login macros are the same as <a href=/blog/2018-12-11-tiredful-api-part-1-burp-session-validation-with-macros/#login-macro title="Login Macro">part 1</a>. This macro logs in as Batman and gets the authorization token.</p><span class=caption-wrapper><img class=caption src=02-login-as-batman-macro.png title="Login as Batman macro" alt="Login as Batman macro">
<span class=caption-text>Login as Batman macro</span></span><p>We will make a similar one for Superman.</p><h2 id=session-handling-rules>Session Handling Rules
<a class=header-link href=#session-handling-rules><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We will reuse the session handling rule from <a href=/blog/2018-12-11-tiredful-api-part-1-burp-session-validation-with-macros/#session-validation title="Session Validation">part 1</a> with one modification:</p><ul><li>Under <code>Scope</code> (in the session handling rule editor), check <code>Proxy (use with caution)</code>. This will apply the rule to the requests coming from the browser. Unlike Repeater, we will not see the updated request in history.</li></ul><span class=caption-wrapper><img class=caption src=02-session-handling-scope.png title="Add Proxy to scope of session handling rule" alt="Add Proxy to scope of session handling rule">
<span class=caption-text>Add Proxy to scope of session handling rule</span></span><p>Make a second one for Superman named <code>superman-session</code> and disable it.</p><h2 id=setup-scope>Setup Scope
<a class=header-link href=#setup-scope><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Scope is the same as before.</p><p>Include:</p><ul><li>http://192.168.99.100:8000</li></ul><p>Exclude:</p><ul><li>http://192.168.99.100:8000/oauth/token/</li><li>http://192.168.99.100:8000/oauth/revoke_token/</li></ul><span class=caption-wrapper><img class=caption src=03-scope.png title=Scope alt=Scope>
<span class=caption-text>Scope</span></span><h2 id=add-custom-header>Add Custom Header
<a class=header-link href=#add-custom-header><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>If you are running Burp free (like me in this example), the settings for the <code>Add Custom Header</code> extension have most likely reset. Go back and set them correctly. The magic string is <code>access_token": "(.*?)"</code> (note the space after <code>:</code>).</p><span class=caption-wrapper><img class=caption src=04-extension.png title='"Add Custom Header" settings' alt='"Add Custom Header" settings'>
<span class=caption-text>"Add Custom Header" settings</span></span><h2 id=cleaning-site-map>Cleaning Site Map
<a class=header-link href=#cleaning-site-map><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Obviously, we do not do this step in a real engagement but I want to have a clean slate here.</p><ol><li>Navigate to <code>Target > Site map</code>.</li><li>Click on the <code>Filter</code> bar and click the <code>Show All</code> button. This will show everything.</li><li>Select all hosts and delete them.</li></ol><h2 id=browsing-exams>Browsing Exams
<a class=header-link href=#browsing-exams><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Double-check:</p><ul><li>Session handling rules are working.</li><li><code>batman-session</code> is enabled and <code>super-session</code> is disabled.</li></ul><p>Navigate to these URLs in browser:</p><ul><li>http://192.168.99.100:8000/api/v1/exams/MQ==/</li><li>http://192.168.99.100:8000/api/v1/exams/Mg==/</li></ul><p>Both belong to <code>user: 1</code> who is <code>Batman</code>.</p><h2 id=comparing-site-maps>Comparing Site Maps
<a class=header-link href=#comparing-site-maps><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><ol><li>In <code>Project Options > Sessions > Session Handling Rules</code>, disable <code>batman-session</code> and enable <code>superman-session</code>.</li><li>Right click on <code>192.168.99.100:8000</code> and select <code>Compare site maps</code>.</li><li>A new window opens up. Free edition does not support using other projects or states. Our only choice is <code>Use current site map</code>.\
<span class=caption-wrapper><img class=caption src=05-compare-1.png title="Use current site map" alt="Use current site map">
<span class=caption-text>Use current site map</span></span></li><li>Keep <code>Use all items with responses</code> (in a real engagement, you might want to select <code>Use only selected branches</code>) and check <code>Include in-scope items only</code> (remember I excluded login/logout from scope).\
<span class=caption-wrapper><img class=caption src=06-compare-2.png title="Include settings" alt="Include settings">
<span class=caption-text>Include settings</span></span></li><li>No choices here.\
<span class=caption-wrapper><img class=caption src=07-compare-3.png title="Select source" alt="Select source">
<span class=caption-text>Select source</span></span></li><li>The rest of the screens have a lot of options for performance and matching requests/responses. Let's not worry about them and go with default values.</li><li>And it's working.</li></ol><span class=caption-wrapper><img class=caption src=08-sitemap.png title="Site map comparison results" alt="Site map comparison results">
<span class=caption-text>Site map comparison results</span></span><p>We can access both exams with both users. It should not be the case.</p><p>The only difference between the requests is the authorization header in the Superman session. This happened because the headers are not added to the requests in <code>HTTP History</code> but the default settings tell Burp to ignore request headers.</p><h1 id=conclusion>Conclusion
<a class=header-link href=#conclusion><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Someone recently asked me about this, so I decided to write about it. There you go <code>Reviewer #2</code>, I did my duty.</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Parsia</span></span>
<time>Dec 17, 2018</time></span></p><p class=meta><a class="basic-alignment left" href=https://parsiya.net/blog/2018-12-11-tiredful-api-part-1-burp-session-validation-with-macros/ title="Tiredful API - Part 1 - Burp Session Validation with Macros">Tiredful API - Part 1 - Burp Session Validation with Macros</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2018-12-19-python-utility-modules-for-burp-extensions/ title="Python Utility Modules for Burp Extensions">Python Utility Modules for Burp Extensions</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//parsiya.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I?</h1><p><p>I am Parsia, an application security engineer.</p><p>I write about application security, cryptography, static analysis, and
(of course) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more.</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="me noopener noreferrer" href=https://infosec.exchange/@parsiya title=https://infosec.exchange/@parsiya><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><h1>Collections</h1><li><a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a></li><li><a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a></li><li><a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a></li><li><a href=https://parsiya.net/categories/semgrep/ title=Semgrep>Semgrep</a></li><li><a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a></li><li><a href=https://parsiya.net/categories/blockchain/ title="Blockchain (lol)">Blockchain (lol)</a></li><li><a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a></li><li><a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a></li><li><a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a></li><li><a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a></li><li><a href=https://parsiya.net/categories/winappdbg/ title="WinAppDbg (use Frida instead)">WinAppDbg (use Frida instead)</a></li><li><a href=https://awsome.pw title='AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability'>AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability</a></li></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2023 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>