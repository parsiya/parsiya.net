<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Using Mozilla Rhino to Run JavaScript in Java</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.net/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia"><meta name=generator content="Hugo 0.149.0"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content="https://parsiya.net/blog/2019-12-22-using-mozilla-rhino-to-run-javascript-in-java/01-beautified.png"><meta name=twitter:title content="Using Mozilla Rhino to Run JavaScript in Java"><meta name=twitter:description content="This post discusses what I learned about executing JavaScript code in Java
with Mozilla Rhino. By the end of this post, you will know:

What Rhino is.
How to use Rhino in your Java application (e.g., a Burp extension).
Some tips and tricks when dealing with Rhino.
Alternative options to using Rhino.

Code is at:

https://github.com/parsiya/Parsia-Code/tree/master/java-rhino
"><meta name=twitter:domain content="parsiya.net"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select></fieldset><ul class=main-navigation><li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription><a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Dec 22, 2019
- 8 minute read - <a class=label href=https://parsiya.net/categories/burp/>Burp </a><a class=label href=https://parsiya.net/categories/burp-extension/>Burp extension</a></p><h1 class=entry-title>Using Mozilla Rhino to Run JavaScript in Java</h1></header><div class=entry-content><p>This post discusses what I learned about executing JavaScript code in Java
with Mozilla Rhino. By the end of this post, you will know:</p><ol><li>What Rhino is.</li><li>How to use Rhino in your Java application (e.g., a Burp extension).</li><li>Some tips and tricks when dealing with Rhino.</li><li>Alternative options to using Rhino.</li></ol><p>Code is at:</p><ul><li><a href=https://github.com/parsiya/Parsia-Code/tree/master/java-rhino target=_blank rel="noreferrer noopener">https://github.com/parsiya/Parsia-Code/tree/master/java-rhino</a></li></ul><h1 id=whats-mozilla-rhino>What's Mozilla Rhino?
<a class=header-link href=#whats-mozilla-rhino><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><a href=https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino target=_blank rel="noreferrer noopener">Mozilla Rhino</a> is an open-source implementation of JavaScript in
Java. In other words, we can run JavaScript on the JVM.</p><h1 id=beautifying-javascript-with-rhino>Beautifying JavaScript with Rhino
<a class=header-link href=#beautifying-javascript-with-rhino><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>As part of a different project, I wanted to beautify JavaScript in Burp. The
extension is in Java and I could not find anything that does it in native Java.
The closest thing I could find was a <code>java-prettify</code> from Google at
<a href=https://gerrit.googlesource.com/java-prettify/ target=_blank rel="noreferrer noopener">https://gerrit.googlesource.com/java-prettify/</a>.</p><p>There is a Burp extension named <a href=https://github.com/irsdl/BurpSuiteJSBeautifier target=_blank rel="noreferrer noopener">BurpSuiteJSBeautifier</a>
that beautifies JavaScript. This extension along with most utilities use an
open-source library named <a href=https://github.com/beautify-web/js-beautify target=_blank rel="noreferrer noopener">js-beautify</a>. I did not try the
extension to see if it still works (the last update was more than 6 years ago)
but when I modified it in my example application, I got an error.</p><p>If your extension is in Python, <code>js-beautify</code> has
<a href=https://github.com/beautify-web/js-beautify#python target=_blank rel="noreferrer noopener">Python bindings</a>.</p><p>For the remainder of the blog, I will work on an example that reads minified
JavaScript from a file, beautifies it, and stores it in another file.</p><h2 id=adding-rhino-to-the-java-application>Adding Rhino to The Java Application
<a class=header-link href=#adding-rhino-to-the-java-application><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Let's start with a skeleton project. This is not a Burp extension but we can use
the instructions from
<a href=/blog/2019-12-02-developing-and-debugging-java-burp-extensions-with-visual-studio-code/ title="Developing and Debugging Java Burp Extensions with VisualStudio Code">Developing and Debugging Java Burp Extensions with VisualStudio Code</a>.</p><p>Our <code>build.gradle</code> is different this time because we are making a standalone
application. The most important parts are:</p><ul><li>Adding Rhino as a dependency with <code>compile 'org.mozilla:rhino:1.7.11'</code>.</li><li>Creating the <code>Main-Class</code> attribute to be able to do <code>java -jar whatever.jar</code>.</li></ul><p>See the comments to figure out what was changed.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#586e75>// Apply the application plugin (runs the &#39;java&#39; plugin implicitly).</span>
</span></span><span style=display:flex><span>apply plugin: &#39;application&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// Use Maven (because Burp Extender is on Maven)</span>
</span></span><span style=display:flex><span>repositories {
</span></span><span style=display:flex><span>    mavenCentral()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dependencies {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Add the Burp Extender interface</span>
</span></span><span style=display:flex><span>    compile &#39;org.mozilla:rhino:1.7.11&#39;
</span></span><span style=display:flex><span>    compile &#39;commons<span style=color:#719e07>-</span>io:commons<span style=color:#719e07>-</span>io:2.6&#39;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sourceSets {
</span></span><span style=display:flex><span>    main {
</span></span><span style=display:flex><span>        java {
</span></span><span style=display:flex><span>            <span style=color:#586e75>// Set the source directory to &#34;src&#34;</span>
</span></span><span style=display:flex><span>            srcDir &#39;src&#39;
</span></span><span style=display:flex><span>            exclude &#39;resources<span style=color:#719e07>/</span>&#39;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    main {
</span></span><span style=display:flex><span>        resources {
</span></span><span style=display:flex><span>            <span style=color:#586e75>// Set the resource directory to &#34;src/resources&#34;</span>
</span></span><span style=display:flex><span>            srcDir &#39;src<span style=color:#719e07>/</span>resources&#39;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// Put the final jar file in a different location</span>
</span></span><span style=display:flex><span>libsDirName <span style=color:#719e07>=</span> &#39;..<span style=color:#719e07>/</span>release&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// This is needed if we want to run the jar with &#34;gradlew run&#34;</span>
</span></span><span style=display:flex><span><span style=color:#586e75>// mainClassName = &#39;beautify.Beautify&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// Create a task for bundling all dependencies into a jar file.</span>
</span></span><span style=display:flex><span>task <span style=color:#268bd2>bigJar</span>(type: Jar) {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Make an executable jar that can be executed with &#34;java -jar&#34;</span>
</span></span><span style=display:flex><span>    manifest {
</span></span><span style=display:flex><span>        attributes(
</span></span><span style=display:flex><span>                &#39;Main<span style=color:#719e07>-</span>Class&#39;: &#39;beautify.Beautify&#39;
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Bundle all dependencies together in one jar file.</span>
</span></span><span style=display:flex><span>    baseName <span style=color:#719e07>=</span> project.name <span style=color:#719e07>+</span> &#39;<span style=color:#719e07>-</span>all&#39;
</span></span><span style=display:flex><span>    from { configurations.compile.collect { it.isDirectory() <span style=color:#719e07>?</span> it : zipTree(it) } }
</span></span><span style=display:flex><span>    with jar
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=beautifyjs>beautify.js
<a class=header-link href=#beautifyjs><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>There are different versions of the beautifier. We can use it as Node or Python
package and there is a <a href=https://github.com/beautify-web/js-beautify#web-library target=_blank rel="noreferrer noopener">web version</a> in a stand-alone
JavaScript file. This is the version used by the <code>BurpSuiteJSBeautifier</code>
extension and we will use it. Get it from
<a href=https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.10.2/beautify.js target=_blank rel="noreferrer noopener">https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.10.2/beautify.js</a> and add it
to the <code>resources</code> directory.</p><h2 id=reading-resource-files>Reading Resource Files
<a class=header-link href=#reading-resource-files><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><code>src\Beautify\beautify.java</code> will be our main class. Inside, we
create a couple of helper utils. For example, to load a file from the jar's
resource, we use this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> String <span style=color:#268bd2>getResourceFile</span>(Class cls, String name) <span style=color:#268bd2>throws</span> IOException {
</span></span><span style=display:flex><span>    InputStream in <span style=color:#719e07>=</span> cls.getResourceAsStream(name);
</span></span><span style=display:flex><span>    String content <span style=color:#719e07>=</span> IOUtils.toString(in, <span style=color:#2aa198>&#34;UTF-8&#34;</span>);
</span></span><span style=display:flex><span>    in.close();
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> content;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If you are already using the <a href=https://github.com/apache/commons-io target=_blank rel="noreferrer noopener">Apache Commons IO</a> library then
this function is not an overhead. The following utility function does the same
but without the extra dependency.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> String <span style=color:#268bd2>getResourceFile</span>(String name) <span style=color:#268bd2>throws</span> IOException {
</span></span><span style=display:flex><span>    InputStream in <span style=color:#719e07>=</span> BurpExtender.class.getResourceAsStream(name); 
</span></span><span style=display:flex><span>    BufferedReader reader <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> BufferedReader(<span style=color:#719e07>new</span> InputStreamReader(in));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    StringBuffer buf <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> StringBuffer();
</span></span><span style=display:flex><span>    String tmpStr <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>while</span>((tmpStr <span style=color:#719e07>=</span> reader.readLine()) <span style=color:#719e07>!=</span> <span style=color:#cb4b16>null</span>) {
</span></span><span style=display:flex><span>        buf.append(tmpStr);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    in.close();
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> buf.toString();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=beautify-function>Beautify Function
<a class=header-link href=#beautify-function><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The other utility function is <code>beautify</code>. It uses <code>beautify.js</code> to beautify the
JavaScript code in the input. We will follow the Mozilla embedding
tutorial at
<a href=https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Embedding_tutorial target=_blank rel="noreferrer noopener">https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Embedding_tutorial</a>.</p><p>We create a context and enter it.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> String <span style=color:#268bd2>beautify</span>(String uglyJS) <span style=color:#268bd2>throws</span> IOException {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Enter a context.</span>
</span></span><span style=display:flex><span>    Context cx <span style=color:#719e07>=</span> Context.enter();
</span></span></code></pre></div><p>We can set the optimization level. The optimization levels are explained at
<a href=https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Optimization target=_blank rel="noreferrer noopener">https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Optimization</a>. I
am not sure if we will need it here.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#586e75>// Set optimization.</span>
</span></span><span style=display:flex><span><span style=color:#586e75>// cx.setOptimizationLevel(-1);</span>
</span></span></code></pre></div><p>Create standard objects.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#586e75>// Initialize standard objects.</span>
</span></span><span style=display:flex><span>Scriptable scope <span style=color:#719e07>=</span> cx.initSafeStandardObjects();
</span></span></code></pre></div><p>Moving forward, we can add scripts to the scope with
<a href=http://mozilla.github.io/rhino/javadoc/org/mozilla/javascript/Context.html#evaluateString-org.mozilla.javascript.Scriptable-java.lang.String-java.lang.String-int-java.lang.Object- target=_blank rel="noreferrer noopener">cx.evaluateString</a>.</p><p>Follow the BurpSuiteJSBeautifier extension source code at</p><ul><li><a href=https://github.com/irsdl/BurpSuiteJSBeautifier/blob/master/jsbeautifier/src/burp/JSBeautifier/JSBeautifierFunctions.java#L321 target=_blank rel="noreferrer noopener">https://github.com/irsdl/BurpSuiteJSBeautifier/blob/master/jsbeautifier/src/burp/JSBeautifier/JSBeautifierFunctions.java#L321</a></li><li>or this solution on <a href=https://stackoverflow.com/a/16338524 target=_blank rel="noreferrer noopener">Stack Overflow</a>.</li></ul><p>Tl;DR, we need to add a <code>global</code> variable to our scope because the <code>js_beautify</code>
function is added to the global variable. See the last few lines of
<code>beautify.js</code> in the following snippet:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#268bd2>var</span> js_beautify <span style=color:#719e07>=</span> legacy_beautify_js;
</span></span><span style=display:flex><span><span style=color:#586e75>/* Footer */</span>
</span></span><span style=display:flex><span><span style=color:#719e07>if</span> (<span style=color:#719e07>typeof</span> define <span style=color:#719e07>===</span> <span style=color:#2aa198>&#34;function&#34;</span> <span style=color:#719e07>&amp;&amp;</span> define.amd) {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Add support for AMD ( https://github.com/amdjs/amdjs-api/wiki/AMD#defineamd-property- )
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    define([], <span style=color:#268bd2>function</span>() {
</span></span><span style=display:flex><span>        <span style=color:#719e07>return</span> { js_beautify<span style=color:#719e07>:</span> js_beautify };
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>} <span style=color:#719e07>else</span> <span style=color:#719e07>if</span> (<span style=color:#719e07>typeof</span> exports <span style=color:#719e07>!==</span> <span style=color:#2aa198>&#34;undefined&#34;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Add support for CommonJS. Just put this file somewhere on your require.paths
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#586e75>// and you will be able to `var js_beautify = require(&#34;beautify&#34;).js_beautify`.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    exports.js_beautify <span style=color:#719e07>=</span> js_beautify;
</span></span><span style=display:flex><span>} <span style=color:#719e07>else</span> <span style=color:#719e07>if</span> (<span style=color:#719e07>typeof</span> <span style=color:#b58900>window</span> <span style=color:#719e07>!==</span> <span style=color:#2aa198>&#34;undefined&#34;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// If we&#39;re running a web page and don&#39;t have either of the above, add our one global
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#b58900>window</span>.js_beautify <span style=color:#719e07>=</span> js_beautify;
</span></span><span style=display:flex><span>} <span style=color:#719e07>else</span> <span style=color:#719e07>if</span> (<span style=color:#719e07>typeof</span> global <span style=color:#719e07>!==</span> <span style=color:#2aa198>&#34;undefined&#34;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// If we don&#39;t even have window, try global.
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    global.js_beautify <span style=color:#719e07>=</span> js_beautify; <span style=color:#586e75>// &lt;----- HERE
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>}
</span></span></code></pre></div><p>Now we need to read <code>beautify.js</code> with <code>getResourceFile</code> and add it to the
scope.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#586e75>// Read the jsbeautify.js file.</span>
</span></span><span style=display:flex><span>String jsbeautifyFile <span style=color:#719e07>=</span> getResourceFile(Beautify.class, <span style=color:#2aa198>&#34;/beautify.js&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cx.evaluateString(scope, <span style=color:#2aa198>&#34;var global = {}; &#34;</span><span style=color:#719e07>+</span>jsbeautifyFile, <span style=color:#2aa198>&#34;global&#34;</span>, 0, <span style=color:#cb4b16>null</span>);
</span></span></code></pre></div><p>Note the initial forward slash in the file name <code>/beautify.js</code>. This wasted a
few hours of my life.</p><p>Next is what wasted a few more hours of my life. In both the Burp extension and
the Stack Overflow solution, the function is retrieved from the scope directly
like this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#586e75>// Solution: https://stackoverflow.com/a/16338524 -- doesn&#39;t work</span>
</span></span><span style=display:flex><span>Object fjsBeautify <span style=color:#719e07>=</span> scope.get(<span style=color:#2aa198>&#34;js_beautify&#34;</span>, scope);
</span></span></code></pre></div><p><strong>This does not work here.</strong> I am not sure why. It might be a JavaScript version
issue. Even calling it with <code>global.js_beautify</code> does not work either.</p><p>Instead, what I did was add a new script to scope.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#586e75>// Add our own export.</span>
</span></span><span style=display:flex><span>cx.evaluateString(scope, <span style=color:#2aa198>&#34;var js_beautify = global.js_beautify;&#34;</span>, <span style=color:#2aa198>&#34;export&#34;</span>, 0, <span style=color:#cb4b16>null</span>);
</span></span></code></pre></div><p>We can get this new function with:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#586e75>// Get the function.</span>
</span></span><span style=display:flex><span>Object fjsBeautify <span style=color:#719e07>=</span> scope.get(<span style=color:#2aa198>&#34;js_beautify&#34;</span>, scope);
</span></span></code></pre></div><p>We can follow the rest of the tutorial to call the function. The input to the
function is the <code>uglyJS</code> string:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#586e75>// Check to see if we got the correct function?</span>
</span></span><span style=display:flex><span><span style=color:#719e07>if</span> (<span style=color:#719e07>!</span>(fjsBeautify <span style=color:#719e07>instanceof</span> Function)) {
</span></span><span style=display:flex><span>    System.out.println(<span style=color:#2aa198>&#34;js_beautify is undefined or not a function.&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#586e75>// System.out.println(fjsBeautify.toString());</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>} <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>    Object functionArgs<span style=color:#719e07>[]</span> <span style=color:#719e07>=</span> { uglyJS };
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Object functionArgs[] = { &#34;var x=&#39;1234&#39;;var y=&#39;4444&#39;;var z=&#39;3123123&#39;;&#34; };</span>
</span></span><span style=display:flex><span>    Function f <span style=color:#719e07>=</span> (Function)fjsBeautify;
</span></span><span style=display:flex><span>    Object result <span style=color:#719e07>=</span> f.call(cx, scope, scope, functionArgs);
</span></span><span style=display:flex><span>    Context.exit();
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> Context.toString(result);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#586e75>// We should throw an exception here in production code.</span>
</span></span><span style=display:flex><span>Context.exit();
</span></span><span style=display:flex><span><span style=color:#719e07>return</span> <span style=color:#cb4b16>null</span>;
</span></span></code></pre></div><p>The next utility function takes two file paths, reads the first one, beautifies
it and stores it in the second path.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>beautifyFile</span>(String inFilePath, String outFilePath) <span style=color:#268bd2>throws</span> IOException {
</span></span><span style=display:flex><span>    <span style=color:#586e75>// Read the file.</span>
</span></span><span style=display:flex><span>    File inFile <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> File(inFilePath);
</span></span><span style=display:flex><span>    String fileContent <span style=color:#719e07>=</span> FileUtils.readFileToString(inFile, <span style=color:#2aa198>&#34;UTF-8&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    File outFile <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> File(outFilePath);
</span></span><span style=display:flex><span>    <span style=color:#719e07>try</span> {
</span></span><span style=display:flex><span>        String beautified <span style=color:#719e07>=</span> beautify(fileContent);
</span></span><span style=display:flex><span>        FileUtils.writeStringToFile(outFile, beautified, <span style=color:#2aa198>&#34;UTF-8&#34;</span>);
</span></span><span style=display:flex><span>    } <span style=color:#719e07>catch</span> (Exception e) {
</span></span><span style=display:flex><span>        <span style=color:#586e75>// TODO: handle exception</span>
</span></span><span style=display:flex><span>        StringWriter sw <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> StringWriter();
</span></span><span style=display:flex><span>        e.printStackTrace(<span style=color:#719e07>new</span> PrintWriter(sw));
</span></span><span style=display:flex><span>        System.out.println(sw.toString());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Time to tie everything together. As an example, we want to beautify the
<code>cookiebanner.min.js</code> at:</p><ul><li><a href=https://raw.githubusercontent.com/dobarkod/cookie-banner/master/dist/cookiebanner.min.js target=_blank rel="noreferrer noopener">https://raw.githubusercontent.com/dobarkod/cookie-banner/master/dist/cookiebanner.min.js</a></li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#268bd2>public</span> <span style=color:#268bd2>static</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>main</span>(String<span style=color:#719e07>[]</span> args) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#719e07>try</span> {
</span></span><span style=display:flex><span>            beautifyFile(<span style=color:#2aa198>&#34;cookiebanner.min.js&#34;</span>, <span style=color:#2aa198>&#34;cookie-beautified.js&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#719e07>catch</span> (Exception e) {
</span></span><span style=display:flex><span>            e.printStackTrace();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        System.out.println(<span style=color:#2aa198>&#34;Done&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Build the project. The jar will be created in the <code>release</code> directory. Download
the <code>cookiebanner.min.js</code> file and store it in the same directory. Next, we can
run the jar file <code>java -jar test-jsbeautify-all.jar</code>.</p><p>After a few seconds, the <code>cookie-beautified.js</code> is created.</p><span class=caption-wrapper><img class=caption src=01-beautified.png title="Beautified JavaScript" alt="Beautified JavaScript">
<span class=caption-text>Beautified JavaScript</span></span><p>To speed up things a little bit, we can modify <code>beautify.js</code> to call
<code>evaluateString</code> once.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#268bd2>var</span> global <span style=color:#719e07>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>// Beautify.js
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>
</span></span><span style=display:flex><span><span style=color:#268bd2>var</span> js_beautify <span style=color:#719e07>=</span> global.js_beautify;
</span></span></code></pre></div><h2 id=re-using-the-scope>Re-using the scope
<a class=header-link href=#re-using-the-scope><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>If we want to beautify a bunch of JavaScript files, we can reuse this scope
instead of creating this every time. This is what the BurpSuiteJSBeautifier
extension does.</p><h1 id=precompiling-to-bytecode>Precompiling to Bytecode
<a class=header-link href=#precompiling-to-bytecode><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>It's also possible to compile the string into a class file and then execute it.
To make a class file, we can do it programmatically with
<a href=http://mozilla.github.io/rhino/javadoc/org/mozilla/javascript/Context.html#compileString-java.lang.String-java.lang.String-int-java.lang.Object- target=_blank rel="noreferrer noopener">Context.compileString</a>. The result is a <a href=http://mozilla.github.io/rhino/javadoc/org/mozilla/javascript/Script.html target=_blank rel="noreferrer noopener">Script</a>
that can be executed with <code>exec</code>. In this case, <code>exec</code> will the equivalent of
<code>evaluateString</code>.</p><p>So for <code>beautify.js</code> we can also use:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Script scr <span style=color:#719e07>=</span> cx.compileString(jsbeautifyFile, <span style=color:#2aa198>&#34;beautify.js&#34;</span>, 0, <span style=color:#cb4b16>null</span>);
</span></span><span style=display:flex><span>scr.exec(cx, scope);
</span></span><span style=display:flex><span>Object fjsBeautify <span style=color:#719e07>=</span> scope.get(<span style=color:#2aa198>&#34;beautify&#34;</span>, scope);
</span></span></code></pre></div><h2 id=creating-class-files-from-javascript-files>Creating Class Files from JavaScript Files
<a class=header-link href=#creating-class-files-from-javascript-files><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We can create a class file from a JavaScript file using the Rhino jar.</p><ol><li>Download the Rhino jar file to a path.<ol><li>E.g., <code>rhino-1.7.11.jar</code> from <a href=https://github.com/mozilla/rhino/releases/tag/Rhino1_7_11_Release target=_blank rel="noreferrer noopener">https://github.com/mozilla/rhino/releases/tag/Rhino1_7_11_Release</a>.</li></ol></li><li>Run the following command.<ol><li><code>java -cp rhino-1.7.11.jar org.mozilla.javascript.tools.jsc.Main beautify.js</code></li></ol></li><li>Load the resulting class file and use objects/functions/etc.</li></ol><p>See the options at:</p><ul><li><a href=https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/JavaScript_Compiler target=_blank rel="noreferrer noopener">https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/JavaScript_Compiler</a></li></ul><p>I have not been able to load the compiled strings in Rhino and execute them yet.</p><h2 id=js_beautify-options>js_beautify Options
<a class=header-link href=#js_beautify-options><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The <code>js_beautify</code> function has a second optional parameter. This is a JSON
string with options. See an example at:</p><ul><li><a href=https://github.com/beautify-web/js-beautify#nodejs-javascript-1 target=_blank rel="noreferrer noopener">https://github.com/beautify-web/js-beautify#nodejs-javascript-1</a></li></ul><h1 id=alternatives>Alternatives
<a class=header-link href=#alternatives><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Instead of using Rhino, it's possible to call <code>js-beautify</code> via the command
line. This method requires the <a href=https://www.npmjs.com/package/js-beautify target=_blank rel="noreferrer noopener">https://www.npmjs.com/package/js-beautify</a> to be
installed globally or your Java code should point to
<code>node_modules/.bin/js-beautify</code>.</p><p>Then we can call <code>js-beautify -f inputfile -o output-file</code>.</p><p>Another option is to create an executable using <a href=https://github.com/zeit/pkg target=_blank rel="noreferrer noopener">https://github.com/zeit/pkg</a>.
This means we do not need to install the package. The executable size on Windows
is around 40 MBs.</p><p>These two might be better your use case. However, that means you have to create
the dependencies yourself and or ship them with your app.</p><h1 id=what-did-we-learn-here-today>What Did We Learn Here Today?
<a class=header-link href=#what-did-we-learn-here-today><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><ol><li>How to add Rhino to your project.</li><li>How to read resources inside jar files.</li><li>How to run a JavaScript function in Rhino.</li><li>Troubleshooting tips and tricks.</li></ol></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Parsia</span></span><time>Dec 22, 2019</time>
<span class=categories>Tags:<a class=category href=https://parsiya.net/tags/java>Java</a> <a class=category href=https://parsiya.net/tags/rhino>Rhino</a></span></p><p class=meta><a class="basic-alignment left" href=https://parsiya.net/blog/2019-12-02-developing-and-debugging-java-burp-extensions-with-visual-studio-code/ title="Developing and Debugging Java Burp Extensions with Visual Studio Code">Developing and Debugging Java Burp Extensions with Visual Studio Code</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2020-01-15-some-sans-holiday-hack-2019-solutions/ title="Some SANS Holiday Hack 2019 Solutions">Some SANS Holiday Hack 2019 Solutions</a></p></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I?</h1><p><p>I am Parsia, a security engineer at Microsoft.</p><p>I write about application security, cryptography, static analysis, and
(of course) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more. Contact me via any of these ways.</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="me noopener noreferrer" href=https://infosec.exchange/@parsiya title=https://infosec.exchange/@parsiya><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><h1>Collections</h1><li><a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a></li><li><a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a></li><li><a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a></li><li><a href=https://parsiya.net/categories/static-analysis/ title="Static Analysis">Static Analysis</a></li><li><a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a></li><li><a href=https://parsiya.net/categories/blockchain/ title="Blockchain (lol)">Blockchain (lol)</a></li><li><a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a></li><li><a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a></li><li><a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a></li><li><a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a></li><li><a href=https://parsiya.net/categories/winappdbg/ title="WinAppDbg (use Frida instead)">WinAppDbg (use Frida instead)</a></li><li><a href=https://awsome.pw title='AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability'>AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability</a></li></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2025 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>