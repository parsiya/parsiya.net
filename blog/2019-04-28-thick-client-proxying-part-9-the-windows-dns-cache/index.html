<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Thick Client Proxying - Part 9 - The Windows DNS Cache</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.net/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia"><meta name=generator content="Hugo 0.148.1"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content="https://parsiya.net/blog/2019-04-28-thick-client-proxying-part-9-the-windows-dns-cache/05.png"><meta name=twitter:title content="Thick Client Proxying - Part 9 - The Windows DNS Cache"><meta name=twitter:description content="This post explains a trick that I have been using for a few years to discover
application endpoints on Windows quickly.
It's a simple trick:

Clear the DNS cache.
Take a snapshot of the cache.
Run the application and use different functionalities.
Take another snapshot of the cache.
Compare these two snapshots.
???
Discover (most) endpoints.

Code is at:

https://github.com/parsiya/Parsia-Code/tree/master/dns-cache
"><meta name=twitter:domain content="parsiya.net"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select></fieldset><ul class=main-navigation><li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription><a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Apr 28, 2019
- 5 minute read - <a class=label href=https://parsiya.net/categories/thick-client-proxying/>Thick client proxying</a></p><h1 class=entry-title>Thick Client Proxying - Part 9 - The Windows DNS Cache</h1></header><div class=entry-content><nav id=TableOfContents><ul><li><a href=#discovering-endpoints>Discovering Endpoints</a></li><li><a href=#the-dns-cache>The DNS Cache</a></li><li><a href=#creating-a-pasteops-prototype>Creating a PasteOps Prototype</a><ul><li><a href=#pasteops-v10>PasteOps v1.0</a><ul><li><a href=#the-ping-step>The Ping Step</a></li></ul></li><li><a href=#what-does-get-dnsclientcache-return>What does Get-DnsClientCache Return?</a><ul><li><a href=#output-format>Output Format</a></li></ul></li><li><a href=#compare-object-output>Compare-Object Output</a></li><li><a href=#pasteops-v20>PasteOps v2.0</a></li></ul></li><li><a href=#powershell-script>PowerShell Script</a></li><li><a href=#limitations>Limitations</a></li><li><a href=#what-did-we-learn-here-today>What Did We Learn Here Today?</a></li></ul></nav><p>This post explains a trick that I have been using for a few years to discover
application endpoints on Windows quickly.</p><p>It's a simple trick:</p><ol><li>Clear the DNS cache.</li><li>Take a snapshot of the cache.</li><li>Run the application and use different functionalities.</li><li>Take another snapshot of the cache.</li><li>Compare these two snapshots.</li><li>???</li><li>Discover (most) endpoints.</li></ol><p>Code is at:</p><ul><li><a href=https://github.com/parsiya/Parsia-Code/tree/master/dns-cache target=_blank rel="noreferrer noopener">https://github.com/parsiya/Parsia-Code/tree/master/dns-cache</a></li></ul><p><strong>Update May 2020</strong>: If you are doing this in a Hyper-V guest virtual machine,
it will not work. The default DNS server for a Hyper-V guest is the server. And
it does not populate the local DNS cache (I do not know the reason). The fix is
to manually configure a DNS server (e.g., <code>8.8.8.8</code>) in the guest's network
adapter.</p><span class=caption-wrapper><img class=caption src=08-hyperv-issue.png title="Results in a Hyper-V guest with the default DNS server" alt="Results in a Hyper-V guest with the default DNS server">
<span class=caption-text>Results in a Hyper-V guest with the default DNS server</span></span><h1 id=discovering-endpoints>Discovering Endpoints
<a class=header-link href=#discovering-endpoints><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Discovering application endpoints is one of the starting steps in thick client
proxying. I have written about it so many times that I will just make a list
here. Off the top of my head I can think of:</p><ol><li>Netmon or Microsoft Message Analyzer<ul><li>These tools isolate traffic by pid.</li></ul></li><li>Procmon (Process Monitor)<ul><li>Filter by process name and then <code>TCP/UDP Connect/Send/Receive</code>.</li></ul></li><li>Procexp (Process Explorer)<ul><li>The TCP/IP tab.</li></ul></li><li>TCP Catcher or 3rd party other tools.</li></ol><h1 id=the-dns-cache>The DNS Cache
<a class=header-link href=#the-dns-cache><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>You can interact with the DNS cache in different ways. Most common ways are:</p><ul><li><a href=https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/ipconfig target=_blank rel="noreferrer noopener">ipconfig</a><ul><li>View : <code>ipconfig /displaydns</code></li><li>Clear: <code>ipconfig /flushdns</code></li></ul></li><li>PowerShell<ul><li>View : <a href=https://docs.microsoft.com/en-us/powershell/module/dnsclient/get-dnsclientcache target=_blank rel="noreferrer noopener">Get-DnsClientCache</a></li><li>Clear: <a href=https://docs.microsoft.com/en-us/powershell/module/dnsclient/clear-dnsclientcache target=_blank rel="noreferrer noopener">Clear-DnsClientCache</a></li></ul></li></ul><h1 id=creating-a-pasteops-prototype>Creating a PasteOps Prototype
<a class=header-link href=#creating-a-pasteops-prototype><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>We will use PowerShell because the output of commands are objects. We can format
the output at-will.</p><h2 id=pasteops-v10>PasteOps v1.0
<a class=header-link href=#pasteops-v10><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The first iteration of our commands is completely manual. We copy/paste the
following command into the PowerShell console (or ISE during development):</p><ol><li><code>Clear-DnsClientCache</code></li><li>Start Google Chrome or <code>ping google.com</code><ul><li>I will explaint the reason for this step below.</li></ul></li><li><code>$dns1 = Get-DnsClientCache</code></li><li>Navigate to <a href=https://example.net target=_blank rel="noreferrer noopener">https://example.net</a>.</li><li><code>$dns2 = Get-DnsClientCache</code></li><li><code>Compare-Object -ReferenceObject $dns2 -DifferenceObject $dns1</code></li></ol><span class=caption-wrapper><img class=caption src=01.png title="Results of PasteOps" alt="Results of PasteOps">
<span class=caption-text>Results of PasteOps</span></span><p>We have successfully discovered that the thick client (browser) has contacted
<code>example.net</code>.</p><h3 id=the-ping-step>The Ping Step
<a class=header-link href=#the-ping-step><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>In a real scenario, we want to clear the cache just right before starting the
application. In our PasteOps, <code>$dns1</code> might be empty if we call it just
right after clearing the cache and that will return an error when doing the
compare.</p><span class=caption-wrapper><img class=caption src=02.png title="Error when comparing with a null result" alt="Error when comparing with a null result">
<span class=caption-text>Error when comparing with a null result</span></span><h2 id=what-does-get-dnsclientcache-return>What does Get-DnsClientCache Return?
<a class=header-link href=#what-does-get-dnsclientcache-return><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Looking at the <a href=https://docs.microsoft.com/en-us/powershell/module/dnsclient/get-dnsclientcache target=_blank rel="noreferrer noopener">Get-DnsClientCache</a> documentation, we can see it
returns <a href="https://msdn.microsoft.com/en-us/library/hh872334%28v=vs.85%29.aspx" target=_blank rel="noreferrer noopener">MSFT_DnsClientCache</a>:</p><pre tabindex=0><code>class MSFT_DNSClientCache : CIM_ManagedElement
{
  string InstanceId;
  string Caption;
  string Description;
  string ElementName;
  string Entry;
  string Name;
  uint16 Type;
  uint32 TimeToLive;
  uint16 DataLength;
  uint8  Section;
  string Data;
  uint32 Status;
};
</code></pre><p>As we will see later, not all fields are populated for every record.</p><h3 id=output-format>Output Format
<a class=header-link href=#output-format><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h3><p>Table output in PowerShell is usually truncated but we can format the output
as objects unlike Bash<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p><a href=https://docs.microsoft.com/en-us/powershell/scripting/samples/using-format-commands-to-change-output-view target=_blank rel="noreferrer noopener">Using Format Commands to Change Output View</a> is a good
introduction to different output formats.</p><p>We can use <code>Format-Table</code> to get the output in a table and see truncated
results (it's fixable):</p><ul><li><code>Get-DnsClientCache | Format-Table</code></li></ul><span class=caption-wrapper><img class=caption src=03.png title="Truncated results" alt="Truncated results">
<span class=caption-text>Truncated results</span></span><p>We probably don't need to see all the fields, let's modify our command:</p><ul><li><code>Get-DnsClientCache | Format-Table -Property Entry,RecordName,Data</code></li></ul><span class=caption-wrapper><img class=caption src=04.png title="RecordName does not exist" alt="RecordName does not exist">
<span class=caption-text>RecordName does not exist</span></span><p>Wait, what? <code>RecordName</code> column is in the original output but does not exist
here. You might have also observed that you could use tab-complete for
the other two field names (e.g., <code>-Pro [tab] Ent [tab]</code> to get
<code>-Property Entry</code>) but not <code>RecordName</code>.</p><p>We have to use field names based on the return value which is
<code>MSFT_DNSClientCache</code>.</p><ul><li><code>Get-DnsClientCache | Format-Table -Property Entry,Name,Type,Data</code></li></ul><span class=caption-wrapper><img class=caption src=05.png title="Columns based on object fields" alt="Columns based on object fields">
<span class=caption-text>Columns based on object fields</span></span><p>Some field values like <code>Type</code> are different from the original command
output. Objects have some default printing formats. See the following link for
a similar command:</p><ul><li><a href=http://www.viapowershell.com/2016/06/hidden-formatting.html target=_blank rel="noreferrer noopener">http://www.viapowershell.com/2016/06/hidden-formatting.html</a></li></ul><h2 id=compare-object-output>Compare-Object Output
<a class=header-link href=#compare-object-output><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>We have enough to write a PowerShell script to do the job. We can get the
output of both commands and then remove the duplicates with
<a href=https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/compare-object target=_blank rel="noreferrer noopener">Compare-Object</a>.</p><p>The output of <code>Compare-Object</code> is a <code>PSCustomObject</code> that wraps the original
object with a slide indicator.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$ <span style=color:#b58900>Compare-Object</span> -ReferenceObject <span style=color:#268bd2>$dns2</span> -DifferenceObject <span style=color:#268bd2>$dns1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>InputObject                                                        SideIndicator
</span></span><span style=display:flex><span>-----------                                                        -------------
</span></span><span style=display:flex><span>MSFT_DNSClientCache (Entry = <span style=color:#2aa198>&#34;example.net&#34;</span>, Name = <span style=color:#2aa198>&#34;example.net&#34;</span>)  &lt;=
</span></span></code></pre></div><p>The <code>-PassThru</code> switch will spit out the unwrapped objects.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>$ <span style=color:#b58900>Compare-Object</span> -ReferenceObject <span style=color:#268bd2>$dns2</span> -DifferenceObject <span style=color:#268bd2>$dns1</span> -PassThru
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Entry           RecordName      Record Status    Section TimeTo Data   Data
</span></span><span style=display:flex><span>                                <span style=color:#b58900>Type </span>                    Live   Length
</span></span><span style=display:flex><span>-----           ----------      ------ ------    ------- ------ ------ ----
</span></span><span style=display:flex><span>example.net     example.net     A      Success   Answer   <span style=color:#2aa198>77102</span>      <span style=color:#2aa198>4</span> <span style=color:#2aa198>93.184</span>.216.34
</span></span></code></pre></div><h2 id=pasteops-v20>PasteOps v2.0
<a class=header-link href=#pasteops-v20><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Wrapped objects are not useful here. Let's add <code>-PassThru</code> to our PasteOps.</p><figure class=code><figcaption><span>PasteOps v2.0</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#b58900>Clear-DnsClientCache</span>
</span></span><span style=display:flex><span><span style=color:#586e75># Obviously replace this if you are looking to trace example.net</span>
</span></span><span style=display:flex><span>ping example.net
</span></span><span style=display:flex><span><span style=color:#268bd2>$dns1</span> = <span style=color:#b58900>Get-DnsClientCache</span>
</span></span><span style=display:flex><span><span style=color:#586e75># Run the application.</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$dns2</span> = <span style=color:#b58900>Get-DnsClientCache</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Compare-Object</span> -ReferenceObject <span style=color:#268bd2>$dns2</span> -DifferenceObject <span style=color:#268bd2>$dns1</span> -PassThru</span></span></code></pre></td></tr></table></div></div></div></figure><p>We can directly work on objects and format the output in different ways or
export them with something like <a href=https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/export-csv target=_blank rel="noreferrer noopener">Export-Csv</a> for later use.</p><ul><li><a href=https://github.com/parsiya/Parsia-Code/blob/master/dns-cache/pasteops-v2.ps1 target=_blank rel="noreferrer noopener">https://github.com/parsiya/Parsia-Code/blob/master/dns-cache/pasteops-v2.ps1</a></li></ul><h1 id=powershell-script>PowerShell Script
<a class=header-link href=#powershell-script><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>The next step after PasteOps is combining all these commands into a PowerShell
script.</p><figure class=code><figcaption><span>Endpoint-Discovery v1.0</span></figcaption><div class=codewrapper><div class=highlight><div style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#b58900>Write-Output</span> <span style=color:#2aa198>&#34;Clearing the DNS cache&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Clear-DnsClientCache</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Write-Output</span> <span style=color:#2aa198>&#34;Pinging example.net to populate the DNS cache&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Invoke-Expression</span> <span style=color:#2aa198>&#34;ping example.net&#34;</span> | <span style=color:#b58900>Out-Null</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Write-Output</span> <span style=color:#2aa198>&#34;Creating a snapshot of the DNS cache&#34;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$dns_before</span> = <span style=color:#b58900>Get-DnsClientCache</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Read-Host</span> <span style=color:#2aa198>&#34;Start the application and interact with it. Press Enter when done&#34;</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Write-Output</span> <span style=color:#2aa198>&#34;Creating a snapshot of the DNS cache&#34;</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>$dns_after</span> = <span style=color:#b58900>Get-DnsClientCache</span>
</span></span><span style=display:flex><span><span style=color:#b58900>Compare-Object</span> -ReferenceObject <span style=color:#268bd2>$dns2</span> -DifferenceObject <span style=color:#268bd2>$dns1</span> -PassThru</span></span></code></pre></td></tr></table></div></div></div></figure><ul><li><a href=https://github.com/parsiya/Parsia-Code/blob/master/dns-cache/endpoint-discovery.ps1 target=_blank rel="noreferrer noopener">https://github.com/parsiya/Parsia-Code/blob/master/dns-cache/endpoint-discovery.ps1</a></li></ul><p>If we run the script and open up Google Chrome when prompted, we can see:</p><span class=caption-wrapper><img class=caption src=06.png title="Endpoints used by Google Chrome" alt="Endpoints used by Google Chrome">
<span class=caption-text>Endpoints used by Google Chrome</span></span><p>We can pass the command output (which is a list of objects) to pipes and
manipulate it:</p><span class=caption-wrapper><img class=caption src=07.png title="Manipulating command output" alt="Manipulating command output">
<span class=caption-text>Manipulating command output</span></span><h1 id=limitations>Limitations
<a class=header-link href=#limitations><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Any connection method that does not end up in the DNS cache is not discoverable
by this method. This usually happens when the application:</p><ul><li>Does its own DNS lookup.</li><li>Contacts the endpoint by IP.</li></ul><p>Full automation might be an issue. It's definitely feasible to integrate the
script into an automation framework and harvest the endpoints. It will miss
endpoints unless you know that your framework can call all application
functionality.</p><h1 id=what-did-we-learn-here-today>What Did We Learn Here Today?
<a class=header-link href=#what-did-we-learn-here-today><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><ol><li>We can use the Windows DNS cache to do endpoint discovery.</li><li>A simple PowerShell script allows us to collect this endpoints and spits out
objects that can be manipulated however you want.</li></ol><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Bash bashing.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Parsia</span></span><time>Apr 28, 2019</time>
<span class=categories>Tags:<a class=category href=https://parsiya.net/tags/powershell>powershell</a></span></p><p class=meta><a class="basic-alignment left" href=https://parsiya.net/blog/2019-04-21-disabling-burps-update-screen-part-1-analysis-and-failures/ title="Disabling Burp's Update Screen - Part 1 - Analysis and Failures">Disabling Burp's Update Screen - Part 1 - Analysis and Failures</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2019-06-18-chaining-three-bugs-to-get-rce-in-microsoft-attacksurfaceanalyzer/ title="Chaining Three Bugs to Get RCE in Microsoft AttackSurfaceAnalyzer">Chaining Three Bugs to Get RCE in Microsoft AttackSurfaceAnalyzer</a></p></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I?</h1><p><p>I am Parsia, a security engineer at Microsoft.</p><p>I write about application security, cryptography, static analysis, and
(of course) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more. Contact me via any of these ways.</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="me noopener noreferrer" href=https://infosec.exchange/@parsiya title=https://infosec.exchange/@parsiya><i class="fa fa-mastodon fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><h1>Collections</h1><li><a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a></li><li><a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a></li><li><a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a></li><li><a href=https://parsiya.net/categories/static-analysis/ title="Static Analysis">Static Analysis</a></li><li><a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a></li><li><a href=https://parsiya.net/categories/blockchain/ title="Blockchain (lol)">Blockchain (lol)</a></li><li><a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a></li><li><a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a></li><li><a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a></li><li><a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a></li><li><a href=https://parsiya.net/categories/winappdbg/ title="WinAppDbg (use Frida instead)">WinAppDbg (use Frida instead)</a></li><li><a href=https://awsome.pw title='AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability'>AWSome.pw - S3 bucket squatting - my very "legit" branded vulnerability</a></li></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2025 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>