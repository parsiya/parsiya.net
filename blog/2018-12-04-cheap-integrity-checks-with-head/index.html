<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Cheap Integrity Checks with HEAD</title><link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.net/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia"><meta name=generator content="Hugo 0.97.3"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image:src content="https://parsiya.net/blog/2018-12-04-cheap-integrity-checks-with-head/04-head.png"><meta name=twitter:title content="Cheap Integrity Checks with HEAD"><meta name=twitter:description content="tl;dr: HEAD returns file size in Content-Length response header.
A few months ago, I did a side project of creating a Go package for npm. It was before the current dumpster fire that is event-stream. The idea was to be able to query npm and get information and packages."><meta name=twitter:domain content="parsiya.net"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.net/>Hackerman's Hacking Tutorials</a></h1><h2>The knowledge of anything, since all things have causes, is not acquired or
complete unless it is known by its causes. - Avicenna</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://parsiya.net/about/>» About Me!</option><option value=https://parsiya.net/cheatsheet/>» Cheat Sheet</option><option value=https://parsiya.io/>» My Clone</option><option value=https://github.com/parsiya/parsiya.net>» Source Repo</option><option value="https://queue.acm.org/detail.cfm?id=3197520">» Manual Work is a Bug</option><option value="https://www.google.com/search?q=andrew+ridgeley">» The Other Guy from Wham!</option></select></fieldset><ul class=main-navigation><li><a href=https://parsiya.net/about/ title="About Me!" target=_blank rel="noopener noreferrer">About Me!</a></li><li><a href=https://parsiya.net/cheatsheet/ title="Cheat Sheet" target=_blank rel="noopener noreferrer">Cheat Sheet</a></li><li><a href=https://parsiya.io/ title="My Clone" target=_blank rel="noopener noreferrer">My Clone</a></li><li><a href=https://github.com/parsiya/parsiya.net title="Source Repo" target=_blank rel="noopener noreferrer">Source Repo</a></li><li><a href="https://queue.acm.org/detail.cfm?id=3197520" title="Manual Work is a Bug" target=_blank rel="noopener noreferrer">Manual Work is a Bug</a></li><li><a href="https://www.google.com/search?q=andrew+ridgeley" title="The Other Guy from Wham!" target=_blank rel="noopener noreferrer">The Other Guy from Wham!</a></li></ul><ul class=subscription><a href=https://parsiya.net/index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.net/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Dec 4, 2018
- 4 minute read
- <a href=https://parsiya.net/blog/2018-12-04-cheap-integrity-checks-with-head/#disqus_thread>Comments</a>
- <a class=label href=https://parsiya.net/categories/npm/>npm</a></p><h1 class=entry-title>Cheap Integrity Checks with HEAD</h1></header><div class=entry-content><p><strong>tl;dr:</strong> HEAD returns file size in <code>Content-Length</code> response header.</p><p>A few months ago, I did a side project of creating a Go package for npm. It was before the current dumpster fire that is <a href=https://github.com/dominictarr/event-stream/issues/116 target=_blank rel="noreferrer noopener">event-stream</a>. The idea was to be able to query npm and get information and packages.</p><h1 id=the-problem>The Problem
<a class=header-link href=#the-problem><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>As part of the metadata check, I wanted to see if a package's tarball size matches the size mentioned in the metadata. Downloading the file and checking the size works but is slow because the file has to be downloaded.</p><h1 id=the-solution>The Solution
<a class=header-link href=#the-solution><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Running <code>HEAD</code> on a tarball, does not return the file but the response will have the <code>Content-Length</code> header. The header will have the size of the file.</p><p>In <a href=https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.13 target=_blank rel="noreferrer noopener">RFC 2616 - Hypertext Transfer Protocol -- HTTP/1.1 - Section 14.13 Content-Length</a> we can read:</p><blockquote><p>The Content-Length entity-header field indicates [...] in the case of the HEAD method, the size of the entity-body that would have been sent had the request been a GET.</p></blockquote><h2 id=npm-registry-documentation>npm Registry Documentation
<a class=header-link href=#npm-registry-documentation><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>The npm APIs were a bit hard to find. Here's a link and you're welcome:</p><ul><li><a href=https://github.com/npm/registry target=_blank rel="noreferrer noopener">https://github.com/npm/registry</a></li></ul><p>Everyone seems to be using the app. 17K Github stars for the app and only 19 for the documentation. Github stars are how people rank themselves in the JS ecosystem right?</p><p>Hint: Hit me up if you want to do some supply chain attacks on the app itself.</p><h2 id=package-metadata>Package Metadata
<a class=header-link href=#package-metadata><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p><a href=https://github.com/npm/registry/blob/master/docs/responses/package-metadata.md#package-metadata target=_blank rel="noreferrer noopener">Full package metadata</a> can be access by sending a GET request to <code>https://{{registry_url}}/{{package_name}}</code> (if the package name is not unique, it will do a search but let's not worry about that). E.g. <a href=https://registry.npmjs.org/lodash target=_blank rel="noreferrer noopener">https://registry.npmjs.org/lodash</a>. <a href=https://www.npmjs.com/package/lodash target=_blank rel="noreferrer noopener">Lodash</a> is the most depended upon package according to <a href=https://www.npmjs.com/browse/depended target=_blank rel="noreferrer noopener">https://www.npmjs.com/browse/depended</a>.</p><span class=caption-wrapper><img class=caption src=01-lodash-metadata.png title="Lodash metadata" alt="Lodash metadata">
<span class=caption-text>Lodash metadata</span></span>
<span class=caption-wrapper><img class=caption src=02-lodash-burp.png title="Lodash full metadata in Burp" alt="Lodash full metadata in Burp">
<span class=caption-text>Lodash full metadata in Burp</span></span><p>Retrieve short package metadata by sending a GET request to the same URL but with the following header:</p><ul><li><code>Accept: application/vnd.npm.install-v1+json</code></li></ul><span class=caption-wrapper><img class=caption src=03-lodash-short.png title="Lodash short metadata in Burp" alt="Lodash short metadata in Burp">
<span class=caption-text>Lodash short metadata in Burp</span></span><p>You can see the tarball address in the screenshot.</p><ul><li><a href=http://registry.npmjs.org/lodash/-/lodash-0.1.0.tgz target=_blank rel="noreferrer noopener">http://registry.npmjs.org/lodash/-/lodash-0.1.0.tgz</a></li></ul><p>Note: While the addresses are <code>http</code>, npm registry will redirect them to <code>https</code>.</p><p>Now we can run <code>HEAD</code> to get the size.</p><span class=caption-wrapper><img class=caption src=04-head.png title="Also look at that fancy npm-notice header" alt="Also look at that fancy npm-notice header">
<span class=caption-text>Also look at that fancy npm-notice header</span></span><h2 id=the-bug>The Bug
<a class=header-link href=#the-bug><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>This has a <del>feature</del> bug. The header returns the size of the response. If the file is not there or the response contains an error, then the header value will not be accurate and I hit some false positives. For example, Vue.js 0.8.6.</p><span class=caption-wrapper><img class=caption src=05-vue-metadata.png title="Vue.js 0.8.6 in short metadata" alt="Vue.js 0.8.6 in short metadata">
<span class=caption-text>Vue.js 0.8.6 in short metadata</span></span><p>According to the metadata it should be there at <a href=http://registry.npmjs.org/vue/-/vue-0.8.6.tgz target=_blank rel="noreferrer noopener">http://registry.npmjs.org/vue/-/vue-0.8.6.tgz</a> but it does not exist on npm and returns a 404.</p><span class=caption-wrapper><img class=caption src=06-vue-not-found.png title="Vue.js 0.8.6 tarball not found" alt="Vue.js 0.8.6 tarball not found">
<span class=caption-text>Vue.js 0.8.6 tarball not found</span></span><p>Which means <code>HEAD</code> will not have a <code>Content-Length</code> header (or <code>0</code> if we are unmarshalling the response into a struct).</p><span class=caption-wrapper><img class=caption src=07-vue-not-found-head.png title="HEAD on Vue.js 0.8.6 tarball" alt="HEAD on Vue.js 0.8.6 tarball">
<span class=caption-text>HEAD on Vue.js 0.8.6 tarball</span></span><h1 id=why-does-it-work-for-tarballs-most-of-the-time>Why does it Work for tarballs (most of the time)?
<a class=header-link href=#why-does-it-work-for-tarballs-most-of-the-time><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Now you could say this method will work for most files and you would be correct. But <code>tar.gz</code> files are different.</p><p>Let's assume you want to modify a JavaScript file without altering the size. Remove comments, whitespace etc and add your own code. One character removed for every character added. If it's done to multiple files in the package, the total size of files will stay the same. If you <code>tar</code> them, they are all concatenated into one big file. <code>tar</code> of the modified version and the original version will have the same size (I think).</p><p>That's when <code>gzip</code> jumps in. It's a compression tool, uses dictionaries and everything. It's going to be impossible to have modified files that produce the same size after compression. The dictionary and other artifacts will be different.</p><p><strong>Correction</strong>: My esteemed colleagues, more specifically <a href=https://www.linkedin.com/in/robertallenhill target=_blank rel="noreferrer noopener">Robert Hill</a> and <a href=https://www.linkedin.com/in/travisbiehn target=_blank rel="noreferrer noopener">Travis Biehn</a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, have pointed out that <code>gz</code> files can be padded with random files and still be valid. If your modified package is smaller than the original, you can just pad it to reach the original size. Of course, why didn't I think like that? I have done this to PNGs for data exfil. Well there goes my patent.</p><h1 id=conclusion>Conclusion
<a class=header-link href=#conclusion><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>This is a nice trick. I explained it to a group recently and was asked why I did not download the files instead. I felt damn clever after explaining it. Let me have my moment.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>In the DEF CON video I say "my boss is sitting right here" and point to Travis. Fortunately for him, he is not my manager.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Parsia</span></span>
<time>Dec 4, 2018</time></span></p><p class=meta><a class="basic-alignment left" href=https://parsiya.net/blog/2018-11-18-pointers-inside-for/ title="Pointers Inside for">Pointers Inside for</a>
<a class="basic-alignment right" href=https://parsiya.net/blog/2018-12-11-tiredful-api-part-1-burp-session-validation-with-macros/ title="Tiredful API - Part 1 - Burp Session Validation with Macros">Tiredful API - Part 1 - Burp Session Validation with Macros</a></p><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//parsiya.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h1>Who am I?</h1><p><p>I am Parsia, a senior security engineer at <a href=https://www.ea.com/security target=_blank rel="noreferrer noopener">Electronic Arts</a>.</p><p>I write about application security, reverse engineering,
Go, cryptography, and (obviously) videogames.</p><p>Click on <a href=/about/>About Me!</a> to know more.</p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/parsiya/ title=https://github.com/parsiya/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cryptogangsta/ title=https://twitter.com/cryptogangsta/><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://keybase.io/parsiya/ title=https://keybase.io/parsiya/><i class="fa fa-keybase fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/parsiya title=https://www.linkedin.com/in/parsiya><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><h1>Collections</h1><li><a href=https://parsiya.net/categories/thick-client-proxying/ title="Thick Client Proxying">Thick Client Proxying</a></li><li><a href=https://parsiya.net/categories/writeup/ title=CTFs/Writeups>CTFs/Writeups</a></li><li><a href=https://parsiya.net/categories/attack-surface-analysis/ title="Attack Surface Analysis">Attack Surface Analysis</a></li><li><a href=https://parsiya.net/categories/bug-bounty/ title="Bug Bounty">Bug Bounty</a></li><li><a href=https://parsiya.net/categories/go/ title=Go/Golang>Go/Golang</a></li><li><a href=https://parsiya.net/categories/blockchain/ title=Blockchain>Blockchain</a></li><li><a href=https://parsiya.net/categories/burp-extension/ title="Burp Extension Development">Burp Extension Development</a></li><li><a href=https://parsiya.net/categories/automation/ title=Automation>Automation</a></li><li><a href=https://parsiya.net/categories/reverse-engineering/ title="Reverse Engineering">Reverse Engineering</a></li><li><a href=https://parsiya.net/categories/crypto/ title=Crypto(graphy)>Crypto(graphy)</a></li><li><a href=https://parsiya.net/categories/winappdbg/ title=WinAppDbg>WinAppDbg</a></li><li><a href=https://awsome.pw title="AWSome.pw - S3 bucket squatting - my very legit branded vulnerability">AWSome.pw - S3 bucket squatting - my very legit branded vulnerability</a></li></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2022 Parsia - <a href=https://parsiya.net/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>